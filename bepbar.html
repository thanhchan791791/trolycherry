
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản Lý Đơn Hàng Bếp & Bar</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <style>
        /* 1. iOS Font & General Styles */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "Segoe UI", Roboto, Arial, sans-serif;
            background: #F2F2F7;
            min-height: 100vh;
            color: #1C1C1E;
            transition: all 0.25s ease-in-out; 
        }

        :root {
            --ios-blue: #007AFF;
            --ios-green: #34C759;
            --ios-red: #FF3B30;
            --ios-orange: #FF9500;
            --ios-gray-2: #AEAEB2;
            --ios-gray-6: #F2F2F7;
            --ios-card-bg: #FFFFFF;
            --default-transition: all 0.25s ease-in-out;
            --fast-transition: all 0.15s ease-out;
            --ios-indigo: #5856D6;
            --ios-yellow: #FFCC00;
            --ios-teal: #5AC8FA;
        }

        .card-ios {
            background-color: var(--ios-card-bg);
            border-radius: 16px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
            transition: var(--default-transition);
        }

        .btn-ios {
            padding: 12px 16px; 
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--fast-transition);
            user-select: none;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .btn-ios:active {
            transform: scale(0.96);
            opacity: 0.9;
        }

        .ios-button-complete {
            background-color: var(--ios-green);
            color: white;
            padding: 12px 16px; 
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--fast-transition);
            box-shadow: 0 4px 10px rgba(52, 199, 89, 0.4);
        }
        .ios-button-complete:active {
            transform: scale(0.96); 
            background-color: #2CA94D;
        }
        
        .ios-button-delete {
            background-color: var(--ios-red);
            color: white;
            padding: 12px 16px; 
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--fast-transition);
            box-shadow: 0 4px 10px rgba(255, 59, 48, 0.4);
        }
        .ios-button-delete:active {
            transform: scale(0.96); 
            background-color: #D62F26;
        }
        
        .ios-button-edit {
            background-color: var(--ios-yellow);
            color: #1C1C1E;
            padding: 12px 16px; 
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--fast-transition);
            box-shadow: 0 4px 10px rgba(255, 204, 0, 0.4);
        }

        .segmented-control {
            display: flex;
            background-color: var(--ios-card-bg);
            border-radius: 12px;
            padding: 4px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
            top: 0; 
        }
        .segmented-control-item {
            flex: 1;
            padding: 10px 8px;
            border-radius: 10px;
            text-align: center;
            font-weight: 600;
            cursor: pointer;
            color: #8E8E93;
            transition: var(--fast-transition);
            font-size: 13px;
        }
        .segmented-control-item.active {
            background-color: var(--ios-blue);
            color: white;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.15);
        }

        .order-card {
            margin-bottom: 20px;
            @apply card-ios; 
            --item-color: var(--ios-indigo);
        }
        
        .order-header-food { background-color: var(--ios-red); }
        .order-header-drink { background-color: var(--ios-blue); }

        .order-card.priority-high {
            border: 2px solid var(--ios-red); 
            box-shadow: 0 6px 20px rgba(255, 59, 48, 0.2);
            animation: pulse-border 1.5s infinite alternate;
        }
        
        .item-list-container {
            border-top: 1px solid #E5E5EA;
            padding: 12px 0;
            margin-top: 8px;
        }
        .item-list-container li span:last-child {
            color: var(--item-color);
            font-weight: 700;
        }

        #custom-modal-backdrop, #item-edit-modal-backdrop {
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease-in-out;
        }
        #custom-modal-backdrop.show, #item-edit-modal-backdrop.show {
            opacity: 1;
            pointer-events: auto;
        }
        #custom-modal-backdrop > div, #item-edit-modal-backdrop > div {
            transform: translateY(20px);
            transition: transform 0.3s ease-out, opacity 0.3s ease-out;
            opacity: 0;
            @apply card-ios;
            border-radius: 20px;
            padding: 24px;
        }
        #custom-modal-backdrop.show > div, #item-edit-modal-backdrop.show > div {
            transform: translateY(0);
            opacity: 1;
        }
        
        .status-indicator-connecting { color: var(--ios-orange); }
        .status-indicator-stable { color: var(--ios-green); }
        .status-indicator-error { color: var(--ios-red); }
        
        @keyframes pulse-border {
            0% { border-color: rgba(255, 59, 48, 0.5); }
            100% { border-color: rgba(255, 59, 48, 0.9); }
        }

        @keyframes slide-up-fade {
            0% { transform: translateY(20px); opacity: 0; }
            100% { transform: translateY(0); opacity: 1; }
        }
        .order-card { animation: slide-up-fade 0.5s ease-out backwards; }
        
        .button-container {
            display: flex;
            gap: 12px;
            margin-top: 16px;
        }
        .button-container > button { flex: 1; }
        
        .edit-item-btn {
            background-color: transparent;
            border: none;
            color: var(--ios-blue);
            font-size: 16px;
            padding: 4px 8px;
            cursor: pointer;
            opacity: 0.7;
        }

        /* Thống kê styles */
        .stats-summary-card {
            background: linear-gradient(135deg, #007AFF, #5856D6);
            color: white;
            padding: 20px;
            border-radius: 16px;
            margin-bottom: 20px;
        }
        .ingredient-usage-row {
            padding: 12px;
            border-bottom: 1px solid #E5E5EA;
        }
        .dish-detail-tag {
            font-size: 11px;
            background: #E5E5EA;
            padding: 2px 6px;
            border-radius: 4px;
            margin-right: 4px;
            color: #3A3A3C;
        }
    </style>
</head>
<body class="p-4 max-w-lg mx-auto">
    <script>
        document.body.style.opacity = 0;
        document.addEventListener('DOMContentLoaded', () => {
             document.body.style.opacity = 1;
        });
    </script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyB8uLkLJFlzmCodcawJhs2dRckHQzO5y10",
            authDomain: "chitieu-7263e.firebaseapp.com",
            databaseURL: "https://chitieu-7263e-default-rtdb.firebaseio.com",
            projectId: "chitieu-7263e",
            storageBucket: "chitieu-7263e.firebasestorage.app",
            messagingSenderId: "83833140682",
            appId: "1:83833140682:web:f9254b418ace3a659fcb33",
            measurementId: "G-523X74K18N"
        };
        
        let app;
        let database;

        try {
            app = firebase.initializeApp(firebaseConfig);
            database = firebase.database();
            console.log("Firebase Realtime Database initialized.");
        } catch (e) {
            console.error("Error initializing Firebase:", e);
        }
    </script>
    
    <header class="mb-6 pt-2 pb-2 flex justify-between items-center">
        <h1 class="text-gray-800 flex items-center font-bold text-2xl">
            <i class="fas fa-shipping-fast text-blue-500 mr-2"></i> Phiếu Bếp & Bar
        </h1>
        <div id="status-indicator" class="text-sm font-medium">
            <span class="status-indicator-connecting"><i class="fas fa-spinner animate-spin"></i> Đang kết nối...</span>
        </div>
    </header>

    <nav class="segmented-control sticky top-0 z-10 mb-6 shadow-lg">
        <div id="toggle-kitchen" class="segmented-control-item active flex items-center justify-center" onclick="changeView('kitchen')">
            <i class="fas fa-fire-alt mr-1"></i> BẾP
        </div>
        <div id="toggle-bar" class="segmented-control-item flex items-center justify-center" onclick="changeView('bar')">
            <i class="fas fa-cocktail mr-1"></i> BAR
        </div>
        <div id="toggle-history" class="segmented-control-item flex items-center justify-center" onclick="changeView('history')">
            <i class="fas fa-history mr-1"></i> LỊCH SỬ
        </div>
        <div id="toggle-stats" class="segmented-control-item flex items-center justify-center" onclick="changeView('stats')">
            <i class="fas fa-chart-pie mr-1"></i> THỐNG KÊ
        </div>
    </nav>
    
    <div id="main-content">
        <div id="kitchen-view" class="view-content">
            <h2 class="text-red-600 border-b pb-2 font-bold text-xl mb-4">Đơn Hàng Món Ăn Đang Chờ</h2>
            <div id="kitchen-orders-list" class="space-y-4">
                <p id="kitchen-empty" class="text-gray-500 italic hidden p-4 text-center card-ios">Chưa có món ăn nào đang chờ.</p>
            </div>
        </div>

        <div id="bar-view" class="view-content hidden">
            <h2 class="text-blue-600 border-b pb-2 font-bold text-xl mb-4">Đơn Hàng Đồ Uống Đang Chờ</h2>
            <div id="bar-orders-list" class="space-y-4">
                <p id="bar-empty" class="text-gray-500 italic hidden p-4 text-center card-ios">Chưa có đồ uống nào đang chờ.</p>
            </div>
        </div>

        <div id="history-view" class="view-content hidden">
            <h2 class="text-gray-600 border-b pb-2 font-bold text-xl mb-4">Đơn Hàng Đã Hoàn Thành</h2>
            <div id="history-orders-list" class="space-y-4">
                <p id="history-empty" class="text-gray-500 italic hidden p-4 text-center card-ios">Chưa có đơn hàng nào.</p>
            </div>
        </div>

        <div id="stats-view" class="view-content hidden">
            <h2 class="text-teal-600 border-b pb-2 font-bold text-xl mb-4">Thống Kê Hôm Nay</h2>
            <div id="stats-container" class="space-y-6">
                <div class="stats-summary-card">
                    <p class="opacity-80 text-sm">Tổng món ăn & đồ uống hoàn thành</p>
                    <h3 id="total-dishes-today" class="text-3xl font-bold">0</h3>
                </div>

                <div>
                    <h3 class="text-gray-600 font-bold mb-2 ml-1 text-sm uppercase tracking-wider">Số lượng món đã bán</h3>
                    <div id="dishes-sold-list" class="card-ios divide-y divide-gray-100 overflow-hidden mb-4">
                        <p class="p-4 text-center text-gray-400 italic">Chưa có món nào.</p>
                    </div>
                </div>

                <div>
                    <h3 class="text-gray-600 font-bold mb-2 ml-1 text-sm uppercase tracking-wider">Nguyên liệu tiêu hao</h3>
                    <div id="ingredients-usage-list" class="card-ios divide-y divide-gray-100 overflow-hidden">
                        <p class="p-8 text-center text-gray-500 italic">Đang tính toán dữ liệu...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="custom-modal-backdrop" class="fixed inset-0 bg-black bg-opacity-40 backdrop-blur-sm hidden justify-center items-center z-50" onclick="if(event.target.id === 'custom-modal-backdrop') document.getElementById('custom-modal-backdrop').classList.remove('show', 'hidden');">
        <div class="w-11/12 max-sm:max-w-sm" onclick="event.stopPropagation()">
            <h3 id="custom-modal-title" class="text-xl font-bold mb-4 text-gray-800">Thông báo</h3>
            <p id="custom-modal-message" class="mb-6 text-gray-700"></p>
            <div class="flex justify-end space-x-3">
                <button id="custom-modal-cancel" class="btn-ios bg-gray-300 text-gray-800 hidden">Hủy</button> 
                <button id="custom-modal-ok" class="btn-ios bg-blue-500 text-white">Đóng</button>
            </div>
        </div>
    </div>
    
    <div id="item-edit-modal-backdrop" class="fixed inset-0 bg-black bg-opacity-40 backdrop-blur-sm hidden justify-center items-center z-50" onclick="if(event.target.id === 'item-edit-modal-backdrop') hideItemEditModal();">
        <div class="w-11/12 max-w-sm" onclick="event.stopPropagation()">
            <h3 class="text-xl font-bold mb-4 text-gray-800">Chỉnh Sửa Số Lượng Món</h3>
            <p id="item-edit-name" class="mb-4 text-lg font-semibold text-gray-800"></p>
            <div class="mb-6 space-y-3">
                <div class="flex justify-between items-center p-3 card-ios shadow-none border border-gray-200">
                    <span class="text-gray-700 font-medium">Số Lượng Mới</span>
                    <div class="flex items-center space-x-2">
                        <button id="decrease-btn" class="ios-button-delete !p-2 !rounded-lg !shadow-none !w-8 !h-8 disabled:opacity-50" disabled>
                            <i class="fas fa-minus"></i>
                        </button>
                        <input type="number" id="new-quantity-input" value="1" min="0" class="w-16 text-center border rounded-lg p-1 font-bold text-lg" onchange="validateNewQuantityInput(this)">
                        <button id="increase-btn" class="ios-button-complete !p-2 !rounded-lg !shadow-none !w-8 !h-8">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                </div>
                <div class="flex justify-between items-center p-3 card-ios shadow-none border border-red-300">
                    <span class="text-red-600 font-medium">Xóa Hẳn Món</span>
                    <button id="delete-item-final-btn" class="ios-button-delete !py-2 !px-3 !shadow-none flex items-center text-sm">
                        <i class="fas fa-trash-alt mr-2"></i> XÓA MÓN
                    </button>
                </div>
            </div>
            <div class="flex justify-end space-x-3">
                <button id="item-edit-cancel" class="btn-ios bg-gray-300 text-gray-800" onclick="hideItemEditModal()">Trở lại</button> 
                <button id="item-edit-confirm" class="btn-ios bg-blue-500 text-white">Xác nhận</button>
            </div>
        </div>
    </div>

    <script>
        // Các biến toàn cục
        const KITCHEN_ORDERS_REF = 'kitchen_bar_orders';
        const RECIPES_REF = 'recipes';
        const INVENTORY_REF = 'ingredients';
        const COMPLETED_LOG_REF = 'completed_dishes_log'; // Node mới cho thống kê
        let currentView = 'kitchen';
        let currentOrderKey = null;
        let currentItemKey = null;
        let currentItemName = null;
        let originalQuantity = 0;

        // --- Custom Dialogs ---
        function customAlert(message, title = 'Thông báo') {
            const backdrop = document.getElementById('custom-modal-backdrop');
            document.getElementById('custom-modal-title').textContent = title;
            document.getElementById('custom-modal-message').innerHTML = message;
            const okButton = document.getElementById('custom-modal-ok');
            const cancelButton = document.getElementById('custom-modal-cancel');
            okButton.textContent = 'Đóng';
            okButton.className = 'btn-ios bg-blue-500 text-white';
            cancelButton.classList.add('hidden');
            okButton.onclick = () => { backdrop.classList.remove('show'); setTimeout(() => backdrop.classList.add('hidden'), 300); };
            backdrop.classList.remove('hidden');
            setTimeout(() => backdrop.classList.add('show'), 10); 
        }

        function customConfirm(message, title, onConfirm) {
            const backdrop = document.getElementById('custom-modal-backdrop');
            document.getElementById('custom-modal-title').textContent = title;
            document.getElementById('custom-modal-message').innerHTML = message;
            const okButton = document.getElementById('custom-modal-ok');
            const cancelButton = document.getElementById('custom-modal-cancel');
            okButton.textContent = 'Hủy Đơn'; 
            okButton.className = 'ios-button-delete btn-ios';
            cancelButton.classList.remove('hidden');
            cancelButton.textContent = 'Trở lại';
            cancelButton.className = 'btn-ios bg-gray-300 text-gray-800';
            okButton.onclick = () => { backdrop.classList.remove('show'); setTimeout(() => backdrop.classList.add('hidden'), 300); onConfirm(); };
            cancelButton.onclick = () => { backdrop.classList.remove('show'); setTimeout(() => backdrop.classList.add('hidden'), 300); };
            backdrop.classList.remove('hidden');
            setTimeout(() => backdrop.classList.add('show'), 10); 
        }

        // --- Item Editing ---
        const itemEditModalBackdrop = document.getElementById('item-edit-modal-backdrop');
        const newQuantityInput = document.getElementById('new-quantity-input');
        const decreaseBtn = document.getElementById('decrease-btn');
        const increaseBtn = document.getElementById('increase-btn');
        const confirmEditBtn = document.getElementById('item-edit-confirm');
        const deleteItemFinalBtn = document.getElementById('delete-item-final-btn');

        function hideItemEditModal() {
            itemEditModalBackdrop.classList.remove('show');
            setTimeout(() => itemEditModalBackdrop.classList.add('hidden'), 300);
            currentOrderKey = null;
        }

        function validateNewQuantityInput(input) {
            let value = parseInt(input.value) || 0;
            if (value < 0) value = 0;
            input.value = value;
            decreaseBtn.disabled = (value <= 0);
            if (value === 0) {
                 confirmEditBtn.textContent = 'Xác nhận Xóa Món';
                 confirmEditBtn.className = 'ios-button-delete btn-ios';
            } else {
                 confirmEditBtn.textContent = `Cập nhật (${value})`;
                 confirmEditBtn.className = 'btn-ios bg-blue-500 text-white';
            }
        }

        function showItemEditModal(orderKey, itemKey, itemName, quantity) {
            currentOrderKey = orderKey;
            currentItemKey = itemKey;
            currentItemName = itemName;
            originalQuantity = quantity;
            document.getElementById('item-edit-name').textContent = `${itemName} (Đang có: ${quantity})`;
            newQuantityInput.value = quantity;
            validateNewQuantityInput(newQuantityInput);

            increaseBtn.onclick = () => { newQuantityInput.value = parseInt(newQuantityInput.value) + 1; validateNewQuantityInput(newQuantityInput); };
            decreaseBtn.onclick = () => { newQuantityInput.value = parseInt(newQuantityInput.value) - 1; validateNewQuantityInput(newQuantityInput); };

            confirmEditBtn.onclick = () => {
                const nq = parseInt(newQuantityInput.value);
                if (nq === originalQuantity) { hideItemEditModal(); return; }
                if (nq > 0) updateItemQuantity(currentOrderKey, currentItemKey, currentItemName, nq);
                else confirmDeleteItem(currentOrderKey, currentItemKey, currentItemName, true);
            };
            
            deleteItemFinalBtn.onclick = () => confirmDeleteItem(currentOrderKey, currentItemKey, currentItemName, false);
            itemEditModalBackdrop.classList.remove('hidden');
            setTimeout(() => itemEditModalBackdrop.classList.add('show'), 10);
        }

        async function updateItemQuantity(orderKey, itemKey, itemName, newQuantity) {
             hideItemEditModal();
             try {
                await database.ref(`${KITCHEN_ORDERS_REF}/${orderKey}/items/${itemKey}/quantity`).set(newQuantity);
                customAlert(`Đã cập nhật **${itemName}** thành **${newQuantity}**`, 'Thành công');
            } catch (e) { customAlert('Lỗi cập nhật số lượng'); }
        }

        async function deleteSingleItem(orderKey, itemKey, itemName) {
            hideItemEditModal();
            try {
                await database.ref(`${KITCHEN_ORDERS_REF}/${orderKey}/items/${itemKey}`).remove();
                customAlert(`Đã xóa **${itemName}**`, 'Đã xóa');
            } catch (e) { customAlert('Lỗi xóa món'); }
        }

        function confirmDeleteItem(orderKey, itemKey, itemName, isFromZero) {
            hideItemEditModal();
            const msg = isFromZero ? `Xóa món **${itemName}** vì số lượng là 0?` : `Xóa hẳn món **${itemName}** khỏi đơn?`;
            const backdrop = document.getElementById('custom-modal-backdrop');
            document.getElementById('custom-modal-title').textContent = 'Xác nhận xóa';
            document.getElementById('custom-modal-message').innerHTML = msg;
            const okBtn = document.getElementById('custom-modal-ok');
            const cancelBtn = document.getElementById('custom-modal-cancel');
            okBtn.textContent = 'Xóa'; 
            okBtn.className = 'ios-button-delete btn-ios';
            cancelBtn.classList.remove('hidden');
            okBtn.onclick = () => { backdrop.classList.remove('show'); setTimeout(() => backdrop.classList.add('hidden'), 300); deleteSingleItem(orderKey, itemKey, itemName); };
            cancelBtn.onclick = () => { backdrop.classList.remove('show'); setTimeout(() => backdrop.classList.add('hidden'), 300); if(isFromZero) showItemEditModal(orderKey, itemKey, itemName, originalQuantity); };
            backdrop.classList.remove('hidden');
            setTimeout(() => backdrop.classList.add('show'), 10);
        }

        // --- View Navigation ---
        function changeView(view) {
            currentView = view;
            document.querySelectorAll('.view-content').forEach(v => v.classList.add('hidden'));
            document.querySelectorAll('.segmented-control-item').forEach(i => i.classList.remove('active'));
            document.getElementById(`${view}-view`).classList.remove('hidden');
            document.getElementById(`toggle-${view}`).classList.add('active');
            if(view === 'stats') renderStats();
        }

        function formatTimestamp(ts) {
            if (!ts) return "Không rõ";
            const d = new Date(ts);
            if (isNaN(d.getTime())) return "Không rõ";
            return `${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
        }
        
        function isHighPriority(ts) { return (Date.now() - ts) > (15 * 60 * 1000); }

        // --- Core Logic ---
        async function updateInventory(completedItems) {
            if (!database) return;
            try {
                const recipesSnap = await database.ref(RECIPES_REF).once('value');
                const recipes = recipesSnap.val() || {};
                const invSnap = await database.ref(INVENTORY_REF).once('value');
                const inventory = invSnap.val() || {};
                const updates = {};

                completedItems.forEach(item => {
                    const recipe = recipes[item.itemName];
                    if (recipe) {
                        Object.entries(recipe).forEach(([ingId, ing]) => {
                            const currentStock = inventory[ingId]?.qty || 0;
                            const amountToSub = item.quantity * (ing.qty || 0);
                            updates[`${ingId}/qty`] = currentStock - amountToSub;
                        });
                    }
                });

                if (Object.keys(updates).length > 0) await database.ref(INVENTORY_REF).update(updates);
            } catch (e) { console.error("Lỗi tồn kho:", e); }
        }

        async function completeOrder(orderKey, type) {
            if (!database) return;
            const ref = database.ref(`${KITCHEN_ORDERS_REF}/${orderKey}/items`);
            try {
                const snap = await ref.once('value');
                const items = snap.val();
                if (!items) return;
                
                const updates = {};
                const toInv = [];
                const logUpdates = {}; // Dùng để lưu vào node thống kê riêng

                Object.entries(items).forEach(([k, it]) => {
                    if (it.status === 'pending' && it.type === type) {
                        const now = firebase.database.ServerValue.TIMESTAMP;
                        
                        // Cập nhật trạng thái trong đơn hàng gốc
                        updates[`${k}/status`] = 'completed';
                        updates[`${k}/completedAt`] = now;
                        
                        // Chuẩn bị dữ liệu cho node thống kê độc lập
                        const logKey = database.ref(COMPLETED_LOG_REF).push().key;
                        logUpdates[logKey] = {
                            itemName: it.itemName,
                            quantity: it.quantity,
                            type: it.type,
                            completedAt: now, // Server sẽ tự điền timestamp
                            orderRef: orderKey
                        };

                        if(type === 'food') toInv.push({ itemName: it.itemName, quantity: it.quantity });
                    }
                });

                if (Object.keys(updates).length > 0) {
                    await ref.update(updates);
                    // Đẩy dữ liệu vào node thống kê
                    await database.ref(COMPLETED_LOG_REF).update(logUpdates);
                    
                    if(toInv.length > 0) await updateInventory(toInv);
                    customAlert('Đã hoàn thành các món.', 'Thành công');
                }
            } catch (e) { 
                console.error(e);
                customAlert('Lỗi cập nhật'); 
            }
        }

        async function deleteOrder(orderKey, name) {
            try {
                await database.ref(`${KITCHEN_ORDERS_REF}/${orderKey}`).remove();
                customAlert(`Đã hủy đơn **${name}**`, 'Đã hủy');
            } catch (e) { customAlert('Lỗi hủy đơn'); }
        }

        function showDeleteConfirmation(okey, name) {
            customConfirm(`Hủy hoàn toàn đơn **${name}**?`, 'Xác nhận', () => deleteOrder(okey, name));
        }

        // --- Thống kê ---
        async function renderStats() {
            const listEl = document.getElementById('ingredients-usage-list');
            const dishesSoldEl = document.getElementById('dishes-sold-list');
            const totalEl = document.getElementById('total-dishes-today');
            
            listEl.innerHTML = '<p class="p-8 text-center text-gray-500 italic">Đang tải...</p>';
            dishesSoldEl.innerHTML = '<p class="p-4 text-center text-gray-500 italic">Đang tải...</p>';
            
            try {
                // Đọc dữ liệu từ node thống kê riêng biệt COMPLETED_LOG_REF
                const [logSnap, recipesSnap, invSnap] = await Promise.all([
                    database.ref(COMPLETED_LOG_REF).once('value'),
                    database.ref(RECIPES_REF).once('value'),
                    database.ref(INVENTORY_REF).once('value')
                ]);
                
                const logs = logSnap.val() || {};
                const recipes = recipesSnap.val() || {};
                const inventory = invSnap.val() || {};
                const today = new Date().setHours(0,0,0,0);
                
                let stats = {}; 
                let dishesSold = {}; 
                let totalItemsCount = 0;

                Object.values(logs).forEach(item => {
                    const compDate = item.completedAt ? new Date(item.completedAt).setHours(0,0,0,0) : 0;
                    
                    if (compDate === today) {
                        totalItemsCount += item.quantity;
                        
                        // 1. Thống kê món bán ra
                        dishesSold[item.itemName] = (dishesSold[item.itemName] || 0) + item.quantity;

                        // 2. Thống kê nguyên liệu tiêu hao
                        const recipe = recipes[item.itemName];
                        if (recipe) {
                            Object.entries(recipe).forEach(([ingId, ing]) => {
                                if (!stats[ingId]) {
                                    const unit = inventory[ingId]?.unit || ing.unit || '';
                                    stats[ingId] = { 
                                        name: ing.name || inventory[ingId]?.name || ingId, 
                                        total: 0, 
                                        unit: unit,
                                        dishes: {} 
                                    };
                                }
                                const used = item.quantity * (ing.qty || 0);
                                stats[ingId].total += used;
                                stats[ingId].dishes[item.itemName] = (stats[ingId].dishes[item.itemName] || 0) + used;
                            });
                        }
                    }
                });

                totalEl.textContent = totalItemsCount;

                // Render danh sách món bán ra
                if (Object.keys(dishesSold).length === 0) {
                    dishesSoldEl.innerHTML = '<p class="p-4 text-center text-gray-500">Chưa bán món nào.</p>';
                } else {
                    dishesSoldEl.innerHTML = Object.entries(dishesSold).map(([name, qty]) => `
                        <div class="flex justify-between items-center p-3">
                            <span class="font-medium text-gray-700">${name}</span>
                            <span class="bg-blue-100 text-blue-700 font-bold px-3 py-1 rounded-full text-sm">x${qty}</span>
                        </div>
                    `).join('');
                }

                // Render danh sách nguyên liệu
                if (Object.keys(stats).length === 0) {
                    listEl.innerHTML = '<p class="p-8 text-center text-gray-500">Chưa có nguyên liệu tiêu hao.</p>';
                    return;
                }

                listEl.innerHTML = Object.values(stats).map(s => `
                    <div class="ingredient-usage-row">
                        <div class="flex justify-between items-start mb-1">
                            <span class="font-bold text-gray-800">${s.name}</span>
                            <span class="text-red-600 font-bold">-${s.total} <small class="text-gray-500 font-normal">${s.unit}</small></span>
                        </div>
                        <div class="flex flex-wrap">
                            ${Object.entries(s.dishes).map(([d, q]) => `
                                <span class="dish-detail-tag">${d}: ${q}${s.unit}</span>
                            `).join('')}
                        </div>
                    </div>
                `).join('');

            } catch (e) {
                console.error(e);
                listEl.innerHTML = '<p class="p-8 text-center text-red-500">Lỗi tải thống kê.</p>';
            }
        }

        // --- Listeners ---
        function startOrderListener() {
            if (!database) return;
            const kList = document.getElementById('kitchen-orders-list');
            const bList = document.getElementById('bar-orders-list');
            const hList = document.getElementById('history-orders-list');
            const statusIndicator = document.getElementById('status-indicator');

            database.ref(KITCHEN_ORDERS_REF).on('value', (snap) => {
                const orders = snap.val();
                statusIndicator.innerHTML = '<span class="status-indicator-stable"><i class="fas fa-check-circle"></i> Ổn định</span>';
                kList.innerHTML = ''; bList.innerHTML = ''; hList.innerHTML = '';
                
                if (!orders) {
                    document.getElementById('kitchen-empty').classList.remove('hidden');
                    document.getElementById('bar-empty').classList.remove('hidden');
                    document.getElementById('history-empty').classList.remove('hidden');
                    return;
                }

                const pending = [];
                const completed = [];
                Object.entries(orders).forEach(([key, o]) => {
                    const items = Object.entries(o.items || {}).map(([ik, iv]) => ({ itemKey: ik, ...iv }));
                    const food = items.filter(i => i.status === 'pending' && i.type === 'food');
                    const bar = items.filter(i => i.status === 'pending' && i.type === 'drink');
                    const done = items.filter(i => i.status === 'completed');

                    if (food.length > 0) kList.appendChild(createOrderCard(key, o.tableName, food, 'food', o.createdAt, pending.length));
                    if (bar.length > 0) bList.appendChild(createOrderCard(key, o.tableName, bar, 'drink', o.createdAt, pending.length));
                    if (done.length > 0) hList.appendChild(createHistoryCard(key, o.tableName, done, o.createdAt, completed.length));
                });

                document.getElementById('kitchen-empty').classList.toggle('hidden', kList.children.length > 1);
                document.getElementById('bar-empty').classList.toggle('hidden', bList.children.length > 1);
                document.getElementById('history-empty').classList.toggle('hidden', hList.children.length > 1);
                if(currentView === 'stats') renderStats();
            });
        }

        function createOrderCard(okey, tname, items, type, cat, idx) {
            const card = document.createElement('div');
            card.className = `order-card p-4 flex flex-col shadow-md border border-gray-200 ${cat && isHighPriority(cat) ? 'priority-high' : ''}`;
            const color = type === 'food' ? 'order-header-food' : 'order-header-drink';
            const icon = type === 'food' ? 'fa-utensils' : 'fa-glass-martini-alt';
            
            card.innerHTML = `
                <div class="p-3 -m-4 -mt-4 mb-4 rounded-t-xl ${color} text-white flex justify-between items-center">
                    <h3 class="font-bold flex items-center"><i class="fas ${icon} mr-2"></i> ${tname}</h3>
                    <span class="text-xs opacity-90"><i class="far fa-clock mr-1"></i> ${formatTimestamp(cat).split(' ')[1]}</span>
                </div>
                <ul class="divide-y divide-gray-100">
                    ${items.map(i => `
                        <li class="flex justify-between items-center py-3">
                            <div class="flex items-center">
                                <button onclick="showItemEditModal('${okey}','${i.itemKey}','${i.itemName}',${i.quantity})" class="edit-item-btn"><i class="fas fa-edit"></i></button>
                                <span class="font-medium">${i.itemName}</span>
                            </div>
                            <span class="text-xl font-bold">${i.quantity}</span>
                        </li>
                    `).join('')}
                </ul>
                <div class="button-container">
                    <button onclick="showDeleteConfirmation('${okey}','${tname}')" class="ios-button-delete btn-ios text-xs"><i class="fas fa-trash-alt mr-1"></i> HỦY</button>
                    <button onclick="completeOrder('${okey}','${type}')" class="ios-button-complete btn-ios text-xs"><i class="fas fa-check mr-1"></i> XONG</button>
                </div>
            `;
            return card;
        }

        function createHistoryCard(okey, tname, items, cat, idx) {
            const card = document.createElement('div');
            card.className = 'order-card p-4 shadow-md';
            items.sort((a,b) => (b.completedAt||0) - (a.completedAt||0));
            card.innerHTML = `
                <div class="p-3 -m-4 -mt-4 mb-4 rounded-t-xl bg-gray-500 text-white flex justify-between items-center">
                    <h3 class="font-bold">ĐH ${tname}</h3>
                    <span class="text-xs">Xong: ${formatTimestamp(items[0].completedAt).split(' ')[1]}</span>
                </div>
                <ul class="divide-y divide-gray-500/10">
                    ${items.map(i => `<li class="flex justify-between py-2 text-sm"><span>${i.itemName}</span><b>${i.quantity}</b></li>`).join('')}
                </ul>
            `;
            return card;
        }

        document.addEventListener('DOMContentLoaded', startOrderListener);
    </script>
</body>
</html>
