<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Thống Kê Doanh Thu Premium</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <style>
        :root { --bg: #0f172a; --card-bg: rgba(30, 41, 59, 0.7); --accent: #38bdf8; --success: #4ade80; --warning: #fbbf24; --danger: #f87171; --text-main: #f8fafc; --text-dim: #94a3b8; --glass-border: rgba(255, 255, 255, 0.1); --radius-lg: 24px; --radius-md: 16px; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; scroll-behavior: smooth; }
        
        /* Khóa cuộn ngang */
        html, body { overflow-x: hidden; width: 100%; position: relative; }

        body { font-family: 'Plus Jakarta Sans', sans-serif; background: radial-gradient(circle at top right, #1e293b, #0f172a); color: var(--text-main); margin: 0; padding: 20px 16px; min-height: 100vh; }
        
        .reveal { opacity: 0; transform: translateY(30px); transition: all 0.8s cubic-bezier(0.2, 0.8, 0.2, 1); }
        .reveal.active { opacity: 1; transform: translateY(0); }

        @keyframes slideInUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        @keyframes scaleIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        
        .container { max-width: 600px; margin: 0 auto; padding-bottom: 60px; width: 100%; }
        h2.page-title { font-size: 28px; font-weight: 800; margin-bottom: 24px; background: linear-gradient(to right, #fff, var(--accent)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; letter-spacing: -1px; }
        .quick-nav { display: flex; gap: 10px; margin-bottom: 24px; overflow-x: auto; padding: 4px; scrollbar-width: none; -ms-overflow-style: none; }
        .quick-nav::-webkit-scrollbar { display: none; }
        .nav-btn { background: var(--card-bg); border: 1px solid var(--glass-border); padding: 12px 20px; border-radius: var(--radius-md); font-size: 14px; font-weight: 600; color: var(--accent); display: flex; align-items: center; gap: 8px; white-space: nowrap; backdrop-filter: blur(10px); text-decoration: none; transition: 0.3s; }
        .card-main { background: linear-gradient(135deg, #0284c7 0%, #0369a1 100%); padding: 24px; border-radius: var(--radius-lg); box-shadow: 0 20px 40px rgba(0,0,0,0.3), inset 0 1px 1px rgba(255,255,255,0.2); position: relative; overflow: hidden; margin-bottom: 12px; }
        .card-main::after { content: ''; position: absolute; top: -50%; right: -20%; width: 200px; height: 200px; background: rgba(255,255,255,0.1); border-radius: 50%; filter: blur(40px); }
        .card-main h3 { margin: 0; font-size: 14px; text-transform: uppercase; letter-spacing: 1px; color: rgba(255,255,255,0.8); display: flex; align-items: center; gap: 8px; }
        .card-main .value { font-size: 36px; font-weight: 800; margin: 16px 0; text-shadow: 0 2px 10px rgba(0,0,0,0.2); }
        .card-main .sub { display: flex; gap: 20px; font-size: 13px; font-weight: 600; padding-top: 16px; border-top: 1px solid rgba(255,255,255,0.15); }
        .grid-mini-vertical { display: flex; flex-direction: column; gap: 10px; margin-bottom: 24px; }
        .card-mini-row { background: var(--card-bg); backdrop-filter: blur(15px); padding: 16px 20px; border-radius: var(--radius-md); border: 1px solid var(--glass-border); display: flex; justify-content: space-between; align-items: center; transition: 0.3s; }
        .card-mini-row .info-left h3 { margin: 0; font-size: 11px; color: var(--text-dim); text-transform: uppercase; margin-bottom: 4px; }
        .card-mini-row .info-left .value { font-size: 20px; font-weight: 700; color: var(--text-main); }
        .card-mini-row .sub-right { text-align: right; font-size: 12px; color: var(--text-dim); display: flex; flex-direction: column; gap: 4px; }
        .card-mini-row .sub-right b { color: var(--accent); }
        .section { background: var(--card-bg); backdrop-filter: blur(15px); padding: 24px; border-radius: var(--radius-lg); margin-bottom: 20px; border: 1px solid var(--glass-border); box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .section h3 { font-size: 18px; font-weight: 700; margin-bottom: 20px; display: flex; align-items: center; gap: 10px; color: var(--accent); }
        .filter-group { display: flex; background: rgba(0,0,0,0.2); padding: 6px; border-radius: 16px; gap: 6px; margin-bottom: 20px; border: 1px solid var(--glass-border); }
        .date-input-wrapper { flex: 1; display: flex; align-items: center; background: rgba(255,255,255,0.05); border-radius: 10px; padding: 0 12px; }
        .date-input-wrapper i { color: var(--accent); font-size: 16px; }
        input[type="date"] { border: none; background: transparent; padding: 10px 4px; font-size: 12px; font-weight: 600; color: #fff; width: 100%; outline: none; font-family: inherit; color-scheme: dark; }
        .reset-mini { background: transparent; border: none; padding: 8px; color: var(--text-dim); transition: 0.3s; }
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; font-size: 11px; color: var(--text-dim); text-transform: uppercase; padding-bottom: 12px; }
        td { padding: 14px 0; font-size: 14px; border-top: 1px solid var(--glass-border); transition: 0.2s; }
        .btn-detail { background: rgba(56, 189, 248, 0.15); color: var(--accent); border: 1px solid rgba(56, 189, 248, 0.3); padding: 8px; border-radius: 10px; cursor: pointer; transition: 0.3s; }
        .table-stat-card { background: rgba(255,255,255,0.03); border-radius: 16px; padding: 18px; margin-bottom: 12px; border: 1px solid var(--glass-border); animation: scaleIn 0.4s ease both; }
        #modal { display: none; position: fixed; inset: 0; background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(8px); justify-content: center; align-items: flex-end; z-index: 1000; transition: opacity 0.3s ease; }
        .modal-content { background: #1e293b; padding: 30px; border-radius: 32px 32px 0 0; width: 100%; max-width: 500px; max-height: 85vh; border: 1px solid var(--glass-border); animation: slideInUp 0.4s cubic-bezier(0.18, 0.89, 0.32, 1.1); overflow-y: auto; }
        .close-bar { width: 50px; height: 4px; background: var(--text-dim); border-radius: 10px; margin: -10px auto 25px; opacity: 0.3; cursor: pointer; }
        .collapsible-content { display: none; }
    </style>
</head>
<body>
<div class="container">
    <h2 class="page-title reveal">Báo cáo doanh thu</h2>
    <div class="quick-nav reveal">
        <a href="#tableStatsSection" class="nav-btn"><i class="ph-duotone ph-rocket-launch"></i> Grab & S</a>
        <a href="#historySection" class="nav-btn"><i class="ph-duotone ph-receipt"></i> Lịch sử đơn</a>
    </div>
    <div class="stats-container">
        <div class="card-main reveal">
            <h3><i class="ph-duotone ph-wallet"></i> Tổng Doanh Thu</h3>
            <div class="value counter" id="a-all" data-target="0">0đ</div>
            <div class="sub">
                <span><i class="ph ph-money"></i> TM: <b id="a-cash">0</b></span>
                <span><i class="ph ph-credit-card"></i> CK: <b id="a-bank">0</b></span>
            </div>
        </div>
        <div class="grid-mini-vertical">
            <div class="card-mini-row reveal">
                <div class="info-left"><h3>Tháng Này</h3><div class="value counter" id="m-all">0đ</div></div>
                <div class="sub-right"><span>TM: <b id="m-cash">0</b></span><span>CK: <b id="m-bank">0</b></span></div>
            </div>
            <div class="card-mini-row reveal">
                <div class="info-left"><h3>Tuần Này</h3><div class="value counter" id="w-all">0đ</div></div>
                <div class="sub-right"><span>TM: <b id="w-cash">0</b></span><span>CK: <b id="w-bank">0</b></span></div>
            </div>
            <div class="card-mini-row reveal">
                <div class="info-left"><h3>Hôm Nay</h3><div class="value counter" id="t-all">0đ</div></div>
                <div class="sub-right"><span>TM: <b id="t-cash">0</b></span><span>CK: <b id="t-bank">0</b></span></div>
            </div>
        </div>
    </div>
    <div class="section reveal">
        <h3><i class="ph-duotone ph-chart-line-up"></i> Biểu Đồ Doanh Thu</h3>
        <div class="filter-group">
            <div class="date-input-wrapper"><i class="ph ph-calendar"></i><input type="date" id="startDate"></div>
            <div class="date-input-wrapper"><i class="ph ph-calendar"></i><input type="date" id="endDate"></div>
            <button class="reset-mini" id="btnReset"><i class="ph-bold ph-arrow-counter-clockwise"></i></button>
        </div>
        <canvas id="dailyChart" style="max-height: 250px;"></canvas>
    </div>
    <div class="section reveal">
        <h3><i class="ph-duotone ph-clock"></i> Khung Giờ Cao Điểm</h3>
        <canvas id="hourChart" style="max-height: 250px;"></canvas>
    </div>
    <div class="section reveal">
        <h3><i class="ph-duotone ph-calendar"></i> Doanh Thu Theo Thứ</h3>
        <canvas id="weekdayChart" style="max-height: 200px;"></canvas>
    </div>
    <div class="section reveal">
        <h3 onclick="toggleCollapsible(this)" style="cursor:pointer"><i class="ph-duotone ph-fire"></i> Top 10 Bán Chạy <i class="ph ph-caret-down"></i></h3>
        <div class="collapsible-content">
            <h4 style="font-size:12px; color:var(--text-dim); margin-top:10px">MÓN ĂN</h4>
            <table id="topFood"><tbody></tbody></table>
            <h4 style="font-size:12px; color:var(--text-dim); margin-top:20px">THỨC UỐNG</h4>
            <table id="topDrink"><tbody></tbody></table>
        </div>
    </div>
    <div class="section reveal">
        <h3 onclick="toggleCollapsible(this)" style="cursor:pointer"><i class="ph-duotone ph-trend-down"></i> Danh Sách Bán Chậm <i class="ph ph-caret-down"></i></h3>
        <div class="collapsible-content">
            <table id="bottomSales"><tbody></tbody></table>
        </div>
    </div>
    <div id="tableStatsSection" class="section reveal">
        <h3><i class="ph-duotone ph-shopping-bag"></i> Grab & S Stats</h3>
        <div class="filter-group">
            <div class="date-input-wrapper" style="width:100%"><i class="ph ph-calendar-check"></i><input type="date" id="tableStatDate"></div>
        </div>
        <div id="tableStatsContainer"></div>
    </div>
    <div id="historySection" class="section reveal">
        <h3><i class="ph-duotone ph-list-checks"></i> Lịch Sử Giao Dịch</h3>
        <div class="filter-group">
            <div class="date-input-wrapper" style="width:100%"><i class="ph ph-calendar-plus"></i><input type="date" id="historyDate"></div>
        </div>
        <table id="orderTable">
            <thead><tr><th>Bàn & Giờ</th><th>PTTT</th><th>Tổng</th><th></th></tr></thead>
            <tbody></tbody>
        </table>
    </div>
</div>
<div id="modal" onclick="closeModal(event)"><div class="modal-content" onclick="event.stopPropagation()"><div class="close-bar" onclick="closeModal()"></div><h3 style="margin-top:0; color:var(--accent)">Order Details</h3><div id="modal-body"></div></div></div>
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
    const firebaseConfig = { apiKey: "AIzaSyB8uLkLJFlzmCodcawJhs2dRckHQzO5y10", authDomain: "chitieu-7263e.firebaseapp.com", databaseURL: "https://chitieu-7263e-default-rtdb.firebaseio.com", projectId: "chitieu-7263e", storageBucket: "chitieu-7263e.firebasestorage.app", messagingSenderId: "83833140682", appId: "1:83833140682:web:f9254b418ace3a659fcb33", measurementId: "G-523X74K18N" };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    let chartObj = null, hourChartObj = null, weekdayChartObj = null, allData = {}, rawDailyData = {};
    Chart.defaults.color = '#94a3b8'; Chart.defaults.font.family = "'Plus Jakarta Sans'"; Chart.defaults.animation = { duration: 2000, easing: 'easeOutQuart' };
    
    const reveal = () => {
        const items = document.querySelectorAll(".reveal");
        items.forEach(item => {
            const windowHeight = window.innerHeight;
            const elementTop = item.getBoundingClientRect().top;
            const elementVisible = 100;
            if (elementTop < windowHeight - elementVisible) item.classList.add("active");
        });
    };
    window.addEventListener("scroll", reveal);
    window.addEventListener("load", reveal);

    function formatValue(v) {
        if (v >= 1000000) return (v / 1000000).toFixed(1).replace(/\.0$/, '') + 'tr';
        if (v >= 1000) return (v / 1000).toFixed(0) + 'k';
        return v;
    }

    function animateValue(id, start, end, duration) {
        const obj = document.getElementById(id);
        if (start === end) { obj.innerText = end.toLocaleString() + (id.includes('all') ? 'đ' : ''); return; }
        let startTimestamp = null;
        const step = (timestamp) => {
            if (!startTimestamp) startTimestamp = timestamp;
            const progress = Math.min((timestamp - startTimestamp) / duration, 1);
            const current = Math.floor(progress * (end - start) + start);
            obj.innerText = current.toLocaleString() + (id.includes('all') ? 'đ' : '');
            if (progress < 1) window.requestAnimationFrame(step);
        };
        window.requestAnimationFrame(step);
    }

    window.toggleCollapsible = (header) => {
        const content = header.nextElementSibling;
        const isOpen = content.style.display === "block";
        content.style.display = isOpen ? "none" : "block";
        const icon = header.querySelector('.ph-caret-down');
        if(icon) icon.style.transform = isOpen ? "rotate(0deg)" : "rotate(180deg)";
    };

    onValue(ref(db, 'payment_history'), (snap) => {
        const data = snap.val(); if (!data) return;
        allData = data;
        const now = new Date(), todayStr = now.toLocaleDateString('en-GB');
        const sevenDaysAgo = new Date(); sevenDaysAgo.setDate(now.getDate() - 7);
        let s = { t:0, tc:0, tk:0, w:0, wc:0, wk:0, m:0, mc:0, mk:0, a:0, ac:0, ak:0 };
        rawDailyData = {}; let itemCounts = {};
        let hourRevenue = Array(24).fill(0);
        let weekdayData = { 0:[], 1:[], 2:[], 3:[], 4:[], 5:[], 6:[] };
        Object.keys(data).forEach(key => {
            const o = data[key], amt = o.finalTotal || 0, meth = o.paymentMethod === "Chuyển khoản" ? 'K' : 'C';
            const d = new Date(o.timestamp), dStr = d.toLocaleDateString('en-GB'), isoStr = d.toISOString().split('T')[0];
            s.a += amt; meth==='C' ? s.ac += amt : s.ak += amt;
            if(dStr === todayStr) { s.t += amt; meth==='C' ? s.tc += amt : s.tk += amt; }
            if(d >= sevenDaysAgo) { s.w += amt; meth==='C' ? s.wc += amt : s.wk += amt; }
            if(d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear()) { s.m += amt; meth==='C' ? s.mc += amt : s.mk += amt; }
            rawDailyData[isoStr] = (rawDailyData[isoStr] || 0) + amt;
            hourRevenue[d.getHours()] += amt;
            if(o.items) o.items.forEach(i => { if(i) itemCounts[i.name] = (itemCounts[i.name] || 0) + (i.quantity || 1); });
        });
        Object.keys(rawDailyData).forEach(iso => { const d = new Date(iso); weekdayData[d.getDay()].push(rawDailyData[iso]); });
        const setA = (id, val) => {
            const currentElement = document.getElementById(id);
            const current = parseInt(currentElement.innerText.replace(/[^0-9]/g, '')) || 0;
            animateValue(id, current, val, 1500);
        };
        setA('t-all', s.t); setA('t-cash', s.tc); setA('t-bank', s.tk); 
        setA('w-all', s.w); setA('w-cash', s.wc); setA('w-bank', s.wk); 
        setA('m-all', s.m); setA('m-cash', s.mc); setA('m-bank', s.mk); 
        setA('a-all', s.a); setA('a-cash', s.ac); setA('a-bank', s.ak);
        renderStats(itemCounts);
        updateChart();
        renderExtraCharts(hourRevenue, weekdayData);
        updateHistory(document.getElementById('historyDate').value);
        updateTableStats(document.getElementById('tableStatDate').value);
        setTimeout(reveal, 100);
    });

    function renderExtraCharts(hours, weekdays) {
        if(hourChartObj) hourChartObj.destroy();
        if(weekdayChartObj) weekdayChartObj.destroy();
        const ctxH = document.getElementById('hourChart').getContext('2d');
        const gradH = ctxH.createLinearGradient(0, 0, 0, 300); gradH.addColorStop(0, 'rgba(56, 189, 248, 0.4)'); gradH.addColorStop(1, 'rgba(56, 189, 248, 0)');
        const hLabels = Array.from({length: 13}, (_, i) => (i + 10) + 'h');
        const hData = hours.slice(10, 23);
        const maxVal = Math.max(...hData), minVal = Math.min(...hData.filter(v => v > 0) || [0]);
        hourChartObj = new Chart(ctxH, {
            type: 'line',
            data: { labels: hLabels, datasets: [{ data: hData, borderColor: '#38bdf8', backgroundColor: gradH, fill: true, tension: 0.4, pointRadius: 4, pointBackgroundColor: '#38bdf8' }] },
            plugins: [ChartDataLabels],
            options: { layout: { padding: { top: 25 } }, plugins: { legend: { display: false }, datalabels: { anchor: 'end', align: 'top', color: '#fff', font: { weight: '800', size: 10 }, formatter: (v) => (v === maxVal || v === minVal) ? formatValue(v) : null } }, scales: { y: { display: false }, x: { grid: { display: false } } } }
        });
        const wLabels = ['CN', 'T2', 'T3', 'T4', 'T5', 'T6', 'T7'];
        const wData = [0,1,2,3,4,5,6].map(i => weekdays[i].length ? (weekdays[i].reduce((a,b)=>a+b,0)/weekdays[i].length) : 0);
        weekdayChartObj = new Chart(document.getElementById('weekdayChart'), {
            type: 'bar',
            data: { labels: wLabels, datasets: [{ data: wData, backgroundColor: '#4ade80', borderRadius: 6 }] },
            plugins: [ChartDataLabels],
            options: { plugins: { legend: { display: false }, datalabels: { formatter: v => v > 0 ? formatValue(v) : '', color: '#fff', font: {size: 10, weight:'bold'}, align: 'top' } }, scales: { y: { display: false }, x: { grid: { display: false } } } }
        });
    }

    function renderStats(counts) {
        const sorted = Object.entries(counts).sort((a,b) => b[1] - a[1]);
        const foodKeywords = ['cơm', 'bún', 'phở', 'mì', 'lẩu', 'gà', 'bò', 'heo', 'vịt', 'mẹt', 'nem', 'khoai', 'ngô', 'salad', 'bánh', 'trứng'];
        let food = sorted.filter(item => foodKeywords.some(k => item[0].toLowerCase().includes(k)));
        let drink = sorted.filter(item => !foodKeywords.some(k => item[0].toLowerCase().includes(k)));
        const fill = (id, arr) => document.querySelector(`#${id} tbody`).innerHTML = arr.map(x => `<tr style="animation: scaleIn 0.3s ease forwards"><td style="color:var(--text-main)">${x[0]}</td><td style="text-align:right; font-weight:800; color:var(--success)">${x[1]}</td></tr>`).join('');
        fill('topFood', food.slice(0, 10)); fill('topDrink', drink.slice(0, 10));
        document.querySelector(`#bottomSales tbody`).innerHTML = sorted.slice(-10).reverse().map(x => `<tr style="animation: scaleIn 0.3s ease forwards"><td style="color:var(--text-main)">${x[0]}</td><td style="text-align:right; font-weight:800; color:var(--danger)">${x[1]}</td></tr>`).join('');
    }

    function updateChart(start = null, end = null) {
        let filteredKeys = Object.keys(rawDailyData).sort();
        if (start && end) filteredKeys = filteredKeys.filter(k => k >= start && k <= end);
        else { const limit = new Date(); limit.setDate(limit.getDate() - 7); filteredKeys = filteredKeys.filter(k => k >= limit.toISOString().split('T')[0]); }
        if(chartObj) chartObj.destroy();
        const ctx = document.getElementById('dailyChart').getContext('2d');
        const grad = ctx.createLinearGradient(0, 0, 0, 300); grad.addColorStop(0, 'rgba(56, 189, 248, 0.4)'); grad.addColorStop(1, 'rgba(15, 23, 42, 0)');
        chartObj = new Chart(ctx, {
            type: 'line',
            data: { labels: filteredKeys.map(k => k.split('-').reverse().join('/')), datasets: [{ data: filteredKeys.map(k => rawDailyData[k]), borderColor: '#38bdf8', backgroundColor: grad, fill: true, tension: 0.4, pointRadius: 5, pointHoverRadius: 8 }] },
            plugins: [ChartDataLabels],
            options: { layout: { padding: { top: 25 } }, plugins: { datalabels: { anchor: 'end', align: 'top', color: '#38bdf8', font: { weight: 'bold' }, formatter: (v) => formatValue(v) }, legend: { display: false } }, scales: { y: { display: false }, x: { grid: { color: 'rgba(255,255,255,0.05)' } } } }
        });
    }

    function updateHistory(targetDate) {
        const tbody = document.querySelector("#orderTable tbody"); tbody.innerHTML = "";
        Object.keys(allData).sort((a,b)=>allData[b].timestamp - allData[a].timestamp).forEach(key => {
            const o = allData[key], d = new Date(o.timestamp);
            if(d.toISOString().split('T')[0] === targetDate) {
                tbody.innerHTML += `<tr style="animation: scaleIn 0.3s ease both"><td><b style="color:var(--text-main)">Bàn ${o.tableName||'--'}</b><br><small style="color:var(--text-dim)">${d.toLocaleTimeString('vi-VN',{hour:'2-digit',minute:'2-digit'})}</small></td><td style="color:var(--text-dim)">${o.paymentMethod||'TM'}</td><td style="font-weight:800; color:var(--accent)">${(o.finalTotal||0).toLocaleString()}</td><td><button class="btn-detail" onclick="showDetail('${key}')"><i class="ph ph-eye"></i></button></td></tr>`;
            }
        });
    }

    function updateTableStats(targetDate) {
        const container = document.getElementById('tableStatsContainer'); container.innerHTML = "";
        let tableData = {}; const targets = ["S", "GRAB"];
        Object.values(allData).forEach(o => {
            if(new Date(o.timestamp).toISOString().split('T')[0] === targetDate && targets.includes((o.tableName||"").toUpperCase())) {
                const t = o.tableName.toUpperCase(); if(!tableData[t]) tableData[t] = { total: 0, items: {} };
                tableData[t].total += o.finalTotal; if(o.items) o.items.forEach(i => i && (tableData[t].items[i.name] = (tableData[t].items[i.name] || 0) + i.quantity));
            }
        });
        targets.forEach(t => { if(tableData[t]) { let items = Object.entries(tableData[t].items).map(x => `<div style="display:flex;justify-content:space-between;font-size:13px;color:var(--text-dim);margin:4px 0;"><span>${x[0]}</span><b style="color:var(--text-main)">x${x[1]}</b></div>`).join(''); container.innerHTML += `<div class="table-stat-card"><div style="display:flex;justify-content:space-between;margin-bottom:12px;"><b style="font-size:16px;">Bàn ${t}</b><b style="color:var(--success); font-size:16px;">${tableData[t].total.toLocaleString()}đ</b></div><div style="border-top:1px solid var(--glass-border);padding-top:12px">${items}</div></div>`; } });
    }

    document.getElementById('startDate').onchange = () => { if(document.getElementById('startDate').value && document.getElementById('endDate').value) updateChart(document.getElementById('startDate').value, document.getElementById('endDate').value); };
    document.getElementById('endDate').onchange = () => { if(document.getElementById('startDate').value && document.getElementById('endDate').value) updateChart(document.getElementById('startDate').value, document.getElementById('endDate').value); };
    document.getElementById('btnReset').onclick = () => { document.getElementById('startDate').value = ''; document.getElementById('endDate').value = ''; updateChart(); };
    document.getElementById('historyDate').onchange = (e) => updateHistory(e.target.value);
    document.getElementById('tableStatDate').onchange = (e) => updateTableStats(e.target.value);
    
    window.showDetail = (id) => {
        const o = allData[id]; let h = `<div style="background:rgba(255,255,255,0.03); border-radius:20px; padding:20px; margin-top:10px; border:1px solid var(--glass-border);"><p style="font-size:18px; font-weight:800;">Bàn: ${o.tableName}</p>`;
        if(o.items) o.items.forEach(i => i && (h += `<div style="display:flex; justify-content:space-between; margin:10px 0; color:var(--text-dim)"><span>${i.name} x${i.quantity}</span><b style="color:var(--text-main)">${(i.price*i.quantity).toLocaleString()}đ</b></div>`));
        document.getElementById('modal-body').innerHTML = h + `<hr style="border:0; border-top:1px solid var(--glass-border); margin:20px 0;"><div style="text-align:right; font-weight:800; font-size:22px; color:var(--success);">Tổng: ${o.finalTotal.toLocaleString()}đ</div></div>`;
        const modal = document.getElementById('modal'); modal.style.display = 'flex'; modal.style.opacity = '1';
    };
    window.closeModal = (e) => { const modal = document.getElementById('modal'); modal.style.opacity = '0'; setTimeout(() => { modal.style.display = 'none'; }, 300); };
    const tday = new Date().toISOString().split('T')[0]; document.getElementById('historyDate').value = tday; document.getElementById('tableStatDate').value = tday;
</script>
</body>
</html>
