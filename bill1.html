
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Danh Sách Hóa Đơn & Tìm kiếm - RTDB</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9; /* Slate 100 */
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: flex-end; /* Align to bottom for mobile feel */
            z-index: 1000;
        }
        .modal-card {
            width: 100%;
            max-width: 500px;
            background-color: white;
            border-top-left-radius: 2rem;
            border-top-right-radius: 2rem;
            box-shadow: 0 -10px 25px -3px rgba(0, 0, 0, 0.2);
            padding: 1.5rem;
            max-height: 85vh;
            overflow-y: auto;
            transform: translateY(0);
            transition: transform 0.3s ease-out;
        }
        /* Custom scrollbar for better mobile feel */
        .receipt-container { -ms-overflow-style: none; scrollbar-width: none; }
        .receipt-container::-webkit-scrollbar { display: none; }

        /* Notification styles */
        #notification-box {
            position: fixed;
            top: 1rem;
            left: 50%;
            transform: translateX(-50%);
            z-index: 2000;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            min-width: 300px;
        }
        #notification-box.show {
            opacity: 1;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center p-4">

    <!-- Custom Notification Box -->
    <div id="notification-box" class="rounded-lg shadow-xl p-4 text-sm font-semibold text-white transition duration-300 hidden">
        <p id="notification-message"></p>
    </div>

    <div class="w-full max-w-md">
        <h1 class="text-2xl font-bold text-gray-800 mb-4">Danh sách Hóa đơn</h1>

        <!-- Search Input Field (New) -->
        <div class="mb-6">
            <input type="text" id="search-input" placeholder="Tìm kiếm theo Mã HĐ hoặc Tổng tiền..." 
                   class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500 shadow-sm transition duration-150"
            >
        </div>
        
        <!-- Loading Indicator -->
        <div id="loading" class="text-center p-8 bg-white rounded-xl">
            <svg class="animate-spin h-8 w-8 text-indigo-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="mt-3 text-sm text-gray-600">Đang tải danh sách hóa đơn...</p>
        </div>

        <!-- Error Message -->
        <div id="error-message" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4" role="alert">
            <strong class="font-bold">Lỗi!</strong>
            <span class="block sm:inline" id="error-details"></span>
        </div>

        <!-- Receipts List Container -->
        <div id="receipts-list" class="space-y-3 receipt-container max-h-[70vh] overflow-y-auto">
            <!-- Receipt summary cards will be injected here -->
        </div>

        <p id="no-data-message" class="hidden text-center text-gray-500 mt-8 p-4 bg-white rounded-xl">Không tìm thấy dữ liệu hóa đơn nào trong "payment_history".</p>
    </div>

    <!-- Receipt Details Modal (Hidden by default) -->
    <div id="receipt-modal-overlay" class="modal-overlay hidden">
        <div id="receipt-modal" class="modal-card">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-gray-900">Chi tiết Hóa đơn</h2>
                <button id="close-modal" class="text-gray-400 hover:text-gray-700 p-1">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>

            <!-- Receipt Info -->
            <div class="space-y-3 mb-6 border-b pb-4">
                <p class="text-sm">
                    <span class="text-gray-600">Mã HĐ:</span> 
                    <span id="invoice-id" class="font-semibold text-gray-900"></span>
                </p>
                <p class="text-sm">
                    <span class="text-gray-600">Ngày:</span> 
                    <span id="invoice-date" class="font-semibold text-red-500"></span>
                </p>
                <p class="text-sm">
                    <span class="text-gray-600">Hình thức:</span> 
                    <span id="payment-method" class="font-semibold text-gray-900"></span>
                </p>
            </div>

            <!-- Total Amount -->
            <div class="flex justify-between items-center mb-6 pt-4 border-t border-dashed border-gray-300">
                <p class="text-base font-semibold text-gray-700">Tổng tiền:</p>
                <p id="total-amount" class="text-xl font-bold text-red-600">₫</p>
            </div>

            <!-- Items List -->
            <h3 class="font-bold text-gray-800 mb-3">Các món đã mua:</h3>
            <div id="items-list" class="space-y-3 mb-8">
                <!-- Items will be injected here -->
            </div>

            <!-- Button: Set to 0 VND -->
            <button id="set-to-zero-btn" class="w-full bg-indigo-600 text-white font-bold py-3 rounded-xl shadow-lg hover:bg-indigo-700 transition duration-150 active:scale-[0.98]">
                VỀ 0 ĐỒNG
            </button>
            
        </div>
    </div>

    <!-- Firebase SDKs for Realtime Database and Auth -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getDatabase, ref, onValue, update } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // setLogLevel('Debug');
        
        // Cấu hình Firebase gốc từ yêu cầu của người dùng
        const providedConfig = {
            apiKey: "AIzaSyB8uLkLJFlzmCodcawJhs2dRckHQzO5y10",
            authDomain: "chitieu-7263e.firebaseapp.com",
            databaseURL: "https://chitieu-7263e-default-rtdb.firebaseio.com", 
            projectId: "chitieu-7263e",
            storageBucket: "chitieu-7263e.firebasestorage.app",
            messagingSenderId: "83833140682",
            appId: "1:83833140682:web:f9254b418ace3a659fcb33",
            measurementId: "G-523X74K18N"
        };
        
        let firebaseConfig = providedConfig;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        if (typeof __firebase_config !== 'undefined') {
            try {
                const globalConfig = JSON.parse(__firebase_config);
                firebaseConfig = { ...providedConfig, ...globalConfig };
            } catch (e) {
                console.warn("Lỗi khi parse __firebase_config, sử dụng providedConfig.", e);
            }
        }
        
        let app, auth, db;
        // Lưu trữ toàn bộ dữ liệu gốc đã tải về từ Firebase
        let masterReceipts = []; 
        let currentInvoiceId = null; 

        const loadingElement = document.getElementById('loading');
        const errorElement = document.getElementById('error-message');
        const errorDetails = document.getElementById('error-details');
        const listElement = document.getElementById('receipts-list');
        const modalOverlay = document.getElementById('receipt-modal-overlay');
        const noDataMessage = document.getElementById('no-data-message');
        const itemsListElement = document.getElementById('items-list');
        const closeModalButton = document.getElementById('close-modal');
        const setToZeroButton = document.getElementById('set-to-zero-btn');
        const searchInput = document.getElementById('search-input'); // New search input element
        const notificationBox = document.getElementById('notification-box');
        const notificationMessage = document.getElementById('notification-message');

        // --- Custom Notification Function ---
        const showCustomMessage = (type, message) => {
            notificationMessage.textContent = message;
            notificationBox.classList.remove('hidden', 'bg-green-600', 'bg-red-600');
            
            if (type === 'success') {
                notificationBox.classList.add('bg-green-600');
            } else if (type === 'error') {
                notificationBox.classList.add('bg-red-600');
            }

            // Show and hide animation
            setTimeout(() => notificationBox.classList.add('show'), 10);
            setTimeout(() => notificationBox.classList.remove('show'), 3000);
            setTimeout(() => notificationBox.classList.add('hidden'), 3500);
        };

        // --- Helper Functions ---
        const formatVND = (amount) => {
            if (typeof amount !== 'number' || isNaN(amount)) return '0₫';
            return amount.toLocaleString('vi-VN', { 
                style: 'currency', 
                currency: 'VND', 
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            });
        };

        const formatTimestamp = (timestamp) => {
            if (!timestamp) return 'Không rõ';
            const ms = String(timestamp).length === 10 ? timestamp * 1000 : timestamp;
            const date = new Date(ms);
            if (isNaN(date.getTime())) return 'Ngày không hợp lệ';

            const time = date.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            const day = date.toLocaleDateString('vi-VN');
            return `${time} ${day}`;
        };
        
        // --- Search/Filter Function (New) ---
        const filterReceipts = () => {
            const query = searchInput.value.toLowerCase().trim();
            
            if (!query) {
                // Nếu ô tìm kiếm trống, hiển thị toàn bộ danh sách gốc
                renderReceiptsList(masterReceipts);
                return;
            }

            const filtered = masterReceipts.filter(receipt => {
                const idMatch = receipt.invoiceId && receipt.invoiceId.toLowerCase().includes(query);
                
                // Chuyển tổng tiền sang chuỗi VND để tìm kiếm (ví dụ: "100.000₫")
                const totalVND = formatVND(receipt.totalAmount || 0).toLowerCase().replace(/\./g, '');
                // Chuyển tổng tiền sang chuỗi số (ví dụ: "100000")
                const totalNumber = String(receipt.totalAmount || 0);

                // Kiểm tra xem query có phải là số tiền (ví dụ: "100000" hoặc "100k")
                const priceMatch = totalVND.includes(query) || totalNumber.includes(query);

                return idMatch || priceMatch;
            });

            if (filtered.length === 0) {
                listElement.innerHTML = `<p class="text-center text-gray-500 mt-8 p-4 bg-white rounded-xl">Không tìm thấy hóa đơn nào khớp với từ khóa "${query}".</p>`;
            } else {
                renderReceiptsList(filtered, true); // true để không cập nhật masterReceipts
            }
        };


        // --- Database Update Function ---
        const setTotalAmountToZero = async (invoiceId) => {
            if (!db || !invoiceId) {
                showCustomMessage('error', 'Lỗi: Không thể kết nối DB hoặc thiếu ID hóa đơn.');
                return;
            }

            try {
                const receiptRef = ref(db, `payment_history/${invoiceId}`);
                
                await update(receiptRef, {
                    totalAmount: 0
                });
                
                showCustomMessage('success', `Hóa đơn ${invoiceId.substring(0, 5)}... đã được cập nhật thành công về 0₫!`);
                
                setTimeout(() => modalOverlay.classList.add('hidden'), 1000); 

            } catch (error) {
                console.error("Lỗi khi cập nhật DB:", error);
                showCustomMessage('error', 'Lỗi khi cập nhật DB: ' + error.message);
            }
        };


        // --- Renderer Functions ---
        // Thêm tham số isFiltered để tránh cập nhật masterReceipts khi đang lọc
        const renderReceiptsList = (receipts, isFiltered = false) => {
            listElement.innerHTML = '';
            loadingElement.classList.add('hidden');
            
            if (!isFiltered) {
                 masterReceipts = receipts; // Chỉ cập nhật master data khi load từ Firebase
            }
            
            if (receipts.length === 0) {
                // Chỉ hiển thị thông báo không có dữ liệu nếu không có kết quả lọc
                if (!isFiltered) { 
                    noDataMessage.textContent = 'Không tìm thấy dữ liệu hóa đơn nào trong "payment_history".';
                    noDataMessage.classList.remove('hidden');
                }
                return;
            }

            noDataMessage.classList.add('hidden');

            receipts.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));

            receipts.forEach((receipt) => {
                const card = document.createElement('div');
                card.id = `receipt-${receipt.invoiceId}`;
                card.className = 'bg-white p-4 rounded-xl shadow-lg cursor-pointer transition duration-200 ease-in-out hover:bg-gray-50 active:bg-gray-100';
                card.onclick = () => renderReceiptDetail(receipt);

                card.innerHTML = `
                    <div class="flex justify-between items-center mb-1">
                        <p class="text-xs font-medium text-indigo-500">Mã HĐ: ${receipt.invoiceId.substring(0, 10)}...</p>
                        <p class="text-sm font-bold ${receipt.totalAmount === 0 ? 'text-green-500' : 'text-red-600'}">${formatVND(receipt.totalAmount || 0)}</p>
                    </div>
                    <div class="flex justify-between items-end">
                        <p class="text-sm text-gray-700">${receipt.paymentMethod || 'Không rõ'}</p>
                        <p class="text-xs text-gray-500">${formatTimestamp(receipt.timestamp)}</p>
                    </div>
                `;
                listElement.appendChild(card);
            });
        };

        const renderReceiptDetail = (receipt) => {
            currentInvoiceId = receipt.invoiceId; 

            document.getElementById('invoice-id').textContent = receipt.invoiceId;
            document.getElementById('invoice-date').textContent = formatTimestamp(receipt.timestamp);
            document.getElementById('payment-method').textContent = receipt.paymentMethod || 'Không rõ';
            document.getElementById('total-amount').textContent = formatVND(receipt.totalAmount || 0);

            // Cập nhật trạng thái nút nếu tổng tiền đã bằng 0
            if (receipt.totalAmount === 0) {
                setToZeroButton.textContent = "ĐÃ VỀ 0 ĐỒNG";
                setToZeroButton.disabled = true;
                setToZeroButton.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
                setToZeroButton.classList.add('bg-green-500', 'cursor-not-allowed');
            } else {
                setToZeroButton.textContent = "VỀ 0 ĐỒNG";
                setToZeroButton.disabled = false;
                setToZeroButton.classList.remove('bg-green-500', 'cursor-not-allowed');
                setToZeroButton.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
            }

            itemsListElement.innerHTML = '';
            
            if (receipt.items) {
                const rawItems = receipt.items;
                const itemsArray = Array.isArray(rawItems) 
                    ? rawItems.filter(item => item) 
                    : Object.keys(rawItems).map(key => rawItems[key]).filter(item => item);

                if (itemsArray.length > 0) {
                    itemsArray.forEach(item => {
                        const itemTotal = (item.price || 0) * (item.quantity || 1);

                        const itemElement = document.createElement('div');
                        itemElement.className = 'flex justify-between items-start text-sm border-b border-gray-100 py-2 last:border-b-0';
                        
                        const itemNameAndQuantity = document.createElement('p');
                        itemNameAndQuantity.className = 'text-gray-700 pr-2 flex-1';
                        itemNameAndQuantity.innerHTML = `<span class="font-semibold">${item.name || 'Sản phẩm'}</span> <span class="text-indigo-500 font-bold">x ${item.quantity || 1}</span>`;

                        const itemPrice = document.createElement('p');
                        itemPrice.className = 'text-gray-800 font-medium whitespace-nowrap';
                        itemPrice.textContent = formatVND(itemTotal);

                        itemElement.appendChild(itemNameAndQuantity);
                        itemElement.appendChild(itemPrice);
                        itemsListElement.appendChild(itemElement);
                    });
                } else {
                    itemsListElement.innerHTML = '<p class="text-center text-gray-500 italic text-sm">Không có chi tiết mặt hàng.</p>';
                }
            } else {
                itemsListElement.innerHTML = '<p class="text-center text-gray-500 italic text-sm">Không có chi tiết mặt hàng.</p>';
            }
            
            modalOverlay.classList.remove('hidden');
        };

        // --- Main Firebase Logic ---

        const fetchData = () => {
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getDatabase(app);
                
                const authenticate = async () => {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }
                };

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        const dbRef = ref(db, 'payment_history');
                        
                        // onValue sẽ tự động chạy lại khi dữ liệu thay đổi
                        onValue(dbRef, (snapshot) => {
                            const data = snapshot.val();

                            let receipts = [];
                            if (data) {
                                receipts = Object.keys(data).map(key => ({
                                    ...data[key],
                                    invoiceId: key 
                                }));
                            }

                            // Cập nhật master data và lọc/render lại
                            masterReceipts = receipts; 
                            filterReceipts(); // Sử dụng hàm lọc để hiển thị

                            // Nếu modal đang mở, cập nhật chi tiết hóa đơn đang xem
                            if (!modalOverlay.classList.contains('hidden') && currentInvoiceId) {
                                const updatedReceipt = masterReceipts.find(r => r.invoiceId === currentInvoiceId);
                                if (updatedReceipt) {
                                    renderReceiptDetail(updatedReceipt);
                                } else {
                                     // Nếu hóa đơn bị xóa (dù không có chức năng xóa ở đây), đóng modal
                                    modalOverlay.classList.add('hidden'); 
                                }
                            }

                        }, (err) => {
                            console.error("Firebase DB Error:", err);
                            loadingElement.classList.add('hidden');
                            errorDetails.textContent = `Lỗi truy cập DB: ${err.message}`;
                            errorElement.classList.remove('hidden');
                        });
                        
                    } else {
                        await authenticate();
                    }
                });

                authenticate().catch(e => {
                    console.error("Authentication failed:", e);
                    loadingElement.classList.add('hidden');
                    errorDetails.textContent = `Lỗi xác thực: ${e.message}`;
                    errorElement.classList.remove('hidden');
                });

            } catch (e) {
                console.error("Initialization Error:", e);
                loadingElement.classList.add('hidden');
                errorDetails.textContent = `Lỗi khởi tạo Firebase: ${e.message}`;
                errorElement.classList.remove('hidden');
            }
        };

        // --- Event Listeners and Initialization ---

        // Lắng nghe sự kiện input trên ô tìm kiếm để lọc tức thì
        searchInput.addEventListener('input', filterReceipts);

        // Xử lý sự kiện click nút "VỀ 0 ĐỒNG"
        setToZeroButton.onclick = () => {
            if (currentInvoiceId) {
                // Ta bỏ qua bước xác nhận (window.confirm) và thực hiện ngay
                setTotalAmountToZero(currentInvoiceId);
            } else {
                showCustomMessage('error', 'Không tìm thấy ID hóa đơn để cập nhật.');
            }
        };

        // Close modal when close button is clicked
        closeModalButton.onclick = () => modalOverlay.classList.add('hidden');

        // Close modal when clicking outside the modal card
        modalOverlay.onclick = (event) => {
            if (event.target === modalOverlay) {
                modalOverlay.classList.add('hidden');
            }
        };

        window.onload = function() {
            if (!firebaseConfig.databaseURL) {
                loadingElement.classList.add('hidden');
                errorDetails.textContent = 'Lỗi cấu hình: databaseURL không được tìm thấy. Vui lòng kiểm tra lại cấu hình Firebase.';
                errorElement.classList.remove('hidden');
            } else {
                fetchData();
            }
        };

    </script>
</body>
</html>

