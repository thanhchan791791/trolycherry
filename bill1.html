<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Danh S√°ch H√≥a ƒê∆°n & T√¨m ki·∫øm - RTDB</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'ios-background': '#F8F9FB', // N·ªÅn s√°ng iOS
                        'ios-dark-background': '#1C1C1E', // N·ªÅn t·ªëi iOS
                        'ios-card': 'rgba(255, 255, 255, 0.65)',
                        'ios-dark-card': 'rgba(40, 40, 42, 0.65)',
                        'ios-accent': '#007AFF', // Xanh iOS
                        'ios-text': '#1C1C1E',
                        'ios-dark-text': '#F2F2F7',
                        'ios-orange': '#FF9500', // M√†u cam m·ªõi cho n√∫t gi·∫£m gi√°
                        'ios-purple': '#AF52DE', // M√†u t√≠m m·ªõi cho n√∫t set custom
                    },
                    borderRadius: {
                        '4xl': '2rem',
                    },
                    boxShadow: {
                        'ios-soft': '0 4px 12px rgba(0, 0, 0, 0.08), 0 1px 3px rgba(0, 0, 0, 0.04)',
                        'ios-dark-soft': '0 4px 12px rgba(0, 0, 0, 0.4), 0 1px 3px rgba(0, 0, 0, 0.2)',
                        'ios-modal': '0 -20px 50px rgba(0, 0, 0, 0.1)',
                        'ios-dark-modal': '0 -20px 50px rgba(0, 0, 0, 0.6)',
                    },
                }
            }
        }
    </script>

    <style>
        /* SF Pro Display Font Fallback (Similar to iOS) */
        @font-face {
            font-family: 'SF Pro Display';
            font-weight: 100 900;
            src: local('Helvetica Neue'); /* Fallback on Mac/iOS */
        }
        
        /* Transition chung cho t·∫•t c·∫£, ƒë·∫£m b·∫£o animation m∆∞·ª£t */
        * {
            transition: all 0.35s cubic-bezier(0.25, 0.1, 0.25, 1); /* Ease-in-out m∆∞·ª£t */
        }

        body {
            font-family: 'SF Pro Display', 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", sans-serif;
            background-color: theme('colors.ios-background');
            color: theme('colors.ios-text');
            min-height: 100vh;
        }

        /* iOS Glassmorphism Card */
        .ios-card {
            background-color: theme('colors.ios-card');
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px); /* For Safari */
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: theme('boxShadow.ios-soft');
            transform: translateZ(0); /* K√≠ch ho·∫°t GPU acceleration */
        }

        /* iOS Modern Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.3); /* N·ªÅn t·ªëi nh·∫π */
            display: flex;
            justify-content: center;
            align-items: flex-end;
            z-index: 1000;
            opacity: 0;
            pointer-events: none; /* V√¥ hi·ªáu h√≥a t∆∞∆°ng t√°c khi ·∫©n */
            transition: opacity 0.3s ease-in-out;
        }
        .modal-overlay.show {
            opacity: 1;
            pointer-events: auto;
        }
        .modal-card {
            width: 100%;
            max-width: 500px;
            background-color: theme('colors.ios-card');
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            border-top-left-radius: 2rem;
            border-top-right-radius: 2rem;
            box-shadow: theme('boxShadow.ios-modal');
            padding: 1.5rem;
            max-height: 90vh; /* TƒÉng ƒë·ªô cao cho ph√©p cu·ªôn */
            overflow-y: auto;
            transform: translateY(100%);
            transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1); /* iOS bounce/slide up */
        }
        .modal-overlay.show .modal-card {
            transform: translateY(0);
        }

        /* Input Field Style */
        .ios-input {
            background-color: rgba(255, 255, 255, 0.8);
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 0.75rem; /* Corner radius nh·ªè h∆°n card */
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.05);
        }
        .ios-input:focus {
            outline: none;
            box-shadow: 0 0 0 4px rgba(0, 122, 255, 0.2); /* Focus ring iOS */
            border-color: theme('colors.ios-accent');
        }
        /* Ch·ªâ cho ph√©p hi·ªÉn th·ªã c√°c n√∫t ƒëi·ªÅu ch·ªânh s·ªë (spinners) cho input type="number" */
        .ios-input[type='number']::-webkit-outer-spin-button,
        .ios-input[type='number']::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        .ios-input[type='number'] {
            -moz-appearance: textfield; /* Firefox */
        }


        /* Custom scrollbar for better mobile feel */
        .receipt-container { -ms-overflow-style: none; scrollbar-width: none; }
        .receipt-container::-webkit-scrollbar { display: none; }

        /* --- Dark Mode Styles --- */
        @media (prefers-color-scheme: dark) {
            body {
                background-color: theme('colors.ios-dark-background');
                color: theme('colors.ios-dark-text');
            }
            .ios-card {
                background-color: theme('colors.ios-dark-card');
                border: 1px solid rgba(255, 255, 255, 0.1);
                box-shadow: theme('boxShadow.ios-dark-soft');
            }
            .modal-card {
                background-color: theme('colors.ios-dark-card');
                box-shadow: theme('boxShadow.ios-dark-modal');
            }
            .ios-input {
                background-color: rgba(60, 60, 67, 0.6);
                border: 1px solid rgba(255, 255, 255, 0.2);
                color: theme('colors.ios-dark-text');
            }
            .ios-input::placeholder {
                color: rgba(255, 255, 255, 0.5);
            }
            .ios-input:focus {
                box-shadow: 0 0 0 4px rgba(10, 132, 255, 0.4);
            }
        }
    </style>
</head>
<body class="p-4 flex flex-col items-center">

    <div id="notification-box" class="rounded-xl shadow-xl p-3 text-sm font-semibold text-white transition duration-300 hidden fixed top-4 left-1/2 -translate-x-1/2 z-[2000] min-w-[280px] max-w-[90vw] text-center backdrop-blur-md">
        <p id="notification-message"></p>
    </div>

    <div class="w-full max-w-lg">
        <header class="mb-6 pt-4">
            <h1 class="text-4xl font-bold text-ios-text dark:text-ios-dark-text tracking-tight">H√≥a ƒë∆°n</h1>
        </header>

        <div class="mb-6">
            <input type="text" id="search-input" placeholder="T√¨m ki·∫øm theo M√£ Hƒê ho·∫∑c T·ªïng ti·ªÅn..." 
                   class="w-full px-4 py-3 border-transparent rounded-xl focus:outline-none shadow-sm transition duration-150 ios-input"
            >
        </div>
        
        <div id="loading" class="text-center p-8 ios-card rounded-4xl">
            <svg class="animate-spin h-8 w-8 text-ios-accent mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="mt-3 text-sm text-gray-600 dark:text-gray-400">ƒêang t·∫£i danh s√°ch h√≥a ƒë∆°n...</p>
        </div>

        <div id="error-message" class="hidden bg-red-500/10 border border-red-500 text-red-700 dark:text-red-400 px-4 py-3 rounded-xl relative mb-4 ios-card" role="alert">
            <strong class="font-bold">L·ªói!</strong>
            <span class="block sm:inline" id="error-details"></span>
        </div>

        <div id="receipts-list" class="space-y-4 receipt-container max-h-[70vh] overflow-y-auto">
            </div>

        <p id="no-data-message" class="hidden text-center text-gray-500 mt-8 p-4 ios-card rounded-4xl">Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu h√≥a ƒë∆°n n√†o trong "payment_history".</p>
    </div>

    <div id="receipt-modal-overlay" class="modal-overlay">
        <div id="receipt-modal" class="modal-card">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-ios-text dark:text-ios-dark-text">Chi ti·∫øt H√≥a ƒë∆°n</h2>
                <button id="close-modal" class="text-gray-400 hover:text-ios-accent dark:hover:text-ios-accent p-2 -mr-2 rounded-full active:scale-90 transition duration-150">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>

            <div class="space-y-4 mb-6 pb-4 border-b border-gray-200 dark:border-gray-700">
                <p class="text-base flex justify-between">
                    <span class="text-gray-600 dark:text-gray-400 font-medium">M√£ Hƒê:</span> 
                    <span id="invoice-id" class="font-semibold text-ios-text dark:text-ios-dark-text break-all text-right"></span>
                </p>
                <p class="text-base flex justify-between">
                    <span class="text-gray-600 dark:text-gray-400 font-medium">Ng√†y:</span> 
                    <span id="invoice-date" class="font-semibold text-red-500 dark:text-red-400 text-right"></span>
                </p>
                <p class="text-base flex justify-between">
                    <span class="text-gray-600 dark:text-gray-400 font-medium">H√¨nh th·ª©c:</span> 
                    <span id="payment-method" class="font-semibold text-ios-text dark:text-ios-dark-text text-right"></span>
                </p>
            </div>

            <div class="flex justify-between items-center mb-6 pt-4 border-t border-dashed border-gray-300 dark:border-gray-600">
                <p class="text-lg font-bold text-gray-700 dark:text-gray-300">T·ªïng ti·ªÅn:</p>
                <p id="total-amount" class="text-2xl font-extrabold text-red-600 dark:text-red-400">‚Ç´</p>
            </div>

            <div id="custom-set-section" class="mb-6 p-4 bg-gray-50/50 dark:bg-white/5 rounded-xl border border-gray-200 dark:border-gray-700">
                <h3 class="font-bold text-lg text-ios-text dark:text-ios-dark-text mb-3">üí∞ ƒê·∫∑t l·∫°i T·ªïng ti·ªÅn (Custom)</h3>
                <div class="flex space-x-2">
                    <input type="text" id="custom-amount-input" placeholder="Nh·∫≠p s·ªë ti·ªÅn mong mu·ªën" 
                        class="w-2/3 px-3 py-3 border-transparent rounded-xl focus:outline-none shadow-sm transition duration-150 ios-input text-right font-semibold"
                    >
                    <button id="set-custom-amount-btn" class="flex-1 bg-ios-purple text-white font-bold py-3 rounded-full shadow-lg hover:bg-purple-600 active:scale-[0.97] transition duration-150 active:shadow-none disabled:bg-gray-400 disabled:cursor-not-allowed">
                        C·∫¨P NH·∫¨T BILL
                    </button>
                </div>
            </div>
            <div id="discount-section" class="mb-6 p-4 bg-gray-50/50 dark:bg-white/5 rounded-xl border border-gray-200 dark:border-gray-700">
                <h3 class="font-bold text-lg text-ios-text dark:text-ios-dark-text mb-3">üõ† C√¥ng c·ª• gi·∫£m gi√°</h3>
                <div class="flex space-x-2">
                    <input type="number" id="discount-percent-input" placeholder="% Gi·∫£m" min="0" max="100" 
                        class="w-1/3 px-3 py-3 border-transparent rounded-xl focus:outline-none shadow-sm transition duration-150 ios-input text-center"
                        value="10"
                    >
                    <button id="apply-discount-btn" class="flex-1 bg-ios-orange text-white font-bold py-3 rounded-full shadow-lg hover:bg-orange-600 active:scale-[0.97] transition duration-150 active:shadow-none disabled:bg-gray-400 disabled:cursor-not-allowed">
                        √ÅP D·ª§NG GI·∫¢M GI√Å
                    </button>
                </div>
            </div>
            
            <h3 class="font-bold text-lg text-ios-text dark:text-ios-dark-text mb-4">C√°c m√≥n ƒë√£ mua:</h3>
            <div id="items-list" class="space-y-2 mb-8 p-3 bg-gray-50/50 dark:bg-white/5 rounded-xl">
                </div>

            <button id="set-to-zero-btn" class="w-full bg-ios-accent text-white font-bold text-lg py-4 rounded-full shadow-lg hover:bg-blue-600 active:scale-[0.97] transition duration-150 active:shadow-none disabled:bg-gray-400 disabled:cursor-not-allowed">
                V·ªÄ 0 ƒê·ªíNG
            </button>
            
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getDatabase, ref, onValue, update } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // setLogLevel('Debug');
        
        // C·∫•u h√¨nh Firebase g·ªëc t·ª´ y√™u c·∫ßu c·ªßa ng∆∞·ªùi d√πng
        const providedConfig = {
            apiKey: "AIzaSyB8uLkLJFlzmCodcawJhs2dRckHQzO5y10",
            authDomain: "chitieu-7263e.firebaseapp.com",
            databaseURL: "https://chitieu-7263e-default-rtdb.firebaseio.com", 
            projectId: "chitieu-7263e",
            storageBucket: "chitieu-7263e.firebasestorage.app",
            messagingSenderId: "83833140682",
            appId: "1:83833140682:web:f9254b418ace3a659fcb33",
            measurementId: "G-523X74K18N"
        };
        
        let firebaseConfig = providedConfig;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        if (typeof __firebase_config !== 'undefined') {
            try {
                const globalConfig = JSON.parse(__firebase_config);
                firebaseConfig = { ...providedConfig, ...globalConfig };
            } catch (e) {
                console.warn("L·ªói khi parse __firebase_config, s·ª≠ d·ª•ng providedConfig.", e);
            }
        }
        
        let app, auth, db;
        // L∆∞u tr·ªØ to√†n b·ªô d·ªØ li·ªáu g·ªëc ƒë√£ t·∫£i v·ªÅ t·ª´ Firebase
        let masterReceipts = []; 
        let currentInvoiceId = null; 
        let currentBaseTotalAmount = 0; // L∆∞u tr·ªØ totalAmount g·ªëc (ch∆∞a gi·∫£m gi√°, ch∆∞a v·ªÅ 0)

        const loadingElement = document.getElementById('loading');
        const errorElement = document.getElementById('error-message');
        const errorDetails = document.getElementById('error-details');
        const listElement = document.getElementById('receipts-list');
        const modalOverlay = document.getElementById('receipt-modal-overlay');
        const noDataMessage = document.getElementById('no-data-message');
        const itemsListElement = document.getElementById('items-list');
        const closeModalButton = document.getElementById('close-modal');
        const setToZeroButton = document.getElementById('set-to-zero-btn');
        const searchInput = document.getElementById('search-input');
        const notificationBox = document.getElementById('notification-box');
        const notificationMessage = document.getElementById('notification-message');
        
        // C√°c ph·∫ßn t·ª≠ m·ªõi
        const applyDiscountButton = document.getElementById('apply-discount-btn');
        const discountPercentInput = document.getElementById('discount-percent-input');
        
        // C√ÅC PH·∫¶N T·ª¨ M·ªöI TH√äM V√ÄO
        const customAmountInput = document.getElementById('custom-amount-input');
        const setCustomAmountButton = document.getElementById('set-custom-amount-btn');
        // K·∫æT TH√öC C√ÅC PH·∫¶N T·ª¨ M·ªöI TH√äM V√ÄO

        // --- Custom Notification Function ---
        const showCustomMessage = (type, message) => {
            notificationMessage.textContent = message;
            notificationBox.classList.remove('hidden', 'bg-green-600', 'bg-red-600', 'bg-blue-600');
            
            if (type === 'success') {
                notificationBox.classList.add('bg-green-600');
            } else if (type === 'error') {
                notificationBox.classList.add('bg-red-600');
            } else if (type === 'info') {
                notificationBox.classList.add('bg-blue-600');
            }

            // Show and hide animation
            setTimeout(() => notificationBox.classList.add('show'), 10);
            setTimeout(() => notificationBox.classList.remove('show'), 3000);
            setTimeout(() => notificationBox.classList.add('hidden'), 3500);
        };

        // --- Helper Functions ---
        const formatVND = (amount) => {
            if (typeof amount !== 'number' || isNaN(amount)) return '0‚Ç´';
            return amount.toLocaleString('vi-VN', { 
                style: 'currency', 
                currency: 'VND', 
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            });
        };
        
        // H√†m ƒë·ªãnh d·∫°ng s·ªë ti·ªÅn c√≥ d·∫•u ch·∫•m ngƒÉn c√°ch 000
        const formatNumber = (num) => {
            return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
        };

        // H√†m chuy·ªÉn chu·ªói c√≥ d·∫•u ch·∫•m th√†nh s·ªë nguy√™n
        const parseNumber = (str) => {
            // Lo·∫°i b·ªè t·∫•t c·∫£ c√°c k√Ω t·ª± kh√¥ng ph·∫£i s·ªë
            return parseInt(str.replace(/[^0-9]/g, ''), 10) || 0;
        };


        const formatTimestamp = (timestamp) => {
            if (!timestamp) return 'Kh√¥ng r√µ';
            const ms = String(timestamp).length === 10 ? timestamp * 1000 : timestamp;
            const date = new Date(ms);
            if (isNaN(date.getTime())) return 'Ng√†y kh√¥ng h·ª£p l·ªá';

            const time = date.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            const day = date.toLocaleDateString('vi-VN');
            return `${time} ${day}`;
        };
        
        // --- Search/Filter Function ---
        const filterReceipts = () => {
            const query = searchInput.value.toLowerCase().trim();
            
            if (!query) {
                renderReceiptsList(masterReceipts);
                return;
            }

            const filtered = masterReceipts.filter(receipt => {
                const idMatch = receipt.invoiceId && receipt.invoiceId.toLowerCase().includes(query);
                
                // L·∫•y t·ªïng ti·ªÅn hi·ªÉn th·ªã (ƒë√£ qua gi·∫£m gi√°/v·ªÅ 0)
                const displayAmount = receipt.finalTotal !== undefined ? receipt.finalTotal : (receipt.totalAmount || 0);
                
                const totalVND = formatVND(displayAmount).toLowerCase().replace(/\./g, '');
                const totalNumber = String(displayAmount);

                const priceMatch = totalVND.includes(query) || totalNumber.includes(query);

                return idMatch || priceMatch;
            });

            if (filtered.length === 0) {
                listElement.innerHTML = `<p class="text-center text-gray-500 mt-8 p-4 ios-card rounded-4xl">Kh√¥ng t√¨m th·∫•y h√≥a ƒë∆°n n√†o kh·ªõp v·ªõi t·ª´ kh√≥a "${query}".</p>`;
            } else {
                renderReceiptsList(filtered, true);
            }
        };


        // --- Database Update Function (C·∫≠p nh·∫≠t totalAmount v√† finalTotal) ---
        const updateReceiptTotal = async (invoiceId, newTotalAmount) => {
            if (!db || !invoiceId) {
                showCustomMessage('error', 'L·ªói: Kh√¥ng th·ªÉ k·∫øt n·ªëi DB ho·∫∑c thi·∫øu ID h√≥a ƒë∆°n.');
                return;
            }
            
            // ƒê·∫£m b·∫£o l√† s·ªë nguy√™n v√† kh√¥ng √¢m
            const amountToUpdate = Math.max(0, Math.round(newTotalAmount));

            try {
                const receiptRef = ref(db, `payment_history/${invoiceId}`);
                
                await update(receiptRef, {
                    totalAmount: amountToUpdate,
                    finalTotal: amountToUpdate 
                });
                
                showCustomMessage('success', `H√≥a ƒë∆°n ${invoiceId.substring(0, 5)}... ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t th√†nh ${formatVND(amountToUpdate)}!`);
                
                // Sau khi c·∫≠p nh·∫≠t, ·∫©n modal ƒë·ªÉ tr√°nh xung ƒë·ªôt d·ªØ li·ªáu
                setTimeout(() => modalOverlay.classList.remove('show'), 1000); 

            } catch (error) {
                console.error("L·ªói khi c·∫≠p nh·∫≠t DB:", error);
                showCustomMessage('error', 'L·ªói khi c·∫≠p nh·∫≠t DB: ' + error.message);
            }
        };
        
        // --- H√†m x·ª≠ l√Ω Gi·∫£m gi√° ---
        const applyDiscount = () => {
            if (!currentInvoiceId || currentBaseTotalAmount === null) {
                showCustomMessage('error', 'L·ªói: Kh√¥ng t√¨m th·∫•y h√≥a ƒë∆°n g·ªëc.');
                return;
            }
            
            const discountPercent = parseFloat(discountPercentInput.value);

            if (isNaN(discountPercent) || discountPercent < 0 || discountPercent > 100) {
                showCustomMessage('error', 'Vui l√≤ng nh·∫≠p ph·∫ßn trƒÉm gi·∫£m gi√° h·ª£p l·ªá (0-100).');
                return;
            }
            
            // T√≠nh to√°n s·ªë ti·ªÅn m·ªõi
            const discountFactor = 1 - (discountPercent / 100);
            const newTotal = currentBaseTotalAmount * discountFactor;

            // G·ªçi h√†m c·∫≠p nh·∫≠t chung
            updateReceiptTotal(currentInvoiceId, newTotal);
        };
        
        // --- H√†m x·ª≠ l√Ω ƒê·∫∑t l·∫°i t·ªïng ti·ªÅn theo gi√° tr·ªã nh·∫≠p (M·ªöI) ---
        const setCustomAmount = () => {
            if (!currentInvoiceId) {
                showCustomMessage('error', 'L·ªói: Kh√¥ng t√¨m th·∫•y ID h√≥a ƒë∆°n.');
                return;
            }

            const amountString = customAmountInput.value;
            const newAmount = parseNumber(amountString); // Chuy·ªÉn chu·ªói c√≥ d·∫•u ch·∫•m th√†nh s·ªë nguy√™n

            if (isNaN(newAmount) || newAmount < 0) {
                 showCustomMessage('error', 'Vui l√≤ng nh·∫≠p s·ªë ti·ªÅn h·ª£p l·ªá.');
                return;
            }

            // G·ªçi h√†m c·∫≠p nh·∫≠t chung
            updateReceiptTotal(currentInvoiceId, newAmount);
        };
        // K·∫æT TH√öC H√ÄM M·ªöI

        // --- Renderer Functions ---
        const renderReceiptsList = (receipts, isFiltered = false) => {
            listElement.innerHTML = '';
            loadingElement.classList.add('hidden');
            
            if (!isFiltered) {
                 masterReceipts = receipts; 
            }
            
            if (receipts.length === 0 && !isFiltered) { 
                noDataMessage.textContent = 'Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu h√≥a ƒë∆°n n√†o trong "payment_history".';
                noDataMessage.classList.remove('hidden');
                return;
            } else if (receipts.length === 0 && isFiltered) {
                // ƒê√£ x·ª≠ l√Ω ·ªü h√†m filterReceipts
                return;
            }

            noDataMessage.classList.add('hidden');

            receipts.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));

            receipts.forEach((receipt) => {
                const card = document.createElement('div');
                card.id = `receipt-${receipt.invoiceId}`;
                card.className = 'ios-card p-4 rounded-4xl shadow-lg cursor-pointer active:scale-[0.97] transition duration-200 ease-in-out hover:bg-white/70 dark:hover:bg-gray-800/70';
                card.onclick = () => renderReceiptDetail(receipt);

                // L·∫•y t·ªïng ti·ªÅn, ∆∞u ti√™n finalTotal n·∫øu c√≥, n·∫øu kh√¥ng th√¨ d√πng totalAmount
                const displayAmount = receipt.finalTotal !== undefined ? receipt.finalTotal : (receipt.totalAmount || 0);

                card.innerHTML = `
                    <div class="flex justify-between items-center mb-1">
                        <p class="text-xs font-medium text-ios-accent">M√£ Hƒê: ${receipt.invoiceId.substring(0, 10)}...</p>
                        <p class="text-lg font-extrabold ${displayAmount === 0 ? 'text-green-500' : 'text-red-600 dark:text-red-400'}">${formatVND(displayAmount)}</p>
                    </div>
                    <div class="flex justify-between items-end mt-1">
                        <p class="text-sm text-gray-700 dark:text-gray-300">${receipt.paymentMethod || 'Kh√¥ng r√µ'}</p>
                        <p class="text-xs text-gray-500 dark:text-gray-400">${formatTimestamp(receipt.timestamp)}</p>
                    </div>
                `;
                listElement.appendChild(card);
            });
        };

        const renderReceiptDetail = (receipt) => {
            currentInvoiceId = receipt.invoiceId; 
            // L∆∞u tr·ªØ totalAmount g·ªëc l√†m m·ªëc ƒë·ªÉ t√≠nh to√°n gi·∫£m gi√°
            currentBaseTotalAmount = receipt.totalAmount || 0; 
            
            // L·∫•y t·ªïng ti·ªÅn ƒë·ªÉ hi·ªÉn th·ªã, ∆∞u ti√™n finalTotal n·∫øu c√≥
            const displayAmount = receipt.finalTotal !== undefined ? receipt.finalTotal : (receipt.totalAmount || 0);

            document.getElementById('invoice-id').textContent = receipt.invoiceId;
            document.getElementById('invoice-date').textContent = formatTimestamp(receipt.timestamp);
            document.getElementById('payment-method').textContent = receipt.paymentMethod || 'Kh√¥ng r√µ';
            document.getElementById('total-amount').textContent = formatVND(displayAmount); 

            // C·∫≠p nh·∫≠t tr·∫°ng th√°i n√∫t n·∫øu t·ªïng ti·ªÅn ƒë√£ b·∫±ng 0
            if (displayAmount === 0) {
                setToZeroButton.textContent = "ƒê√É V·ªÄ 0 ƒê·ªíNG";
                setToZeroButton.disabled = true;
                setToZeroButton.classList.remove('bg-ios-accent', 'hover:bg-blue-600');
                setToZeroButton.classList.add('bg-green-500', 'cursor-not-allowed');
                applyDiscountButton.disabled = true;
                setCustomAmountButton.disabled = true; // V√¥ hi·ªáu h√≥a n√∫t set custom
            } else {
                setToZeroButton.textContent = "V·ªÄ 0 ƒê·ªíNG";
                setToZeroButton.disabled = false;
                setToZeroButton.classList.remove('bg-green-500', 'cursor-not-allowed');
                setToZeroButton.classList.add('bg-ios-accent', 'hover:bg-blue-600');
                applyDiscountButton.disabled = false;
                setCustomAmountButton.disabled = false; // K√≠ch ho·∫°t n√∫t set custom
            }
            
            // Reset input gi·∫£m gi√° v·ªÅ gi√° tr·ªã m·∫∑c ƒë·ªãnh 10% m·ªói l·∫ßn m·ªü modal
            discountPercentInput.value = '10';
            
            // C·∫≠p nh·∫≠t gi√° tr·ªã hi·ªÉn th·ªã cho input custom amount
            customAmountInput.value = formatNumber(displayAmount);

            itemsListElement.innerHTML = '';
            
            if (receipt.items) {
                const rawItems = receipt.items;
                const itemsArray = Array.isArray(rawItems) 
                    ? rawItems.filter(item => item) 
                    : Object.keys(rawItems).map(key => rawItems[key]).filter(item => item);

                if (itemsArray.length > 0) {
                    itemsArray.forEach(item => {
                        const itemTotal = (item.price || 0) * (item.quantity || 1);

                        const itemElement = document.createElement('div');
                        itemElement.className = 'flex justify-between items-start text-sm border-b border-gray-200 dark:border-gray-700 py-2 last:border-b-0';
                        
                        const itemNameAndQuantity = document.createElement('p');
                        itemNameAndQuantity.className = 'text-gray-700 dark:text-gray-300 pr-2 flex-1';
                        itemNameAndQuantity.innerHTML = `<span class="font-semibold">${item.name || 'S·∫£n ph·∫©m'}</span> <span class="text-ios-accent font-bold">x ${item.quantity || 1}</span>`;

                        const itemPrice = document.createElement('p');
                        itemPrice.className = 'text-gray-800 dark:text-ios-dark-text font-medium whitespace-nowrap';
                        itemPrice.textContent = formatVND(itemTotal);

                        itemElement.appendChild(itemNameAndQuantity);
                        itemElement.appendChild(itemPrice);
                        itemsListElement.appendChild(itemElement);
                    });
                } else {
                    itemsListElement.innerHTML = '<p class="text-center text-gray-500 dark:text-gray-400 italic text-sm py-2">Kh√¥ng c√≥ chi ti·∫øt m·∫∑t h√†ng.</p>';
                }
            } else {
                itemsListElement.innerHTML = '<p class="text-center text-gray-500 dark:text-gray-400 italic text-sm py-2">Kh√¥ng c√≥ chi ti·∫øt m·∫∑t h√†ng.</p>';
            }
            
            modalOverlay.classList.add('show');
        };

        // --- Main Firebase Logic ---

        const fetchData = () => {
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getDatabase(app);
                
                const authenticate = async () => {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }
                };

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        const dbRef = ref(db, 'payment_history');
                        
                        onValue(dbRef, (snapshot) => {
                            const data = snapshot.val();

                            let receipts = [];
                            if (data) {
                                receipts = Object.keys(data).map(key => ({
                                    ...data[key],
                                    invoiceId: key 
                                }));
                            }

                            masterReceipts = receipts; 
                            filterReceipts(); 

                            // N·∫øu modal ƒëang m·ªü, c·∫≠p nh·∫≠t chi ti·∫øt h√≥a ƒë∆°n ƒëang xem
                            if (modalOverlay.classList.contains('show') && currentInvoiceId) {
                                const updatedReceipt = masterReceipts.find(r => r.invoiceId === currentInvoiceId);
                                if (updatedReceipt) {
                                    renderReceiptDetail(updatedReceipt); 
                                } else {
                                    modalOverlay.classList.remove('show'); 
                                }
                            }

                        }, (err) => {
                            console.error("Firebase DB Error:", err);
                            loadingElement.classList.add('hidden');
                            errorDetails.textContent = `L·ªói truy c·∫≠p DB: ${err.message}`;
                            errorElement.classList.remove('hidden');
                        });
                        
                    } else {
                        await authenticate();
                    }
                });

                authenticate().catch(e => {
                    console.error("Authentication failed:", e);
                    loadingElement.classList.add('hidden');
                    errorDetails.textContent = `L·ªói x√°c th·ª±c: ${e.message}`;
                    errorElement.classList.remove('hidden');
                });

            } catch (e) {
                console.error("Initialization Error:", e);
                loadingElement.classList.add('hidden');
                errorDetails.textContent = `L·ªói kh·ªüi t·∫°o Firebase: ${e.message}`;
                errorElement.classList.remove('hidden');
            }
        };

        // --- Event Listeners and Initialization ---

        searchInput.addEventListener('input', filterReceipts);

        // X·ª≠ l√Ω s·ª± ki·ªán Gi·∫£m gi√°
        applyDiscountButton.onclick = applyDiscount;
        
        // X·ª≠ l√Ω s·ª± ki·ªán Set Custom Amount (M·ªöI)
        setCustomAmountButton.onclick = setCustomAmount;
        
        // X·ª≠ l√Ω ƒë·ªãnh d·∫°ng khi ng∆∞·ªùi d√πng nh·∫≠p v√†o input custom amount (M·ªöI)
        customAmountInput.addEventListener('input', function(e) {
            // L·∫•y s·ªë ti·ªÅn kh√¥ng d·∫•u ch·∫•m
            const rawValue = parseNumber(e.target.value);
            // ƒê·ªãnh d·∫°ng l·∫°i v√† g√°n v√†o input
            e.target.value = formatNumber(rawValue);
        });
        // K·∫æT TH√öC X·ª¨ L√ù S·ª∞ KI·ªÜN M·ªöI

        // X·ª≠ l√Ω s·ª± ki·ªán click n√∫t "V·ªÄ 0 ƒê·ªíNG"
        setToZeroButton.onclick = () => {
            if (currentInvoiceId) {
                // S·ª≠ d·ª•ng h√†m c·∫≠p nh·∫≠t chung v·ªõi gi√° tr·ªã 0
                updateReceiptTotal(currentInvoiceId, 0); 
            } else {
                showCustomMessage('error', 'Kh√¥ng t√¨m th·∫•y ID h√≥a ƒë∆°n ƒë·ªÉ c·∫≠p nh·∫≠t.');
            }
        };

        // Close modal when close button is clicked
        closeModalButton.onclick = () => modalOverlay.classList.remove('show');

        // Close modal when clicking outside the modal card
        modalOverlay.onclick = (event) => {
            if (event.target === modalOverlay) {
                modalOverlay.classList.remove('show');
            }
        };

        window.onload = function() {
            if (!firebaseConfig.databaseURL) {
                loadingElement.classList.add('hidden');
                errorDetails.textContent = 'L·ªói c·∫•u h√¨nh: databaseURL kh√¥ng ƒë∆∞·ª£c t√¨m th·∫•y. Vui l√≤ng ki·ªÉm tra l·∫°i c·∫•u h√¨nh Firebase.';
                errorElement.classList.remove('hidden');
            } else {
                fetchData();
            }
        };

    </script>
</body>
</html>
