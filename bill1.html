<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Danh Sách Hóa Đơn & Tìm kiếm - RTDB</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'ios-background': '#F8F9FB', // Nền sáng iOS
                        'ios-dark-background': '#1C1C1E', // Nền tối iOS
                        'ios-card': 'rgba(255, 255, 255, 0.65)',
                        'ios-dark-card': 'rgba(40, 40, 42, 0.65)',
                        'ios-accent': '#007AFF', // Xanh iOS
                        'ios-text': '#1C1C1E',
                        'ios-dark-text': '#F2F2F7',
                    },
                    borderRadius: {
                        '4xl': '2rem',
                    },
                    boxShadow: {
                        'ios-soft': '0 4px 12px rgba(0, 0, 0, 0.08), 0 1px 3px rgba(0, 0, 0, 0.04)',
                        'ios-dark-soft': '0 4px 12px rgba(0, 0, 0, 0.4), 0 1px 3px rgba(0, 0, 0, 0.2)',
                        'ios-modal': '0 -20px 50px rgba(0, 0, 0, 0.1)',
                        'ios-dark-modal': '0 -20px 50px rgba(0, 0, 0, 0.6)',
                    },
                }
            }
        }
    </script>

    <style>
        /* SF Pro Display Font Fallback (Similar to iOS) */
        @font-face {
            font-family: 'SF Pro Display';
            font-weight: 100 900;
            src: local('Helvetica Neue'); /* Fallback on Mac/iOS */
        }
        
        /* Transition chung cho tất cả, đảm bảo animation mượt */
        * {
            transition: all 0.35s cubic-bezier(0.25, 0.1, 0.25, 1); /* Ease-in-out mượt */
        }

        body {
            font-family: 'SF Pro Display', 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", sans-serif;
            background-color: theme('colors.ios-background');
            color: theme('colors.ios-text');
            min-height: 100vh;
        }

        /* iOS Glassmorphism Card */
        .ios-card {
            background-color: theme('colors.ios-card');
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px); /* For Safari */
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: theme('boxShadow.ios-soft');
            transform: translateZ(0); /* Kích hoạt GPU acceleration */
        }

        /* iOS Modern Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.3); /* Nền tối nhẹ */
            display: flex;
            justify-content: center;
            align-items: flex-end;
            z-index: 1000;
            opacity: 0;
            pointer-events: none; /* Vô hiệu hóa tương tác khi ẩn */
            transition: opacity 0.3s ease-in-out;
        }
        .modal-overlay.show {
            opacity: 1;
            pointer-events: auto;
        }
        .modal-card {
            width: 100%;
            max-width: 500px;
            background-color: theme('colors.ios-card');
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            border-top-left-radius: 2rem;
            border-top-right-radius: 2rem;
            box-shadow: theme('boxShadow.ios-modal');
            padding: 1.5rem;
            max-height: 90vh; /* Tăng độ cao cho phép cuộn */
            overflow-y: auto;
            transform: translateY(100%);
            transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1); /* iOS bounce/slide up */
        }
        .modal-overlay.show .modal-card {
            transform: translateY(0);
        }

        /* Input Field Style */
        .ios-input {
            background-color: rgba(255, 255, 255, 0.8);
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 0.75rem; /* Corner radius nhỏ hơn card */
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.05);
        }
        .ios-input:focus {
            outline: none;
            box-shadow: 0 0 0 4px rgba(0, 122, 255, 0.2); /* Focus ring iOS */
            border-color: theme('colors.ios-accent');
        }

        /* Custom scrollbar for better mobile feel */
        .receipt-container { -ms-overflow-style: none; scrollbar-width: none; }
        .receipt-container::-webkit-scrollbar { display: none; }

        /* --- Dark Mode Styles --- */
        @media (prefers-color-scheme: dark) {
            body {
                background-color: theme('colors.ios-dark-background');
                color: theme('colors.ios-dark-text');
            }
            .ios-card {
                background-color: theme('colors.ios-dark-card');
                border: 1px solid rgba(255, 255, 255, 0.1);
                box-shadow: theme('boxShadow.ios-dark-soft');
            }
            .modal-card {
                background-color: theme('colors.ios-dark-card');
                box-shadow: theme('boxShadow.ios-dark-modal');
            }
            .ios-input {
                background-color: rgba(60, 60, 67, 0.6);
                border: 1px solid rgba(255, 255, 255, 0.2);
                color: theme('colors.ios-dark-text');
            }
            .ios-input::placeholder {
                color: rgba(255, 255, 255, 0.5);
            }
            .ios-input:focus {
                box-shadow: 0 0 0 4px rgba(10, 132, 255, 0.4);
            }
        }
    </style>
</head>
<body class="p-4 flex flex-col items-center">

    <div id="notification-box" class="rounded-xl shadow-xl p-3 text-sm font-semibold text-white transition duration-300 hidden fixed top-4 left-1/2 -translate-x-1/2 z-[2000] min-w-[280px] max-w-[90vw] text-center backdrop-blur-md">
        <p id="notification-message"></p>
    </div>

    <div class="w-full max-w-lg">
        <header class="mb-6 pt-4">
            <h1 class="text-4xl font-bold text-ios-text dark:text-ios-dark-text tracking-tight">Hóa đơn</h1>
        </header>

        <div class="mb-6">
            <input type="text" id="search-input" placeholder="Tìm kiếm theo Mã HĐ hoặc Tổng tiền..." 
                   class="w-full px-4 py-3 border-transparent rounded-xl focus:outline-none shadow-sm transition duration-150 ios-input"
            >
        </div>
        
        <div id="loading" class="text-center p-8 ios-card rounded-4xl">
            <svg class="animate-spin h-8 w-8 text-ios-accent mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="mt-3 text-sm text-gray-600 dark:text-gray-400">Đang tải danh sách hóa đơn...</p>
        </div>

        <div id="error-message" class="hidden bg-red-500/10 border border-red-500 text-red-700 dark:text-red-400 px-4 py-3 rounded-xl relative mb-4 ios-card" role="alert">
            <strong class="font-bold">Lỗi!</strong>
            <span class="block sm:inline" id="error-details"></span>
        </div>

        <div id="receipts-list" class="space-y-4 receipt-container max-h-[70vh] overflow-y-auto">
            </div>

        <p id="no-data-message" class="hidden text-center text-gray-500 mt-8 p-4 ios-card rounded-4xl">Không tìm thấy dữ liệu hóa đơn nào trong "payment_history".</p>
    </div>

    <div id="receipt-modal-overlay" class="modal-overlay">
        <div id="receipt-modal" class="modal-card">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-ios-text dark:text-ios-dark-text">Chi tiết Hóa đơn</h2>
                <button id="close-modal" class="text-gray-400 hover:text-ios-accent dark:hover:text-ios-accent p-2 -mr-2 rounded-full active:scale-90 transition duration-150">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>

            <div class="space-y-4 mb-6 pb-4 border-b border-gray-200 dark:border-gray-700">
                <p class="text-base flex justify-between">
                    <span class="text-gray-600 dark:text-gray-400 font-medium">Mã HĐ:</span> 
                    <span id="invoice-id" class="font-semibold text-ios-text dark:text-ios-dark-text break-all text-right"></span>
                </p>
                <p class="text-base flex justify-between">
                    <span class="text-gray-600 dark:text-gray-400 font-medium">Ngày:</span> 
                    <span id="invoice-date" class="font-semibold text-red-500 dark:text-red-400 text-right"></span>
                </p>
                <p class="text-base flex justify-between">
                    <span class="text-gray-600 dark:text-gray-400 font-medium">Hình thức:</span> 
                    <span id="payment-method" class="font-semibold text-ios-text dark:text-ios-dark-text text-right"></span>
                </p>
            </div>

            <div class="flex justify-between items-center mb-6 pt-4 border-t border-dashed border-gray-300 dark:border-gray-600">
                <p class="text-lg font-bold text-gray-700 dark:text-gray-300">Tổng tiền:</p>
                <p id="total-amount" class="text-2xl font-extrabold text-red-600 dark:text-red-400">₫</p>
            </div>

            <h3 class="font-bold text-lg text-ios-text dark:text-ios-dark-text mb-4">Các món đã mua:</h3>
            <div id="items-list" class="space-y-2 mb-8 p-3 bg-gray-50/50 dark:bg-white/5 rounded-xl">
                </div>

            <button id="set-to-zero-btn" class="w-full bg-ios-accent text-white font-bold text-lg py-4 rounded-full shadow-lg hover:bg-blue-600 active:scale-[0.97] transition duration-150 active:shadow-none">
                VỀ 0 ĐỒNG
            </button>
            
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getDatabase, ref, onValue, update } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // setLogLevel('Debug');
        
        // Cấu hình Firebase gốc từ yêu cầu của người dùng
        const providedConfig = {
            apiKey: "AIzaSyB8uLkLJFlzmCodcawJhs2dRckHQzO5y10",
            authDomain: "chitieu-7263e.firebaseapp.com",
            databaseURL: "https://chitieu-7263e-default-rtdb.firebaseio.com", 
            projectId: "chitieu-7263e",
            storageBucket: "chitieu-7263e.firebasestorage.app",
            messagingSenderId: "83833140682",
            appId: "1:83833140682:web:f9254b418ace3a659fcb33",
            measurementId: "G-523X74K18N"
        };
        
        let firebaseConfig = providedConfig;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        if (typeof __firebase_config !== 'undefined') {
            try {
                const globalConfig = JSON.parse(__firebase_config);
                firebaseConfig = { ...providedConfig, ...globalConfig };
            } catch (e) {
                console.warn("Lỗi khi parse __firebase_config, sử dụng providedConfig.", e);
            }
        }
        
        let app, auth, db;
        // Lưu trữ toàn bộ dữ liệu gốc đã tải về từ Firebase
        let masterReceipts = []; 
        let currentInvoiceId = null; 

        const loadingElement = document.getElementById('loading');
        const errorElement = document.getElementById('error-message');
        const errorDetails = document.getElementById('error-details');
        const listElement = document.getElementById('receipts-list');
        const modalOverlay = document.getElementById('receipt-modal-overlay');
        const noDataMessage = document.getElementById('no-data-message');
        const itemsListElement = document.getElementById('items-list');
        const closeModalButton = document.getElementById('close-modal');
        const setToZeroButton = document.getElementById('set-to-zero-btn');
        const searchInput = document.getElementById('search-input'); // New search input element
        const notificationBox = document.getElementById('notification-box');
        const notificationMessage = document.getElementById('notification-message');

        // --- Custom Notification Function ---
        const showCustomMessage = (type, message) => {
            notificationMessage.textContent = message;
            notificationBox.classList.remove('hidden', 'bg-green-600', 'bg-red-600');
            
            if (type === 'success') {
                notificationBox.classList.add('bg-green-600');
            } else if (type === 'error') {
                notificationBox.classList.add('bg-red-600');
            }

            // Show and hide animation
            setTimeout(() => notificationBox.classList.add('show'), 10);
            setTimeout(() => notificationBox.classList.remove('show'), 3000);
            setTimeout(() => notificationBox.classList.add('hidden'), 3500);
        };

        // --- Helper Functions ---
        const formatVND = (amount) => {
            if (typeof amount !== 'number' || isNaN(amount)) return '0₫';
            return amount.toLocaleString('vi-VN', { 
                style: 'currency', 
                currency: 'VND', 
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            });
        };

        const formatTimestamp = (timestamp) => {
            if (!timestamp) return 'Không rõ';
            const ms = String(timestamp).length === 10 ? timestamp * 1000 : timestamp;
            const date = new Date(ms);
            if (isNaN(date.getTime())) return 'Ngày không hợp lệ';

            const time = date.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            const day = date.toLocaleDateString('vi-VN');
            return `${time} ${day}`;
        };
        
        // --- Search/Filter Function (New) ---
        const filterReceipts = () => {
            const query = searchInput.value.toLowerCase().trim();
            
            if (!query) {
                // Nếu ô tìm kiếm trống, hiển thị toàn bộ danh sách gốc
                renderReceiptsList(masterReceipts);
                return;
            }

            const filtered = masterReceipts.filter(receipt => {
                const idMatch = receipt.invoiceId && receipt.invoiceId.toLowerCase().includes(query);
                
                // Chuyển tổng tiền sang chuỗi VND để tìm kiếm (ví dụ: "100.000₫")
                const totalVND = formatVND(receipt.totalAmount || 0).toLowerCase().replace(/\./g, '');
                // Chuyển tổng tiền sang chuỗi số (ví dụ: "100000")
                const totalNumber = String(receipt.totalAmount || 0);

                // Kiểm tra xem query có phải là số tiền (ví dụ: "100000" hoặc "100k")
                const priceMatch = totalVND.includes(query) || totalNumber.includes(query);

                return idMatch || priceMatch;
            });

            if (filtered.length === 0) {
                listElement.innerHTML = `<p class="text-center text-gray-500 mt-8 p-4 ios-card rounded-4xl">Không tìm thấy hóa đơn nào khớp với từ khóa "${query}".</p>`;
            } else {
                renderReceiptsList(filtered, true); // true để không cập nhật masterReceipts
            }
        };


        // --- Database Update Function (Đã sửa để cập nhật totalAmount và finalTotal về 0) ---
        const setTotalAmountToZero = async (invoiceId) => {
            if (!db || !invoiceId) {
                showCustomMessage('error', 'Lỗi: Không thể kết nối DB hoặc thiếu ID hóa đơn.');
                return;
            }

            try {
                const receiptRef = ref(db, `payment_history/${invoiceId}`);
                
                // Cập nhật cả totalAmount và finalTotal về 0
                await update(receiptRef, {
                    totalAmount: 0,
                    finalTotal: 0 // Thêm trường finalTotal
                });
                
                showCustomMessage('success', `Hóa đơn ${invoiceId.substring(0, 5)}... đã được cập nhật thành công về 0₫!`);
                
                setTimeout(() => modalOverlay.classList.remove('show'), 1000); // Ẩn modal bằng class 'show'

            } catch (error) {
                console.error("Lỗi khi cập nhật DB:", error);
                showCustomMessage('error', 'Lỗi khi cập nhật DB: ' + error.message);
            }
        };


        // --- Renderer Functions ---
        // Thêm tham số isFiltered để tránh cập nhật masterReceipts khi đang lọc
        const renderReceiptsList = (receipts, isFiltered = false) => {
            listElement.innerHTML = '';
            loadingElement.classList.add('hidden');
            
            if (!isFiltered) {
                 masterReceipts = receipts; // Chỉ cập nhật master data khi load từ Firebase
            }
            
            if (receipts.length === 0) {
                // Chỉ hiển thị thông báo không có dữ liệu nếu không có kết quả lọc
                if (!isFiltered) { 
                    noDataMessage.textContent = 'Không tìm thấy dữ liệu hóa đơn nào trong "payment_history".';
                    noDataMessage.classList.remove('hidden');
                }
                return;
            }

            noDataMessage.classList.add('hidden');

            receipts.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));

            receipts.forEach((receipt) => {
                const card = document.createElement('div');
                card.id = `receipt-${receipt.invoiceId}`;
                // Sử dụng các class iOS mới: ios-card, rounded-4xl, active:scale-[0.97]
                card.className = 'ios-card p-4 rounded-4xl shadow-lg cursor-pointer active:scale-[0.97] transition duration-200 ease-in-out hover:bg-white/70 dark:hover:bg-gray-800/70';
                card.onclick = () => renderReceiptDetail(receipt);

                // Lấy tổng tiền, ưu tiên finalTotal nếu có, nếu không thì dùng totalAmount
                const displayAmount = receipt.finalTotal !== undefined ? receipt.finalTotal : (receipt.totalAmount || 0);

                card.innerHTML = `
                    <div class="flex justify-between items-center mb-1">
                        <p class="text-xs font-medium text-ios-accent">Mã HĐ: ${receipt.invoiceId.substring(0, 10)}...</p>
                        <p class="text-lg font-extrabold ${displayAmount === 0 ? 'text-green-500' : 'text-red-600 dark:text-red-400'}">${formatVND(displayAmount)}</p>
                    </div>
                    <div class="flex justify-between items-end mt-1">
                        <p class="text-sm text-gray-700 dark:text-gray-300">${receipt.paymentMethod || 'Không rõ'}</p>
                        <p class="text-xs text-gray-500 dark:text-gray-400">${formatTimestamp(receipt.timestamp)}</p>
                    </div>
                `;
                listElement.appendChild(card);
            });
        };

        const renderReceiptDetail = (receipt) => {
            currentInvoiceId = receipt.invoiceId; 
            
            // Lấy tổng tiền để hiển thị, ưu tiên finalTotal nếu có
            const displayAmount = receipt.finalTotal !== undefined ? receipt.finalTotal : (receipt.totalAmount || 0);

            document.getElementById('invoice-id').textContent = receipt.invoiceId;
            document.getElementById('invoice-date').textContent = formatTimestamp(receipt.timestamp);
            document.getElementById('payment-method').textContent = receipt.paymentMethod || 'Không rõ';
            document.getElementById('total-amount').textContent = formatVND(displayAmount); // Hiển thị tổng tiền đã được cập nhật

            // Cập nhật trạng thái nút nếu tổng tiền đã bằng 0
            if (displayAmount === 0) {
                setToZeroButton.textContent = "ĐÃ VỀ 0 ĐỒNG";
                setToZeroButton.disabled = true;
                setToZeroButton.classList.remove('bg-ios-accent', 'hover:bg-blue-600');
                setToZeroButton.classList.add('bg-green-500', 'cursor-not-allowed');
            } else {
                setToZeroButton.textContent = "VỀ 0 ĐỒNG";
                setToZeroButton.disabled = false;
                setToZeroButton.classList.remove('bg-green-500', 'cursor-not-allowed');
                setToZeroButton.classList.add('bg-ios-accent', 'hover:bg-blue-600');
            }

            itemsListElement.innerHTML = '';
            
            if (receipt.items) {
                const rawItems = receipt.items;
                const itemsArray = Array.isArray(rawItems) 
                    ? rawItems.filter(item => item) 
                    : Object.keys(rawItems).map(key => rawItems[key]).filter(item => item);

                if (itemsArray.length > 0) {
                    itemsArray.forEach(item => {
                        const itemTotal = (item.price || 0) * (item.quantity || 1);

                        const itemElement = document.createElement('div');
                        itemElement.className = 'flex justify-between items-start text-sm border-b border-gray-200 dark:border-gray-700 py-2 last:border-b-0';
                        
                        const itemNameAndQuantity = document.createElement('p');
                        itemNameAndQuantity.className = 'text-gray-700 dark:text-gray-300 pr-2 flex-1';
                        itemNameAndQuantity.innerHTML = `<span class="font-semibold">${item.name || 'Sản phẩm'}</span> <span class="text-ios-accent font-bold">x ${item.quantity || 1}</span>`;

                        const itemPrice = document.createElement('p');
                        itemPrice.className = 'text-gray-800 dark:text-ios-dark-text font-medium whitespace-nowrap';
                        itemPrice.textContent = formatVND(itemTotal);

                        itemElement.appendChild(itemNameAndQuantity);
                        itemElement.appendChild(itemPrice);
                        itemsListElement.appendChild(itemElement);
                    });
                } else {
                    itemsListElement.innerHTML = '<p class="text-center text-gray-500 dark:text-gray-400 italic text-sm py-2">Không có chi tiết mặt hàng.</p>';
                }
            } else {
                itemsListElement.innerHTML = '<p class="text-center text-gray-500 dark:text-gray-400 italic text-sm py-2">Không có chi tiết mặt hàng.</p>';
            }
            
            // Dùng class 'show' để kích hoạt animation modal
            modalOverlay.classList.add('show');
        };

        // --- Main Firebase Logic ---

        const fetchData = () => {
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getDatabase(app);
                
                const authenticate = async () => {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }
                };

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        const dbRef = ref(db, 'payment_history');
                        
                        // onValue sẽ tự động chạy lại khi dữ liệu thay đổi
                        onValue(dbRef, (snapshot) => {
                            const data = snapshot.val();

                            let receipts = [];
                            if (data) {
                                receipts = Object.keys(data).map(key => ({
                                    ...data[key],
                                    invoiceId: key 
                                }));
                            }

                            // Cập nhật master data và lọc/render lại
                            masterReceipts = receipts; 
                            filterReceipts(); // Sử dụng hàm lọc để hiển thị

                            // Nếu modal đang mở, cập nhật chi tiết hóa đơn đang xem
                            if (modalOverlay.classList.contains('show') && currentInvoiceId) {
                                const updatedReceipt = masterReceipts.find(r => r.invoiceId === currentInvoiceId);
                                if (updatedReceipt) {
                                    // Kiểm tra xem hóa đơn có bị cập nhật về 0 hay không để đóng modal
                                    const displayAmount = updatedReceipt.finalTotal !== undefined ? updatedReceipt.finalTotal : (updatedReceipt.totalAmount || 0);
                                    if (displayAmount === 0) {
                                        // Cập nhật trạng thái chi tiết (nút, số tiền)
                                        renderReceiptDetail(updatedReceipt); 
                                        showCustomMessage('success', `Cập nhật thành công!`);
                                    } else {
                                        renderReceiptDetail(updatedReceipt);
                                    }
                                } else {
                                     // Nếu hóa đơn bị xóa (dù không có chức năng xóa ở đây), đóng modal
                                    modalOverlay.classList.remove('show'); 
                                }
                            }

                        }, (err) => {
                            console.error("Firebase DB Error:", err);
                            loadingElement.classList.add('hidden');
                            errorDetails.textContent = `Lỗi truy cập DB: ${err.message}`;
                            errorElement.classList.remove('hidden');
                        });
                        
                    } else {
                        await authenticate();
                    }
                });

                authenticate().catch(e => {
                    console.error("Authentication failed:", e);
                    loadingElement.classList.add('hidden');
                    errorDetails.textContent = `Lỗi xác thực: ${e.message}`;
                    errorElement.classList.remove('hidden');
                });

            } catch (e) {
                console.error("Initialization Error:", e);
                loadingElement.classList.add('hidden');
                errorDetails.textContent = `Lỗi khởi tạo Firebase: ${e.message}`;
                errorElement.classList.remove('hidden');
            }
        };

        // --- Event Listeners and Initialization ---

        // Lắng nghe sự kiện input trên ô tìm kiếm để lọc tức thì
        searchInput.addEventListener('input', filterReceipts);

        // Xử lý sự kiện click nút "VỀ 0 ĐỒNG"
        setToZeroButton.onclick = () => {
            if (currentInvoiceId) {
                // Ta bỏ qua bước xác nhận (window.confirm) và thực hiện ngay
                setTotalAmountToZero(currentInvoiceId);
            } else {
                showCustomMessage('error', 'Không tìm thấy ID hóa đơn để cập nhật.');
            }
        };

        // Close modal when close button is clicked
        closeModalButton.onclick = () => modalOverlay.classList.remove('show');

        // Close modal when clicking outside the modal card
        modalOverlay.onclick = (event) => {
            if (event.target === modalOverlay) {
                modalOverlay.classList.remove('show');
            }
        };

        window.onload = function() {
            if (!firebaseConfig.databaseURL) {
                loadingElement.classList.add('hidden');
                errorDetails.textContent = 'Lỗi cấu hình: databaseURL không được tìm thấy. Vui lòng kiểm tra lại cấu hình Firebase.';
                errorElement.classList.remove('hidden');
            } else {
                fetchData();
            }
        };

    </script>
</body>
</html>
