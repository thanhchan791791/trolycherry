<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Qu·∫£n L√Ω Nh√† H√†ng - iOS Style</title>

    <!-- TailwindCSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <!-- iOS PWA -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="POS Nh√† H√†ng">
    <link rel="apple-touch-icon" href="IMG_5641.png">

    <!-- PWA manifest -->
    <link rel="manifest" href="manifest.json">
    <style>
        /* 1. iOS Font & General Styles */
        body {
            font-family: -apple-system, San Francisco, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: linear-gradient(135deg, #f0f4f8, #e0e7f1); /* Pastel light gradient background */
            transition: background-color 0.5s ease;
        }

        /* 2. Color Variables (iOS inspired) */
        :root {
            --ios-blue: #007AFF;
            --ios-green: #34C759;
            --ios-red: #FF3B30;
            --ios-yellow: #FFCC00;
            --ios-gray-bg: #F2F2F7;
            --ios-card-bg: #FFFFFF;
            --ios-shadow: 0 4px 12px rgba(0,0,0,0.08);
            --ios-text-primary: #1C1C1E;
            --ios-text-secondary: #6E6E73;
            --sidebar-bg: #1C1C1E; /* Dark mode for sidebar for contrast */
        }
        
        /* Utility Classes for Tailwind */
        .card-style {
            border-radius: 12px;
            box-shadow: var(--ios-shadow);
            background-color: var(--ios-card-bg);
            transition: all 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94); /* Smooth iOS transition curve */
        }
        
        /* 3. Animations & Interactivity */
        
        /* Button Press Animation */
        .btn-ios-press {
            transition: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .btn-ios-press:active {
            transform: scale(0.95);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
        }

        /* Card Hover/Interaction Animation */
        .card-interactive:hover {
            transform: scale(1.02);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.12);
        }
        
        /* Fade In and Slide Up Animation */
        @keyframes fadeInSlideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .animate-stagger-in {
            animation: fadeInSlideUp 0.6s ease-out forwards;
        }

        /* Main Menu Grid Item Style */
        .menu-grid-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 150px; /* Uniform height for mobile appeal */
            border-radius: 16px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            transition: all 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            cursor: pointer;
        }

        .menu-grid-item:active {
            transform: scale(0.98);
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }
        
        /* Modal Animation */
        @keyframes modalFadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        .modal-animated {
            animation: modalFadeIn 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }
        
        /* Sidebar item style (Kept for desktop layout) */
        .sidebar-item {
            color: #C0C0C0;
            transition: all 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            border-radius: 8px;
        }
        .sidebar-item:hover {
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
        }
        .sidebar-item.active {
            background: var(--ios-blue); /* Changed to blue for consistency with Main Menu active color */
            color: white;
            font-weight: 600;
            box-shadow: 0 4px 10px rgba(0, 122, 255, 0.4);
        }
        /* Hide sidebar completely when viewing main menu */
        .sidebar-hidden-on-main-menu {
            display: none !important;
        }

        /* 4. Mobile Responsiveness */
        .sidebar {
            width: 280px; 
        }
        @media (max-width: 768px) {
            /* Hide the entire sidebar on mobile to force main menu view */
            .sidebar {
                display: none !important; 
            }
            #dashboard-container {
                flex-direction: column;
            }
            .content-area {
                padding-bottom: 20px;
            }
            /* Hide mobile bottom nav as it's not needed for the Main Menu view */
            .sidebar-nav-mobile {
                display: none !important; 
            }
        }

        /* Style cho iframe content */
        .iframe-container {
            width: 100%;
            height: calc(100vh - 120px); /* Adjust height based on header and padding */
            overflow: hidden;
            border-radius: 12px; /* Match iOS card style */
            box-shadow: var(--ios-shadow);
        }
        .iframe-content {
            width: 100%;
            height: 100%;
            border: none;
            background-color: white;
        }
    </style>
</head>
<body class="min-h-screen text-ios-text-primary" style="color: var(--ios-text-primary);">

    <div id="customAlertModal" class="fixed inset-0 bg-gray-900 bg-opacity-30 z-50 hidden flex items-center justify-center transition-opacity duration-300">
        <div class="card-style p-6 w-11/12 max-w-sm modal-animated text-center" style="border-radius: 14px;">
            <h3 id="modalTitle" class="text-xl font-bold mb-3">Th√¥ng b√°o</h3>
            <p id="modalMessage" class="mb-6 text-base text-ios-text-secondary"></p>
            <div class="flex justify-center space-x-3 border-t pt-4">
                <button id="modalCancel" class="hidden flex-1 px-4 py-2 bg-ios-gray-bg text-ios-text-primary rounded-xl hover:bg-gray-300 font-medium btn-ios-press">H·ªßy</button>
<button id="modalConfirm" 
    class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-xl hover:bg-blue-700 font-semibold shadow-md flex items-center justify-center gap-2">
    <i class="fas fa-check"></i>
    <span class="text-base">X√°c nh·∫≠n</span>
</button>
            </div>
        </div>
    </div>

    <div id="login-container" class="fixed inset-0 flex items-center justify-center" style="background: linear-gradient(135deg, #f0f4f8, #e0e7f1);">
        <div class="card-style p-8 w-11/12 max-w-md transform transition duration-500 hover:scale-[1.01] animate-stagger-in">
            <h2 class="text-3xl font-bold text-center mb-2" style="color: var(--ios-blue);">Qu·∫£n L√Ω Nh√† H√†ng</h2>
            <p class="text-center mb-6 text-ios-text-secondary">ƒêƒÉng nh·∫≠p ƒë·ªÉ b·∫Øt ƒë·∫ßu c√¥ng vi·ªác</p>
            
            <div id="initial-setup-message" class="hidden p-3 mb-4 text-sm bg-yellow-100 text-yellow-800 card-style" role="alert" style="box-shadow: none;">
                <i class="fas fa-info-circle mr-2"></i> ƒêang thi·∫øt l·∫≠p t√†i kho·∫£n Admin l·∫ßn ƒë·∫ßu...
            </div>
            
            <div class="mb-4">
                <label for="username" class="block text-ios-text-secondary font-semibold mb-1 text-sm">T√™n ƒëƒÉng nh·∫≠p</label>
                <input type="text" id="username" placeholder="admin ho·∫∑c t√™n nh√¢n vi√™n" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-ios-blue focus:border-transparent transition">
            </div>
            <div class="mb-6">
                <label for="password" class="block text-sm font-medium text-ios-text-secondary">M·∫≠t kh·∫©u</label>
                <input type="password" id="password" placeholder="M·∫≠t kh·∫©u c·ªßa b·∫°n" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-ios-blue focus:border-transparent transition">
            </div>
            
           <button id="login-button" 
    class="w-full bg-blue-500 text-white py-3 rounded-xl font-bold text-lg hover:bg-blue-600 active:scale-95 transition-all duration-200 shadow-lg flex items-center justify-center gap-2"
    style="box-shadow: 0 4px 10px rgba(0, 122, 255, 0.4);">
    <i class="fas fa-sign-in-alt"></i>
    <span>ƒêƒÉng Nh·∫≠p</span>
</button>

            <p id="login-error" class="text-ios-red text-center mt-4 hidden"></p>
           
        </div>
    </div>

    <div id="dashboard-container" class="hidden flex h-screen">
        
        <aside id="sidebar-desktop" class="sidebar bg-sidebar flex flex-col shadow-xl transition-all duration-300 z-30" style="background-color: var(--sidebar-bg);">
            
            <div class="p-6 flex items-center justify-center border-b border-gray-700 sidebar-header">
                <i class="fas fa-utensils text-2xl text-ios-green mr-3"></i>
                <h1 class="text-white text-xl font-extrabold tracking-tight">Q.L√ù NH√Ä H√ÄNG</h1>
            </div>

            <nav id="sidebar-nav-desktop" class="flex-grow p-4 space-y-2 overflow-y-auto sidebar-nav-desktop">
                </nav>
            
            <div class="p-4 border-t border-gray-700 sidebar-footer">
                <div class="text-sm font-medium text-gray-300 mb-3 p-2 bg-gray-800 rounded-lg">
                    <i class="fas fa-user-circle mr-2 text-ios-green"></i>
                    T√†i kho·∫£n: <span id="current-user-role" class="font-bold"></span>
                </div>
                <button id="logout-button" class="w-full flex items-center justify-center p-3 text-sm font-medium text-white bg-ios-red rounded-xl hover:opacity-90 transition duration-200 btn-ios-press">
                    <i class="fas fa-sign-out-alt mr-2"></i> ƒêƒÉng Xu·∫•t
                </button>
            </div>
        </aside>

        <nav id="sidebar-nav-mobile" class="hidden"></nav>

        <main class="flex-1 overflow-y-auto p-4 md:p-8 content-area">
            <header class="mb-6 pt-4 flex justify-between items-center">
                <h2 id="current-view-title" class="text-2xl md:text-3xl font-bold tracking-tight" style="color: var(--ios-text-primary);">Menu Ch√≠nh</h2>
                <div id="main-menu-actions" class="flex space-x-3">
                    <button id="logout-button-mobile" class="md:hidden p-2 text-ios-red hover:opacity-80 transition duration-200 btn-ios-press" style="border-radius: 8px;" title="ƒêƒÉng xu·∫•t">
                        <i class="fas fa-sign-out-alt text-xl"></i>
                    </button>
                </div>
            </header>
            
            <div id="dashboard-content">
                </div>
        </main>
    </div>

    <script>
        // --- Custom Alert/Confirm Logic (Using iOS Style Modal) ---
        const customAlert = (message, title = "Th√¥ng b√°o") => {
            return new Promise(resolve => {
                const modal = document.getElementById('customAlertModal');
                document.getElementById('modalTitle').textContent = title;
                document.getElementById('modalMessage').textContent = message;
                document.getElementById('modalCancel').classList.add('hidden');
                
                const confirmBtn = document.getElementById('modalConfirm');
                confirmBtn.textContent = 'ƒê√≥ng';
                confirmBtn.onclick = () => {
                    modal.classList.add('hidden');
                    resolve(true);
                };
                modal.classList.remove('hidden');
            });
        };

        const customConfirm = (message, title = "X√°c nh·∫≠n") => {
            return new Promise(resolve => {
                const modal = document.getElementById('customAlertModal');
                document.getElementById('modalTitle').textContent = title;
                document.getElementById('modalMessage').textContent = message;
                
                const cancelBtn = document.getElementById('modalCancel');
                const confirmBtn = document.getElementById('modalConfirm');
                
                cancelBtn.classList.remove('hidden');
                confirmBtn.textContent = 'X√°c nh·∫≠n';
                
                cancelBtn.onclick = () => {
                    modal.classList.add('hidden');
                    resolve(false);
                };
                
                confirmBtn.onclick = () => {
                    modal.classList.add('hidden');
                    resolve(true);
                };
                
                modal.classList.remove('hidden');
            });
        };

        // --- Configuration & Initialization ---
        // DO NOT CHANGE FIREBASE CODE
        const firebaseConfig = {
            apiKey: "AIzaSyB8uLkLJFlzmCodcawJhs2dRckHQzO5y10",
            authDomain: "chitieu-7263e.firebaseapp.com",
            databaseURL: "https://chitieu-7263e-default-rtdb.firebaseio.com",
            projectId: "chitieu-7263e",
            storageBucket: "chitieu-7263e.firebasestorage.app",
            messagingSenderId: "83833140682",
            appId: "1:83833140682:web:f9254b418ace3a659fcb33",
            measurementId: "G-523X74K18N"
        };

        const app = firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        
        let currentUser = null;
        let currentPermissions = [];
        let currentViewId = 'main_menu'; // Track current view, default to main menu

       // --- Role-Based Access Control (RBAC) Setup - UPDATED PERMISSIONS ---
const PERMISSIONS = {
    'admin': ['sales', 'stats', 'revenue_expense', 'inventory', 'kitchen_bar', 'personnel', 'menu_management'], // TH√äM 'menu_management' V√ÄO ƒê√ÇY
    'waiter': ['sales'], 
    'cashier': ['sales', 'stats', 'revenue_expense'], 
    'kitchen_bar_staff': ['inventory', 'kitchen_bar'], 
    'accountant': ['stats', 'revenue_expense', 'personnel'],
};

       const MENU_ITEMS = [
    { id: 'sales', name: 'B√°n h√†ng', icon: 'fas fa-cash-register', color: '#007AFF', view: renderSalesView, file: 'banhang.html' }, // Blue
    { id: 'stats', name: 'Th·ªëng k√™', icon: 'fas fa-chart-pie', color: '#FF9500', view: renderStatsView, file: 'thongke.html' }, // Orange
    { id: 'revenue_expense', name: 'Thu Chi', icon: 'fas fa-file-invoice-dollar', color: '#34C759', view: renderRevenueExpenseView, file: 'thuchi.html' }, // Green
    { id: 'inventory', name: 'T·ªìn kho', icon: 'fas fa-boxes', color: '#AF52DE', view: renderInventoryView, file: 'quanlytonkho.html' }, // Purple
    { id: 'kitchen_bar', name: 'B·∫øp & Bar', icon: 'fas fa-cookie-bite', color: '#FF3B30', view: renderKitchenBarView, file: 'bepbar.html' }, // Red
    { id: 'personnel', name: 'Nh√¢n s·ª±', icon: 'fas fa-users', color: '#5856D6', view: renderPersonnelView }, // Indigo
    // CH·ª®C NƒÇNG M·ªöI ƒê∆Ø·ª¢C TH√äM V√ÄO ƒê√ÇY
    { id: 'menu_management', name: 'Qu·∫£n l√Ω Menu', icon: 'fas fa-clipboard-list', color: '#9400D3', view: renderMenuView, file: 'menu.html' }, // Dark Violet
];
        
        // --- Utility Functions (Firebase not modified) ---
        function showLoginScreen() {
            document.getElementById('dashboard-container').classList.add('hidden');
            document.getElementById('login-container').classList.remove('hidden');
            document.getElementById('login-error').classList.add('hidden');
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
        }

        function showDashboardScreen(user) {
            currentUser = user;
            currentPermissions = PERMISSIONS[user.role] || [];
            document.getElementById('current-user-role').textContent = `${user.username} (${user.role.toUpperCase()})`;
            
            // Render menu based on permissions
            renderSidebarMenu(); // Render sidebar for desktop/fallback
            
            // Switch views
            document.getElementById('login-container').classList.add('hidden');
            document.getElementById('dashboard-container').classList.remove('hidden');
            
            // RENDER MAIN MENU IMMEDIATELY AFTER LOGIN
            switchView('main_menu'); 
        }

        async function createInitialAdmin() {
            const usersRef = database.ref('users');
            const snapshot = await usersRef.once('value');
            if (!snapshot.exists()) {
                document.getElementById('initial-setup-message').classList.remove('hidden');
                
                const adminData = {
                    username: 'admin',
                    password: 'comdongbaobanme', 
                    role: 'admin',
                    createdAt: new Date().toISOString()
                };
                
                await usersRef.child('admin_user').set(adminData);
                document.getElementById('initial-setup-message').classList.add('hidden');
                customAlert('T√†i kho·∫£n Admin ƒë√£ ƒë∆∞·ª£c thi·∫øt l·∫≠p th√†nh c√¥ng! Vui l√≤ng ƒëƒÉng nh·∫≠p.', 'Thi·∫øt l·∫≠p th√†nh c√¥ng');
            }
        }
        
        // --- Authentication Logic (Firebase not modified) ---
        async function loginUser() {
            const usernameInput = document.getElementById('username').value.trim();
            const passwordInput = document.getElementById('password').value.trim();
            const errorEl = document.getElementById('login-error');

            if (!usernameInput || !passwordInput) {
                errorEl.textContent = 'Vui l√≤ng nh·∫≠p t√™n ƒëƒÉng nh·∫≠p v√† m·∫≠t kh·∫©u.';
                errorEl.classList.remove('hidden');
                return;
            }

            const usersRef = database.ref('users');
            const snapshot = await usersRef.once('value');
            const users = snapshot.val();
            
            if (!users) {
                errorEl.textContent = 'L·ªói h·ªá th·ªëng: Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu ng∆∞·ªùi d√πng.';
                errorEl.classList.remove('hidden');
                return;
            }

            const userId = Object.keys(users).find(key => users[key].username === usernameInput);
            const user = userId ? users[userId] : null;

            if (user && user.password === passwordInput) {
                if (PERMISSIONS[user.role] || user.role === 'admin') {
                    user.uid = userId;
                    // Add 'dashboard' to permissions just for the main menu view if user is admin
                    if (user.role === 'admin') {
                         currentPermissions = MENU_ITEMS.map(item => item.id);
                    } else {
                         currentPermissions = PERMISSIONS[user.role] || [];
                    }
                    user.rolePermissions = currentPermissions; // Store explicit permissions
                    showDashboardScreen(user);
                    localStorage.setItem("currentUser", JSON.stringify(user));

                } else {
                    errorEl.textContent = `Vai tr√≤ '${user.role}' kh√¥ng h·ª£p l·ªá ho·∫∑c ch∆∞a ƒë∆∞·ª£c ph√¢n quy·ªÅn.`;
                    errorEl.classList.remove('hidden');
                }
            } else {
                errorEl.textContent = 'T√™n ƒëƒÉng nh·∫≠p ho·∫∑c m·∫≠t kh·∫©u kh√¥ng ƒë√∫ng.';
                errorEl.classList.remove('hidden');
            }
        }

       function logoutUser() {
    currentUser = null;
    currentPermissions = [];
    localStorage.removeItem("currentUser"); // üëâ X√≥a th√¥ng tin ƒë√£ l∆∞u
    showLoginScreen();
}

        
        // --- Navigation and View Switching (iOS Styling Applied) ---

        function renderSidebarMenu() {
            const desktopNav = document.getElementById('sidebar-nav-desktop');
            desktopNav.innerHTML = '';
            
            MENU_ITEMS.forEach(item => {
                if (currentPermissions.includes(item.id)) {
                    
                    // Desktop Item
                    const desktopBtn = document.createElement('button');
                    desktopBtn.id = `nav-desktop-${item.id}`;
                    // Add back button to main menu
                    desktopBtn.className = 'sidebar-item w-full flex items-center p-3 text-sm font-medium rounded-lg focus:outline-none';
                    desktopBtn.innerHTML = `<i class="${item.icon} text-lg w-6 text-center mr-3"></i> <span>${item.name}</span>`;
                    desktopBtn.onclick = () => switchView(item.id);
                    desktopNav.appendChild(desktopBtn);
                }
            });
            
            // Add Main Menu button for navigation back
            const main_menu_btn = document.createElement('button');
            main_menu_btn.id = 'nav-desktop-main_menu';
            main_menu_btn.className = 'sidebar-item w-full flex items-center p-3 text-sm font-medium rounded-lg focus:outline-none bg-gray-700 text-white mt-4';
            main_menu_btn.innerHTML = `<i class="fas fa-home text-lg w-6 text-center mr-3"></i> <span>Menu Ch√≠nh</span>`;
            main_menu_btn.onclick = () => switchView('main_menu');
            desktopNav.prepend(main_menu_btn);
        }
        
        function switchView(viewId) {
            currentViewId = viewId;
            const contentEl = document.getElementById('dashboard-content');
            const titleEl = document.getElementById('current-view-title');
            const sidebar = document.getElementById('sidebar-desktop');
            const mainMenuActions = document.getElementById('main-menu-actions');
            
            // 1. Handle Sidebar/Mobile Visibility
            if (viewId === 'main_menu') {
                titleEl.innerHTML = `Xin ch√†o, ${currentUser.username} (${currentUser.role.toUpperCase()})!`;
                sidebar.classList.add('sidebar-hidden-on-main-menu');
                mainMenuActions.innerHTML = ''; // Hide back button on main menu
            } else {
                const menuItem = MENU_ITEMS.find(item => item.id === viewId);
                titleEl.textContent = menuItem ? menuItem.name : 'Ch·ª©c nƒÉng';
                sidebar.classList.remove('sidebar-hidden-on-main-menu');
                // Show Back button on mobile
                mainMenuActions.innerHTML = `
                    <button onclick="switchView('main_menu')" class="md:hidden p-2 text-ios-blue hover:opacity-80 transition duration-200 btn-ios-press" style="border-radius: 8px;" title="Quay l·∫°i">
                        <i class="fas fa-arrow-left text-xl"></i>
                    </button>
                    <button id="logout-button-mobile" onclick="logoutUser()" class="md:hidden p-2 text-ios-red hover:opacity-80 transition duration-200 btn-ios-press" style="border-radius: 8px;" title="ƒêƒÉng xu·∫•t">
                        <i class="fas fa-sign-out-alt text-xl"></i>
                    </button>
                `;
            }
            
            // 2. Update Active state
            document.querySelectorAll('.sidebar-item').forEach(btn => {
                btn.classList.remove('active');
            });
            const activeDesktopBtn = document.getElementById(`nav-desktop-${viewId}`);
            if(activeDesktopBtn) {
                activeDesktopBtn.classList.add('active');
            }
            
            // 3. Render View Content
            if (viewId === 'main_menu') {
                renderMainMenu();
            } else {
                const menuItem = MENU_ITEMS.find(item => item.id === viewId);
                if (!menuItem || !currentPermissions.includes(viewId)) {
                    renderAccessDenied();
                    return;
                }
                menuItem.view();
            }
        }
        
        // --- New Main Menu Render Function ---
        function renderMainMenu() {
            const contentEl = document.getElementById('dashboard-content');
            
            // Filter allowed menu items
            const allowedItems = MENU_ITEMS.filter(item => currentPermissions.includes(item.id));

            let htmlContent = `
                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 md:gap-6 pt-4">
            `;

            allowedItems.forEach((item, index) => {
                const delay = (index * 0.08) + 0.1; // Staggered animation delay
                htmlContent += `
                    <div 
                        onclick="switchView('${item.id}')" 
                        class="menu-grid-item bg-white text-ios-text-primary card-style animate-stagger-in" 
                        style="animation-delay: ${delay}s;"
                    >
                        <div class="p-4 rounded-full mb-3" style="background-color: ${item.color}15; color: ${item.color};">
                            <i class="${item.icon} text-3xl"></i>
                        </div>
                        <span class="text-sm font-semibold text-center tracking-tight">${item.name}</span>
                    </div>
                `;
            });

            htmlContent += `</div>`;
            contentEl.innerHTML = htmlContent;
        }

        // --- Access Denied View ---
        function renderAccessDenied() {
            const contentEl = document.getElementById('dashboard-content');
            document.getElementById('current-view-title').textContent = 'Truy c·∫≠p b·ªã t·ª´ ch·ªëi';
            contentEl.innerHTML = `
                <div class="p-8 text-center bg-ios-gray-bg card-style border-l-4 border-ios-red animate-stagger-in">
                    <i class="fas fa-exclamation-triangle text-5xl mb-4 text-ios-red"></i>
                    <h3 class="text-xl font-semibold text-ios-text-primary">B·∫°n kh√¥ng c√≥ quy·ªÅn truy c·∫≠p ch·ª©c nƒÉng n√†y.</h3>
                    <p class="mt-2 text-ios-text-secondary">Vui l√≤ng li√™n h·ªá Admin ƒë·ªÉ ƒë∆∞·ª£c ph√¢n quy·ªÅn.</p>
                    <button onclick="switchView('main_menu')" class="mt-6 p-3 bg-ios-blue text-white rounded-xl hover:opacity-90 font-semibold btn-ios-press">
                        <i class="fas fa-home mr-2"></i> Quay l·∫°i Menu Ch√≠nh
                    </button>
                </div>
            `;
        }


        // --- View Render Functions (iOS Style Placeholders - UPDATED TO IFRAME) ---
        
        const renderIframeView = (file, name, delay = 0.2) => {
            const contentEl = document.getElementById('dashboard-content');
            contentEl.innerHTML = `
                <div class="iframe-container animate-stagger-in" style="animation-delay: ${delay}s;">
                    <iframe src="${file}" title="${name}" class="iframe-content"></iframe>
                </div>
            `;
        };
        
        // L·∫•y th√¥ng tin file t·ª´ MENU_ITEMS
        const getFile = (id) => MENU_ITEMS.find(item => item.id === id).file;
        const getName = (id) => MENU_ITEMS.find(item => item.id === id).name;


        function renderSalesView() {
            renderIframeView(getFile('sales'), getName('sales')); // banhang.html
        }

        function renderStatsView() {
            renderIframeView(getFile('stats'), getName('stats')); // thongke.html
        }

        function renderRevenueExpenseView() {
            renderIframeView(getFile('revenue_expense'), getName('revenue_expense')); // thuchi.html
        }

        function renderInventoryView() {
            renderIframeView(getFile('inventory'), getName('inventory')); // quanlytonkho.html
        }

        function renderKitchenBarView() {
            renderIframeView(getFile('kitchen_bar'), getName('kitchen_bar')); // bepba.html
        }
        
        // --- Personnel Management View (KEPT INTACT - iOS Styling Applied) ---

        function renderPersonnelView() {
            const contentEl = document.getElementById('dashboard-content');
            contentEl.innerHTML = `
                <div class="p-4 md:p-6 card-style animate-stagger-in">
                    <h3 class="text-2xl font-bold mb-6" style="color: var(--ios-blue);">Qu·∫£n l√Ω Nh√¢n s·ª± & Ph√¢n quy·ªÅn</h3>
                    <div class="mb-6 flex space-x-4">
                       <button id="show-add-user-btn" 
    class="p-3 bg-green-500 text-white rounded-xl hover:bg-green-600 font-medium shadow-md flex items-center gap-2">
    <i class="fas fa-user-plus"></i> 
    <span class="text-base">T·∫°o T√†i kho·∫£n m·ªõi</span>
</button>

                    </div>

                    <div id="add-user-form" class="bg-ios-gray-bg p-4 md:p-6 rounded-xl shadow-inner mb-8 hidden animate-stagger-in" style="border: 1px solid #E5E5EA;">
                        <h4 class="text-xl font-semibold mb-4" style="color: var(--ios-text-primary);">T·∫°o T√†i kho·∫£n Nh√¢n vi√™n</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-ios-text-secondary">T√™n ƒëƒÉng nh·∫≠p</label>
                                <input type="text" id="new-user-username" class="mt-1 p-3 w-full border rounded-xl focus:ring-ios-blue focus:border-ios-blue transition">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-ios-text-secondary">M·∫≠t kh·∫©u</label>
                                <input type="password" id="new-user-password" class="mt-1 p-3 w-full border rounded-xl focus:ring-ios-blue focus:border-ios-blue transition">
                            </div>
                        </div>
                        <div class="mt-4">
                            <label class="block text-sm font-medium text-ios-text-secondary">Vai tr√≤ / Ph√¢n quy·ªÅn</label>
                            <select id="new-user-role" class="mt-1 p-3 w-full border rounded-xl bg-white focus:ring-ios-blue focus:border-ios-blue transition">
                                <option value="waiter">Nh√¢n vi√™n Ph·ª•c v·ª• (waiter) - Ch·ªâ B√°n h√†ng</option>
                                <option value="cashier">Nh√¢n vi√™n Thu ng√¢n (cashier) - B√°n h√†ng, Th·ªëng k√™, Thu Chi</option>
                                <option value="kitchen_bar_staff">Nh√¢n vi√™n B·∫øp & Pha ch·∫ø (kitchen_bar_staff) - T·ªìn kho, B·∫øp/Bar</option>
                                <option value="accountant">Nh√¢n vi√™n K·∫ø to√°n (accountant) - Th·ªëng k√™, Thu Chi, Nh√¢n s·ª±</option>
                            </select>
                        </div>
                        <div class="flex space-x-3 mt-6">
<button id="submit-new-user" 
    class="flex-1 p-3 bg-blue-600 text-white rounded-xl hover:bg-blue-700 font-semibold shadow-md flex items-center justify-center gap-2">
    <i class="fas fa-save"></i>
    <span class="text-base">L∆∞u T√†i kho·∫£n</span>
</button>
                            <button id="hide-add-user-btn" class="flex-1 p-3 bg-gray-300 text-gray-700 rounded-xl hover:bg-gray-400 font-medium btn-ios-press">H·ªßy</button>
                        </div>
                    </div>

                    <h4 class="text-xl font-semibold mb-3 mt-6">Danh s√°ch Nh√¢n vi√™n</h4>
                    <div class="overflow-x-auto card-style p-0" style="box-shadow: none;">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-ios-gray-bg">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-semibold text-ios-text-secondary uppercase tracking-wider">T√™n ƒêƒÉng nh·∫≠p</th>
                                    <th class="px-4 py-3 text-left text-xs font-semibold text-ios-text-secondary uppercase tracking-wider">Vai tr√≤</th>
                                    <th class="px-4 py-3 text-left text-xs font-semibold text-ios-text-secondary uppercase tracking-wider hidden sm:table-cell">Quy·ªÅn h·∫°n</th>
                                    <th class="px-4 py-3 text-right text-xs font-semibold text-ios-text-secondary uppercase tracking-wider">H√†nh ƒë·ªông</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200" id="user-list-tbody">
                                </tbody>
                        </table>
                    </div>
                </div>
            `;
            // Attach event listeners and load data for Personnel View
            setupPersonnelListeners();
            loadUserList();
        }

        // --- Personnel Management Logic (Firebase not modified) ---
        function setupPersonnelListeners() {
            const showBtn = document.getElementById('show-add-user-btn');
            const hideBtn = document.getElementById('hide-add-user-btn');
            const formDiv = document.getElementById('add-user-form');
            const submitBtn = document.getElementById('submit-new-user');

            showBtn.onclick = () => formDiv.classList.remove('hidden');
            hideBtn.onclick = () => formDiv.classList.add('hidden');
            submitBtn.onclick = saveNewUser;
        }

        async function loadUserList() {
            // Note: This logic only runs if switchView('personnel') is called.
            const tbody = document.getElementById('user-list-tbody');
            tbody.innerHTML = '<tr><td colspan="4" class="p-4 text-center text-ios-text-secondary">ƒêang t·∫£i danh s√°ch...</td></tr>';

            const usersRef = database.ref('users');
            usersRef.on('value', (snapshot) => {
                const users = snapshot.val();
                if (currentViewId !== 'personnel') return; // Prevent updating DOM if user navigated away

                tbody.innerHTML = '';
                if (users) {
                    let delay = 0.0;
                    Object.keys(users).forEach(uid => {
                        const user = users[uid];
                        // Use explicit permissions list for display
                        const userPermissions = (user.role === 'admin' ? MENU_ITEMS.map(item => item.id) : PERMISSIONS[user.role]) || [];
                        const permissionsText = userPermissions.join(', ');
                        
                        const row = document.createElement('tr');
                        
                        // Add iOS row animation style
                        row.className = 'hover:bg-ios-gray-bg animate-stagger-in';
                        row.style.animationDelay = `${delay}s`;
                        
                        row.innerHTML = `
                            <td class="px-4 py-3 whitespace-nowrap font-medium text-ios-text-primary">${user.username}</td>
                            <td class="px-4 py-3 whitespace-nowrap">
                                <span class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full" style="background-color: ${user.role === 'admin' ? '#FEE2E2' : '#D1F7C4'}; color: ${user.role === 'admin' ? '#B91C1C' : '#15803D'};">
                                    ${user.role.toUpperCase()}
                                </span>
                            </td>
                            <td class="px-4 py-3 text-sm text-ios-text-secondary hidden sm:table-cell">${permissionsText}</td>
                            <td class="px-4 py-3 whitespace-nowrap text-right text-sm font-medium">
                                ${user.role !== 'admin' ? 
                                    `<button onclick="deleteUser('${uid}', '${user.username}')" class="text-ios-red hover:text-red-800 ml-4 btn-ios-press">X√≥a</button>` :
                                    `<span class="text-ios-text-secondary opacity-50">Admin</span>`}
                            </td>
                        `;
                        tbody.appendChild(row);
                        delay += 0.05;
                    });
                } else {
                    tbody.innerHTML = '<tr><td colspan="4" class="p-4 text-center text-ios-text-secondary">Ch∆∞a c√≥ t√†i kho·∫£n n√†o.</td></tr>';
                }
            });
        }

        async function saveNewUser() {
            const username = document.getElementById('new-user-username').value.trim();
            const password = document.getElementById('new-user-password').value.trim();
            const role = document.getElementById('new-user-role').value;
            const formDiv = document.getElementById('add-user-form');

            if (!username || !password) {
                customAlert('Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß T√™n ƒëƒÉng nh·∫≠p v√† M·∫≠t kh·∫©u.');
                return;
            }

            const usersSnapshot = await database.ref('users').orderByChild('username').equalTo(username).once('value');
            if (usersSnapshot.exists()) {
                customAlert('T√™n ƒëƒÉng nh·∫≠p n√†y ƒë√£ t·ªìn t·∫°i. Vui l√≤ng ch·ªçn t√™n kh√°c.');
                return;
            }

            const confirm = await customConfirm(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën t·∫°o t√†i kho·∫£n "${username}" v·ªõi vai tr√≤ "${role}"?`);
            if (!confirm) return;

            const newUserRef = database.ref('users').push(); 
            const userData = {
                username: username,
                password: password,
                role: role,
                createdAt: new Date().toISOString()
            };

            newUserRef.set(userData)
                .then(() => {
                    customAlert(`ƒê√£ t·∫°o th√†nh c√¥ng t√†i kho·∫£n: ${username}`);
                    document.getElementById('new-user-username').value = '';
                    document.getElementById('new-user-password').value = '';
                    formDiv.classList.add('hidden');
                })
                .catch(error => {
                    customAlert(`L·ªói khi t·∫°o t√†i kho·∫£n: ${error.message}`, 'L·ªói Firebase');
                    console.error("L·ªói Firebase:", error);
                });
        }
        
        async function deleteUser(uid, username) {
            const confirm = await customConfirm(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a t√†i kho·∫£n "${username}"? D·ªØ li·ªáu n√†y kh√¥ng th·ªÉ ph·ª•c h·ªìi.`, 'C·∫£nh b√°o');
            if (!confirm) return;

            database.ref(`users/${uid}`).remove()
                .then(() => {
                    customAlert(`ƒê√£ x√≥a th√†nh c√¥ng t√†i kho·∫£n: ${username}`);
                })
                .catch(error => {
                    customAlert(`L·ªói khi x√≥a t√†i kho·∫£n: ${error.message}`, 'L·ªói Firebase');
                    console.error("L·ªói Firebase:", error);
                });
        }
        
        document.addEventListener('DOMContentLoaded', async () => {
    await createInitialAdmin();

    document.getElementById('login-button').addEventListener('click', loginUser);
    document.getElementById('logout-button').addEventListener('click', logoutUser);
    document.getElementById('logout-button-mobile').addEventListener('click', logoutUser);

    document.getElementById('password').addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            loginUser();
        }
    });

    // üëâ Ki·ªÉm tra localStorage khi load trang
    const savedUser = localStorage.getItem("currentUser");
    if (savedUser) {
        const user = JSON.parse(savedUser);
        showDashboardScreen(user); 
    } else {
        showLoginScreen(); 
    }
});
// Th√™m h√†m n√†y v√†o nh√≥m "View Render Functions (iOS Style Placeholders - UPDATED TO IFRAME)"

function renderMenuView() {
    renderIframeView(getFile('menu_management'), getName('menu_management')); // menu.html
}

// ... c√°c h√†m render kh√°c (renderSalesView, renderStatsView, v.v.)

    </script>
</body>
</html>
