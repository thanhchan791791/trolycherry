<!doctype html>
<html lang="vi">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Sổ Thu Chi Hàng Ngày - Firebase</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">

    <style>
        :root {
            --primary-color: #4CAF50; /* Green */
            --secondary-color: #e0e7f7;
            --text-color: #34495e; /* Dark Blue */
            --light-bg: #f9fbfd;
            --card-bg: #ffffff;
            --shadow-light: rgba(0, 0, 0, 0.05);
            --border-color: #e6e9ed;
            --positive: #28a745;
            --negative: #dc3545;
            --cash: #ffc107; /* Amber for Cash */
            --transfer: #007bff; /* Blue for Transfer */
        }

        body {
            background-color: var(--light-bg);
            font-family: 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
            color: var(--text-color);
            transition: background-color 0.3s ease;
        }
        .container-fluid {
            max-width: 1200px;
        }
        .card {
            border: none;
            border-radius: 1.5rem;
            box-shadow: 0 10px 30px var(--shadow-light);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.1);
        }
        .card-header-styled {
            background: linear-gradient(45deg, var(--primary-color), #81c784);
            color: white;
            padding: 1.5rem 2rem;
            border-top-left-radius: 1.5rem;
            border-top-right-radius: 1.5rem;
            margin-bottom: 1.5rem;
        }
        .form-control, .form-select {
            border-radius: 0.75rem;
            border: 1px solid var(--border-color);
            padding: 0.75rem 1rem;
            transition: all 0.3s ease;
        }
        .form-control:focus, .form-select:focus {
            box-shadow: 0 0 0 0.25rem rgba(76, 175, 80, 0.25);
            border-color: var(--primary-color);
        }
        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
            border-radius: 0.75rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        .btn-primary:hover {
            background-color: #388e3c;
            border-color: #388e3c;
            transform: translateY(-2px);
        }
        .btn-outline-secondary, .btn-light {
            border-radius: 0.75rem;
            transition: all 0.3s ease;
        }
        .btn-outline-secondary:hover {
            background-color: var(--secondary-color);
        }
        .btn-sm-custom {
            border-radius: 0.5rem;
            font-size: 0.8rem;
            padding: 0.3rem 0.6rem;
        }
        .balance-box {
            background-color: var(--card-bg); /* Use white background for filtered totals */
            border: 1px solid var(--border-color);
            border-radius: 1.25rem;
            padding: 1.5rem;
            text-align: center;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            transition: all 0.3s ease;
        }
        .balance-box:hover {
            transform: scale(1.03);
            box-shadow: 0 5px 15px var(--shadow-light);
        }
        .balance-box .small-muted {
            font-size: 0.9rem;
            color: #6c757d;
        }
        .balance-box .h4 {
            font-weight: 700;
            margin-top: 0.5rem;
        }
        .balance-positive {
            color: var(--positive);
        }
        .balance-negative {
            color: var(--negative);
        }
        .balance-cash {
            color: var(--cash);
        }
        .balance-transfer {
            color: var(--transfer);
        }
        .total-summary {
            background-color: #f0f4fa;
            border-radius: 1.5rem;
            padding: 1.5rem;
        }
        /* Style for the overall totals box (different background) */
        .overall-totals .balance-box {
            background-color: var(--secondary-color); /* Retain secondary color for overall totals */
            border: none;
        }
        .table-fixed {
            max-height: 500px;
            overflow-y: auto;
            overflow-x: auto;
            border-radius: 1.5rem;
        }
        .table-fixed::-webkit-scrollbar {
            width: 8px;
        }
        .table-fixed::-webkit-scrollbar-thumb {
            background-color: #d1d8e0;
            border-radius: 10px;
        }
        .table-fixed::-webkit-scrollbar-track {
            background-color: transparent;
        }
        .table {
            --bs-table-bg: var(--card-bg);
        }
        .table thead th {
            position: sticky;
            top: 0;
            background-color: var(--card-bg);
            box-shadow: 0 2px 2px -1px rgba(0, 0, 0, 0.1);
            z-index: 10;
        }
        .table tbody tr {
            transition: all 0.2s ease;
        }
        .table tbody tr:hover {
            background-color: #f0f4f7 !important;
        }
        .action-cell .btn {
            margin-right: 0.25rem;
            transition: all 0.2s ease;
        }
        .action-cell .btn:hover {
            transform: scale(1.1);
        }
        .fade-in {
            animation: fadeIn 0.8s ease-out;
        }
        .fade-in-up {
            animation: fadeInUp 0.6s ease-out forwards;
            opacity: 0;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes fadeInUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        /* CSS cho mobile, chỉ áp dụng cho bảng lịch sử giao dịch chính */
        @media (max-width: 767.98px) {
            .table.table-hover {
                width: 100%;
            }
            .table-fixed {
                border: 1px solid var(--border-color);
            }
            .table.table-hover thead, .action-header {
                display: none;
            }
            .table.table-hover tbody tr {
                display: block;
                margin-bottom: 1rem;
                border: 1px solid var(--border-color);
                border-radius: 1rem;
                padding: 1rem;
                box-shadow: 0 4px 12px var(--shadow-light);
            }
            .table.table-hover tbody tr:hover {
                background-color: var(--card-bg) !important;
                transform: translateY(-2px);
            }
            .table.table-hover td {
                display: block;
                text-align: right;
                border: none;
                padding: 0.5rem 0;
                position: relative;
                padding-left: 50%;
            }
            .table.table-hover td::before {
                content: attr(data-label);
                position: absolute;
                left: 10px;
                width: calc(50% - 20px);
                text-align: left;
                font-weight: bold;
                color: #6c757d;
            }
            .table.table-hover td button {
                width: 100%;
                margin: 0.25rem 0;
            }
            
            /* Điều chỉnh kích thước cột cho mobile */
            .total-summary .row.g-3 > div {
                flex: 0 0 100%;
                max-width: 100%;
            }
        }
        
        .transfer-wallet-box {
            background-color: var(--transfer);
            color: white;
            border: none;
        }
        .transfer-wallet-box .small-muted {
            color: rgba(255, 255, 255, 0.8);
        }
    </style>
</head>
<body>
    <div class="container-fluid py-5">
        <div class="d-flex align-items-center mb-4 fade-in">
            <h1 class="me-3 fw-bold text-primary">Sổ Thu Chi</h1>
            <div class="badge bg-secondary-subtle text-secondary small-muted py-2 px-3 rounded-pill">Đồng bộ qua Firebase (Realtime)</div>
        </div>

        <div class="row g-4">
            <div class="col-lg-5">
                <div class="card p-4 fade-in-up">
                    <div class="card-header-styled mb-4">
                        <h4 class="mb-0 text-white"><i class="fas fa-plus-circle me-2"></i> Thêm Giao Dịch Mới</h4>
                    </div>
                    <div class="d-grid gap-3 d-md-flex justify-content-md-start mb-4">
                        <button type="button" class="btn btn-success btn-lg flex-fill" id="addRevenueBtn"><i class="fas fa-arrow-down me-2"></i> Thêm Giao Dịch Thu</button>
                        <button type="button" class="btn btn-info btn-lg flex-fill" id="addExpenseBtn"><i class="fas fa-wallet me-2"></i> Rút về Ví Duy trì</button>
                        </div>

                    <hr class="text-secondary-subtle my-4">

                    <div class="total-summary text-center">
                        <h5 class="fw-bold mb-3"><i class="fas fa-chart-pie me-2"></i> Tổng hợp (Tất cả dữ liệu)</h5>
                        <div class="row g-3 overall-totals">
                            <div class="col-6 col-md-4">
                                <div class="balance-box">
                                    <div class="small-muted">Thu Tiền mặt</div>
                                    <div id="totalRevenueCash" class="h4 balance-cash">0 ₫</div>
                                </div>
                            </div>
                            <div class="col-6 col-md-4">
                                <div class="balance-box">
                                    <div class="small-muted">Thu Chuyển khoản</div>
                                    <div id="totalRevenueTransfer" class="h4 balance-transfer">0 ₫</div>
                                </div>
                            </div>
                            <div class="col-12 col-md-4">
                                <div class="balance-box">
                                    <div class="small-muted">Tổng tiền đã rút về ví</div>
                                    <div id="totalExpense" class="h4 balance-negative">0 ₫</div>
                                </div>
                            </div>
                            <div class="col-6 col-md-6">
                                <div class="balance-box">
                                    <div class="small-muted">Tổng Dư</div>
                                    <div id="totalBalance" class="h4">0 ₫</div>
                                </div>
                            </div>
                            <div class="col-6 col-md-6">
                                <div class="balance-box">
                                    <div class="d-flex justify-content-between align-items-center w-100">
                                        <div class="text-start">
                                            <div class="small-muted">Dư Tiền mặt</div>
                                            <div id="totalBalanceCash" class="h4">0 ₫</div>
                                        </div>
                                        <button id="withdrawFromWalletBtn" class="btn btn-sm btn-outline-secondary btn-sm-custom ms-2" title="Rút tiền từ Ví Chuyển khoản về Tiền mặt"><i class="fas fa-undo me-1"></i> Rút tiền</button>
                                    </div>
                                </div>
                            </div>
                            <div class="col-12 col-md-6">
                                <div class="balance-box transfer-wallet-box">
                                    <div class="d-flex justify-content-between align-items-center w-100">
                                        <div class="text-start">
                                            <div class="small-muted">Ví Chuyển Khoản</div>
                                            <div id="totalWalletBalance" class="h4 text-white">0 ₫</div>
                                        </div>
                                        <button id="transferToWalletBtn" class="btn btn-sm btn-light btn-sm-custom ms-2"><i class="fas fa-exchange-alt me-1"></i> Quản lý Ví</button>
                                    </div>
                                </div>
                            </div>
                            </div>

                        <hr class="text-secondary-subtle my-4">
                        <button id="toggleDateFilterBtn" class="btn btn-sm btn-outline-primary mb-3">
                            <i class="fas fa-calendar-check me-2"></i> **Thống kê theo Ngày Cụ thể**
                        </button>

                        <div id="dateFilterControls" style="display: none;">
                            <h5 class="fw-bold mb-3 text-start"><i class="fas fa-sliders-h me-2"></i> Chọn Ngày Cụ thể</h5>
                            <div class="row g-3 align-items-end mb-4">
                                <div class="col-12 col-md-8">
                                    <label for="specificDateFilter" class="form-label small-muted mb-1">Ngày</label>
                                    <input type="date" id="specificDateFilter" class="form-control" />
                                </div>
                                <div class="col-12 col-md-4">
                                    <button id="applyDateFilterBtn" class="btn btn-primary w-100"><i class="fas fa-filter me-1"></i> Lọc & Hiển thị</button>
                                </div>
                            </div>

                            <div id="filteredTotals" class="row g-3">
                                <div class="col-6 col-md-4">
                                    <div class="balance-box">
                                        <div class="small-muted">Thu Tiền mặt đã lọc</div>
                                        <div id="filteredRevenueCash" class="h4 balance-cash">0 ₫</div>
                                    </div>
                                </div>
                                <div class="col-6 col-md-4">
                                    <div class="balance-box">
                                        <div class="small-muted">Thu Chuyển khoản đã lọc</div>
                                        <div id="filteredRevenueTransfer" class="h4 balance-transfer">0 ₫</div>
                                    </div>
                                </div>
                                <div class="col-12 col-md-4">
                                    <div class="balance-box">
                                        <div class="small-muted">Chi tiêu đã lọc</div>
                                        <div id="filteredExpense" class="h4 balance-negative">0 ₫</div>
                                    </div>
                                </div>
                                <div class="col-6 col-md-6">
                                    <div class="balance-box">
                                        <div class="small-muted">Số Dư đã lọc</div>
                                        <div id="filteredBalance" class="h4">0 ₫</div>
                                    </div>
                                </div>
                                <div class="col-6 col-md-6">
                                    <div class="balance-box">
                                        <div class="small-muted">Dư Tiền mặt đã lọc</div>
                                        <div id="filteredBalanceCash" class="h4">0 ₫</div>
                                    </div>
                                </div>
                                </div>
                        </div>
                        </div>

                    <div class="mt-4 d-flex flex-wrap gap-2">
                        <button id="exportCsv" class="btn btn-sm btn-outline-success btn-sm-custom"><i class="fas fa-file-csv me-1"></i> CSV</button>
                        <button id="exportJson" class="btn btn-sm btn-outline-primary btn-sm-custom"><i class="fas fa-file-code me-1"></i> JSON</button>
                        <input type="file" id="importFile" accept=".json" style="display:none;">
                        <button id="importJsonBtn" class="btn btn-sm btn-outline-dark btn-sm-custom"><i class="fas fa-upload me-1"></i> Import</button>
                       
                    </div>                </div>
            </div>

            <div class="col-lg-7">
                <div class="card p-4 fade-in-up">
                    <div class="d-flex align-items-center mb-3">
                        <h4 class="mb-0 fw-bold me-auto" id="reportTitle"><i class="fas fa-history me-2"></i> Lịch sử Giao dịch</h4>
                        <div class="d-flex align-items-center gap-2">
                            <select id="reportView" class="form-select form-select-sm">
                                <option value="day">Theo Ngày</option>
                                <option value="month">Theo Tháng</option>
                                <option value="quarter">Theo Quý</option>
                            </select>
                            <select id="sortOrder" class="form-select form-select-sm">
                                <option value="desc">Mới nhất</option>
                                <option value="asc">Cũ nhất</option>
                            </select>
                        </div>
                    </div>

                    <div class="table-fixed">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr id="tableHeader">
                                    <th class="date-header">Ngày</th>
                                    <th>Doanh thu</th>
                                    <th>Chi tiêu</th>
                                    <th>Số dư</th>
                                    <th>Chi tiết</th>
                                    <th class="action-header">Hành động</th>
                                </tr>
                            </thead>
                            <tbody id="historyBody">
                                </tbody>
                        </table>
                    </div>
                    <div id="noDataMessage" class="text-center text-muted p-4 d-none">
                        <i class="fas fa-box-open fa-2x mb-2"></i>
                        <p>Chưa có dữ liệu nào. Hãy thêm giao dịch đầu tiên!</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="addTransactionModal" tabindex="-1" aria-labelledby="addTransactionModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addTransactionModalLabel"></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="addTransactionForm">
                    <div class="modal-body">
                        <input type="hidden" id="transactionType">
                        <div class="mb-3">
                            <label class="form-label fw-bold">Ngày</label>
                            <input type="date" id="modalEntryDate" class="form-control" required>
                        </div>
                        
                        <div id="revenueFields" style="display: none;">
                            <div class="row g-3 mb-3">
                                <div class="col-md-6">
                                    <label class="form-label fw-bold"><i class="fas fa-money-bill-wave me-1 text-warning"></i> Thu Tiền mặt (VND)</label>
                                    <input type="text" id="modalAmountCash" class="form-control currency-input" value="0">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-bold"><i class="fas fa-exchange-alt me-1 text-primary"></i> Thu Chuyển khoản (VND)</label>
                                    <input type="text" id="modalAmountTransfer" class="form-control currency-input" value="0">
                                </div>
                            </div>
                        </div>

                        <div class="mb-3" id="expenseField" style="display: none;">
                            <label class="form-label fw-bold" id="modalAmountLabel"></label>
                            <input type="text" id="modalAmount" class="form-control currency-input" required>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label fw-bold">Chi tiết Giao dịch</label>
                            <textarea id="modalDetails" class="form-control" rows="3"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                        <button type="submit" class="btn btn-primary" id="modalSubmitBtn"></button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <div class="modal fade" id="transferModal" tabindex="-1" aria-labelledby="transferModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="transferModalLabel"><i class="fas fa-exchange-alt me-2"></i> Quản Lý Ví Chuyển Khoản</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <ul class="nav nav-tabs mb-3" id="transferTab" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="transfer-form-tab" data-bs-toggle="tab" data-bs-target="#transfer-form-pane" type="button" role="tab" aria-controls="transfer-form-pane" aria-selected="true"><i class="fas fa-hand-holding-usd me-1"></i> Nạp Ví</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="expense-form-tab" data-bs-toggle="tab" data-bs-target="#expense-form-pane" type="button" role="tab" aria-controls="expense-form-pane" aria-selected="false"><i class="fas fa-wallet me-1"></i> Chi Ví</button>
                        </li>
                         <li class="nav-item" role="presentation">
                            <button class="nav-link" id="withdraw-form-tab" data-bs-toggle="tab" data-bs-target="#withdraw-form-pane" type="button" role="tab" aria-controls="withdraw-form-pane" aria-selected="false"><i class="fas fa-undo me-1"></i> Rút Ví</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="transfer-history-tab" data-bs-toggle="tab" data-bs-target="#transfer-history-pane" type="button" role="tab" aria-controls="transfer-history-pane" aria-selected="false"><i class="fas fa-history me-1"></i> Lịch sử Chuyển/Chi</button>
                        </li>
                    </ul>
                    <div class="tab-content" id="transferTabContent">
                        <div class="tab-pane fade show active" id="transfer-form-pane" role="tabpanel" aria-labelledby="transfer-form-tab" tabindex="0">
                            <form id="transferForm">
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Ngày Nạp</label>
                                    <input type="date" id="transferDate" class="form-control" required>
                                </div>
                                <div class="mb-3 p-3 border rounded">
                                    <p class="mb-1 small-muted">Số Dư Tiền Mặt Hiện Có (Giới hạn nạp):</p>
                                    <h4 id="availableCashBalance" class="balance-cash fw-bold">0 ₫</h4>
                                    <input type="hidden" id="hiddenAvailableCashBalance" value="0">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Số Tiền Muốn Nạp vào Ví Chuyển Khoản (VND)</label>
                                    <input type="text" id="transferAmount" class="form-control currency-input" required placeholder="Nhập số tiền">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Chi tiết</label>
                                    <textarea id="transferDetails" class="form-control" rows="2">Chuyển tiền từ Tiền mặt sang Ví Chuyển khoản</textarea>
                                </div>
                                <div class="modal-footer px-0 pb-0">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                                    <button type="submit" class="btn btn-primary" id="transferSubmitBtn"><i class="fas fa-paper-plane me-1"></i> Xác Nhận Nạp</button>
                                </div>
                            </form>
                        </div>
                        
                        <div class="tab-pane fade" id="expense-form-pane" role="tabpanel" aria-labelledby="expense-form-tab" tabindex="0">
                            <form id="walletExpenseForm">
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Ngày Chi</label>
                                    <input type="date" id="walletExpenseDate" class="form-control" required>
                                </div>
                                <div class="mb-3 p-3 border rounded">
                                    <p class="mb-1 small-muted">Số Dư Ví Chuyển Khoản Hiện Có (Giới hạn chi):</p>
                                    <h4 id="availableWalletBalance" class="balance-transfer fw-bold">0 ₫</h4>
                                    <input type="hidden" id="hiddenAvailableWalletBalance" value="0">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Số Tiền Muốn Chi từ Ví Chuyển Khoản (VND)</label>
                                    <input type="text" id="walletExpenseAmount" class="form-control currency-input" required placeholder="Nhập số tiền chi">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Chi tiết Chi tiêu</label>
                                    <textarea id="walletExpenseDetails" class="form-control" rows="2" required></textarea>
                                </div>
                                <div class="modal-footer px-0 pb-0">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                                    <button type="submit" class="btn btn-danger" id="walletExpenseSubmitBtn"><i class="fas fa-paper-plane me-1"></i> Xác Nhận Chi Ví</button>
                                </div>
                            </form>
                        </div>

                         <div class="tab-pane fade" id="withdraw-form-pane" role="tabpanel" aria-labelledby="withdraw-form-tab" tabindex="0">
                            <form id="withdrawForm">
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Ngày Rút</label>
                                    <input type="date" id="withdrawDate" class="form-control" required>
                                </div>
                                <div class="mb-3 p-3 border rounded">
                                    <p class="mb-1 small-muted">Số Dư Ví Chuyển Khoản Hiện Có (Giới hạn rút):</p>
                                    <h4 id="availableWalletBalanceWithdraw" class="balance-transfer fw-bold">0 ₫</h4>
                                    <input type="hidden" id="hiddenAvailableWalletBalanceWithdraw" value="0">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Số Tiền Muốn Rút về Tiền Mặt (VND)</label>
                                    <input type="text" id="withdrawAmount" class="form-control currency-input" required placeholder="Nhập số tiền">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Chi tiết</label>
                                    <textarea id="withdrawDetails" class="form-control" rows="2">Rút tiền từ Ví Chuyển khoản về Tiền mặt</textarea>
                                </div>
                                <div class="modal-footer px-0 pb-0">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                                    <button type="submit" class="btn btn-warning" id="withdrawSubmitBtn"><i class="fas fa-paper-plane me-1"></i> Xác Nhận Rút</button>
                                </div>
                            </form>
                        </div>

                        <div class="tab-pane fade" id="transfer-history-pane" role="tabpanel" aria-labelledby="transfer-history-tab" tabindex="0">
                            <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                                <table class="table table-striped table-sm mb-0">
                                    <thead>
                                        <tr>
                                            <th>Ngày</th>
                                            <th>Loại</th>
                                            <th>Số Tiền</th>
                                            <th>Chi tiết</th>
                                            <th>Hành động</th>
                                        </tr>
                                    </thead>
                                    <tbody id="transferHistoryBody">
                                        </tbody>
                                    <div id="noTransferDataMessage" class="text-center text-muted p-4 d-none">
                                        <i class="fas fa-box-open fa-2x mb-2"></i>
                                        <p>Chưa có giao dịch nạp/chi ví nào.</p>
                                    </div>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="detailsModal" tabindex="-1" aria-labelledby="detailsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="detailsModalLabel">Chi tiết Giao dịch</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="detailsModalBody">
                    </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

    <script>
    // Cấu hình Firebase của bạn
    const firebaseConfig = {
      apiKey: "AIzaSyB8uLkLJFlzmCodcawJhs2dRckHQzO5y10",
      authDomain: "chitieu-7263e.firebaseapp.com",
      databaseURL: "https://chitieu-7263e-default-rtdb.firebaseio.com",
      projectId: "chitieu-7263e",
      storageBucket: "chitieu-7263e.firebasestorage.app",
      messagingSenderId: "83833140682",
      appId: "1:83833140682:web:f9254b418ace3a659fcb33",
      measurementId: "G-523X74K18N"
    };

    // Khởi tạo Firebase
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    const recordsRef = database.ref('daily_records');
    // Reference for Wallet Transfers
    const walletTransfersRef = database.ref('wallet_transfers');
    // NEW: Reference for Wallet History node (vi/lichsu)
    const viLichSuRef = database.ref('vi/lichsu'); // <--- THÊM DÒNG NÀY

    // UI Elements
    const addRevenueBtn = document.getElementById('addRevenueBtn');
    const addExpenseBtn = document.getElementById('addExpenseBtn'); // Đã đổi chức năng thành Rút về Ví Duy trì
    const addTransactionModal = new bootstrap.Modal(document.getElementById('addTransactionModal'));
    const addTransactionForm = document.getElementById('addTransactionForm');
    const modalTitle = document.getElementById('addTransactionModalLabel');
    const modalAmountLabel = document.getElementById('modalAmountLabel');
    const modalSubmitBtn = document.getElementById('modalSubmitBtn');
    const transactionTypeEl = document.getElementById('transactionType');
    const modalEntryDateEl = document.getElementById('modalEntryDate');
    const modalAmountEl = document.getElementById('modalAmount'); // Expense Amount
    const modalAmountCashEl = document.getElementById('modalAmountCash'); // Cash Amount
    const modalAmountTransferEl = document.getElementById('modalAmountTransfer'); // Transfer Amount
    const modalDetailsEl = document.getElementById('modalDetails');
    const historyBodyEl = document.getElementById('historyBody');
    // Overall Totals
    const totalRevenueCashEl = document.getElementById('totalRevenueCash');
    const totalRevenueTransferEl = document.getElementById('totalRevenueTransfer');
    const totalExpenseEl = document.getElementById('totalExpense');
    const totalBalanceEl = document.getElementById('totalBalance');
    const totalBalanceCashEl = document.getElementById('totalBalanceCash');
    const totalWalletBalanceEl = document.getElementById('totalWalletBalance'); // Wallet Balance

    const sortOrderEl = document.getElementById('sortOrder');
    const reportViewEl = document.getElementById('reportView');
    const reportTitleEl = document.getElementById('reportTitle');
    const tableHeaderEl = document.getElementById('tableHeader');
    const noDataMessageEl = document.getElementById('noDataMessage');
    const addSampleBtn = document.getElementById('addSampleBtn');
    const detailsModal = new bootstrap.Modal(document.getElementById('detailsModal'));
    const detailsModalBodyEl = document.getElementById('detailsModalBody');
    
    // UI Elements for Modal
    const revenueFieldsEl = document.getElementById('revenueFields'); // Revenue Fields Container
    const expenseFieldEl = document.getElementById('expenseField'); // Existing Expense Field Container

    // UI Elements for Date Filter (UPDATED)
    const toggleDateFilterBtn = document.getElementById('toggleDateFilterBtn'); // Nút Ẩn/Hiện
    const dateFilterControlsEl = document.getElementById('dateFilterControls'); // Khối điều khiển
    const specificDateFilterEl = document.getElementById('specificDateFilter'); // CHANGED ID
    const applyDateFilterBtn = document.getElementById('applyDateFilterBtn');
    // Filtered Totals
    const filteredRevenueCashEl = document.getElementById('filteredRevenueCash');
    const filteredRevenueTransferEl = document.getElementById('filteredRevenueTransfer');
    const filteredExpenseEl = document.getElementById('filteredExpense');
    const filteredBalanceEl = document.getElementById('filteredBalance');
    const filteredBalanceCashEl = document.getElementById('filteredBalanceCash');
    // const filteredWalletBalanceEl = document.getElementById('filteredWalletBalance'); // REMOVED/HIDDEN

    // UI Elements for Transfer Modal
    const transferToWalletBtn = document.getElementById('transferToWalletBtn');
    const withdrawFromWalletBtn = document.getElementById('withdrawFromWalletBtn'); // Button in Cash Balance box
    const transferModal = new bootstrap.Modal(document.getElementById('transferModal'));
    // Nạp Ví (Transfer In)
    const transferForm = document.getElementById('transferForm');
    const transferDateEl = document.getElementById('transferDate');
    const availableCashBalanceEl = document.getElementById('availableCashBalance');
    const hiddenAvailableCashBalanceEl = document.getElementById('hiddenAvailableCashBalance');
    const transferAmountEl = document.getElementById('transferAmount');
    const transferDetailsEl = document.getElementById('transferDetails');
    // Chi Ví (Wallet Expense)
    const walletExpenseForm = document.getElementById('walletExpenseForm');
    const walletExpenseDateEl = document.getElementById('walletExpenseDate');
    const availableWalletBalanceEl = document.getElementById('availableWalletBalance');
    const hiddenAvailableWalletBalanceEl = document.getElementById('hiddenAvailableWalletBalance');
    const walletExpenseAmountEl = document.getElementById('walletExpenseAmount');
    const walletExpenseDetailsEl = document.getElementById('walletExpenseDetails');
    // Rút Ví (Withdrawal)
    const withdrawForm = document.getElementById('withdrawForm');
    const withdrawDateEl = document.getElementById('withdrawDate');
    const availableWalletBalanceWithdrawEl = document.getElementById('availableWalletBalanceWithdraw');
    const hiddenAvailableWalletBalanceWithdrawEl = document.getElementById('hiddenAvailableWalletBalanceWithdraw');
    const withdrawAmountEl = document.getElementById('withdrawAmount');
    const withdrawDetailsEl = document.getElementById('withdrawDetails');
    // UI for History Tab
    const transferHistoryBodyEl = document.getElementById('transferHistoryBody');
    const noTransferDataMessageEl = document.getElementById('noTransferDataMessage');


    // --- Helper Functions ---

    /**
     * Định dạng số thành chuỗi tiền tệ VND.
     * @param {number} n - Số tiền (ví dụ: 1000000).
     * @returns {string} - Chuỗi định dạng (ví dụ: 1.000.000 ₫).
     */
    function formatVND(n) {
        if (n === undefined || n === null) return '0 ₫';
        const absN = Math.abs(n);
        const sign = n < 0 ? '-' : '';
        return sign + absN.toLocaleString('vi-VN') + ' ₫';
    }

    /**
     * Chuyển chuỗi tiền tệ VND thành số.
     * @param {string} s - Chuỗi tiền tệ (ví dụ: "1.000.000 ₫" hoặc "1,000,000").
     * @returns {number} - Số tiền (ví dụ: 1000000).
     */
    function unformatVND(s) {
        if (!s) return 0;
        // Loại bỏ ký tự không phải số (trừ dấu phẩy, chấm)
        let cleaned = s.replace(/[^0-9,.]/g, '');
        // Thay thế dấu chấm thành rỗng (cho định dạng VN: 1.000.000)
        cleaned = cleaned.replace(/\./g, '');
        // Thay thế dấu phẩy thành dấu chấm (nếu có, cho định dạng US: 1,000.00)
        cleaned = cleaned.replace(/,/g, '.');
        return parseFloat(cleaned) || 0;
    }

    /**
     * Định dạng ngày thành chuỗi hiển thị (dd/mm/yyyy).
     * @param {string} dateString - Chuỗi ngày (yyyy-mm-dd).
     * @returns {string} - Chuỗi ngày định dạng (dd/mm/yyyy).
     */
    function formatDate(dateString) {
        if (!dateString) return '';
        const [year, month, day] = dateString.split('-');
        return `${day}/${month}/${year}`;
    }
    
    // NEW: Function to open the Transfer Modal and switch to the specified tab
    /**
     * Cập nhật số dư trong modal và hiển thị Modal Quản Lý Ví.
     * @param {string} tabId - ID của tab muốn chuyển tới (ví dụ: 'transfer-form-tab', 'expense-form-pane', 'withdraw-form-tab').
     * @param {string} detailsTransferIn - Chi tiết mặc định cho giao dịch Nạp Ví (chuyển vào).
     * @param {string} detailsTransferOut - Chi tiết mặc định cho giao dịch Rút Ví (chuyển ra).
     */
    function updateAndShowTransferModal(tabId, detailsTransferIn, detailsTransferOut) {
        const currentCashBalance = window.cachedTotals ? window.cachedTotals.cashBalance : 0;
        const currentWalletBalance = window.cachedTotals ? window.cachedTotals.walletBalance : 0;
        
        // Cập nhật số dư cho các tab
        availableCashBalanceEl.innerText = formatVND(currentCashBalance);
        hiddenAvailableCashBalanceEl.value = currentCashBalance;
        availableWalletBalanceEl.innerText = formatVND(currentWalletBalance);
        hiddenAvailableWalletBalanceEl.value = currentWalletBalance;
        availableWalletBalanceWithdrawEl.innerText = formatVND(currentWalletBalance);
        hiddenAvailableWalletBalanceWithdrawEl.value = currentWalletBalance;

        // Đặt lại giá trị mặc định cho form Nạp Ví
        transferDateEl.value = new Date().toISOString().slice(0, 10);
        transferAmountEl.value = '';
        transferDetailsEl.value = detailsTransferIn; 
        
        // Đặt lại giá trị mặc định cho form Rút Ví
        withdrawDateEl.value = new Date().toISOString().slice(0, 10);
        withdrawAmountEl.value = '';
        withdrawDetailsEl.value = detailsTransferOut; 
        
        // Đặt lại giá trị mặc định cho form Chi Ví
        walletExpenseDateEl.value = new Date().toISOString().slice(0, 10);
        walletExpenseAmountEl.value = '';
        walletExpenseDetailsEl.value = '';
        
        // Chuyển sang tab mong muốn
        const targetTab = document.getElementById(tabId);
        if (targetTab) {
            new bootstrap.Tab(targetTab).show();
        }
        transferModal.show();
    }


    // --- Core Functions for Firebase ---

    /**
     * Adds a single revenue or expense entry to the daily_records collection.
     * @param {string} date - Date in yyyy-mm-dd format.
     * @param {number} revenue - Revenue amount.
     * @param {number} expense - Expense amount.
     * @param {string} details - Transaction details.
     * @param {string|null} paymentMethod - 'cash', 'transfer', or null for expense.
     */
    async function addSingleEntry(date, revenue = 0, expense = 0, details = '', paymentMethod = null) {
        if (!date) return;

        const transactionData = {
            revenue: Number(revenue || 0),
            expense: Number(expense || 0),
            details: details,
            timestamp: firebase.database.ServerValue.TIMESTAMP,
            paymentMethod: paymentMethod // Store paymentMethod even if null
        };

        // NEW LOGIC: Separate Wallet Transfers
        if (['wallet_in', 'wallet_out_cash', 'wallet_expense', 'wallet_withdraw_out', 'cash_in_from_wallet'].includes(paymentMethod)) {
            // MODIFIED: 'cash_in_from_wallet' is now also stored here.
            // NOTE: For linked transfers, we will write them directly in the event listener to control the group ID
            const transferRef = walletTransfersRef.push();
            await transferRef.set(transactionData);
        } else {
            // Regular transaction (Revenue or Expense)
            const transactionRef = recordsRef.child(date).child('transactions').push();
            await transactionRef.set(transactionData);
        }
    }

    /**
     * Deletes a full day's record and all its transactions.
     */
    async function deleteDay(date) {
        if (confirm('Xóa toàn bộ giao dịch của ngày ' + formatDate(date) + '?')) {
            await recordsRef.child(date).remove();
        }
    }

    /**
     * Deletes a group of linked wallet transactions (Nạp Ví, Rút Ví).
     * This function is now responsible for deleting both halves of the internal transfers
     * from the wallet_transfers collection.
     */
    async function deleteGroupTransaction(transferGroupId) {
        if (!transferGroupId) return;

        let deleteCount = 0;
        try {
            const transfersSnapshot = await walletTransfersRef.get();
            const transfers = transfersSnapshot.val();
            const updates = {};
            for (const id in transfers) {
                const trans = transfers[id];
                if (trans.transferGroupId === transferGroupId) {
                    updates[id] = null; // Mark for deletion
                    deleteCount++;
                }
            }

            if (deleteCount > 0) {
                 await walletTransfersRef.update(updates);
                 alert('Đã xóa thành công nhóm giao dịch Ví (bao gồm ' + deleteCount + ' mục).');
            } else {
                alert('Không tìm thấy nhóm giao dịch Ví nào để xóa.');
            }
        } catch (error) {
            console.error('Lỗi khi xóa nhóm giao dịch Ví:', error);
            alert('Đã xảy ra lỗi khi xóa nhóm giao dịch Ví.');
        }
    }

    window.deleteGroupTransaction = deleteGroupTransaction; // Attach to window for button use


    /**
     * Deletes a regular transaction from the daily_records collection.
     * Also handles deletion of linked cash-in from withdrawal (LEGACY) if it was still stored in daily_records.
     */
    async function deleteTransaction(date, transactionId) {
        if (confirm('Xóa giao dịch này?')) {
            try {
                // Check if it's a linked cash-in from withdrawal (LEGACY structure)
                const snapshot = await recordsRef.child(date).child('transactions').child(transactionId).get();
                const transToDelete = snapshot.val();

                // Keep this check for legacy data that might still exist in daily_records
                if (transToDelete && transToDelete.paymentMethod === 'cash_in_from_wallet' && transToDelete.linkedTransferGroupId) {
                    // It's the linked cash-in from withdrawal (LEGACY). Delete the whole group.
                    await deleteGroupTransaction(transToDelete.linkedTransferGroupId);
                } else {
                    // Regular transaction deletion
                    await recordsRef.child(date).child('transactions').child(transactionId).remove();
                }
            } catch (error) {
                 console.error('Lỗi khi xóa giao dịch:', error);
                 alert('Đã xảy ra lỗi khi xóa giao dịch.');
            }
        }
    }

    /**
     * Deletes a Wallet Transfer transaction (wallet_in, wallet_expense, or wallet_withdraw_out)
     * and its corresponding linked transactions (MODIFIED to use deleteGroupTransaction).
     * @param {string} transactionId - ID of the visible transaction.
     */
    async function deleteTransferTransaction(transactionId) {
        if (!confirm('Xóa giao dịch Ví này? Thao tác này sẽ hoàn lại số dư Ví Chuyển khoản (Chi Ví) hoặc hoàn lại cả 2 giao dịch liên kết (Nạp Ví, Rút Ví).')) return;

        try {
            const snapshot = await walletTransfersRef.child(transactionId).get();
            const transToDelete = snapshot.val();

            if (!transToDelete) {
                alert('Không tìm thấy giao dịch Ví này.');
                return;
            }

            if (transToDelete.transferGroupId) {
                // For linked transactions (Nạp Ví, Rút Ví), delete the whole group
                await deleteGroupTransaction(transToDelete.transferGroupId);
            } else {
                // For single transactions (Chi Ví - wallet_expense), delete the single entry
                await walletTransfersRef.child(transactionId).remove();
                alert('Đã xóa thành công giao dịch Ví.');
            }
        } catch (error) {
            console.error('Lỗi khi xóa giao dịch Ví:', error);
            alert('Đã xảy ra lỗi khi xóa giao dịch Ví.');
        }
    }

    window.deleteTransaction = deleteTransaction; // Attach to window
    window.deleteDay = deleteDay; // Attach to window
    window.deleteTransferTransaction = deleteTransferTransaction; // Attach to window

    /**
     * Edits a transaction (only works for regular daily_records entries).
     */
    async function editTransaction(date, transactionId) {
        const snapshot = await recordsRef.child(date).child('transactions').child(transactionId).get();
        const transaction = snapshot.val();

        if (!transaction) return;

        const isRevenue = transaction.revenue > 0;
        const newDetails = prompt('Nhập chi tiết mới:', transaction.details || '');
        let newAmount = prompt(`Nhập số tiền mới (${isRevenue ? 'Thu' : 'Chi'}):`, isRevenue ? transaction.revenue : transaction.expense);
        
        if (newDetails === null || newAmount === null) return; // User cancelled

        newAmount = unformatVND(newAmount);
        
        if (newAmount <= 0) {
            alert("Số tiền phải lớn hơn 0.");
            return;
        }

        const updates = { details: newDetails };
        if (isRevenue) {
            let newPaymentMethod = transaction.paymentMethod;
             // Check if user wants to change payment method for revenue
            const methodChange = prompt('Thay đổi hình thức thanh toán? ("cash" hoặc "transfer")', transaction.paymentMethod || 'cash');
            if (methodChange && ['cash', 'transfer'].includes(methodChange.toLowerCase())) {
                newPaymentMethod = methodChange.toLowerCase();
            }

            updates.revenue = Number(newAmount);
            updates.expense = 0;
            updates.paymentMethod = newPaymentMethod;

        } else {
            updates.revenue = 0;
            updates.expense = Number(newAmount);
            // Ensure paymentMethod is removed or undefined for generic expenses
            updates.paymentMethod = null;
        }
        
        await recordsRef.child(date).child('transactions').child(transactionId).update(updates);
    }
    window.editTransaction = editTransaction; // Attach to window

    async function clearAll() {
        if (!confirm('Bạn có chắc muốn xóa tất cả dữ liệu trên Firebase? Thao tác này không thể hoàn tác.')) return;
        await recordsRef.remove();
        await walletTransfersRef.remove(); // Clear wallet transfers
    }

    async function addSampleData() {
        // Dữ liệu mẫu
        const detailsList = ['Ăn sáng', 'Tiền thuê nhà', 'Mua sắm', 'Chi phí sinh hoạt', 'Đi lại'];
        const numDays = 30;
        const today = new Date();
        const currentDate = new Date(today);
        currentDate.setDate(currentDate.getDate() - numDays);

        const batch = {};

        for (let i = 0; i <= numDays; i++) {
            const dateStr = currentDate.toISOString().slice(0, 10);
            
            // Thêm 1-3 giao dịch mỗi ngày
            const numTrans = Math.floor(Math.random() * 3) + 1;
            for (let j = 0; j < numTrans; j++) {
                const isRevenue = Math.random() < 0.3; // 30% là thu
                const amount = Math.floor(Math.random() * 500000) + 10000;
                const detail = detailsList[Math.floor(Math.random() * detailsList.length)];
                const isCash = Math.random() < 0.6; // 60% là tiền mặt

                const transactionData = {
                    revenue: isRevenue ? amount : 0,
                    expense: isRevenue ? 0 : amount,
                    details: detail + (isRevenue ? ' (Thu)' : ' (Chi)'),
                    timestamp: Date.now() + i * 1000 * 60 * 60 * 24 + j * 1000, // Tăng nhẹ timestamp để sắp xếp
                    paymentMethod: isRevenue ? (isCash ? 'cash' : 'transfer') : null
                };

                const newKey = recordsRef.child(dateStr).child('transactions').push().key;
                batch[`daily_records/${dateStr}/transactions/${newKey}`] = transactionData;
            }
            
            currentDate.setDate(currentDate.getDate() + 1); // Chuyển sang ngày tiếp theo
        }
        
        await database.ref().update(batch);
        alert('Đã thêm dữ liệu mẫu thành công!');
    }


    /**
     * Calculates total revenue, expense, balance, cash balance, and wallet balance.
     * @param {object} records - The cached Firebase daily_records object.
     * @param {object} walletTransfers - The cached Firebase wallet_transfers object.
     * @param {string|null} specificDateStr - Optional date string to filter by.
     * @returns {object} Calculated totals.
     */
    function calculateTotals(records, walletTransfers, specificDateStr = null) {
        let totalRevenueCash = 0;
        let totalRevenueTransfer = 0;
        let totalExpense = 0; // Regular Expense (not including wallet expense)
        
        // Totals for Wallet Transfers (from wallet_transfers collection)
        let totalWalletIn = 0;              // Nạp Ví (Tăng Ví CK)
        let totalWalletOutCash = 0;         // Trừ Tiền mặt (Giảm Dư TM)
        let totalWalletExpense = 0;         // Chi Ví (Giảm Ví CK)
        let totalWalletWithdrawOut = 0;     // Rút Ví (Giảm Ví CK)
        let totalRevenueCashFromWallet = 0; // Thu Tiền mặt (từ Rút Ví)

        // 1. Aggregate from daily_records
        for (const dateKey in records) {
            if (specificDateStr && dateKey !== specificDateStr) continue;
            const dailyRecord = records[dateKey];
            if (dailyRecord.transactions) {
                Object.values(dailyRecord.transactions).forEach(trans => {
                    if (trans.revenue > 0) {
                        if (trans.paymentMethod === 'cash') {
                            totalRevenueCash += Number(trans.revenue || 0);
                        } else if (trans.paymentMethod === 'transfer') {
                            totalRevenueTransfer += Number(trans.revenue || 0);
                        }
                    }
                    if (trans.expense > 0) {
                        totalExpense += Number(trans.expense || 0);
                    }
                });
            }
        }

        // 2. Aggregate from wallet_transfers (always aggregate all, ignore date filter for internal movements)
        // If specificDateStr is set, we only aggregate the specific wallet transfers for calculation,
        // but for total balances, we need all, so we check if it is for filtering or overall calculation.
        
        if (walletTransfers) {
            Object.values(walletTransfers).forEach(trans => {
                const dateKey = new Date(trans.timestamp).toISOString().slice(0, 10);
                if (specificDateStr && dateKey !== specificDateStr) return; // Only filter if requested

                if (trans.paymentMethod === 'wallet_in') {
                    totalWalletIn += Number(trans.revenue || 0);
                } else if (trans.paymentMethod === 'wallet_out_cash') {
                    totalWalletOutCash += Number(trans.expense || 0);
                } else if (trans.paymentMethod === 'wallet_expense') {
                    totalWalletExpense += Number(trans.expense || 0);
                } else if (trans.paymentMethod === 'wallet_withdraw_out') {
                    totalWalletWithdrawOut += Number(trans.expense || 0);
                } else if (trans.paymentMethod === 'cash_in_from_wallet') {
                    // NEW: Handle the cash-in part of Withdrawal
                    totalRevenueCashFromWallet += Number(trans.revenue || 0);
                }
            });
        }


        // Calculations
        // Net Cash Balance: Cash Revenue (regular) - Regular Expense - Cash Out for Wallet (Transfer In) + Cash In from Wallet (Withdrawal)
        const totalNetCash = totalRevenueCash - totalExpense - totalWalletOutCash + totalRevenueCashFromWallet;

        // Wallet Balance: Transfer Revenue (regular) + Wallet In (Transfer In) - Wallet Expense (Chi Ví) - Wallet Withdraw Out (Rút Ví)
        const totalWalletBalance = totalRevenueTransfer + totalWalletIn - totalWalletExpense - totalWalletWithdrawOut;

        // Total Net Balance: Total Revenue (Cash + Transfer) - Total Expense (Regular + Wallet)
        // Note: The internal movements should not affect the final total net balance.
        // We use the existing structure to ensure consistency, where the internal transfers cancel out.
        // totalNetBalance = (totalRevenueCash + totalRevenueTransfer) - totalExpense - totalWalletExpense
        // (totalWalletOutCash and totalRevenueCashFromWallet are internal transfers and cancel each other out)
        const totalNetBalance = totalNetCash + totalWalletBalance;

        return {
            revenueCash: totalRevenueCash,
            revenueTransfer: totalRevenueTransfer,
            expense: totalExpense, // Regular expense
            totalExpense: totalExpense + totalWalletExpense, // Total Expense (Regular + Wallet)
            netBalance: totalNetBalance,
            cashBalance: totalNetCash, // Dư Tiền mặt
            walletBalance: totalWalletBalance, // Ví Chuyển Khoản
            totalWalletIn: totalWalletIn,
            totalWalletOutCash: totalWalletOutCash,
            totalWalletExpense: totalWalletExpense,
            totalWalletWithdrawOut: totalWalletWithdrawOut
        };
    }

    /**
     * Updates the main UI totals based on calculated totals.
     * @param {object} totals - The calculated totals object.
     */
    function updateOverallTotalsUI(totals) {
        totalRevenueCashEl.innerText = formatVND(totals.revenueCash);
        totalRevenueTransferEl.innerText = formatVND(totals.revenueTransfer);
        totalExpenseEl.innerText = formatVND(totals.totalExpense);

        // Update Total Balance
        totalBalanceEl.innerText = formatVND(totals.netBalance);
        totalBalanceEl.className = `h4 ${totals.netBalance >= 0 ? 'balance-positive' : 'balance-negative'}`;

        // Update Cash Balance
        totalBalanceCashEl.innerText = formatVND(totals.cashBalance);
        totalBalanceCashEl.className = `h4 ${totals.cashBalance >= 0 ? 'balance-cash' : 'balance-negative'}`;

        // Update Wallet Balance
        totalWalletBalanceEl.innerText = formatVND(totals.walletBalance);
        // Note: The transfer-wallet-box style already sets text-white, so we don't change text color here.
    }

    /**
     * Updates the filtered totals UI.
     * @param {object} records - The cached Firebase daily_records object.
     * @param {object} walletTransfers - The cached Firebase wallet_transfers object.
     */
    function updateFilteredTotalsUI(records, walletTransfers) {
        const specificDate = specificDateFilterEl.value;
        if (!specificDate) {
            // Reset if no date is selected
            filteredRevenueCashEl.innerText = formatVND(0);
            filteredRevenueTransferEl.innerText = formatVND(0);
            filteredExpenseEl.innerText = formatVND(0);
            filteredBalanceEl.innerText = formatVND(0);
            filteredBalanceEl.className = `h4`;
            filteredBalanceCashEl.innerText = formatVND(0);
            filteredBalanceCashEl.className = `h4`;
            return;
        }

        // Pass an empty object for walletTransfers here to exclude it from filtered totals (only focus on daily_records)
        const totals = calculateTotals(records, {}, specificDate); // Pass {} for walletTransfers to ignore them

        // When filtering by date, we are only showing the daily transactions for that day.
        // We exclude wallet_transfers from the calculation (by passing {}) to focus on daily inflow/outflow.
        filteredRevenueCashEl.innerText = formatVND(totals.revenueCash);
        filteredRevenueTransferEl.innerText = formatVND(totals.revenueTransfer);

        const filteredExpense = totals.expense;
        filteredExpenseEl.innerText = formatVND(filteredExpense);

        const filteredNet = totals.revenueCash + totals.revenueTransfer - filteredExpense; // Recalculate based on only daily records
        filteredBalanceEl.innerText = formatVND(filteredNet);
        filteredBalanceEl.className = `h4 ${filteredNet >= 0 ? 'balance-positive' : 'balance-negative'}`;

        const filteredCashNet = totals.revenueCash - totals.expense; // Cash only (no internal transfers in this subset)
        filteredBalanceCashEl.innerText = formatVND(filteredCashNet);
        filteredBalanceCashEl.className = `h4 ${filteredCashNet >= 0 ? 'balance-positive' : 'balance-negative'}`;
    }

    /**
     * Aggregates data by month or quarter.
     */
    function aggregateByPeriod(dailyAggregatedRecords, viewMode) {
        const aggregated = {};
        for (const dateKey in dailyAggregatedRecords) {
            const r = dailyAggregatedRecords[dateKey];
            const date = new Date(dateKey);
            let periodKey;

            if (viewMode === 'month') {
                periodKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
            } else if (viewMode === 'quarter') {
                const quarter = Math.floor(date.getMonth() / 3) + 1;
                periodKey = `${date.getFullYear()}-Q${quarter}`;
            } else {
                continue;
            }

            if (!aggregated[periodKey]) {
                aggregated[periodKey] = {
                    key: periodKey,
                    revenue: 0,
                    expense: 0,
                    net: 0,
                    transactions: 0 // Only count total transactions for this period
                };
            }

            aggregated[periodKey].revenue += r.revenue;
            aggregated[periodKey].expense += r.expense;
            aggregated[periodKey].net += r.net;
            aggregated[periodKey].transactions += Object.keys(r.transactions).length;
        }
        return Object.values(aggregated);
    }

    /**
     * Renders the history table for wallet transfers/expenses.
     * @param {object} walletTransfers - The cached Firebase wallet_transfers object.
     */
    function renderTransferHistory(walletTransfers) {
        const transfersArray = Object.entries(walletTransfers || {}).map(([id, trans]) => ({ id, ...trans }));
        
        // Sắp xếp theo timestamp giảm dần (mới nhất trước)
        transfersArray.sort((a, b) => b.timestamp - a.timestamp); 

        transferHistoryBodyEl.innerHTML = '';
        const renderedGroupIds = new Set();
        let hasData = false;
        
        transfersArray.forEach(trans => {
            // Bỏ qua giao dịch liên kết đã được hiển thị (ví dụ: bỏ qua cash_in_from_wallet nếu wallet_withdraw_out đã được hiển thị)
            if (trans.transferGroupId && renderedGroupIds.has(trans.transferGroupId)) {
                return; 
            }
            
            hasData = true;
            const date = new Date(trans.timestamp).toISOString().slice(0, 10);
            
            let typeText, amountValue, actionTitle, actionButtons;
            
            if (trans.paymentMethod === 'wallet_out_cash') {
                // Đây là giao dịch OUT (giảm Cash) của NẠP VÍ
                typeText = '<span class="badge bg-primary">Nạp Ví (IN)</span>';
                amountValue = trans.expense; // Số tiền đã chuyển ra khỏi Cash
                actionTitle = 'Xóa giao dịch Nạp Ví (sẽ khôi phục cả Tiền mặt và Ví CK)';
                if (trans.transferGroupId) renderedGroupIds.add(trans.transferGroupId); // Đánh dấu nhóm đã render
                
            } else if (trans.paymentMethod === 'wallet_withdraw_out') {
                // Đây là giao dịch OUT (giảm Wallet) của RÚT VÍ
                typeText = '<span class="badge bg-warning text-dark">Rút Ví (OUT)</span>';
                amountValue = trans.expense; // Số tiền đã rút ra khỏi Wallet
                actionTitle = 'Xóa giao dịch Rút Ví (sẽ khôi phục cả Tiền mặt và Ví CK)';
                if (trans.transferGroupId) renderedGroupIds.add(trans.transferGroupId); // Đánh dấu nhóm đã render

            } else if (trans.paymentMethod === 'wallet_expense') {
                // Đây là giao dịch CHI VÍ
                typeText = '<span class="badge bg-danger">Chi Ví</span>';
                amountValue = trans.expense;
                actionTitle = 'Xóa giao dịch Chi Ví (sẽ khôi phục Ví CK)';

            } else if (trans.paymentMethod === 'wallet_in') {
                 // Đây là giao dịch IN (tăng Wallet) của NẠP VÍ, nhưng chỉ hiển thị 1 mục đại diện
                 // Logic ở trên đã xử lý: chỉ hiển thị 'wallet_out_cash' cho NẠP VÍ
                 return; 
            } else if (trans.paymentMethod === 'cash_in_from_wallet') {
                 // Đây là giao dịch IN (tăng Cash) của RÚT VÍ, nhưng chỉ hiển thị 1 mục đại diện
                 // Logic ở trên đã xử lý: chỉ hiển thị 'wallet_withdraw_out' cho RÚT VÍ
                 return;
            } else {
                return; // Bỏ qua các loại giao dịch không xác định
            }

            if (trans.transferGroupId) {
                // Nút xóa cho giao dịch nhóm (Nạp Ví, Rút Ví)
                actionButtons = `<button class="btn btn-sm btn-outline-danger btn-sm-custom" title="${actionTitle}" onclick="window.deleteGroupTransaction('${trans.transferGroupId}')"> <i class="fas fa-trash-alt"></i> Xóa </button>`;
            } else {
                 // Nút xóa cho giao dịch đơn (Chi Ví)
                actionButtons = `<button class="btn btn-sm btn-outline-danger btn-sm-custom" title="${actionTitle}" onclick="window.deleteTransferTransaction('${trans.id}')"> <i class="fas fa-trash-alt"></i> Xóa </button>`;
            }
            
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${formatDate(date)}</td>
                <td>${typeText}</td>
                <td>${formatVND(amountValue)}</td>
                <td>${trans.details}</td>
                <td class="action-cell">${actionButtons}</td>
            `;
            transferHistoryBodyEl.appendChild(tr);
        });

        if (hasData) {
            noTransferDataMessageEl.classList.add('d-none');
        } else {
            noTransferDataMessageEl.classList.remove('d-none');
        }
    }


    // --- UI Rendering ---
    function renderAll(records, walletTransfers) {
        const totals = calculateTotals(records, walletTransfers);
        updateOverallTotalsUI(totals);
        window.cachedTotals = totals; // Cache totals
        window.cachedRecords = records; // Cache full records (for details modal)
        window.cachedWalletTransfers = walletTransfers; // Cache full transfers

        const viewMode = reportViewEl.value;
        const sortOrder = sortOrderEl.value;

        // 1. Aggregate daily records
        const dailyAggregatedRecords = {};
        for (const dateKey in records) {
            const dailyRecord = records[dateKey];
            let dailyRevenueCash = 0;
            let dailyRevenueTransfer = 0;
            let dailyExpense = 0;
            let hasTransactions = false;

            if (dailyRecord.transactions) {
                Object.values(dailyRecord.transactions).forEach(trans => {
                    if (trans.revenue > 0) {
                        if (trans.paymentMethod === 'cash') {
                            dailyRevenueCash += Number(trans.revenue || 0);
                        } else if (trans.paymentMethod === 'transfer') {
                            dailyRevenueTransfer += Number(trans.revenue || 0);
                        }
                    }
                    if (trans.expense > 0) {
                        dailyExpense += Number(trans.expense || 0);
                    }
                    hasTransactions = true;
                });
            }

            const dailyTotalRevenue = dailyRevenueCash + dailyRevenueTransfer;
            const dailyTotalExpense = dailyExpense;
            const dailyNet = dailyTotalRevenue - dailyTotalExpense;

            if (hasTransactions) {
                dailyAggregatedRecords[dateKey] = {
                    date: dateKey,
                    revenue: dailyTotalRevenue,
                    revenueCash: dailyRevenueCash,
                    revenueTransfer: dailyRevenueTransfer,
                    expense: dailyTotalExpense,
                    net: dailyNet,
                    transactions: dailyRecord.transactions
                };
            }
        }

        // Update Filtered Totals if the filter control panel is visible
        if (dateFilterControlsEl.style.display !== 'none') {
            updateFilteredTotalsUI(records, walletTransfers);
        }

        // Update Transfer History in the modal
        renderTransferHistory(walletTransfers);

        // Render main history table
        let dataToRender = dailyAggregatedRecords;
        let isDailyView = true;

        if (viewMode === 'month' || viewMode === 'quarter') {
            dataToRender = aggregateByPeriod(dailyAggregatedRecords, viewMode);
            isDailyView = false;
        } else {
            dataToRender = Object.values(dailyAggregatedRecords);
        }

        // Sắp xếp dữ liệu
        dataToRender.sort((a, b) => {
            const valA = a.date || a.key;
            const valB = b.date || b.key;
            if (sortOrder === 'asc') {
                return valA.localeCompare(valB);
            } else {
                return valB.localeCompare(valA);
            }
        });

        historyBodyEl.innerHTML = '';
        if (dataToRender.length === 0) {
            noDataMessageEl.classList.remove('d-none');
        } else {
            noDataMessageEl.classList.add('d-none');
        }

        // Cập nhật tiêu đề bảng
        if (viewMode === 'day') {
            reportTitleEl.innerHTML = `<i class="fas fa-history me-2"></i> Lịch sử Giao dịch (Chi tiết Ngày)`;
            tableHeaderEl.innerHTML = `
                <th class="date-header">Ngày</th>
                <th>Thu TM/CK</th>
                <th>Chi tiêu</th>
                <th>Số dư</th>
                <th>Chi tiết</th>
                <th class="action-header">Hành động</th>
            `;
        } else if (viewMode === 'month') {
            reportTitleEl.innerHTML = `<i class="fas fa-calendar-alt me-2"></i> Lịch sử Giao dịch (Tổng hợp Tháng)`;
            tableHeaderEl.innerHTML = `
                <th class="date-header">Tháng</th>
                <th>Doanh thu</th>
                <th>Chi tiêu</th>
                <th>Số dư</th>
                <th class="action-header">Tổng giao dịch</th>
                <th></th>
            `;
        } else if (viewMode === 'quarter') {
            reportTitleEl.innerHTML = `<i class="fas fa-calendar-alt me-2"></i> Lịch sử Giao dịch (Tổng hợp Quý)`;
            tableHeaderEl.innerHTML = `
                <th class="date-header">Quý</th>
                <th>Doanh thu</th>
                <th>Chi tiêu</th>
                <th>Số dư</th>
                <th class="action-header">Tổng giao dịch</th>
                <th></th>
            `;
        }

        // Render rows
        dataToRender.forEach(r => {
            const key = r.date || r.key;
            const tr = document.createElement('tr');
            tr.classList.add('fade-in');

            if (isDailyView) {
                // Daily View
                tr.innerHTML = `
                    <td data-label="Ngày:"><strong>${formatDate(key)}</strong></td>
                    <td data-label="Thu TM/CK:">${formatVND(r.revenueCash)} / ${formatVND(r.revenueTransfer)}</td>
                    <td data-label="Chi tiêu:">${formatVND(r.expense)}</td>
                    <td data-label="Số dư:" class="${r.net >= 0 ? 'balance-positive' : 'balance-negative'}">${formatVND(r.net)}</td>
                    <td data-label="Chi tiết:" class="action-cell">
                        <button class="btn btn-sm btn-outline-primary btn-sm-custom" onclick="window.showDetailsModal('${key}')">
                            <i class="fas fa-eye"></i> Xem (${Object.keys(r.transactions).length})
                        </button>
                    </td>
                    <td data-label="Hành động:" class="action-cell">
                        <button class="btn btn-sm btn-outline-danger btn-sm-custom" onclick="window.deleteDay('${key}')">
                            <i class="fas fa-trash-alt"></i> Xóa ngày
                        </button>
                    </td>
                `;
            } else {
                // Aggregated View
                tr.innerHTML = `
                    <td data-label="${viewMode === 'month' ? 'Tháng' : 'Quý'}:"><strong>${key}</strong></td>
                    <td data-label="Doanh thu:">${formatVND(r.revenue)}</td>
                    <td data-label="Chi tiêu:">${formatVND(r.expense)}</td>
                    <td data-label="Số dư:" class="${r.net >= 0 ? 'balance-positive' : 'balance-negative'}">${formatVND(r.net)}</td>
                    <td data-label="Tổng giao dịch:">${r.transactions}</td>
                    <td></td>
                `;
            }

            historyBodyEl.appendChild(tr);
        });
    }

    /**
     * Shows the modal with all transactions for a specific day.
     */
    function showDetailsModal(date) {
        const dailyRecord = window.cachedRecords[date];
        detailsModalBodyEl.innerHTML = '';

        let htmlContent = `<h5 class="mb-3">Giao dịch Ngày: ${formatDate(date)}</h5>`;

        if (!dailyRecord || !dailyRecord.transactions) {
            htmlContent += '<p class="text-muted">Không có giao dịch nào trong ngày này.</p>';
        } else {
            const transactions = dailyRecord.transactions;
            const transactionsArray = Object.entries(transactions).map(([id, trans]) => ({ id, ...trans })).sort((a, b) => a.timestamp - b.timestamp);

            htmlContent += `<div class="table-responsive"><table class="table table-sm table-striped">
                <thead>
                    <tr>
                        <th>Giờ</th>
                        <th>Số Tiền</th>
                        <th>Hình thức</th>
                        <th>Chi tiết</th>
                        <th>Hành động</th>
                    </tr>
                </thead>
                <tbody>`;

            transactionsArray.forEach(trans => {
                const id = trans.id;
                let amount = trans.revenue > 0 ? trans.revenue : trans.expense;
                let amountClass = trans.revenue > 0 ? (trans.paymentMethod === 'cash' ? 'balance-cash' : 'balance-transfer') : 'balance-negative';
                let type, method, isWalletTransfer = false;
                let time = new Date(trans.timestamp).toLocaleTimeString('vi-VN', {hour: '2-digit', minute: '2-digit', second: '2-digit'});

                if (trans.revenue > 0) {
                    type = 'Thu';
                    if (trans.paymentMethod === 'cash') method = 'Tiền mặt';
                    else if (trans.paymentMethod === 'transfer') method = 'Chuyển khoản';
                    else if (trans.paymentMethod === 'cash_in_from_wallet') {
                        method = 'Thu từ Ví';
                        isWalletTransfer = true;
                    }
                    else method = 'Khác';
                } else if (trans.expense > 0) {
                    type = 'Chi';
                    method = 'Tiền mặt'; // Default to cash for regular expense
                } else {
                    return; // Bỏ qua giao dịch không có thu/chi
                }

                // Nút hành động
                let actionButtons = (trans.linkedTransferGroupId) ? // For linked cash-in group (LEGACY - should not happen now but keeping for safety)
                    `<button class="btn btn-sm btn-outline-danger btn-sm-custom" onclick="window.deleteGroupTransaction('${trans.linkedTransferGroupId}')">
                        <i class="fas fa-trash-alt"></i> Xóa (Nhóm)
                    </button>` : 
                    (trans.paymentMethod !== 'cash_in_from_wallet' && !isWalletTransfer ? // For regular transactions
                    `<button class="btn btn-sm btn-outline-secondary btn-sm-custom me-1" onclick="window.editTransaction('${date}', '${id}')">
                        <i class="fas fa-edit"></i> Sửa
                    </button>
                    <button class="btn btn-sm btn-outline-danger btn-sm-custom" onclick="window.deleteTransaction('${date}', '${id}')">
                        <i class="fas fa-trash-alt"></i> Xóa
                    </button>` : 
                    // For other non-editable/deletable internal types (like the new cash_in_from_wallet from wallet_transfers)
                    `<span class="text-muted small">Nội bộ</span>`);

                htmlContent += ` 
                    <tr>
                        <td>${time}</td>
                        <td class="${amountClass}">${formatVND(amount)}</td>
                        <td>${method}</td>
                        <td>${trans.details}</td>
                        <td class="action-cell">${actionButtons}</td>
                    </tr> 
                `;
            });

            htmlContent += `</tbody></table></div>`;
        }
        detailsModalBodyEl.innerHTML = htmlContent;
        detailsModal.show();
    }
    window.showDetailsModal = showDetailsModal; // Attach to window

    // --- Export/Import Functions ---
    function downloadFile(filename, content) {
        const element = document.createElement('a');
        element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(content));
        element.setAttribute('download', filename);
        element.style.display = 'none';
        document.body.appendChild(element);
        element.click();
        document.body.removeChild(element);
    }

    function exportJson(records, walletTransfers) {
        const data = { 
            daily_records: records, 
            wallet_transfers: walletTransfers 
        };
        downloadFile(`records_${new Date().toISOString().slice(0, 10)}.json`, JSON.stringify(data, null, 2));
        alert('Dữ liệu đã được xuất ra JSON.');
    }

    function exportCsv(dailyAggregatedRecords) {
        let csvContent = "Ngày,Doanh thu,Chi tiêu,Số dư\n";
        
        Object.values(dailyAggregatedRecords).sort((a, b) => a.date.localeCompare(b.date)).forEach(r => {
            csvContent += `${r.date},${r.revenue},${r.expense},${r.net}\n`;
        });

        downloadFile(`transactions_${new Date().toISOString().slice(0, 10)}.csv`, csvContent);
        alert('Dữ liệu đã được xuất ra CSV.');
    }

    async function importJsonFile(file) {
        const reader = new FileReader();
        reader.onload = async function(e) {
            try {
                const data = JSON.parse(e.target.result);
                if (!data.daily_records || !data.wallet_transfers) {
                     throw new Error("Tệp JSON không đúng định dạng (thiếu daily_records hoặc wallet_transfers).");
                }
                
                if (!confirm('Bạn có chắc chắn muốn GHI ĐÈ dữ liệu hiện có bằng dữ liệu từ tệp này không? Thao tác này không thể hoàn tác.')) {
                    return;
                }

                // Ghi đè dữ liệu
                await recordsRef.set(data.daily_records);
                await walletTransfersRef.set(data.wallet_transfers);

                alert('Nhập dữ liệu thành công!');
            } catch (error) {
                console.error('Lỗi khi nhập dữ liệu:', error);
                alert('Lỗi khi nhập dữ liệu: ' + error.message);
            }
        };
        reader.readAsText(file);
    }

    // --- Event Listeners ---
    document.addEventListener('DOMContentLoaded', () => {
        // ... (existing listeners for dropdowns)

        // Set default date for modals and filters
        const today = new Date().toISOString().slice(0, 10);
        modalEntryDateEl.value = today;
        transferDateEl.value = today;
        walletExpenseDateEl.value = today;
        withdrawDateEl.value = today;
        specificDateFilterEl.value = today;


        // Listen for data changes on Firebase (recordsRef)
        recordsRef.on('value', (snapshot) => {
            const records = snapshot.val() || {};
            window.cachedRecords = records; // Cache data for quick sorting and viewing
            // Only render if wallet transfers data is also available
            if (window.cachedWalletTransfers !== null) {
                renderAll(records, window.cachedWalletTransfers);
            }
        }, (error) => {
            console.error('Lỗi khi đọc daily_records từ Firebase:', error);
            alert('Không thể kết nối với Firebase (Daily Records). Vui lòng kiểm tra kết nối mạng hoặc cấu hình.');
        });
        
        // NEW: Listen for data changes on Firebase (walletTransfersRef)
        walletTransfersRef.on('value', (snapshot) => {
            const walletTransfers = snapshot.val() || {};
            window.cachedWalletTransfers = walletTransfers; // Cache data
            // Only render if records data is also available
            if (window.cachedRecords !== null) {
                renderAll(window.cachedRecords, walletTransfers);
            }
        }, (error) => {
            console.error('Lỗi khi đọc wallet_transfers từ Firebase:', error);
            alert('Không thể kết nối với Firebase (Wallet Transfers). Vui lòng kiểm tra kết nối mạng hoặc cấu hình.');
        });
    });

    // Handle currency input formatting
    document.querySelectorAll('.currency-input').forEach(input => {
        input.addEventListener('input', (e) => {
            // Lấy giá trị số (ví dụ: 1000000)
            const num = unformatVND(e.target.value);
            // Định dạng lại (ví dụ: 1.000.000)
            e.target.value = num.toLocaleString('vi-VN');
        });
        // Khi blur, thêm ký tự ₫ nếu chưa có và định dạng lại
        input.addEventListener('blur', (e) => {
            const num = unformatVND(e.target.value);
            e.target.value = formatVND(num);
        });
        // Khi focus, xóa ký tự ₫ và định dạng
        input.addEventListener('focus', (e) => {
            const num = unformatVND(e.target.value);
            e.target.value = num.toLocaleString('vi-VN');
        });
    });


    // MODIFIED: Handle click on the 'Thêm Giao Dịch Thu' button
    addRevenueBtn.addEventListener('click', () => {
        modalTitle.innerText = "Thêm Giao Dịch Thu";
        modalSubmitBtn.innerText = "Xác nhận Thu";
        transactionTypeEl.value = "revenue";
        revenueFieldsEl.style.display = 'block';
        expenseFieldEl.style.display = 'none';
        modalAmountEl.required = false;
        modalAmountCashEl.required = true;
        modalAmountTransferEl.required = true;
        modalEntryDateEl.value = new Date().toISOString().slice(0, 10);
        modalAmountCashEl.value = "0";
        modalAmountTransferEl.value = "0";
        modalDetailsEl.value = "";
        addTransactionModal.show();
    });

    // START: Logic mới cho các button liên quan đến Modal Quản Lý Ví
    
    // 1. MODIFIED: Handle click on the formerly 'Thêm Giao Dịch Chi' button (now 'Rút về Ví Duy trì'). 
    // This button will launch the Nạp Ví (Deposit) functionality, which is a withdrawal from Cash.
    addExpenseBtn.addEventListener('click', () => {
        updateAndShowTransferModal(
            'transfer-form-tab', // Tự động mở tab Nạp Ví (Deposit)
            `Rút tiền từ Dư Tiền mặt về Ví Duy trì`,
            `Rút tiền từ Ví Chuyển khoản về Tiền mặt`
        );
    });

    // 2. Handle click on the 'Quản lý Ví' button
    transferToWalletBtn.addEventListener('click', () => {
         updateAndShowTransferModal(
            'transfer-form-tab', // Mở tab Nạp Ví mặc định
            `Chuyển tiền từ Tiền mặt sang Ví Chuyển khoản`,
            `Rút tiền từ Ví Chuyển khoản về Tiền mặt`
        );
    });

    // 3. Handle click on the 'Rút tiền' button in the Cash Balance box
    withdrawFromWalletBtn.addEventListener('click', () => {
        updateAndShowTransferModal(
            'withdraw-form-tab', // Tự động mở tab Rút Ví (Withdrawal)
            `Chuyển tiền từ Tiền mặt sang Ví Chuyển khoản`,
            `Rút tiền từ Ví Chuyển khoản về Tiền mặt`
        );
    });
    
    // END: Logic mới cho các button liên quan đến Modal Quản Lý Ví

    // Handle form submission from the Add Transaction Modal
    addTransactionForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        const type = transactionTypeEl.value;
        const date = modalEntryDateEl.value;
        const details = modalDetailsEl.value.trim();

        if (type === 'revenue') {
            const amountCash = unformatVND(modalAmountCashEl.value);
            const amountTransfer = unformatVND(modalAmountTransferEl.value);

            if (amountCash <= 0 && amountTransfer <= 0) {
                alert("Vui lòng nhập số tiền thu.");
                return;
            }

            if (amountCash > 0) {
                await addSingleEntry(date, amountCash, 0, details || "Thu Tiền mặt", 'cash');
            }
            if (amountTransfer > 0) {
                await addSingleEntry(date, amountTransfer, 0, details || "Thu Chuyển khoản", 'transfer');
            }
        } else if (type === 'expense') {
            // Chức năng Thêm Giao Dịch Chi tiêu thông thường (đã bị gỡ khỏi nút bấm chính, chỉ còn trong logic này nếu được gọi)
            const amount = unformatVND(modalAmountEl.value);

            if (amount <= 0) {
                alert("Vui lòng nhập số tiền chi.");
                return;
            }

            await addSingleEntry(date, 0, amount, details || "Chi tiêu", null);
        }

        addTransactionForm.reset();
        addTransactionModal.hide();
    });

    // Handle form submission from the Transfer Modal (Nạp Ví - Deposit to Wallet)
    transferForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        const date = transferDateEl.value;
        const amount = unformatVND(transferAmountEl.value);
        const details = transferDetailsEl.value.trim();
        const maxAmount = Number(hiddenAvailableCashBalanceEl.value);

        if (amount <= 0) {
            alert("Vui lòng nhập số tiền muốn nạp vào Ví Chuyển Khoản.");
            return;
        }

        if (amount > maxAmount) {
            alert(`[THÔNG BÁO LỖI] Số tiền nạp (${formatVND(amount)}) đã vượt quá Số Dư Tiền Mặt hiện có (${formatVND(maxAmount)}). Vui lòng nhập số tiền nhỏ hơn hoặc bằng số dư.`);
            return;
        }

        const transferGroupId = 'WDI-' + Date.now(); // Wallet Deposit Group ID
        const baseTransactionData = {
            details: details,
            timestamp: firebase.database.ServerValue.TIMESTAMP,
            transferGroupId: transferGroupId // Link both transactions
        };

        // 1. Giao dịch Chi Tiền Mặt (Giảm Cash) - Saved to wallet_transfers (Expense part)
        const cashOutRecordData = {
            ...baseTransactionData,
            revenue: 0,
            expense: amount,
            paymentMethod: 'wallet_out_cash',
            details: `[Nạp Ví OUT] Giảm tiền mặt: ${details}`
        };
        await walletTransfersRef.push(cashOutRecordData); 

        // 2. Giao dịch Thu vào Ví Chuyển Khoản (Tăng Wallet) - Saved to wallet_transfers (Revenue part)
      // 2. Giao dịch Thu vào Ví Chuyển Khoản (Tăng Wallet)
        // ĐÃ CHỈNH SỬA THEO YÊU CẦU: Đặt revenue = 0 để Ví Chuyển Khoản không tăng.
        const inWalletData = {
            ...baseTransactionData,
            revenue: 0, // <--- CHỈNH SỬA: Đặt thành 0. Ví Chuyển Khoản sẽ không tăng lên.
            expense: 0,
            paymentMethod: 'wallet_in',
            details: `[Nạp Ví IN (Đã loại bỏ)] Thu vào Ví: ${details}` // Details for internal tracking
        };
        await walletTransfersRef.push(inWalletData);
        
        // 3. NEW: Add transaction to vi/lichsu node (This is a 'thu' for the wallet)
        const viLichSuData = {
            chitiet: details,
            loai: 'thu', // Rút tiền từ Dư Tiền mặt về Ví Duy trì là 'thu' cho Ví
            ngay: date,
            sotien: amount,
            time: firebase.database.ServerValue.TIMESTAMP
        };
        await viLichSuRef.push(viLichSuData); // <--- ĐÃ THÊM

        transferForm.reset();
        transferModal.hide();
    });

    // Handle form submission from the Withdrawal Modal (Rút Ví)
    withdrawForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        const date = withdrawDateEl.value;
        const amount = unformatVND(withdrawAmountEl.value);
        const details = withdrawDetailsEl.value.trim();
        const maxAmount = Number(hiddenAvailableWalletBalanceWithdrawEl.value);

        if (amount <= 0) {
            alert("Vui lòng nhập số tiền muốn rút về Tiền Mặt.");
            return;
        }

        if (amount > maxAmount) {
            alert(`[THÔNG BÁO LỖI] Số tiền rút (${formatVND(amount)}) đã vượt quá Số Dư Ví Chuyển Khoản hiện có (${formatVND(maxAmount)}). Vui lòng nhập số tiền nhỏ hơn hoặc bằng số dư.`);
            return;
        }

        const transferGroupId = 'WWD-' + Date.now(); // Wallet Withdrawal Group ID
        const baseTransactionData = {
            details: details,
            timestamp: firebase.database.ServerValue.TIMESTAMP,
            transferGroupId: transferGroupId // Link both transactions
        };

        // 1. Giao dịch Chi từ Ví Chuyển Khoản (Giảm Ví) - Saved to wallet_transfers (Expense part)
        const withdrawOutWalletData = {
            ...baseTransactionData,
            revenue: 0,
            expense: amount,
            paymentMethod: 'wallet_withdraw_out',
            details: `[Rút Ví OUT] Rút tiền từ Ví: ${details}`
        };
        await walletTransfersRef.push(withdrawOutWalletData);

        // 2. Giao dịch Thu vào Tiền Mặt (Tăng Tiền Mặt) - MOVED TO wallet_transfers
        const cashInRecordData = {
            ...baseTransactionData,
            revenue: amount,
            expense: 0,
            details: `[Rút Ví IN] Thu tiền mặt từ Ví: ${details}`,
            timestamp: firebase.database.ServerValue.TIMESTAMP,
            paymentMethod: 'cash_in_from_wallet', // New special method
        };
        // KEY CHANGE: Save to wallet_transfers
        await walletTransfersRef.push(cashInRecordData);
        
        // 3. NEW: Add transaction to vi/lichsu node (This is a 'chi' for the wallet)
        const viLichSuData = {
            chitiet: details,
            loai: 'chi', // Rút tiền từ Ví Chuyển khoản là 'chi' cho Ví
            ngay: date,
            sotien: amount,
            time: firebase.database.ServerValue.TIMESTAMP
        };
        await viLichSuRef.push(viLichSuData); // <--- ĐÃ THÊM
        
        withdrawForm.reset();
        transferModal.hide();
    });

    // Handle form submission from the Wallet Expense Modal (Chi Ví - Spend from Wallet)
    walletExpenseForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        const date = walletExpenseDateEl.value;
        const amount = unformatVND(walletExpenseAmountEl.value);
        const details = walletExpenseDetailsEl.value.trim();
        const maxAmount = Number(hiddenAvailableWalletBalanceEl.value);

        if (amount <= 0) {
            alert("Vui lòng nhập số tiền muốn chi từ Ví Chuyển Khoản.");
            return;
        }
        
        if (amount > maxAmount) {
            alert(`[THÔNG BÁO LỖI] Số tiền chi (${formatVND(amount)}) đã vượt quá Số Dư Ví Chuyển Khoản hiện có (${formatVND(maxAmount)}). Vui lòng nhập số tiền nhỏ hơn hoặc bằng số dư.`);
            return;
        }

        // 1. Giao dịch Chi từ Ví Chuyển Khoản (Giảm Ví) - Saved to wallet_transfers (Expense part)
        const expenseData = {
            revenue: 0,
            expense: amount,
            details: details || "Chi tiêu từ Ví Chuyển khoản",
            timestamp: firebase.database.ServerValue.TIMESTAMP,
            paymentMethod: 'wallet_expense',
        };
        
        await walletTransfersRef.push(expenseData);

        // 2. NEW: Add transaction to vi/lichsu node (This is a 'chi' for the wallet)
        const viLichSuData = {
            chitiet: details,
            loai: 'chi', // Chi tiêu từ Ví Chuyển khoản là 'chi' cho Ví
            ngay: date,
            sotien: amount,
            time: firebase.database.ServerValue.TIMESTAMP
        };
        await viLichSuRef.push(viLichSuData); // <--- ĐÃ THÊM

        walletExpenseForm.reset();
        transferModal.hide();
    });

    // Handle dropdown changes for reporting
    reportViewEl.addEventListener('change', () => renderAll(window.cachedRecords, window.cachedWalletTransfers));
    sortOrderEl.addEventListener('change', () => renderAll(window.cachedRecords, window.cachedWalletTransfers));

    // Export/Import listeners
    document.getElementById('exportJson').addEventListener('click', () => exportJson(window.cachedRecords, window.cachedWalletTransfers));
    document.getElementById('exportCsv').addEventListener('click', () => {
        const records = window.cachedRecords;
        const dailyAggregatedRecords = {};
        for (const dateKey in records) {
            const dailyRecord = records[dateKey];
            let dailyRevenueCash = 0;
            let dailyRevenueTransfer = 0;
            let dailyExpense = 0;
            let hasTransactions = false;

            if (dailyRecord.transactions) {
                Object.values(dailyRecord.transactions).forEach(trans => {
                    if (trans.revenue > 0) {
                        if (trans.paymentMethod === 'cash') {
                            dailyRevenueCash += Number(trans.revenue || 0);
                        } else if (trans.paymentMethod === 'transfer') {
                            dailyRevenueTransfer += Number(trans.revenue || 0);
                        }
                    }
                    if (trans.expense > 0) {
                        dailyExpense += Number(trans.expense || 0);
                    }
                    hasTransactions = true;
                });
            }

            if (hasTransactions) {
                dailyAggregatedRecords[dateKey] = {
                    date: dateKey,
                    revenue: dailyRevenueCash + dailyRevenueTransfer,
                    expense: dailyExpense,
                    net: (dailyRevenueCash + dailyRevenueTransfer) - dailyExpense
                };
            }
        }
        exportCsv(dailyAggregatedRecords);
    });
    
    document.getElementById('importJsonBtn').addEventListener('click', () => document.getElementById('importFile').click());
    document.getElementById('importFile').addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
            importJsonFile(e.target.files[0]);
        }
    });

    // Filter Controls
    toggleDateFilterBtn.addEventListener('click', () => {
        if (dateFilterControlsEl.style.display === 'none') {
            dateFilterControlsEl.style.display = 'block';
            toggleDateFilterBtn.innerHTML = '<i class="fas fa-calendar-times me-2"></i> **Tắt Thống kê theo Ngày**';
            specificDateFilterEl.value = new Date().toISOString().slice(0, 10); // Set to current date
            updateFilteredTotalsUI(window.cachedRecords, window.cachedWalletTransfers);
        } else {
            dateFilterControlsEl.style.display = 'none';
            toggleDateFilterBtn.innerHTML = '<i class="fas fa-calendar-check me-2"></i> **Thống kê theo Ngày Cụ thể**';
        }
    });

    applyDateFilterBtn.addEventListener('click', () => {
        updateFilteredTotalsUI(window.cachedRecords, window.cachedWalletTransfers);
    });

    specificDateFilterEl.addEventListener('change', () => {
         updateFilteredTotalsUI(window.cachedRecords, window.cachedWalletTransfers);
    });
    
    // Attach to window
    window.clearAll = clearAll;
    window.addSampleData = addSampleData;

    </script>
</body>
</html>
