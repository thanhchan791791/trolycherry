<!doctype html>
<html lang="vi">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Sổ Thu Chi Hàng Ngày - Firebase</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">

    <style>
        :root {
            --primary-color: #4CAF50; /* Green */
            --secondary-color: #e0e7f7;
            --text-color: #34495e; /* Dark Blue */
            --light-bg: #f9fbfd;
            --card-bg: #ffffff;
            --shadow-light: rgba(0, 0, 0, 0.05);
            --border-color: #e6e9ed;
            --positive: #28a745;
            --negative: #dc3545;
            --cash: #ffc107; /* Amber for Cash */
            --transfer: #007bff; /* Blue for Transfer */
        }

        body {
            background-color: var(--light-bg);
            font-family: 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
            color: var(--text-color);
            transition: background-color 0.3s ease;
        }
        .container-fluid {
            max-width: 1200px;
        }
        .card {
            border: none;
            border-radius: 1.5rem;
            box-shadow: 0 10px 30px var(--shadow-light);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.1);
        }
        .card-header-styled {
            background: linear-gradient(45deg, var(--primary-color), #81c784);
            color: white;
            padding: 1.5rem 2rem;
            border-top-left-radius: 1.5rem;
            border-top-right-radius: 1.5rem;
            margin-bottom: 1.5rem;
        }
        .form-control, .form-select {
            border-radius: 0.75rem;
            border: 1px solid var(--border-color);
            padding: 0.75rem 1rem;
            transition: all 0.3s ease;
        }
        .form-control:focus, .form-select:focus {
            box-shadow: 0 0 0 0.25rem rgba(76, 175, 80, 0.25);
            border-color: var(--primary-color);
        }
        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
            border-radius: 0.75rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        .btn-primary:hover {
            background-color: #388e3c;
            border-color: #388e3c;
            transform: translateY(-2px);
        }
        .btn-outline-secondary, .btn-light {
            border-radius: 0.75rem;
            transition: all 0.3s ease;
        }
        .btn-outline-secondary:hover {
            background-color: var(--secondary-color);
        }
        .btn-sm-custom {
            border-radius: 0.5rem;
            font-size: 0.8rem;
            padding: 0.3rem 0.6rem;
        }
        .balance-box {
            background-color: var(--card-bg); /* Use white background for filtered totals */
            border: 1px solid var(--border-color);
            border-radius: 1.25rem;
            padding: 1.5rem;
            text-align: center;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            transition: all 0.3s ease;
        }
        .balance-box:hover {
            transform: scale(1.03);
            box-shadow: 0 5px 15px var(--shadow-light);
        }
        .balance-box .small-muted {
            font-size: 0.9rem;
            color: #6c757d;
        }
        .balance-box .h4 {
            font-weight: 700;
            margin-top: 0.5rem;
        }
        .balance-positive {
            color: var(--positive);
        }
        .balance-negative {
            color: var(--negative);
        }
        .balance-cash {
            color: var(--cash);
        }
        .balance-transfer {
            color: var(--transfer);
        }
        .total-summary {
            background-color: #f0f4fa;
            border-radius: 1.5rem;
            padding: 1.5rem;
        }
        /* Style for the overall totals box (different background) */
        .overall-totals .balance-box {
            background-color: var(--secondary-color); /* Retain secondary color for overall totals */
            border: none;
        }
        .table-fixed {
            max-height: 500px;
            overflow-y: auto;
            overflow-x: auto;
            border-radius: 1.5rem;
        }
        .table-fixed::-webkit-scrollbar {
            width: 8px;
        }
        .table-fixed::-webkit-scrollbar-thumb {
            background-color: #d1d8e0;
            border-radius: 10px;
        }
        .table-fixed::-webkit-scrollbar-track {
            background-color: transparent;
        }
        .table {
            --bs-table-bg: var(--card-bg);
        }
        .table thead th {
            position: sticky;
            top: 0;
            background-color: var(--card-bg);
            box-shadow: 0 2px 2px -1px rgba(0, 0, 0, 0.1);
            z-index: 10;
        }
        .table tbody tr {
            transition: all 0.2s ease;
        }
        .table tbody tr:hover {
            background-color: #f0f4f7 !important;
        }
        .action-cell .btn {
            margin-right: 0.25rem;
            transition: all 0.2s ease;
        }
        .action-cell .btn:hover {
            transform: scale(1.1);
        }
        .fade-in {
            animation: fadeIn 0.8s ease-out;
        }
        .fade-in-up {
            animation: fadeInUp 0.6s ease-out forwards;
            opacity: 0;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes fadeInUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        /* CSS cho mobile, chỉ áp dụng cho bảng lịch sử giao dịch chính */
        @media (max-width: 767.98px) {
            .table.table-hover {
                width: 100%;
            }
            .table-fixed {
                border: 1px solid var(--border-color);
            }
            .table.table-hover thead, .action-header {
                display: none;
            }
            .table.table-hover tbody tr {
                display: block;
                margin-bottom: 1rem;
                border: 1px solid var(--border-color);
                border-radius: 1rem;
                padding: 1rem;
                box-shadow: 0 4px 12px var(--shadow-light);
            }
            .table.table-hover tbody tr:hover {
                background-color: var(--card-bg) !important;
                transform: translateY(-2px);
            }
            .table.table-hover td {
                display: block;
                text-align: right;
                border: none;
                padding: 0.5rem 0;
                position: relative;
                padding-left: 50%;
            }
            .table.table-hover td::before {
                content: attr(data-label);
                position: absolute;
                left: 10px;
                width: calc(50% - 20px);
                text-align: left;
                font-weight: bold;
                color: #6c757d;
            }
            .table.table-hover td button {
                width: 100%;
                margin: 0.25rem 0;
            }
            
            /* Điều chỉnh kích thước cột cho mobile */
            .total-summary .row.g-3 > div {
                flex: 0 0 100%;
                max-width: 100%;
            }
        }
        
        .transfer-wallet-box {
            background-color: var(--transfer);
            color: white;
            border: none;
        }
        .transfer-wallet-box .small-muted {
            color: rgba(255, 255, 255, 0.8);
        }
        /* Style for Fund Wallet */
        .fund-wallet-box {
            background-color: #ff9800; /* Orange color for Fund */
            color: white;
            border: none;
        }
        .fund-wallet-box .small-muted {
            color: rgba(255, 255, 255, 0.8);
        }
    </style>
</head>
<body>
    <div class="container-fluid py-5">
        <div class="d-flex align-items-center mb-4 fade-in">
            <h1 class="me-3 fw-bold text-primary">Sổ Thu Chi</h1>
            <div class="badge bg-secondary-subtle text-secondary small-muted py-2 px-3 rounded-pill">Đồng bộ qua Firebase (Realtime)</div>
        </div>

        <div class="row g-4">
            <div class="col-lg-5">
                <div class="card p-4 fade-in-up">
                    <div class="card-header-styled mb-4">
                        <h4 class="mb-0 text-white"><i class="fas fa-plus-circle me-2"></i> Thêm Giao Dịch Mới</h4>
                    </div>
                    <div class="d-grid gap-3 d-md-flex justify-content-md-start mb-4">
                        <button type="button" class="btn btn-success btn-lg flex-fill" id="addRevenueBtn"><i class="fas fa-arrow-down me-2"></i> Thêm Giao Dịch Thu</button>
                        <button type="button" class="btn btn-danger btn-lg flex-fill" id="addExpenseBtn"><i class="fas fa-arrow-up me-2"></i> Thêm Giao Dịch Chi</button>
                    </div>

                    <hr class="text-secondary-subtle my-4">

                    <div class="total-summary text-center">
                        <h5 class="fw-bold mb-3"><i class="fas fa-chart-pie me-2"></i> Tổng hợp (Tất cả dữ liệu)</h5>
                        <div class="row g-3 overall-totals">
                            <div class="col-6 col-md-4">
                                <div class="balance-box">
                                    <div class="small-muted">Thu Tiền mặt</div>
                                    <div id="totalRevenueCash" class="h4 balance-cash">0 ₫</div>
                                </div>
                            </div>
                            <div class="col-6 col-md-4">
                                <div class="balance-box">
                                    <div class="small-muted">Thu Chuyển khoản</div>
                                    <div id="totalRevenueTransfer" class="h4 balance-transfer">0 ₫</div>
                                </div>
                            </div>
                            <div class="col-12 col-md-4">
                                <div class="balance-box">
                                    <div class="small-muted">Tổng Chi tiêu</div>
                                    <div id="totalExpense" class="h4 balance-negative">0 ₫</div>
                                </div>
                            </div>
                            <div class="col-6 col-md-6">
                                <div class="balance-box">
                                    <div class="small-muted">Tổng Dư</div>
                                    <div id="totalBalance" class="h4">0 ₫</div>
                                </div>
                            </div>
                            <div class="col-6 col-md-6">
                                <div class="balance-box">
                                    <div class="small-muted">Dư Tiền mặt</div>
                                    <div id="totalBalanceCash" class="h4">0 ₫</div>
                                </div>
                            </div>
                            <div class="col-12 col-md-6">
                                <div class="balance-box transfer-wallet-box">
                                    <div class="d-flex justify-content-between align-items-center w-100">
                                        <div class="text-start">
                                            <div class="small-muted">Ví Chuyển Khoản</div>
                                            <div id="totalWalletBalance" class="h4 text-white">0 ₫</div>
                                        </div>
                                        <button id="transferToWalletBtn" class="btn btn-sm btn-light btn-sm-custom ms-2"><i class="fas fa-exchange-alt me-1"></i> Quản lý Ví</button>
                                    </div>
                                </div>
                            </div>
                            <div class="col-12 col-md-6">
                                <div class="balance-box fund-wallet-box">
                                    <div class="d-flex justify-content-between align-items-center w-100">
                                        <div class="text-start">
                                            <div class="small-muted">Ví Quỹ</div>
                                            <div id="totalFundBalance" class="h4 text-white">0 ₫</div>
                                        </div>
                                        <button id="fundToWalletBtn" class="btn btn-sm btn-light btn-sm-custom ms-2"><i class="fas fa-piggy-bank me-1"></i> Quản lý Quỹ</button>
                                    </div>
                                </div>
                            </div>
                            </div>

                        <hr class="text-secondary-subtle my-4">
                        <button id="toggleDateFilterBtn" class="btn btn-sm btn-outline-primary mb-3">
                            <i class="fas fa-calendar-check me-2"></i> **Thống kê theo Ngày Cụ thể**
                        </button>

                        <div id="dateFilterControls" style="display: none;">
                            <h5 class="fw-bold mb-3 text-start"><i class="fas fa-sliders-h me-2"></i> Chọn Ngày Cụ thể</h5>
                            <div class="row g-3 align-items-end mb-4">
                                <div class="col-12 col-md-8">
                                    <label for="specificDateFilter" class="form-label small-muted mb-1">Ngày</label>
                                    <input type="date" id="specificDateFilter" class="form-control" />
                                </div>
                                <div class="col-12 col-md-4">
                                    <button id="applyDateFilterBtn" class="btn btn-primary w-100"><i class="fas fa-filter me-1"></i> Lọc & Hiển thị</button>
                                </div>
                            </div>

                            <div id="filteredTotals" class="row g-3">
                                <div class="col-6 col-md-4">
                                    <div class="balance-box">
                                        <div class="small-muted">Thu Tiền mặt đã lọc</div>
                                        <div id="filteredRevenueCash" class="h4 balance-cash">0 ₫</div>
                                    </div>
                                </div>
                                <div class="col-6 col-md-4">
                                    <div class="balance-box">
                                        <div class="small-muted">Thu Chuyển khoản đã lọc</div>
                                        <div id="filteredRevenueTransfer" class="h4 balance-transfer">0 ₫</div>
                                    </div>
                                </div>
                                <div class="col-12 col-md-4">
                                    <div class="balance-box">
                                        <div class="small-muted">Chi tiêu đã lọc</div>
                                        <div id="filteredExpense" class="h4 balance-negative">0 ₫</div>
                                    </div>
                                </div>
                                <div class="col-6 col-md-6">
                                    <div class="balance-box">
                                        <div class="small-muted">Số Dư đã lọc</div>
                                        <div id="filteredBalance" class="h4">0 ₫</div>
                                    </div>
                                </div>
                                <div class="col-6 col-md-6">
                                    <div class="balance-box">
                                        <div class="small-muted">Dư Tiền mặt đã lọc</div>
                                        <div id="filteredBalanceCash" class="h4">0 ₫</div>
                                    </div>
                                </div>
                                </div>
                        </div>
                        </div>

                    <div class="mt-4 d-flex flex-wrap gap-2">
                        <button id="exportCsv" class="btn btn-sm btn-outline-success btn-sm-custom"><i class="fas fa-file-csv me-1"></i> CSV</button>
                        <button id="exportJson" class="btn btn-sm btn-outline-primary btn-sm-custom"><i class="fas fa-file-code me-1"></i> JSON</button>
                        <input type="file" id="importFile" accept=".json" style="display:none;">
                        <button id="importJsonBtn" class="btn btn-sm btn-outline-dark btn-sm-custom"><i class="fas fa-upload me-1"></i> Import</button>
                        <button id="resetBtn" class="btn btn-sm btn-outline-danger btn-sm-custom ms-auto"><i class="fas fa-trash-alt me-1"></i> Reset</button>
                        <button id="addSampleBtn" class="btn btn-sm btn-outline-info btn-sm-custom"><i class="fas fa-database me-1"></i> Thêm dữ liệu mẫu</button>
                    </div>
                </div>
            </div>

            <div class="col-lg-7">
                <div class="card p-4 fade-in-up">
                    <div class="d-flex align-items-center mb-3">
                        <h4 class="mb-0 fw-bold me-auto" id="reportTitle"><i class="fas fa-history me-2"></i> Lịch sử Giao dịch</h4>
                        <div class="d-flex align-items-center gap-2">
                            <select id="reportView" class="form-select form-select-sm">
                                <option value="day">Theo Ngày</option>
                                <option value="month">Theo Tháng</option>
                                <option value="quarter">Theo Quý</option>
                            </select>
                            <select id="sortOrder" class="form-select form-select-sm">
                                <option value="desc">Mới nhất</option>
                                <option value="asc">Cũ nhất</option>
                            </select>
                        </div>
                    </div>

                    <div class="table-fixed">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr id="tableHeader">
                                    <th class="date-header">Ngày</th>
                                    <th>Doanh thu</th>
                                    <th>Chi tiêu</th>
                                    <th>Số dư</th>
                                    <th>Chi tiết</th>
                                    <th class="action-header">Hành động</th>
                                </tr>
                            </thead>
                            <tbody id="historyBody">
                                </tbody>
                        </table>
                    </div>
                    <div id="noDataMessage" class="text-center text-muted p-4 d-none">
                        <i class="fas fa-box-open fa-2x mb-2"></i>
                        <p>Chưa có dữ liệu nào. Hãy thêm giao dịch đầu tiên!</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="addTransactionModal" tabindex="-1" aria-labelledby="addTransactionModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addTransactionModalLabel"></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="addTransactionForm">
                    <div class="modal-body">
                        <input type="hidden" id="transactionType">
                        <div class="mb-3">
                            <label class="form-label fw-bold">Ngày</label>
                            <input type="date" id="modalEntryDate" class="form-control" required>
                        </div>
                        
                        <div id="revenueFields" style="display: none;">
                            <div class="row g-3 mb-3">
                                <div class="col-md-6">
                                    <label class="form-label fw-bold"><i class="fas fa-money-bill-wave me-1 text-warning"></i> Thu Tiền mặt (VND)</label>
                                    <input type="text" id="modalAmountCash" class="form-control currency-input" value="0">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-bold"><i class="fas fa-exchange-alt me-1 text-primary"></i> Thu Chuyển khoản (VND)</label>
                                    <input type="text" id="modalAmountTransfer" class="form-control currency-input" value="0">
                                </div>
                            </div>
                        </div>

                        <div class="mb-3" id="expenseField" style="display: none;">
                            <label class="form-label fw-bold" id="modalAmountLabel"></label>
                            <input type="text" id="modalAmount" class="form-control currency-input" required>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label fw-bold">Chi tiết Giao dịch</label>
                            <textarea id="modalDetails" class="form-control" rows="3"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                        <button type="submit" class="btn btn-primary" id="modalSubmitBtn"></button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <div class="modal fade" id="transferModal" tabindex="-1" aria-labelledby="transferModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="transferModalLabel"><i class="fas fa-exchange-alt me-2"></i> Quản Lý Ví Chuyển Khoản</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <ul class="nav nav-tabs mb-3" id="transferTab" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="transfer-form-tab" data-bs-toggle="tab" data-bs-target="#transfer-form-pane" type="button" role="tab" aria-controls="transfer-form-pane" aria-selected="true"><i class="fas fa-hand-holding-usd me-1"></i> Nạp Ví</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="expense-form-tab" data-bs-toggle="tab" data-bs-target="#expense-form-pane" type="button" role="tab" aria-controls="expense-form-pane" aria-selected="false"><i class="fas fa-wallet me-1"></i> Chi Ví</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="transfer-history-tab" data-bs-toggle="tab" data-bs-target="#transfer-history-pane" type="button" role="tab" aria-controls="transfer-history-pane" aria-selected="false"><i class="fas fa-history me-1"></i> Lịch sử Chuyển/Chi</button>
                        </li>
                    </ul>
                    <div class="tab-content" id="transferTabContent">
                        <div class="tab-pane fade show active" id="transfer-form-pane" role="tabpanel" aria-labelledby="transfer-form-tab" tabindex="0">
                            <form id="transferForm">
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Ngày Nạp</label>
                                    <input type="date" id="transferDate" class="form-control" required>
                                </div>
                                <div class="mb-3 p-3 border rounded">
                                    <p class="mb-1 small-muted">Số Dư Tiền Mặt Hiện Có (Giới hạn nạp):</p>
                                    <h4 id="availableCashBalance" class="balance-cash fw-bold">0 ₫</h4>
                                    <input type="hidden" id="hiddenAvailableCashBalance" value="0">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Số Tiền Muốn Nạp vào Ví Chuyển Khoản (VND)</label>
                                    <input type="text" id="transferAmount" class="form-control currency-input" required placeholder="Nhập số tiền">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Chi tiết</label>
                                    <textarea id="transferDetails" class="form-control" rows="2">Chuyển tiền từ Tiền mặt sang Ví Chuyển khoản</textarea>
                                </div>
                                <div class="modal-footer px-0 pb-0">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                                    <button type="submit" class="btn btn-primary" id="transferSubmitBtn"><i class="fas fa-paper-plane me-1"></i> Xác Nhận Nạp</button>
                                </div>
                            </form>
                        </div>
                        
                        <div class="tab-pane fade" id="expense-form-pane" role="tabpanel" aria-labelledby="expense-form-tab" tabindex="0">
                            <form id="walletExpenseForm">
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Ngày Chi</label>
                                    <input type="date" id="walletExpenseDate" class="form-control" required>
                                </div>
                                <div class="mb-3 p-3 border rounded">
                                    <p class="mb-1 small-muted">Số Dư Ví Chuyển Khoản Hiện Có (Giới hạn chi):</p>
                                    <h4 id="availableWalletBalance" class="balance-transfer fw-bold">0 ₫</h4>
                                    <input type="hidden" id="hiddenAvailableWalletBalance" value="0">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Số Tiền Muốn Chi từ Ví Chuyển Khoản (VND)</label>
                                    <input type="text" id="walletExpenseAmount" class="form-control currency-input" required placeholder="Nhập số tiền chi">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Chi tiết Chi tiêu</label>
                                    <textarea id="walletExpenseDetails" class="form-control" rows="2" required></textarea>
                                </div>
                                <div class="modal-footer px-0 pb-0">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                                    <button type="submit" class="btn btn-danger" id="walletExpenseSubmitBtn"><i class="fas fa-paper-plane me-1"></i> Xác Nhận Chi Ví</button>
                                </div>
                            </form>
                        </div>

                        <div class="tab-pane fade" id="transfer-history-pane" role="tabpanel" aria-labelledby="transfer-history-tab" tabindex="0">
                            <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                                <table class="table table-striped table-sm mb-0">
                                    <thead>
                                        <tr>
                                            <th>Ngày</th>
                                            <th>Loại</th>
                                            <th>Số Tiền</th>
                                            <th>Chi tiết</th>
                                            <th>Hành động</th>
                                        </tr>
                                    </thead>
                                    <tbody id="transferHistoryBody">
                                        </tbody>
                                </table>
                            </div>
                            <div id="noTransferDataMessage" class="text-center text-muted p-4 d-none">
                                <i class="fas fa-box-open fa-2x mb-2"></i>
                                <p>Chưa có giao dịch nạp/chi ví nào.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="fundModal" tabindex="-1" aria-labelledby="fundModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-warning text-white">
                    <h5 class="modal-title" id="fundModalLabel"><i class="fas fa-piggy-bank me-2"></i> Quản Lý Ví Quỹ</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <ul class="nav nav-tabs mb-3" id="fundTab" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="fund-in-tab" data-bs-toggle="tab" data-bs-target="#fund-in-pane" type="button" role="tab" aria-controls="fund-in-pane" aria-selected="true"><i class="fas fa-arrow-down me-1"></i> Nạp Ví Quỹ</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="fund-expense-tab" data-bs-toggle="tab" data-bs-target="#fund-expense-pane" type="button" role="tab" aria-controls="fund-expense-pane" aria-selected="false"><i class="fas fa-arrow-up me-1"></i> Chi Ví Quỹ</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="fund-history-tab" data-bs-toggle="tab" data-bs-target="#fund-history-pane" type="button" role="tab" aria-controls="fund-history-pane" aria-selected="false"><i class="fas fa-history me-1"></i> Lịch sử Quỹ</button>
                        </li>
                    </ul>
                    <div class="tab-content" id="fundTabContent">
                        <div class="tab-pane fade show active" id="fund-in-pane" role="tabpanel" aria-labelledby="fund-in-tab" tabindex="0">
                            <form id="fundInForm">
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Ngày Nạp</label>
                                    <input type="date" id="fundInDate" class="form-control" required>
                                </div>
                                <div class="mb-3 p-3 border rounded">
                                    <p class="mb-1 small-muted">Số Dư Ví Chuyển Khoản Hiện Có (Giới hạn nạp):</p>
                                    <h4 id="availableTransferBalanceForFund" class="balance-transfer fw-bold">0 ₫</h4>
                                    <input type="hidden" id="hiddenAvailableTransferBalanceForFund" value="0">
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Số Tiền Muốn Nạp vào Ví Quỹ (VND)</label>
                                    <div class="input-group">
                                        <input type="text" id="fundInAmount" class="form-control currency-input" required placeholder="Nhập số tiền">
                                        <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">Nạp theo %</button>
                                        <ul class="dropdown-menu dropdown-menu-end">
                                            <li><a class="dropdown-item fund-percent-btn" data-percent="10">10%</a></li>
                                            <li><a class="dropdown-item fund-percent-btn" data-percent="20">20%</a></li>
                                            <li><a class="dropdown-item fund-percent-btn" data-percent="50">50%</a></li>
                                            <li><a class="dropdown-item fund-percent-btn" data-percent="75">75%</a></li>
                                            <li><a class="dropdown-item fund-percent-btn" data-percent="100">100%</a></li>
                                            <li><hr class="dropdown-divider"></li>
                                            <li>
                                                <div class="px-3 py-1 d-flex gap-2 align-items-center">
                                                    <input type="number" id="customFundPercent" class="form-control form-control-sm" min="1" max="100" placeholder="Tùy chỉnh %">
                                                    <button class="btn btn-sm btn-primary" type="button" id="applyCustomPercentBtn">Áp dụng</button>
                                                </div>
                                            </li>
                                        </ul>
                                    </div>
                                    <div class="form-text text-muted" id="fundInPercentInfo">Hoặc nhập số tiền trực tiếp.</div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Chi tiết</label>
                                    <textarea id="fundInDetails" class="form-control" rows="2">Chuyển tiền từ Ví Chuyển khoản sang Ví Quỹ</textarea>
                                </div>
                                <div class="modal-footer px-0 pb-0">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                                    <button type="submit" class="btn btn-warning text-white" id="fundInSubmitBtn"><i class="fas fa-paper-plane me-1"></i> Xác Nhận Nạp Quỹ</button>
                                </div>
                            </form>
                        </div>
                        
                        <div class="tab-pane fade" id="fund-expense-pane" role="tabpanel" aria-labelledby="fund-expense-tab" tabindex="0">
                            <form id="fundExpenseForm">
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Ngày Chi</label>
                                    <input type="date" id="fundExpenseDate" class="form-control" required>
                                </div>
                                <div class="mb-3 p-3 border rounded">
                                    <p class="mb-1 small-muted">Số Dư Ví Quỹ Hiện Có (Giới hạn chi):</p>
                                    <h4 id="availableFundBalance" class="balance-fund fw-bold">0 ₫</h4>
                                    <input type="hidden" id="hiddenAvailableFundBalance" value="0">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Số Tiền Muốn Chi từ Ví Quỹ (VND)</label>
                                    <input type="text" id="fundExpenseAmount" class="form-control currency-input" required placeholder="Nhập số tiền chi">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Chi tiết Chi tiêu</label>
                                    <textarea id="fundExpenseDetails" class="form-control" rows="2" required></textarea>
                                </div>
                                <div class="modal-footer px-0 pb-0">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                                    <button type="submit" class="btn btn-danger" id="fundExpenseSubmitBtn"><i class="fas fa-paper-plane me-1"></i> Xác Nhận Chi Quỹ</button>
                                </div>
                            </form>
                        </div>

                        <div class="tab-pane fade" id="fund-history-pane" role="tabpanel" aria-labelledby="fund-history-tab" tabindex="0">
                            <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                                <table class="table table-striped table-sm mb-0">
                                    <thead>
                                        <tr>
                                            <th>Ngày</th>
                                            <th>Loại</th>
                                            <th>Số Tiền</th>
                                            <th>Chi tiết</th>
                                            <th>Hành động</th>
                                        </tr>
                                    </thead>
                                    <tbody id="fundHistoryBody">
                                        </tbody>
                                </table>
                            </div>
                            <div id="noFundDataMessage" class="text-center text-muted p-4 d-none">
                                <i class="fas fa-box-open fa-2x mb-2"></i>
                                <p>Chưa có giao dịch nạp/chi quỹ nào.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="modal fade" id="detailsModal" tabindex="-1" aria-labelledby="detailsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="detailsModalLabel">Chi tiết Giao dịch</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="detailsModalBody">
                    </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

    <script>
    // Cấu hình Firebase của bạn
    const firebaseConfig = {
      apiKey: "AIzaSyB8uLkLJFlzmCodcawJhs2dRckHQzO5y10",
      authDomain: "chitieu-7263e.firebaseapp.com",
      databaseURL: "https://chitieu-7263e-default-rtdb.firebaseio.com",
      projectId: "chitieu-7263e",
      storageBucket: "chitieu-7263e.firebasestorage.app",
      messagingSenderId: "83833140682",
      appId: "1:83833140682:web:f9254b418ace3a659fcb33",
      measurementId: "G-523X74K18N"
    };

    // Khởi tạo Firebase
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    const recordsRef = database.ref('daily_records');
    // Reference for Wallet Transfers
    const walletTransfersRef = database.ref('wallet_transfers');
    // Reference for Fund Wallet Transfers
    const fundTransfersRef = database.ref('fund_transfers');


    // UI Elements
    const addRevenueBtn = document.getElementById('addRevenueBtn');
    const addExpenseBtn = document.getElementById('addExpenseBtn');
    const addTransactionModal = new bootstrap.Modal(document.getElementById('addTransactionModal'));
    const addTransactionForm = document.getElementById('addTransactionForm');
    const modalTitle = document.getElementById('addTransactionModalLabel');
    const modalAmountLabel = document.getElementById('modalAmountLabel');
    const modalSubmitBtn = document.getElementById('modalSubmitBtn');
    const transactionTypeEl = document.getElementById('transactionType');
    const modalEntryDateEl = document.getElementById('modalEntryDate');
    const modalAmountEl = document.getElementById('modalAmount'); // Expense Amount
    const modalAmountCashEl = document.getElementById('modalAmountCash'); // Cash Amount
    const modalAmountTransferEl = document.getElementById('modalAmountTransfer'); // Transfer Amount
    const modalDetailsEl = document.getElementById('modalDetails');
    const historyBodyEl = document.getElementById('historyBody');
    // Overall Totals
    const totalRevenueCashEl = document.getElementById('totalRevenueCash');
    const totalRevenueTransferEl = document.getElementById('totalRevenueTransfer');
    const totalExpenseEl = document.getElementById('totalExpense');
    const totalBalanceEl = document.getElementById('totalBalance');
    const totalBalanceCashEl = document.getElementById('totalBalanceCash');
    const totalWalletBalanceEl = document.getElementById('totalWalletBalance'); // Wallet Balance
    const totalFundBalanceEl = document.getElementById('totalFundBalance'); // Fund Wallet Balance

    const sortOrderEl = document.getElementById('sortOrder');
    const reportViewEl = document.getElementById('reportView');
    const reportTitleEl = document.getElementById('reportTitle');
    const tableHeaderEl = document.getElementById('tableHeader');
    const noDataMessageEl = document.getElementById('noDataMessage');
    const addSampleBtn = document.getElementById('addSampleBtn');
    const detailsModal = new bootstrap.Modal(document.getElementById('detailsModal'));
    const detailsModalBodyEl = document.getElementById('detailsModalBody');
    
    // UI Elements for Modal
    const revenueFieldsEl = document.getElementById('revenueFields'); // Revenue Fields Container
    const expenseFieldEl = document.getElementById('expenseField'); // Existing Expense Field Container

    // UI Elements for Date Filter (UPDATED)
    const toggleDateFilterBtn = document.getElementById('toggleDateFilterBtn'); // Nút Ẩn/Hiện
    const dateFilterControlsEl = document.getElementById('dateFilterControls'); // Khối điều khiển
    const specificDateFilterEl = document.getElementById('specificDateFilter'); // CHANGED ID
    const applyDateFilterBtn = document.getElementById('applyDateFilterBtn');
    // Filtered Totals
    const filteredRevenueCashEl = document.getElementById('filteredRevenueCash');
    const filteredRevenueTransferEl = document.getElementById('filteredRevenueTransfer');
    const filteredExpenseEl = document.getElementById('filteredExpense');
    const filteredBalanceEl = document.getElementById('filteredBalance');
    const filteredBalanceCashEl = document.getElementById('filteredBalanceCash');

    // UI Elements for Transfer Modal
    const transferToWalletBtn = document.getElementById('transferToWalletBtn');
    const transferModal = new bootstrap.Modal(document.getElementById('transferModal'));
    // Nạp Ví (Transfer In)
    const transferForm = document.getElementById('transferForm');
    const transferDateEl = document.getElementById('transferDate');
    const availableCashBalanceEl = document.getElementById('availableCashBalance');
    const hiddenAvailableCashBalanceEl = document.getElementById('hiddenAvailableCashBalance');
    const transferAmountEl = document.getElementById('transferAmount');
    const transferDetailsEl = document.getElementById('transferDetails');
    // Chi Ví (Wallet Expense)
    const walletExpenseForm = document.getElementById('walletExpenseForm');
    const walletExpenseDateEl = document.getElementById('walletExpenseDate');
    const availableWalletBalanceEl = document.getElementById('availableWalletBalance');
    const hiddenAvailableWalletBalanceEl = document.getElementById('hiddenAvailableWalletBalance');
    const walletExpenseAmountEl = document.getElementById('walletExpenseAmount');
    const walletExpenseDetailsEl = document.getElementById('walletExpenseDetails');
    
    // UI for History Tab
    const transferHistoryBodyEl = document.getElementById('transferHistoryBody');
    const noTransferDataMessageEl = document.getElementById('noTransferDataMessage');
    
    // UI Elements for Fund Modal
    const fundToWalletBtn = document.getElementById('fundToWalletBtn');
    const fundModal = new bootstrap.Modal(document.getElementById('fundModal'));
    // Nạp Quỹ (Fund In)
    const fundInForm = document.getElementById('fundInForm');
    const fundInDateEl = document.getElementById('fundInDate');
    const availableTransferBalanceForFundEl = document.getElementById('availableTransferBalanceForFund');
    const hiddenAvailableTransferBalanceForFundEl = document.getElementById('hiddenAvailableTransferBalanceForFund');
    const fundInAmountEl = document.getElementById('fundInAmount'); // The main input field (now linked to percentage logic)
    const fundInDetailsEl = document.getElementById('fundInDetails');
    
    // NEW: Percentage Controls for Fund In
    const customFundPercentEl = document.getElementById('customFundPercent');
    const applyCustomPercentBtnEl = document.getElementById('applyCustomPercentBtn');
    const fundInPercentInfoEl = document.getElementById('fundInPercentInfo');

    // Chi Quỹ (Fund Expense)
    const fundExpenseForm = document.getElementById('fundExpenseForm');
    const fundExpenseDateEl = document.getElementById('fundExpenseDate');
    const availableFundBalanceEl = document.getElementById('availableFundBalance');
    const hiddenAvailableFundBalanceEl = document.getElementById('hiddenAvailableFundBalance');
    const fundExpenseAmountEl = document.getElementById('fundExpenseAmount');
    const fundExpenseDetailsEl = document.getElementById('fundExpenseDetails');
    // UI for Fund History Tab
    const fundHistoryBodyEl = document.getElementById('fundHistoryBody');
    const noFundDataMessageEl = document.getElementById('noFundDataMessage');


    // --- Core Functions for Firebase ---
    function formatVND(n) {
        if (n === undefined || n === null) return '0 ₫';
        return Number(n).toLocaleString('vi-VN') + ' ₫';
    }
    
    // Function to format the number input with thousands separators
    function formatNumberInput(event) {
        let value = event.target.value.replace(/\D/g, ''); // Remove all non-digit characters
        if (value) {
            value = parseInt(value, 10).toLocaleString('vi-VN');
        }
        event.target.value = value;
    }
    
  // Function to unformat number input (remove dots and currency symbol)
function unformatVND(formattedString) {
    // Sử dụng biểu thức chính quy để chỉ giữ lại các ký tự số (0-9)
    const unformatted = formattedString.replace(/[^\d]/g, '');
    // Chuyển chuỗi số đã làm sạch thành kiểu Number
    return Number(unformatted || 0);
}

    /**
     * Helper function to format date from YYYY-MM-DD to DD/MM/YYYY.
     */
    function formatDate(dateStr) {
        if (!dateStr) return '';
        const parts = dateStr.split('-');
        if (parts.length === 3) {
            return `${parts[2]}/${parts[1]}/${parts[0]}`;
        }
        return dateStr;
    }

    /**
     * Adds a new transaction entry.
     * Use this to add a single transaction (Revenue, Expense, or Wallet Transfer).
     * @param {string} date - YYYY-MM-DD format
     * @param {number} revenue - Revenue amount
     * @param {number} expense - Expense amount
     * @param {string} details - Transaction details
     * @param {string} paymentMethod - 'cash', 'transfer', 'wallet_in', 'wallet_out_cash', 'wallet_expense', 'wallet_fund_out', 'fund_in', 'fund_expense' (UPDATED)
     */
    async function addSingleEntry(date, revenue = 0, expense = 0, details = '', paymentMethod = null) {
        if (!date) return;
        
        const transactionData = {
            revenue: Number(revenue || 0),
            expense: Number(expense || 0),
            details: details,
            timestamp: firebase.database.ServerValue.TIMESTAMP,
            paymentMethod: paymentMethod // Store paymentMethod even if null
        };
        
        // NEW LOGIC: Separate Fund Wallet Transfers
        if (['fund_in', 'fund_expense'].includes(paymentMethod)) { 
            const fundRef = fundTransfersRef.push();
            await fundRef.set(transactionData);
        }
        // Existing Logic: Separate Transfer Wallet Transfers (Updated to include wallet_fund_out)
        else if (['wallet_in', 'wallet_out_cash', 'wallet_expense', 'wallet_fund_out'].includes(paymentMethod)) { // Added 'wallet_fund_out'
            const transferRef = walletTransfersRef.push();
            await transferRef.set(transactionData);
        } else {
            // Regular transaction (Revenue or Expense)
            const transactionRef = recordsRef.child(date).child('transactions').push();
            await transactionRef.set(transactionData);
        }
    }
    
    /**
     * Deletes a full day's record and all its transactions.
     */
    async function deleteDay(date) {
        if (confirm('Xóa toàn bộ giao dịch của ngày ' + formatDate(date) + '?')) {
            await recordsRef.child(date).remove();
        }
    }

    /**
     * Deletes a single transaction.
     * @param {string} date - YYYY-MM-DD format (used for regular records)
     * @param {string} transactionId - Firebase push key
     * @param {string} sourceRef - 'records', 'wallet', or 'fund' (NEW)
     */
    async function deleteTransaction(date, transactionId, sourceRef = 'records') {
        if (confirm('Bạn có chắc muốn xóa giao dịch này không?')) {
            if (sourceRef === 'wallet') {
                await walletTransfersRef.child(transactionId).remove();
            } else if (sourceRef === 'fund') { // NEW
                await fundTransfersRef.child(transactionId).remove();
            } else {
                await recordsRef.child(date).child('transactions').child(transactionId).remove();
            }
        }
    }
    
    /**
     * Edits a single transaction. (Simplified for this file)
     */
    async function editTransaction(date, transactionId, currentRev, currentExp, currentDetails, currentPaymentMethod) {
        // ... (Keep existing editTransaction logic for simplicity, assuming it handles regular transactions)
        const isRevenue = currentRev > 0;
        const isExpense = currentExp > 0;
        
        // Handle only Revenue/Expense for simplicity in this prompt
        if (['wallet_in', 'wallet_out_cash', 'wallet_expense', 'wallet_fund_out', 'fund_in', 'fund_expense'].includes(currentPaymentMethod)) { // Updated check
            alert('Giao dịch Ví Chuyển Khoản/Ví Quỹ cần được xử lý riêng. Không thể chỉnh sửa ở đây.');
            return;
        }

        const newRev = isRevenue ? prompt('Sửa doanh thu:', currentRev) : currentRev;
        if (newRev === null) return;
        const newExp = isExpense ? prompt('Sửa chi tiêu:', currentExp) : currentExp;
        if (newExp === null) return;
        const newDetails = prompt('Sửa chi tiết:', currentDetails);
        if (newDetails === null) return;
        
        let newPaymentMethod = currentPaymentMethod;
        if (isRevenue) {
            let method = prompt('Sửa hình thức thu (cash/transfer):', currentPaymentMethod || 'cash');
            if (method === null) return;
            newPaymentMethod = method.toLowerCase() === 'transfer' ? 'transfer' : 'cash';
        }

        const updates = {
            revenue: Number(newRev || 0),
            expense: Number(newExp || 0),
            details: newDetails
        };

        if (isRevenue) {
            updates.paymentMethod = newPaymentMethod;
        } else {
            // Ensure paymentMethod is removed or undefined for generic expenses
            updates.paymentMethod = null;
        }
        
        await recordsRef.child(date).child('transactions').child(transactionId).update(updates);
    }
    
    async function clearAll() {
        if (!confirm('Bạn có chắc muốn xóa tất cả dữ liệu trên Firebase? Thao tác này không thể hoàn tác.')) return;
        await recordsRef.remove();
        await walletTransfersRef.remove(); 
        await fundTransfersRef.remove(); // NEW: Clear fund transfers
    }

    async function addSampleData() {
        // ... (Keep existing addSampleData logic)
        // NOTE: Does not include sample data for Fund Wallet for simplicity.
        if (!confirm('Bạn có muốn thêm dữ liệu mẫu để thử nghiệm không? Dữ liệu này sẽ được trộn với dữ liệu hiện có.')) return;
        
        const detailsList = ["Ăn uống", "Đi chợ", "Di chuyển", "Tiền nhà", "Mua sắm", "Gửi tiết kiệm", "Vui chơi"];
        const sampleTransactions = {};
        
        const days = 7; 
        let currentDate = new Date();
        currentDate.setDate(currentDate.getDate() - days);

        for (let i = 0; i < days; i++) {
            const dateStr = currentDate.toISOString().slice(0, 10);
            sampleTransactions[dateStr] = {};

            // Add revenue transactions
            const dailyRevenue = Math.floor(Math.random() * 5000000) + 500000;
            const cashRevenue = Math.floor(dailyRevenue * (Math.random() * 0.5 + 0.3)); // 30-80% cash
            const transferRevenue = dailyRevenue - cashRevenue;

            // Cash Revenue
            let method = 'cash';
            let revenueId = `trans-rev-${dateStr}-${method}`;
            sampleTransactions[dateStr][revenueId] = {
                revenue: cashRevenue,
                expense: 0,
                details: "Thu nhập tiền mặt",
                timestamp: currentDate.getTime() + Math.floor(Math.random() * 1000),
                paymentMethod: method
            };

            // Transfer Revenue
            if (transferRevenue > 0) {
                method = 'transfer';
                revenueId = `trans-rev-${dateStr}-${method}`;
                sampleTransactions[dateStr][revenueId] = {
                    revenue: transferRevenue,
                    expense: 0,
                    details: "Thu nhập chuyển khoản",
                    timestamp: currentDate.getTime() + Math.floor(Math.random() * 1000),
                    paymentMethod: method
                };
            }

            // Add expense transactions
            const numExpenses = Math.floor(Math.random() * 4) + 1; // 1-4 expense transactions per day
            for (let j = 0; j < numExpenses; j++) {
                const amount = Math.floor(Math.random() * 500000) + 10000;
                const details = detailsList[Math.floor(Math.random() * detailsList.length)];
                const transactionId = `trans-exp-${dateStr}-${j}`;
                sampleTransactions[dateStr][transactionId] = {
                    revenue: 0,
                    expense: amount,
                    details: details,
                    timestamp: currentDate.getTime() + Math.floor(Math.random() * 86400000)
                };
            }

            currentDate.setDate(currentDate.getDate() + 1);
        }

        const updates = {};
        for (const date in sampleTransactions) {
            // This is a simple merge.
            const existingTransactions = window.cachedRecords && window.cachedRecords[date] && window.cachedRecords[date].transactions ? window.cachedRecords[date].transactions : {};
            updates[`${date}/transactions`] = { ...existingTransactions, ...sampleTransactions[date] };
        }

        await recordsRef.update(updates);

        alert('Dữ liệu mẫu đã được thêm thành công!');
    }

    /**
     * Calculates total revenue, expense, balance, cash balance, and wallet balance.
     * @param {object} records - The cached Firebase daily_records object.
     * @param {object} walletTransfers - The cached Firebase wallet_transfers object.
     * @param {object} fundTransfers - The cached Firebase fund_transfers object. (NEW)
     * @param {string|null} specificDateStr - Optional date string to filter by.
     * @returns {object} Calculated totals.
     */
    function calculateTotals(records, walletTransfers, fundTransfers, specificDateStr = null) {
        let totalRevenueCash = 0;
        let totalRevenueTransfer = 0;
        let totalExpense = 0;

        // Wallet Transfer Movements
        let totalWalletIn = 0; // Cash -> Wallet (Revenue for Wallet)
        let totalWalletOutCash = 0; // Cash -> Wallet (Expense for Cash)
        let totalWalletExpense = 0; // Wallet -> Expense (Expense for Wallet/System)
        let totalWalletFundOut = 0; // NEW: Wallet -> Fund (Expense for Wallet)

        // Fund Wallet Movements (NEW)
        let totalFundIn = 0; // Wallet -> Fund (Revenue for Fund)
        let totalFundExpense = 0; // Fund -> Expense (Expense for Fund/System)


        // 1. Calculate Gross Revenue/Expense from daily_records (Regular transactions only)
        for (const dateKey in records) {
            // If filtering by a specific date, skip others
            if (specificDateStr && dateKey !== specificDateStr) continue;

            const dailyRecord = records[dateKey];
            if (dailyRecord.transactions) {
                Object.values(dailyRecord.transactions).forEach(trans => {
                    const revenue = Number(trans.revenue || 0);
                    const expense = Number(trans.expense || 0);
                    const method = trans.paymentMethod;

                    if (revenue > 0) {
                        if (method === 'transfer') {
                            totalRevenueTransfer += revenue;
                        } else {
                            // Default to cash if paymentMethod is missing or not 'transfer'
                            totalRevenueCash += revenue;
                        }
                    } else if (expense > 0) {
                        totalExpense += expense;
                    }
                });
            }
        }

        // 2. Calculate Wallet/Fund Movements (Only for Grand Total, ignore if filtering by specific date on main view)
        if (!specificDateStr) {
            // Wallet Transfers (Cash <> Wallet)
            for (const transKey in walletTransfers) {
                const trans = walletTransfers[transKey];
                if (trans.paymentMethod === 'wallet_in') {
                    totalWalletIn += Number(trans.revenue || 0);
                } else if (trans.paymentMethod === 'wallet_out_cash') {
                    totalWalletOutCash += Number(trans.expense || 0);
                } else if (trans.paymentMethod === 'wallet_expense') { 
                    totalWalletExpense += Number(trans.expense || 0);
                } else if (trans.paymentMethod === 'wallet_fund_out') { // NEW
                    totalWalletFundOut += Number(trans.expense || 0);
                }
            }
            
            // NEW: Fund Transfers (Wallet <> Fund)
            for (const transKey in fundTransfers) {
                const trans = fundTransfers[transKey];
                if (trans.paymentMethod === 'fund_in') {
                    totalFundIn += Number(trans.revenue || 0);
                } else if (trans.paymentMethod === 'fund_expense') { 
                    totalFundExpense += Number(trans.expense || 0);
                }
            }
        }

        // Calculations for Overall System Totals (Excluding internal transfers like wallet_in/out, fund_in/out)
        // Gross Revenue/Expense only includes actual income and direct expense (Regular + Wallet Expense + Fund Expense)
        const totalGrossRevenue = totalRevenueCash + totalRevenueTransfer;
        const totalGrossExpense = totalExpense + totalWalletExpense + totalFundExpense; // Added totalFundExpense
        const finalTotalNet = totalGrossRevenue - totalGrossExpense;

        // Cash Balance = Cash Revenue - Regular Expense - Cash Out for Wallet (Transfer In)
        const totalNetCash = totalRevenueCash - totalExpense - totalWalletOutCash;

        // Wallet Balance = Transfer Revenue + Wallet In (Cash to Wallet) - Wallet Expense (for System) - Wallet Fund Out (to Fund)
        const totalWalletBalance = totalRevenueTransfer + totalWalletIn - totalWalletExpense - totalWalletFundOut;

        // NEW: Fund Balance = Fund In (from Wallet) - Fund Expense (for System)
        const totalFundBalance = totalFundIn - totalFundExpense; // NEW

        return {
            revenueCash: totalRevenueCash,
            revenueTransfer: totalRevenueTransfer,
            expense: totalExpense, // Regular Expense from daily_records only
            net: finalTotalNet, // Overall system balance (Gross Revenue - All Expenses)
            netCash: totalNetCash, // Cash Balance
            walletBalance: totalWalletBalance, // Wallet Balance
            fundBalance: totalFundBalance, // NEW: Fund Balance
        };
    }

    /**
     * Renders the Fund Wallet History tab inside the modal. (NEW)
     */
    function renderFundHistory(fundTransfers) {
        fundHistoryBodyEl.innerHTML = '';
        const transfersArray = Object.entries(fundTransfers || {}).map(([id, trans]) => ({ id, ...trans }));

        // Filter and sort the desired entries: 'fund_in' (Nạp Ví Quỹ) and 'fund_expense' (Chi Ví Quỹ)
        const sortedHistory = transfersArray 
            .filter(t => t.paymentMethod === 'fund_in' || t.paymentMethod === 'fund_expense')
            .sort((a, b) => b.timestamp - a.timestamp); // Sort newest first

        if (sortedHistory.length === 0) {
            noFundDataMessageEl.classList.remove('d-none');
        } else {
            noFundDataMessageEl.classList.add('d-none');
            sortedHistory.forEach(trans => {
                const tempDateKey = new Date(trans.timestamp).toISOString().slice(0, 10);
                const time = new Date(trans.timestamp).toLocaleTimeString('vi-VN', {hour: '2-digit', minute: '2-digit'});
                let typeText, amountValue, amountClass;

                if (trans.paymentMethod === 'fund_in') {
                    typeText = '<span class="badge bg-warning text-white">Nạp Quỹ</span>';
                    amountValue = trans.revenue;
                    amountClass = 'balance-positive';
                } else if (trans.paymentMethod === 'fund_expense') {
                    typeText = '<span class="badge bg-danger">Chi Quỹ</span>';
                    amountValue = trans.expense;
                    amountClass = 'balance-negative';
                }

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${formatDate(tempDateKey)}<br><small class="text-muted">${time}</small></td>
                    <td>${typeText}</td>
                    <td class="${amountClass}"><strong>${formatVND(amountValue)}</strong></td>
                    <td>${trans.details}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-danger" title="Xóa giao dịch này" 
                            onclick="window.deleteTransaction('${tempDateKey}', '${trans.id}', 'fund')">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </td>
                `;
                fundHistoryBodyEl.appendChild(tr);
            });
        }
    }

    /**
     * Renders the Wallet Transfer History tab inside the modal. (UPDATED to include Delete button)
     */
    function renderTransferHistory(walletTransfers) {
        transferHistoryBodyEl.innerHTML = '';
        const transfersArray = Object.entries(walletTransfers || {}).map(([id, trans]) => ({ id, ...trans }));

        // Filter and sort the desired entries: 'wallet_in' (Nạp Ví), 'wallet_expense' (Chi Ví), and 'wallet_fund_out' (NEW)
        const sortedHistory = transfersArray 
            .filter(t => t.paymentMethod === 'wallet_in' || t.paymentMethod === 'wallet_expense' || t.paymentMethod === 'wallet_fund_out') // Added 'wallet_fund_out'
            .sort((a, b) => b.timestamp - a.timestamp); // Sort newest first

        if (sortedHistory.length === 0) {
            noTransferDataMessageEl.classList.remove('d-none');
        } else {
            noTransferDataMessageEl.classList.add('d-none');
            sortedHistory.forEach(trans => {
                const date = new Date(trans.timestamp).toISOString().slice(0, 10);
                const time = new Date(trans.timestamp).toLocaleTimeString('vi-VN', {hour: '2-digit', minute: '2-digit'});
                let typeText, amountValue, amountClass;

                if (trans.paymentMethod === 'wallet_in') {
                    typeText = '<span class="badge bg-primary">Nạp Ví</span>';
                    amountValue = trans.revenue;
                    amountClass = 'balance-positive';
                } else if (trans.paymentMethod === 'wallet_expense') {
                    typeText = '<span class="badge bg-danger">Chi Ví</span>';
                    amountValue = trans.expense;
                    amountClass = 'balance-negative';
                } else if (trans.paymentMethod === 'wallet_fund_out') { // NEW
                    typeText = '<span class="badge bg-warning">Nạp Quỹ (Trừ Ví)</span>';
                    amountValue = trans.expense;
                    amountClass = 'balance-negative';
                }

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${formatDate(date)}<br><small class="text-muted">${time}</small></td>
                    <td>${typeText}</td>
                    <td class="${amountClass}"><strong>${formatVND(amountValue)}</strong></td>
                    <td>${trans.details}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-danger" title="Xóa giao dịch này" 
                            onclick="window.deleteTransaction('${date}', '${trans.id}', 'wallet')">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </td>
                `;
                transferHistoryBodyEl.appendChild(tr);
            });
        }
    }

    /**
     * Updates the UI for the date range totals section.
     */
    function updateFilteredTotalsUI(records, walletTransfers, fundTransfers) {
        const specificDate = specificDateFilterEl.value;
        // Do not update if filter is hidden
        if (dateFilterControlsEl.style.display === 'none') {
            return;
        }

        // Note: calculateTotals is designed to exclude wallet/fundTransfers if specificDateStr is not null, so this is correct.
        const totals = calculateTotals(records, walletTransfers, fundTransfers, specificDate); 

        filteredRevenueCashEl.innerText = formatVND(totals.revenueCash);
        filteredRevenueTransferEl.innerText = formatVND(totals.revenueTransfer);
        filteredExpenseEl.innerText = formatVND(totals.expense);

        // Total Balance
        const filteredNet = totals.revenueCash + totals.revenueTransfer - totals.expense;
        filteredBalanceEl.innerText = formatVND(filteredNet);
        filteredBalanceEl.className = `h4 ${filteredNet >= 0 ? 'balance-positive' : 'balance-negative'}`;

        // Cash Balance - Exclude wallet/fund transfer logic since it's not supported in filtered view
        const filteredNetCash = totals.revenueCash - totals.expense;
        filteredBalanceCashEl.innerText = formatVND(filteredNetCash);
        filteredBalanceCashEl.className = `h4 ${filteredNetCash >= 0 ? 'balance-positive' : 'balance-negative'}`;
    }
    
    // Function to calculate and update fundInAmount based on percentage (NEW)
    function applyFundInPercentage(percent) {
        percent = Number(percent);
        if (isNaN(percent) || percent <= 0 || percent > 100) {
            alert("Phần trăm không hợp lệ (phải từ 1 đến 100).");
            return;
        }
        
        const availableBalance = Number(hiddenAvailableTransferBalanceForFundEl.value);
        const calculatedAmount = Math.floor(availableBalance * (percent / 100));
        
        // Update the input field with the calculated amount (raw number string) and dispatch input event for formatting
        fundInAmountEl.value = calculatedAmount.toString();
        fundInAmountEl.dispatchEvent(new Event('input')); 

        fundInPercentInfoEl.textContent = `Đã tính ${percent}% của ${formatVND(availableBalance)} = ${formatVND(calculatedAmount)}.`;

        // Close the dropdown after applying
        const dropdownToggle = fundInAmountEl.parentElement.querySelector('.dropdown-toggle');
        if (dropdownToggle) {
            new bootstrap.Dropdown(dropdownToggle).hide();
        }
    }


    // --- UI Rendering ---
    function renderAll(records, walletTransfers, fundTransfers) {
        const viewMode = reportViewEl.value;
        const sortOrder = sortOrderEl.value;

        // Calculate ALL totals
        const allTotals = calculateTotals(records, walletTransfers, fundTransfers);

        // Update Overall Totals for All Data
        totalRevenueCashEl.innerText = formatVND(allTotals.revenueCash);
        totalRevenueTransferEl.innerText = formatVND(allTotals.revenueTransfer);
        totalExpenseEl.innerText = formatVND(allTotals.expense);
        
        totalBalanceEl.innerText = formatVND(allTotals.net);
        totalBalanceEl.className = `h4 ${allTotals.net >= 0 ? 'balance-positive' : 'balance-negative'}`;
        
        totalBalanceCashEl.innerText = formatVND(allTotals.netCash);
        totalBalanceCashEl.className = `h4 ${allTotals.netCash >= 0 ? 'balance-positive' : 'balance-negative'}`;

        // Update Overall Wallet Balance
        totalWalletBalanceEl.innerText = formatVND(allTotals.walletBalance);
        totalWalletBalanceEl.className = `h4 text-white`;
        
        // Update Overall Fund Wallet Balance
        totalFundBalanceEl.innerText = formatVND(allTotals.fundBalance);
        totalFundBalanceEl.className = `h4 text-white`;


        // Transform the nested data for rendering and aggregation (Daily Aggregation)
        const dailyAggregatedRecords = {};
        for (const dateKey in records) {
            const dailyRecord = records[dateKey];
            let dailyRevenueCash = 0;
            let dailyRevenueTransfer = 0;
            let dailyExpense = 0;

            if (dailyRecord.transactions) {
                Object.values(dailyRecord.transactions).forEach(trans => {
                    const revenue = Number(trans.revenue || 0);
                    const expense = Number(trans.expense || 0);
                    const method = trans.paymentMethod;

                    if (revenue > 0) {
                        if (method === 'transfer') {
                            dailyRevenueTransfer += revenue;
                        } else {
                            // Default to cash if paymentMethod is missing or not 'transfer'
                            dailyRevenueCash += revenue;
                        }
                    } else if (expense > 0) {
                        dailyExpense += expense;
                    }
                });
            }

            const dailyTotalRevenue = dailyRevenueCash + dailyRevenueTransfer;
            const dailyTotalExpense = dailyExpense;
            const dailyNet = dailyTotalRevenue - dailyTotalExpense;

            dailyAggregatedRecords[dateKey] = {
                date: dateKey,
                revenue: dailyTotalRevenue,
                revenueCash: dailyRevenueCash,
                revenueTransfer: dailyRevenueTransfer,
                expense: dailyTotalExpense,
                net: dailyNet,
                transactions: dailyRecord.transactions
            };
        }

        // Update Filtered Totals if the filter control panel is visible
        if (dateFilterControlsEl.style.display !== 'none') {
            updateFilteredTotalsUI(records, walletTransfers, fundTransfers);
        }

        // Group data based on view mode (Day, Month, Quarter)
        let dataToRender = dailyAggregatedRecords;
        if (viewMode === 'month' || viewMode === 'quarter') {
            dataToRender = aggregateByPeriod(dailyAggregatedRecords, viewMode);
        }

        historyBodyEl.innerHTML = '';
        reportTitleEl.innerHTML = `<i class="fas fa-history me-2"></i> Lịch sử Giao dịch (${viewMode === 'day' ? 'Hàng ngày' : viewMode === 'month' ? 'Theo Tháng' : 'Theo Quý'})`;
        tableHeaderEl.innerHTML = viewMode === 'day' ? 
            `<th class="date-header">Ngày</th>
             <th>Doanh thu</th>
             <th>Chi tiêu</th>
             <th>Số dư</th>
             <th>Chi tiết</th>
             <th class="action-header">Hành động</th>` : 
            `<th class="date-header">${viewMode === 'month' ? 'Tháng' : 'Quý'}</th>
             <th>Doanh thu</th>
             <th>Chi tiêu</th>
             <th>Số dư</th>`;


        const keys = Object.keys(dataToRender).sort();
        if (sortOrder === 'desc') keys.reverse();

        if (keys.length === 0) {
            noDataMessageEl.classList.remove('d-none');
        } else {
            noDataMessageEl.classList.add('d-none');
        }

        keys.forEach((key, index) => {
            const r = dataToRender[key];
            const tr = document.createElement('tr');
            tr.style.animationDelay = `${index * 0.05}s`;
            tr.classList.add('fade-in-up');

            if (viewMode === 'day') {
                tr.innerHTML = `
                    <td data-label="Ngày:"><strong>${formatDate(key)}</strong></td>
                    <td data-label="Doanh thu:">${formatVND(r.revenue)}</td>
                    <td data-label="Chi tiêu:">${formatVND(r.expense)}</td>
                    <td data-label="Số dư:" class="${(r.net || 0) >= 0 ? 'balance-positive' : 'balance-negative'}">
                        <strong>${formatVND(r.net)}</strong>
                    </td>
                    <td data-label="Chi tiết:">
                        <button type="button" class="btn btn-sm btn-outline-info" onclick="handleShowDetails('${key}')">
                            <i class="fas fa-search me-1"></i> Chi tiết
                        </button>
                    </td>
                    <td data-label="Hành động:" class="action-cell">
                        <button type="button" class="btn btn-sm btn-outline-danger" title="Xóa" onclick="window.deleteDay('${key}')">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </td>
                `;
            } else {
                tr.innerHTML = `
                    <td data-label="${viewMode === 'month' ? 'Tháng:' : 'Quý:'}"><strong>${key}</strong></td>
                    <td data-label="Doanh thu:">${formatVND(r.revenue)}</td>
                    <td data-label="Chi tiêu:">${formatVND(r.expense)}</td>
                    <td data-label="Số dư:" class="${(r.net || 0) >= 0 ? 'balance-positive' : 'balance-negative'}">
                        <strong>${formatVND(r.net)}</strong>
                    </td>
                `;
            }
            historyBodyEl.appendChild(tr);
        });
    }

    // Function to show transaction details in modal
    async function handleShowDetails(date) {
        const snapshot = await recordsRef.child(date).child('transactions').get();
        const transactions = snapshot.val();
        
        let htmlContent = `<p class="text-muted">Ngày: <strong>${formatDate(date)}</strong></p>`;

        if (!transactions || Object.keys(transactions).length === 0) {
            htmlContent += '<p class="text-center text-muted">Không có giao dịch chi tiết nào trong ngày này.</p>';
        } else {
            htmlContent += `
                <div class="table-responsive">
                    <table class="table table-bordered table-sm">
                        <thead>
                            <tr>
                                <th>Thời gian</th>
                                <th>Số tiền</th>
                                <th>Hình thức</th>
                                <th>Chi tiết</th>
                                <th>Hành động</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            const transactionsArray = Object.entries(transactions).map(([id, trans]) => ({ id, ...trans }));
            transactionsArray.sort((a, b) => a.timestamp - b.timestamp);

            transactionsArray.forEach(trans => {
                const id = trans.id;
                const isRevenue = trans.revenue > 0;
                const amount = isRevenue ? trans.revenue : trans.expense;
                const amountClass = isRevenue ? 'balance-positive' : 'balance-negative';
                const type = isRevenue ? 'Thu' : 'Chi';
                
                let method = '';
                let isWalletTransfer = ['wallet_in', 'wallet_out_cash', 'wallet_expense', 'wallet_fund_out', 'fund_in', 'fund_expense'].includes(trans.paymentMethod);
                
                if (isWalletTransfer) {
                     // Check if it's a Wallet/Fund transfer. Should not happen if they are logged separately, but for safety.
                     method = `<span class="badge bg-secondary">Giao dịch Ví/Quỹ</span>`;
                } else if (isRevenue) {
                    method = trans.paymentMethod === 'transfer' ? 
                             ('<span class="badge bg-primary">Chuyển khoản</span>') : 
                             ('<span class="badge bg-warning text-dark">Tiền mặt</span>');
                } else {
                    method = '<span class="badge bg-danger">Chi tiêu</span>';
                }

                const time = trans.timestamp ? new Date(trans.timestamp).toLocaleTimeString('vi-VN', {hour: '2-digit', minute: '2-digit'}) : 'N/A';
                
                // Prepare details string for edit
                const detailsForEdit = trans.details.replace(/'/g, "\\'").replace(/"/g, '\\"');
                const paymentMethodForEdit = trans.paymentMethod || 'cash';
                
                // Action buttons are only available for non-wallet/fund transfers (regular records)
                const actionButtons = isWalletTransfer ? 
                    `<span class="badge bg-secondary">Giao dịch Ví/Quỹ</span>` : 
                    `
                        <button class="btn btn-sm btn-outline-primary" onclick="window.editTransaction('${date}', '${id}', ${trans.revenue}, ${trans.expense}, '${detailsForEdit}', '${paymentMethodForEdit}')"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-sm btn-outline-danger" onclick="window.deleteTransaction('${date}', '${id}')"><i class="fas fa-trash-alt"></i></button>
                    `;

                htmlContent += `
                    <tr>
                        <td>${time}</td>
                        <td class="${amountClass}">${formatVND(amount)} (${type})</td>
                        <td>${method}</td>
                        <td>${trans.details}</td>
                        <td>
                            ${actionButtons}
                        </td>
                    </tr>
                `;
            });

            htmlContent += `</tbody></table></div>`;
        }

        detailsModalBodyEl.innerHTML = htmlContent;
        detailsModal.show();
    }

    // Function to aggregate data by month or quarter
    function aggregateByPeriod(records, period) {
        const aggregated = {};
        for (const date in records) {
            const record = records[date];
            let key;
            const d = new Date(date);
            const year = d.getFullYear();
            const month = d.getMonth() + 1; // getMonth() is 0-indexed

            if (period === 'month') {
                key = `${String(month).padStart(2, '0')}/${year}`;
            } else if (period === 'quarter') {
                const quarter = Math.floor((month - 1) / 3) + 1;
                key = `Quý ${quarter}/${year}`;
            }

            if (!aggregated[key]) {
                aggregated[key] = { revenue: 0, expense: 0, net: 0 };
            }

            aggregated[key].revenue += record.revenue;
            aggregated[key].expense += record.expense;
            aggregated[key].net += record.net;
        }
        return aggregated;
    }

    // --- Utility functions for Export/Import (kept basic) ---
    function downloadFile(filename, text) {
        const element = document.createElement('a');
        element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
        element.setAttribute('download', filename);
        element.style.display = 'none';
        document.body.appendChild(element);
        element.click();
        document.body.removeChild(element);
    }

    // UPDATED: Export all data including wallet/fund transfers
    function exportJson(records, walletTransfers, fundTransfers) {
        const fullData = { 
            daily_records: records, 
            wallet_transfers: walletTransfers,
            fund_transfers: fundTransfers // NEW
        };
        const json = JSON.stringify(fullData, null, 2);
        downloadFile(`records_${new Date().toISOString().slice(0, 10)}.json`, json);
        alert('Dữ liệu đã được xuất ra JSON.');
    }

    function exportCsv(dailyAggregatedRecords) {
        let csv = 'Ngày,Doanh thu,Chi tiêu,Số dư\n';
        const sortedKeys = Object.keys(dailyAggregatedRecords).sort();
        sortedKeys.forEach(date => {
            const r = dailyAggregatedRecords[date];
            csv += `${formatDate(date)},${r.revenue},${r.expense},${r.net}\n`;
        });
        downloadFile(`records_${new Date().toISOString().slice(0, 10)}.csv`, csv);
        alert('Dữ liệu đã được xuất ra CSV.');
    }

    function importJsonFile(file) {
        const reader = new FileReader();
        reader.onload = async (e) => {
            try {
                const importedData = JSON.parse(e.target.result);
                if (!confirm('Bạn có chắc chắn muốn nhập dữ liệu này? Dữ liệu hiện tại trên Firebase có thể bị ghi đè hoặc trộn lẫn.')) return;

                // Simple merge logic: overwrite top-level entries
                if (importedData.daily_records) {
                    await recordsRef.update(importedData.daily_records);
                }
                if (importedData.wallet_transfers) {
                    await walletTransfersRef.update(importedData.wallet_transfers);
                }
                if (importedData.fund_transfers) {
                    await fundTransfersRef.update(importedData.fund_transfers); // NEW
                }

                alert('Dữ liệu đã được nhập thành công!');
            } catch (err) {
                alert('Lỗi khi đọc file JSON: ' + err.message);
                console.error(err);
            }
        };
        reader.readAsText(file);
    }

    // --- Event Listeners ---
    document.querySelectorAll('.currency-input').forEach(input => {
        input.addEventListener('input', formatNumberInput);
        // Initial format on load (if value is present)
        input.dispatchEvent(new Event('input'));
    });

    // Toggle Date Filter Panel
    toggleDateFilterBtn.addEventListener('click', () => {
        const isHidden = dateFilterControlsEl.style.display === 'none';
        dateFilterControlsEl.style.display = isHidden ? 'block' : 'none';
        toggleDateFilterBtn.innerHTML = isHidden ? 
            `<i class="fas fa-calendar-times me-2"></i> **Ẩn Thống kê theo Ngày**` : 
            `<i class="fas fa-calendar-check me-2"></i> **Thống kê theo Ngày Cụ thể**`;
            
        // If showing, apply filter immediately if a date is selected
        if (!isHidden && specificDateFilterEl.value && window.cachedRecords) {
            updateFilteredTotalsUI(window.cachedRecords, window.cachedWalletTransfers, window.cachedFundTransfers);
        }
    });

    // Apply Date Filter
    applyDateFilterBtn.addEventListener('click', () => {
        if (!specificDateFilterEl.value) {
            alert('Vui lòng chọn một ngày cụ thể để thống kê.');
            return;
        }
        if (window.cachedRecords) {
            updateFilteredTotalsUI(window.cachedRecords, window.cachedWalletTransfers, window.cachedFundTransfers);
        }
    });

    // Sort/View Change Listeners
    sortOrderEl.addEventListener('change', () => {
        if (window.cachedRecords) {
            renderAll(window.cachedRecords, window.cachedWalletTransfers, window.cachedFundTransfers);
        }
    });
    reportViewEl.addEventListener('change', () => {
        if (window.cachedRecords) {
            renderAll(window.cachedRecords, window.cachedWalletTransfers, window.cachedFundTransfers);
        }
    });

    // Set today's date for modals on load
    const today = new Date().toISOString().split('T')[0];
    modalEntryDateEl.value = today;
    transferDateEl.value = today;
    walletExpenseDateEl.value = today;
    fundInDateEl.value = today;
    fundExpenseDateEl.value = today;

    // Show modal for Revenue (UPDATED)
    addRevenueBtn.addEventListener('click', () => {
        modalTitle.innerText = "Thêm Giao Dịch Thu";
        modalSubmitBtn.innerText = "Thêm Giao Dịch Thu";
        transactionTypeEl.value = "revenue";
        modalAmountCashEl.value = "";
        modalAmountTransferEl.value = "";
        modalDetailsEl.value = "";
        
        revenueFieldsEl.style.display = 'flex'; // Show revenue fields
        expenseFieldEl.style.display = 'none'; // Hide expense field
        modalAmountEl.required = false;
        addTransactionModal.show();
    });

    // Show modal for Expense (UPDATED)
    addExpenseBtn.addEventListener('click', () => {
        modalTitle.innerText = "Thêm Giao Dịch Chi";
        modalAmountLabel.innerText = "Số tiền Chi (VND)";
        modalSubmitBtn.innerText = "Thêm Giao Dịch Chi";
        transactionTypeEl.value = "expense";
        modalAmountEl.value = "";
        modalDetailsEl.value = "";
        
        revenueFieldsEl.style.display = 'none'; // Hide revenue fields
        expenseFieldEl.style.display = 'block'; // Show expense field
        modalAmountEl.required = true;
        addTransactionModal.show();
    });

    // Show modal for Wallet Transfer (Updated to show all balances for context)
    transferToWalletBtn.addEventListener('click', () => {
        const currentCashBalance = unformatVND(totalBalanceCashEl.innerText);
        const currentWalletBalance = unformatVND(totalWalletBalanceEl.innerText);

        // Update Nạp Ví tab
        availableCashBalanceEl.innerText = formatVND(currentCashBalance);
        hiddenAvailableCashBalanceEl.value = currentCashBalance;
        transferAmountEl.value = "";
        transferDetailsEl.value = `Chuyển ${currentCashBalance > 0 ? 'một phần' : ''} Dư Tiền mặt vào Ví Chuyển khoản`;

        // Update Chi Ví tab
        availableWalletBalanceEl.innerText = formatVND(currentWalletBalance);
        hiddenAvailableWalletBalanceEl.value = currentWalletBalance;
        walletExpenseAmountEl.value = "";
        walletExpenseDetailsEl.value = "";
        
        // Render history for immediate update
        if (window.cachedWalletTransfers) {
            renderTransferHistory(window.cachedWalletTransfers);
        }

        transferModal.show();
    });
    
    // Show modal for Fund Wallet (UPDATED to clear percentage info)
    fundToWalletBtn.addEventListener('click', () => {
        const currentTransferBalance = unformatVND(totalWalletBalanceEl.innerText);
        const currentFundBalance = unformatVND(totalFundBalanceEl.innerText);

        // Update Nạp Quỹ tab
        availableTransferBalanceForFundEl.innerText = formatVND(currentTransferBalance);
        hiddenAvailableTransferBalanceForFundEl.value = currentTransferBalance;
        fundInAmountEl.value = "";
        fundInDetailsEl.value = `Chuyển ${currentTransferBalance > 0 ? 'một phần' : ''} Ví Chuyển khoản vào Ví Quỹ`;
        fundInPercentInfoEl.textContent = 'Hoặc nhập số tiền trực tiếp.'; // NEW: Clear info text

        // Update Chi Quỹ tab
        availableFundBalanceEl.innerText = formatVND(currentFundBalance);
        hiddenAvailableFundBalanceEl.value = currentFundBalance;
        fundExpenseAmountEl.value = "";
        fundExpenseDetailsEl.value = ""; 
        
        // Render history for immediate update
        if (window.cachedFundTransfers) {
            renderFundHistory(window.cachedFundTransfers);
        }

        fundModal.show();
    });

    // Event listener for dropdown percentage buttons (NEW)
    document.querySelectorAll('.fund-percent-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            e.preventDefault();
            const percent = e.target.getAttribute('data-percent');
            applyFundInPercentage(percent);
        });
    });

    // Event listener for applying custom percentage (NEW)
    applyCustomPercentBtnEl.addEventListener('click', (e) => {
        e.preventDefault();
        const percent = customFundPercentEl.value;
        applyFundInPercentage(percent);
        customFundPercentEl.value = ''; // Clear custom input
    });

    // Handle form submission from the Add Transaction modal (UPDATED)
    addTransactionForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const date = modalEntryDateEl.value;
        const details = modalDetailsEl.value.trim();
        const type = transactionTypeEl.value;

        if (type === "revenue") {
            const amountCash = unformatVND(modalAmountCashEl.value);
            const amountTransfer = unformatVND(modalAmountTransferEl.value);

            if (amountCash <= 0 && amountTransfer <= 0) {
                alert("Vui lòng nhập số tiền Thu Tiền mặt hoặc Thu Chuyển khoản.");
                return;
            }

            if (amountCash > 0) {
                addSingleEntry(date, amountCash, 0, details || "Thu nhập tiền mặt", 'cash');
            }
            if (amountTransfer > 0) {
                addSingleEntry(date, amountTransfer, 0, details || "Thu nhập chuyển khoản", 'transfer');
            }
        } else if (type === "expense") {
            const amount = unformatVND(modalAmountEl.value);

            if (amount <= 0) {
                alert("Vui lòng nhập số tiền muốn chi.");
                return;
            }
            // Regular Expense is considered cash/undifferentiated for simplicity in this version
            addSingleEntry(date, 0, amount, details || "Chi tiêu", null);
        }

        addTransactionModal.hide();
    });

    // Handle form submission from the Transfer Modal (Nạp Ví)
    transferForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        const date = transferDateEl.value;
        const amount = unformatVND(transferAmountEl.value);
        const details = transferDetailsEl.value.trim();
        const maxAmount = Number(hiddenAvailableCashBalanceEl.value);

        if (amount <= 0) {
            alert("Vui lòng nhập số tiền muốn nạp.");
            return;
        }

        // Logic kiểm tra số tiền nạp không được vượt quá Số Dư Tiền Mặt
        if (amount > maxAmount) {
            alert(`[THÔNG BÁO LỖI] Số tiền nạp (${formatVND(amount)}) đã vượt quá Số Dư Tiền Mặt hiện có (${formatVND(maxAmount)}). Vui lòng nhập số tiền nhỏ hơn hoặc bằng số dư.`);
            return;
        }

        // 1. Giao dịch Chi Tiêu từ Tiền Mặt (Giảm Dư Tiền Mặt) - Saved to wallet_transfers
        await addSingleEntry(date, 0, amount, `[Nạp Ví] Trừ Tiền mặt: ${details}`, 'wallet_out_cash');

        // 2. Giao dịch Thu vào Ví Chuyển Khoản (Tăng Ví Chuyển Khoản) - Saved to wallet_transfers
        await addSingleEntry(date, amount, 0, `[Nạp Ví] Thu vào Ví: ${details}`, 'wallet_in');

        transferModal.hide();
        transferAmountEl.value = ""; // Reset field
    });

    // Handle form submission from the Wallet Expense Modal (Chi Ví)
    walletExpenseForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        const date = walletExpenseDateEl.value;
        const amount = unformatVND(walletExpenseAmountEl.value);
        const details = walletExpenseDetailsEl.value.trim();
        const maxAmount = Number(hiddenAvailableWalletBalanceEl.value);

        if (amount <= 0) {
            alert("Vui lòng nhập số tiền muốn chi.");
            return;
        }

        // Logic kiểm tra số tiền chi không được vượt quá Số Dư Ví Chuyển Khoản
        if (amount > maxAmount) {
            alert(`[THÔNG BÁO LỖI] Số tiền chi (${formatVND(amount)}) đã vượt quá Số Dư Ví Chuyển Khoản hiện có (${formatVND(maxAmount)}). Vui lòng nhập số tiền nhỏ hơn hoặc bằng số dư.`);
            return;
        }

        // 1. Giao dịch Chi từ Ví Chuyển Khoản (Giảm Ví Chuyển Khoản) - Saved to wallet_transfers
        await addSingleEntry(date, 0, amount, `[Chi Ví] Chi tiêu từ Ví: ${details}`, 'wallet_expense');

        walletExpenseForm.reset(); // Reset form fields
        transferModal.hide();
    });

    // Handle form submission from the Fund In Modal (Nạp Ví Quỹ) (UPDATED to use fundInAmountEl value)
    fundInForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        const date = fundInDateEl.value;
        const amount = unformatVND(fundInAmountEl.value); // Use the value from the input, which might be calculated from percentage
        const details = fundInDetailsEl.value.trim();
        const maxAmount = Number(hiddenAvailableTransferBalanceForFundEl.value);

        if (amount <= 0) {
            alert("Vui lòng nhập số tiền muốn nạp.");
            return;
        }

        // Logic kiểm tra số tiền nạp không được vượt quá Số Dư Ví Chuyển Khoản
        if (amount > maxAmount) {
            alert(`[THÔNG BÁO LỖI] Số tiền nạp (${formatVND(amount)}) đã vượt quá Số Dư Ví Chuyển Khoản hiện có (${formatVND(maxAmount)}). Vui lòng nhập số tiền nhỏ hơn hoặc bằng số dư.`);
            return;
        }

        // 1. Giao dịch Chi từ Ví Chuyển Khoản (Giảm Ví Chuyển Khoản) - Saved to wallet_transfers
        await addSingleEntry(date, 0, amount, `[Nạp Quỹ] Trừ Ví Chuyển Khoản: ${details}`, 'wallet_fund_out');

        // 2. Giao dịch Thu vào Ví Quỹ (Tăng Ví Quỹ) - Saved to fund_transfers
        await addSingleEntry(date, amount, 0, `[Nạp Quỹ] Thu vào Ví Quỹ: ${details}`, 'fund_in');

        fundModal.hide();
        fundInAmountEl.value = ""; // Reset field
    });

    // Handle form submission from the Fund Expense Modal (Chi Ví Quỹ)
    fundExpenseForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        const date = fundExpenseDateEl.value;
        const amount = unformatVND(fundExpenseAmountEl.value);
        const details = fundExpenseDetailsEl.value.trim();
        const maxAmount = Number(hiddenAvailableFundBalanceEl.value);

        if (amount <= 0) {
            alert("Vui lòng nhập số tiền muốn chi.");
            return;
        }

        // Logic kiểm tra số tiền chi không được vượt quá Số Dư Ví Quỹ
        if (amount > maxAmount) {
            alert(`[THÔNG BÁO LỖI] Số tiền chi (${formatVND(amount)}) đã vượt quá Số Dư Ví Quỹ hiện có (${formatVND(maxAmount)}). Vui lòng nhập số tiền nhỏ hơn hoặc bằng số dư.`);
            return;
        }

        // Giao dịch Chi từ Ví Quỹ (Giảm Ví Quỹ) - Saved to fund_transfers
        await addSingleEntry(date, 0, amount, `[Chi Quỹ] Chi tiêu từ Ví Quỹ: ${details}`, 'fund_expense');

        fundExpenseForm.reset();
        fundModal.hide();
    });


    // Export/Import/Reset Listeners
    document.getElementById('exportCsv').addEventListener('click', () => {
        const dailyAggregatedRecords = {};
        for (const dateKey in window.cachedRecords) {
            const dailyRecord = window.cachedRecords[dateKey];
            let dailyRevenue = 0;
            let dailyExpense = 0;
            
            if (dailyRecord.transactions) {
                Object.values(dailyRecord.transactions).forEach(trans => {
                    // All non-wallet transfers go to daily summary
                    dailyRevenue += Number(trans.revenue || 0);
                    dailyExpense += Number(trans.expense || 0);
                });
            }

            dailyAggregatedRecords[dateKey] = {
                date: dateKey,
                revenue: dailyRevenue,
                expense: dailyExpense,
                net: dailyRevenue - dailyExpense,
                transactions: dailyRecord.transactions
            };
        }
        exportCsv(dailyAggregatedRecords);
    });

    document.getElementById('exportJson').addEventListener('click', async () => {
        const recordsSnapshot = await recordsRef.get();
        const transfersSnapshot = await walletTransfersRef.get();
        const fundSnapshot = await fundTransfersRef.get();
        exportJson(recordsSnapshot.val() || {}, transfersSnapshot.val() || {}, fundSnapshot.val() || {});
    });

    document.getElementById('importJsonBtn').addEventListener('click', () => {
        document.getElementById('importFile').click();
    });

    document.getElementById('importFile').addEventListener('change', (ev) => {
        const f = ev.target.files[0];
        if (!f) return;
        importJsonFile(f);
        ev.target.value = ''; // Reset file input
    });

    // Reset button
    document.getElementById('resetBtn').addEventListener('click', clearAll);

    // Add sample data button
    addSampleBtn.addEventListener('click', addSampleData);


    // --- Firebase Initialization and Listeners ---
    (function init() {
        // Cache variables to ensure all data is loaded before rendering
        window.cachedRecords = null;
        window.cachedWalletTransfers = null;
        window.cachedFundTransfers = null;

        // Listen for data changes on Firebase (recordsRef)
        recordsRef.on('value', (snapshot) => {
            const records = snapshot.val() || {};
            window.cachedRecords = records; // Cache data for quick sorting and viewing
            // Only render if wallet transfers data and fund transfers data are also available
            if (window.cachedWalletTransfers !== null && window.cachedFundTransfers !== null) {
                renderAll(records, window.cachedWalletTransfers, window.cachedFundTransfers);
            }
        }, (error) => {
            console.error('Lỗi khi đọc daily_records từ Firebase:', error);
            alert('Không thể kết nối với Firebase (Daily Records). Vui lòng kiểm tra kết nối mạng hoặc cấu hình.');
        });
        
        // Listen for data changes on Firebase (walletTransfersRef)
        walletTransfersRef.on('value', (snapshot) => {
            const walletTransfers = snapshot.val() || {};
            window.cachedWalletTransfers = walletTransfers; // Cache data
            // Only render if records data and fund data are available
            if (window.cachedRecords !== null && window.cachedFundTransfers !== null) {
                renderAll(window.cachedRecords, walletTransfers, window.cachedFundTransfers);
            }
        }, (error) => {
            console.error('Lỗi khi đọc wallet_transfers từ Firebase:', error);
            alert('Không thể kết nối với Firebase (Wallet Transfers). Vui lòng kiểm tra kết nối mạng hoặc cấu hình.');
        });
        
        // Listen for data changes on Firebase (fundTransfersRef)
        fundTransfersRef.on('value', (snapshot) => {
            const fundTransfers = snapshot.val() || {};
            window.cachedFundTransfers = fundTransfers; // Cache data
            // Only render if records data and wallet data are available
            if (window.cachedRecords !== null && window.cachedWalletTransfers !== null) {
                renderAll(window.cachedRecords, window.cachedWalletTransfers, fundTransfers);
            }
        }, (error) => {
            console.error('Lỗi khi đọc fund_transfers từ Firebase:', error);
            alert('Không thể kết nối với Firebase (Fund Transfers). Vui lòng kiểm tra kết nối mạng hoặc cấu hình.');
        });
    })();
    </script>
</body>
</html>
