<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tra c·ª©u ƒêi·ªÉm √äƒë√™ Bu√¥n L√†ng</title>
  
  <style>
    /* * ----------------------------------------
     * 1. GENERAL & FONT
     * ----------------------------------------
     */
    :root {
      --color-primary: #8B4513; /* N√¢u ƒë·∫•t/C√† ph√™ ƒë·∫≠m */
      --color-secondary: #D2B48C; /* N√¢u nh·∫°t/Be */
      --color-background: #F8F8F4; /* N·ªÅn kem s√°ng d·ªãu */
      --color-card-bg: #FFFFFF;
      --color-text-dark: #333333;
      --color-text-light: #555555;
      --border-radius-card: 20px;
      --border-radius-sm: 10px;
      --shadow-soft: 0 8px 20px rgba(0, 0, 0, 0.08);
      --shadow-light: 0 4px 10px rgba(0, 0, 0, 0.05);
      --transition-bezier: cubic-bezier(0.25, 0.1, 0.25, 1);
      /* M√†u m·ªõi cho voucher 5 sao */
      --color-gold: #B8860B; /* V√†ng kim lo·∫°i */
      --color-dark-brown: #5C4033; /* N√¢u s·∫´m */
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif;
      padding: 20px;
      max-width: 450px; /* Max-width g·ªçn g√†ng nh∆∞ app */
      margin: auto;
      text-align: center;
      background-color: var(--color-background);
      color: var(--color-text-dark);
      /* Animation: Slide-up v√† fade-in nh·∫π khi load */
      animation: pageLoadFadeIn 0.8s var(--transition-bezier);
    }
    
    @keyframes pageLoadFadeIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    h2 {
      color: var(--color-primary);
      margin-bottom: 25px;
      font-size: 26px;
      font-weight: 600;
    }

    /* * ----------------------------------------
     * 2. UI COMPONENTS: CARD, INPUT, BUTTON
     * ----------------------------------------
     */
    .query-box {
      background: var(--color-card-bg);
      padding: 30px 20px;
      border-radius: var(--border-radius-card);
      box-shadow: var(--shadow-soft);
      margin-bottom: 25px;
    }
    
    .input-group {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    input[type="text"] {
      flex-grow: 1;
      padding: 14px 15px;
      border: none;
      border-radius: var(--border-radius-sm);
      background-color: #F0F0F0; /* N·ªÅn input s√°ng */
      font-size: 16px;
      color: var(--color-text-dark);
      box-sizing: border-box;
      /* Transition focus m∆∞·ª£t */
      transition: background-color 0.3s, box-shadow 0.3s;
      /* ƒê√® style g·ªëc */
      width: auto !important; 
      margin-right: 0 !important;
    }

    input[type="text"]:focus {
      background-color: #FFFFFF;
      box-shadow: 0 0 0 3px var(--color-secondary);
      outline: none;
    }
    
    /* ƒê√® style c≈©: ƒê·∫£m b·∫£o class button c≈© v·∫´n ho·∫°t ƒë·ªông, nh∆∞ng th√™m style m·ªõi */
    button {
      padding: 14px 20px;
      background: var(--color-primary); 
      color: white;
      border: none;
      /* Bo tr√≤n ho√†n to√†n */
      border-radius: var(--border-radius-sm); 
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      /* Transition cho hi·ªáu ·ª©ng nh·∫•n */
      transition: background-color 0.2s, transform 0.1s var(--transition-bezier), box-shadow 0.2s;
      box-shadow: 0 4px 10px rgba(139, 69, 19, 0.3);
      /* ƒê·∫£m b·∫£o style c≈© ƒë∆∞·ª£c ghi ƒë√® m·ªôt c√°ch an to√†n */
      width: auto !important; 
    }
    
    /* Hi·ªáu ·ª©ng nh·∫•n (scale) */
    button:active {
        transform: scale(0.97);
        box-shadow: 0 2px 5px rgba(139, 69, 19, 0.4);
    }

    button:hover {
      background: #A0522D; /* N√¢u s√°ng h∆°n khi hover */
    }

    /* * ----------------------------------------
     * 3. RESULT BOX & STYLES (Gi·ªØ nguy√™n class cho JS)
     * ----------------------------------------
     */
    #loyaltyPointsResult {
      margin-top: 25px;
      padding: 25px;
      border-radius: var(--border-radius-card);
      font-size: 17px;
      font-weight: 500;
      line-height: 1.6;
      text-align: left;
      box-shadow: var(--shadow-soft);
      /* Base styles cho Result Div */
      border: none !important; /* X√≥a vi·ªÅn c≈© */
      transition: background-color 0.3s, color 0.3s;
    }
    
    #loyaltyPointsResult p {
        margin: 5px 0;
    }
    
    /* Success: M√†u xanh l√° c√¢y/xanh r√™u nh·∫°t ·∫•m */
    .success {
      background-color: #E6F3E6; 
      color: #38761D; 
    }
    
    /* Error: M√†u ƒë·ªè ƒë·∫≠m ·∫•m */
    .error {
      background-color: #FBEFEF; 
      color: #990000; 
    }
    
    /* Info/Default: M√†u v√†ng kem ·∫•m */
    .info {
      background-color: #FFF8E1; 
      color: #9C6500;
    }
    
    /* Style cho ƒëi·ªÉm s·ªë l·ªõn */
    .current-points-display {
        display: block;
        font-size: 3em; 
        font-weight: 700;
        margin: 10px 0;
        color: var(--color-primary); /* ƒê·ªïi m√†u cho n·ªïi b·∫≠t */
        text-align: center;
        letter-spacing: -1px;
    }

    .note {
        margin-top: 15px;
        font-size: 13px;
        color: var(--color-text-light);
        padding: 10px;
        border-radius: var(--border-radius-sm);
        background-color: rgba(0, 0, 0, 0.03);
        line-height: 1.5;
        font-weight: 400;
        text-align: center;
    }
    
    /* Style cho ph·∫ßn ti√™u ƒë·ªÅ trong Result Box */
    .result-title {
        display: block;
        font-weight: 600;
        color: var(--color-text-dark);
        margin-bottom: 5px;
        text-align: center;
    }
    
    /* Class m·ªõi ƒë·ªÉ ƒë·ªãnh d·∫°ng l·∫°i HTML ƒë∆∞·ª£c inject */
    .buonlang-text {
        color: var(--color-primary);
        font-weight: 600;
    }
    
    /* * ----------------------------------------
     * 4. VOUCHER SECTION (REDESIGN: 5-STAR PROFESSIONAL)
     * ----------------------------------------
     */
    .voucher-section {
        margin-top: 30px;
        text-align: left;
    }
    
    .voucher-section h3 {
        font-size: 22px;
        color: var(--color-dark-brown); /* M√†u n√¢u s·∫´m l·ªãch l√£m */
        margin-bottom: 20px;
        font-weight: 700;
        text-align: center;
        text-transform: uppercase;
        letter-spacing: 1px;
    }
    
    .voucher-list {
        display: flex;
        flex-direction: column;
        gap: 15px;
    }

    .voucher-card {
        display: flex;
        align-items: center;
        background: linear-gradient(135deg, #FFF, #FAFAFA); /* N·ªÅn gradient nh·∫π */
        border-radius: var(--border-radius-sm);
        /* Box shadow thanh l·ªãch */
        box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1); 
        padding: 20px; /* TƒÉng padding */
        /* Border: 1px vi·ªÅn m√†u gold */
        border: 1px solid var(--color-gold); 
        transition: transform 0.3s var(--transition-bezier), box-shadow 0.3s, border 0.3s, background 0.3s; /* Th√™m transition cho m∆∞·ª£t */
        cursor: pointer;
        position: relative;
        overflow: hidden; /* D√πng cho hi·ªáu ·ª©ng g√≥c */
    }
    
    /* Hi·ªáu ·ª©ng g√≥c: Th√™m m·ªôt d·∫£i m√†u nh·ªè ·ªü g√≥c */
    .voucher-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 10px;
        height: 100%;
        background-color: var(--color-gold);
        opacity: 0.8;
        transition: background-color 0.3s;
    }

    .voucher-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 12px 30px rgba(0, 0, 0, 0.15);
    }
    
    /* NEW: Animation cho to√†n b·ªô Voucher Card khi ƒë·∫°t ƒë∆∞·ª£c (·∫•n t∆∞·ª£ng h∆°n) */
    .voucher-card.complete {
        border: 2px solid var(--color-gold); 
        box-shadow: 0 0 15px rgba(184, 134, 11, 0.6), var(--shadow-soft); 
        background: linear-gradient(135deg, #FFF, #FFF8E1); /* N·ªÅn h∆°i v√†ng */
        /* Th√™m hi·ªáu ·ª©ng l·∫•p l√°nh nh·∫π nh√†ng */
        animation: glowPulse 2s infinite alternate;
    }
    
    @keyframes glowPulse {
        from {
            box-shadow: 0 0 10px rgba(184, 134, 11, 0.4), var(--shadow-soft);
        }
        to {
            box-shadow: 0 0 20px rgba(184, 134, 11, 0.8), var(--shadow-soft);
        }
    }
    
    .voucher-card.complete::before {
        background-color: #38761D; /* Thanh b√™n ƒë·ªïi m√†u xanh l√° */
    }

    .voucher-icon {
        /* ƒê·ªïi style icon: D√πng m√†u n·ªÅn t·ªëi, ch·ªØ v√†ng */
        background-color: var(--color-dark-brown); 
        color: var(--color-gold);
        min-width: 55px;
        height: 55px;
        border-radius: var(--border-radius-sm); /* H√¨nh vu√¥ng bo g√≥c */
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 26px; /* Ch·ªØ to h∆°n */
        font-weight: 800;
        margin-right: 20px; /* TƒÉng kho·∫£ng c√°ch */
        box-shadow: 0 3px 8px rgba(0, 0, 0, 0.3);
        flex-shrink: 0;
        font-family: serif; /* D√πng font c·ªï ƒëi·ªÉn h∆°n */
        transition: background-color 0.3s, box-shadow 0.3s;
    }
    
    /* NEW: Hi·ªáu ·ª©ng ƒë·∫∑c bi·ªát cho icon khi ƒë·ªß ƒëi·ªÉm */
    .voucher-card.complete .voucher-icon {
        background-color: #38761D; /* M√†u xanh l√° c√¢y ƒë·∫≠m */
        box-shadow: 0 0 10px rgba(56, 118, 29, 0.8);
    }
    
    .voucher-details {
        flex-grow: 1;
        margin-left: 5px; /* ƒêi·ªÅu ch·ªânh ƒë·ªÉ c√≥ kho·∫£ng c√°ch v·ªõi d·∫£i g√≥c */
    }
    
    .voucher-details h4 {
        margin: 0;
        font-size: 17px;
        font-weight: 700;
        color: var(--color-dark-brown); /* Ti√™u ƒë·ªÅ m√†u n√¢u s·∫´m */
        letter-spacing: 0.5px;
    }
    
    .voucher-details p {
        margin: 5px 0 0 0;
        font-size: 14px;
        color: var(--color-text-light);
        font-style: italic;
    }
    
    /* NEW: Style cho d√≤ng hi·ªÉn th·ªã ƒëi·ªÉm c·∫ßn t√≠ch th√™m */
    .voucher-diff-text {
        margin-top: 5px;
        font-size: 13px;
        color: #9C6500; /* M√†u cam/v√†ng ·∫•m ƒë·ªÉ n·ªïi b·∫≠t th√¥ng b√°o */
        font-weight: 500;
        font-style: normal;
        /* Animation Base */
        opacity: 0;
        transform: translateY(5px);
        animation: diffTextFadeIn 0.4s ease-out forwards;
    }

    /* Keyframe cho hi·ªáu ·ª©ng Fade In m∆∞·ª£t m√† */
    @keyframes diffTextFadeIn {
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* NEW: Style cho tr·∫°ng th√°i ƒë√£ ƒë·ªß ƒëi·ªÉm */
    .voucher-diff-text.complete {
        color: #38761D; /* M√†u xanh l√° c√¢y cho tr·∫°ng th√°i ƒë·∫°t */
        font-weight: 700; 
        /* Th√™m hi·ªáu ·ª©ng "pop" khi ƒë·∫°t ƒë∆∞·ª£c */
        animation: completePopIn 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards;
    }

    /* Keyframe cho hi·ªáu ·ª©ng Pop In khi ho√†n th√†nh */
    @keyframes completePopIn {
        0% { opacity: 0; transform: scale(0.8); }
        70% { opacity: 1; transform: scale(1.05); }
        100% { opacity: 1; transform: scale(1); }
    }

    .voucher-cost {
        min-width: 90px;
        text-align: right;
        font-weight: 800;
        font-size: 20px;
        color: var(--color-gold); /* ƒêi·ªÉm s·ªë m√†u v√†ng gold n·ªïi b·∫≠t */
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        border-left: 2px dashed #E0E0E0; /* Th√™m ƒë∆∞·ªùng ph√¢n c√°ch m·ªù */
        padding-left: 15px;
        margin-left: 10px;
        line-height: 1.2;
    }
    
    .voucher-cost small {
        font-size: 12px;
        font-weight: 500;
        color: var(--color-text-light);
        margin-top: 3px;
    }

  </style>
  </head>
<body>

<div class="app-container">

    <div class="query-box">
        <h2>Tra c·ª©u <span class="buonlang-text">ƒêi·ªÉm √äƒë√™</span> Bu√¥n L√†ng</h2>
        
        <div class="input-group">
            <input type="text" id="customerPhoneInput" placeholder="Nh·∫≠p S·ªë ƒëi·ªán tho·∫°i c·ªßa b·∫°n" />
            <button onclick="getLoyaltyPoints()">H·ªèi thƒÉm ƒêi·ªÉm</button>
        </div>
    </div>

    <div id="loyaltyPointsResult" class="info">
      M·ªùi b·∫°n nh·∫≠p S·ªë ƒëi·ªán tho·∫°i r·ªìi nh·∫•n n√∫t "H·ªèi thƒÉm ƒêi·ªÉm".
    </div>
    
    <div class="voucher-section">
        <h3>üéÅ ∆ØU ƒê√ÉI ƒê·ªòC QUY·ªÄN T·ª™ BU√îN L√ÄNG üéÅ</h3>
        
        <div class="voucher-list">
            
            <div class="voucher-card" id="card-100">
                <div class="voucher-icon">50</div>
                <div class="voucher-details">
                    <h4>Voucher Gi·∫£m 50.000 VNƒê</h4>
                    <p>√Åp d·ª•ng cho m·ªçi h√≥a ƒë∆°n t·ª´ 500.000 VNƒê</p>
                    <p class="voucher-diff-text" id="diff-100">Tra c·ª©u ƒë·ªÉ xem ƒëi·ªÉm c·∫ßn t√≠ch th√™m.</p>
                </div>
                <div class="voucher-cost">
                    100
                    <small>ƒêi·ªÉm √äƒë√™</small>
                </div>
            </div>

            <div class="voucher-card" id="card-200">
                <div class="voucher-icon">100</div> 
                <div class="voucher-details">
                    <h4>Voucher Gi·∫£m 100.000 VNƒê</h4>
                    <p>Gi·∫£m tr·ª´ tr·ª±c ti·∫øp v√†o t·ªïng h√≥a ƒë∆°n c·ªßa b·∫°n</p>
                    <p class="voucher-diff-text" id="diff-200">Tra c·ª©u ƒë·ªÉ xem ƒëi·ªÉm c·∫ßn t√≠ch th√™m.</p>
                </div>
                <div class="voucher-cost">
                    200
                    <small>ƒêi·ªÉm √äƒë√™</small>
                </div>
            </div>
            
            <div class="voucher-card" id="card-300">
                <div class="voucher-icon">150</div>
                <div class="voucher-details">
                    <h4>Voucher Gi·∫£m 150.000 VNƒê</h4>
                    <p>√Åp d·ª•ng cho m·ªçi h√≥a ƒë∆°n, kh√¥ng gi·ªõi h·∫°n gi√° tr·ªã</p>
                    <p class="voucher-diff-text" id="diff-300">Tra c·ª©u ƒë·ªÉ xem ƒëi·ªÉm c·∫ßn t√≠ch th√™m.</p>
                </div>
                <div class="voucher-cost">
                    300
                    <small>ƒêi·ªÉm √äƒë√™</small>
                </div>
            </div>
            
            <div class="voucher-card" id="card-400">
                <div class="voucher-icon">200</div>
                <div class="voucher-details">
                    <h4>Voucher Ti·ªác L·ªõn 200.000 VNƒê</h4>
                    <p>ƒê·∫∑c quy·ªÅn d√πng cho b·ªØa ti·ªác l·ªõn t·∫°i Bu√¥n L√†ng</p>
                    <p class="voucher-diff-text" id="diff-400">Tra c·ª©u ƒë·ªÉ xem ƒëi·ªÉm c·∫ßn t√≠ch th√™m.</p>
                </div>
                <div class="voucher-cost">
                    400
                    <small>ƒêi·ªÉm √äƒë√™</small>
                </div>
            </div>

        </div>
    </div>
    </div>
<script type="module">
  // Import Firebase SDK
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  // Th√™m 'set' ƒë·ªÉ l∆∞u d·ªØ li·ªáu m·ªõi v√† 'get' ƒë·ªÉ truy v·∫•n
  import { getDatabase, ref, get, set } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js"; 

  // Firebase config c·ªßa b·∫°n (gi·ªØ nguy√™n)
  const firebaseConfig = {
    apiKey: "AIzaSyB8uLkLJFlzmCodcawJhs2dRckHQzO5y10",
    authDomain: "chitieu-7263e.firebaseapp.com",
    databaseURL: "https://chitieu-7263e-default-rtdb.firebaseio.com",
    projectId: "chitieu-7263e",
    storageBucket: "chitieu-7263e.firebasestorage.app",
    messagingSenderId: "83833140682",
    appId: "1:83833140682:web:f9254b418ace3a659fcb33",
    measurementId: "G-523X74K18N"
  };

  // Kh·ªüi t·∫°o Firebase
  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  // Quy t·∫Øc t√≠nh ƒëi·ªÉm: 1,000,000 VNƒê = 100 ƒëi·ªÉm √äƒë√™. (GI·ªÆ NGUY√äN)
  const POINTS_PER_MILLION = 100; 

  /**
   * Chu·∫©n h√≥a SƒêT th√†nh key ch·ªâ ch·ª©a s·ªë.
   * @param {string} phone - S·ªë ƒëi·ªán tho·∫°i th√¥.
   * @returns {string} - S·ªë ƒëi·ªán tho·∫°i ch·ªâ ch·ª©a s·ªë.
   */
  function standardizePhoneKey(phone) {
    return phone.replace(/[^0-9]/g, ''); 
  }

  /**
   * C·∫≠p nh·∫≠t ƒëi·ªÉm t√≠ch l≈©y, ƒëi·ªÉm ƒë√£ ƒë·ªïi, v√† ƒëi·ªÉm hi·ªán t·∫°i v√†o Firebase Realtime Database
   */
  async function updateLoyaltyDataInDB(phone, totalAmount, accumulatedPoints, redeemedPoints, currentPoints) {
    try {
        const phoneKey = standardizePhoneKey(phone);
        // GI·ªÆ NGUY√äN LOGIC V√Ä C√ÅC THAM S·ªê C·ª¶A H√ÄM SET
        await set(ref(db, 'loyalty_points/' + phoneKey), {
            phone: phone,
            totalAmount: totalAmount,
            accumulatedPoints: accumulatedPoints, // T·ªïng ƒëi·ªÉm t√≠ch l≈©y t·ª´ bill
            redeemedPoints: redeemedPoints,       // T·ªïng ƒëi·ªÉm ƒë√£ ƒë·ªïi (s·∫Ω ƒë∆∞·ª£c c·∫≠p nh·∫≠t khi ƒë·ªïi ƒëi·ªÉm)
            currentPoints: currentPoints,         // ƒêi·ªÉm hi·ªán t·∫°i (accumulatedPoints - redeemedPoints)
            lastUpdated: new Date().toISOString()
        });
        console.log(`ƒê√£ c·∫≠p nh·∫≠t d·ªØ li·ªáu ƒëi·ªÉm th√†nh c√¥ng cho SƒêT: ${phone}`);
    } catch (error) {
        console.error("L·ªói khi l∆∞u ƒëi·ªÉm v√†o DB:", error);
    }
  }

  // --- MODIFIED FUNCTION: C·∫≠p nh·∫≠t th√¥ng tin ƒëi·ªÉm c·∫ßn t√≠ch th√™m tr√™n Voucher ---
  function updateVoucherDifference(currentPoints) {
        // Danh s√°ch c√°c voucher, ƒëi·ªÉm c·∫ßn thi·∫øt V√Ä ID TH·∫∫ CHA (ƒê√É S·ª¨A: C·∫≠p nh·∫≠t Cost v√† ID)
        const vouchers = [
            { id: 'diff-100', cost: 100, cardId: 'card-100' }, // 50k
            { id: 'diff-200', cost: 200, cardId: 'card-200' }, // 100k
            { id: 'diff-300', cost: 300, cardId: 'card-300' }, // 150k
            { id: 'diff-400', cost: 400, cardId: 'card-400' }  // 200k
        ];

        vouchers.forEach(v => {
            const diffElement = document.getElementById(v.id);
            const cardElement = document.getElementById(v.cardId); // L·∫•y th·∫ª cha (voucher-card)

            if (diffElement && cardElement) {
                const requiredPoints = v.cost - currentPoints;
                
                // Reset animation state tr∆∞·ªõc khi c·∫≠p nh·∫≠t
                diffElement.style.animation = 'none';
                diffElement.offsetHeight; /* trigger reflow */
                diffElement.style.animation = null; 

                if (requiredPoints <= 0) {
                    // N·∫øu ƒë·ªß ƒëi·ªÉm, hi·ªÉn th·ªã th√¥ng b√°o ho√†n th√†nh, th√™m class 'complete' v√† animation
                    diffElement.innerHTML = `üåü **Ch√∫c m·ª´ng!** B·∫°n ƒë√£ ƒë·ªß ƒëi·ªÉm ƒë·ªÉ ƒë·ªïi Voucher n√†y!`;
                    diffElement.className = "voucher-diff-text complete";
                    cardElement.classList.add('complete'); 
                } else {
                    // N·∫øu ch∆∞a ƒë·ªß ƒëi·ªÉm, hi·ªÉn th·ªã s·ªë ƒëi·ªÉm c·∫ßn th√™m v√† x√≥a class 'complete'
                    diffElement.innerHTML = `B·∫°n c·∫ßn t√≠ch th√™m **${requiredPoints.toLocaleString()}** ƒëi·ªÉm √äƒë√™ n·ªØa.`;
                    diffElement.className = "voucher-diff-text";
                    cardElement.classList.remove('complete'); 
                }
            }
        });
  }


  // --- H√ÄM T√çNH ƒêI·ªÇM T√çCH L≈®Y, T√çNH ƒêI·ªÇM C√íN L·∫†I V√Ä C·∫¨P NH·∫¨T DB ---
  async function getLoyaltyPoints() {
    const phoneInput = document.getElementById("customerPhoneInput");
    const phone = phoneInput.value.trim();
    const phoneKey = standardizePhoneKey(phone);
    const resultDiv = document.getElementById("loyaltyPointsResult");
    
    // Ki·ªÉm tra ƒë·∫ßu v√†o (KH√îNG S·ª¨A LOGIC)
    if (!phone) {
      // ƒê·ªïi HTML ƒë·ªÉ ph√π h·ª£p v·ªõi UI m·ªõi
      resultDiv.innerHTML = "<span class='result-title'>√ä-xem!</span> Vui l√≤ng nh·∫≠p **S·ªë ƒëi·ªán tho·∫°i** c·ªßa b·∫°n.";
      resultDiv.className = "info";
      // C·∫≠p nh·∫≠t l·∫°i voucher v·ªÅ tr·∫°ng th√°i ban ƒë·∫ßu khi l·ªói
      updateVoucherDifference(-99999);
      return;
    }

    // ƒê·ªïi HTML ƒë·ªÉ ph√π h·ª£p v·ªõi UI m·ªõi
    resultDiv.innerHTML = `<span class='result-title'>Th√¥ng B√°o</span><br>Bu√¥n L√†ng ƒëang tra c·ª©u th√¥ng tin cho SƒêT: **${phone}**...`;
    resultDiv.className = "info";

    try {
      // 1. T√çNH T·ªîNG ƒêI·ªÇM T√çCH L≈®Y (Accumulated Points) - KH√îNG S·ª¨A LOGIC
      const paymentHistoryRef = ref(db, 'payment_history');
      const historySnapshot = await get(paymentHistoryRef);

      if (!historySnapshot.exists()) {
        // ƒê·ªïi HTML ƒë·ªÉ ph√π h·ª£p v·ªõi UI m·ªõi
        resultDiv.innerHTML = `<span class='result-title'>L·ªói H·ªá Th·ªëng</span><br>Y√†ng (Tr·ªùi) ∆°i! H·ªá th·ªëng ƒëang c√≥ ch√∫t tr·ª•c tr·∫∑c. Xin b·∫°n ƒë·ª£i l√°t.`;
        resultDiv.className = "error";
        updateVoucherDifference(-99999); // C·∫≠p nh·∫≠t l·∫°i voucher v·ªÅ tr·∫°ng th√°i ban ƒë·∫ßu khi l·ªói
        return;
      }

      let totalAmount = 0;
      let billFound = false; 

      historySnapshot.forEach(child => {
        const data = child.val();
        
        if (data.customerPhone && standardizePhoneKey(data.customerPhone) === phoneKey) {
            billFound = true; 
            const finalTotal = parseFloat(data.finalTotal);
            if (!isNaN(finalTotal) && finalTotal > 0) {
                totalAmount += finalTotal;
            }
        }
      });
      
      const accumulatedPoints = Math.floor(totalAmount / 1000000) * POINTS_PER_MILLION;
      
      
      // LOGIC X·ª¨ L√ù K·∫æT QU·∫¢ V√Ä C·∫¨P NH·∫¨T ƒêI·ªÇM (KH√îNG S·ª¨A LOGIC)
      if (!billFound) {
          // Tr∆∞·ªùng h·ª£p 1: Kh√¥ng t√¨m th·∫•y SƒêT n√†o kh·ªõp trong history
          // ƒê·ªïi HTML ƒë·ªÉ ph√π h·ª£p v·ªõi UI m·ªõi
          resultDiv.innerHTML = `
            <span class='result-title'>Ch∆∞a L√† Kh√°ch Qu√Ω</span>
            <br>
            A-chi! R·∫•t ti·∫øc, S·ªë ƒëi·ªán tho·∫°i **${phone}** ch∆∞a c√≥ trong danh s√°ch kh√°ch qu√Ω c·ªßa Bu√¥n L√†ng.
            <br>
            **B·∫°n ch∆∞a ƒëƒÉng k√Ω th√†nh vi√™n.** M·ªùi b·∫°n gh√© qu·∫ßy g·∫∑p **P√¥** ƒë·ªÉ ƒëƒÉng k√Ω ngay v√† nh·∫≠n qu√† nha!
          `;
          resultDiv.className = "error";
          updateVoucherDifference(-99999); // C·∫≠p nh·∫≠t l·∫°i voucher v·ªÅ tr·∫°ng th√°i ban ƒë·∫ßu khi l·ªói
          return;
      } 
      
      // 2. L·∫§Y ƒêI·ªÇM ƒê√É ƒê·ªîI (Redeemed Points) V√Ä T√çNH ƒêI·ªÇM HI·ªÜN T·∫†I (KH√îNG S·ª¨A LOGIC)
      const loyaltyRef = ref(db, 'loyalty_points/' + phoneKey);
      const loyaltySnapshot = await get(loyaltyRef);
      
      let redeemedPoints = 0;
      
      if (loyaltySnapshot.exists()) {
          // L·∫•y ƒëi·ªÉm ƒë√£ ƒë·ªïi n·∫øu ƒë√£ t·ªìn t·∫°i trong DB
          redeemedPoints = loyaltySnapshot.val().redeemedPoints || 0;
      } else {
          // X·ª≠ l√Ω tr∆∞·ªùng h·ª£p SƒêT v√≠ d·ª• ƒë∆∞·ª£c y√™u c·∫ßu: 0909650816
          if (phoneKey === '0909650816') {
             redeemedPoints = 20; // Thi·∫øt l·∫≠p 20 ƒëi·ªÉm ƒë√£ ƒë·ªïi theo y√™u c·∫ßu
          }
      }

      // T√≠nh ƒëi·ªÉm hi·ªán t·∫°i (KH√îNG S·ª¨A LOGIC)
      const currentPoints = Math.max(0, accumulatedPoints - redeemedPoints);

      // --- NEW CALL: C·∫≠p nh·∫≠t hi·ªÉn th·ªã ƒëi·ªÉm c·∫ßn t√≠ch th√™m tr√™n Voucher ---
      updateVoucherDifference(currentPoints);


      // 3. C·∫¨P NH·∫¨T D·ªÆ LI·ªÜU ƒêI·ªÇM M·ªöI V√ÄO DB (KH√îNG S·ª¨A LOGIC)
      await updateLoyaltyDataInDB(phone, totalAmount, accumulatedPoints, redeemedPoints, currentPoints);

      
      // 4. HI·ªÇN TH·ªä K·∫æT QU·∫¢ (C·∫≠p nh·∫≠t HTML ƒë·ªÉ ph√π h·ª£p UI m·ªõi)
      const formattedTotal = totalAmount.toLocaleString('vi-VN', { style: 'currency', currency: 'VND' });
      
      if (currentPoints > 0) {
         resultDiv.innerHTML = `
            <span class='result-title'>**M'n√¥ng Y√†ng!** (C·∫£m ∆°n Tr·ªùi!)</span>
            <br>
            B·∫°n hi·ªán c√≥:
            <br>
            <span class="current-points-display">${currentPoints.toLocaleString()} ƒêi·ªÉm √äƒë√™</span>
            <br>
            <div class="note">
                T·ªïng ƒëi·ªÉm t√≠ch l≈©y: ${accumulatedPoints.toLocaleString()} ƒêi·ªÉm
                <br>
                T·ªïng ƒëi·ªÉm ƒë√£ ƒë·ªïi: ${redeemedPoints.toLocaleString()} ƒêi·ªÉm
                <br>
                T·ªïng chi ti√™u (Ti·ªÅn c√∫ng Y√†ng): ${formattedTotal}
            </div>
            <p style="text-align: center; margin-top: 15px;">
                H√£y d√πng ƒêi·ªÉm √äƒë√™ n√†y ƒë·ªÉ ƒë·ªïi l·∫•y ƒë·∫∑c s·∫£n Bu√¥n L√†ng nh√©!
            </p>
          `;
          resultDiv.className = "success";
          
      } else {
         resultDiv.innerHTML = `
            <span class='result-title'>**H∆°-nhƒ©!** Ng∆∞·ªùi th√¢n Bu√¥n L√†ng</span>
            <br>
            S·ªë ƒëi·ªán tho·∫°i **${phone}** ƒë√£ l√† ng∆∞·ªùi th√¢n c·ªßa Bu√¥n L√†ng r·ªìi!
            <br>
            Hi·ªán t·∫°i, b·∫°n **ch∆∞a c√≥ ƒêi·ªÉm √äƒë√™** n√†o.
            <br>
            <div class="note">
                T·ªïng ƒëi·ªÉm t√≠ch l≈©y: ${accumulatedPoints.toLocaleString()} ƒêi·ªÉm
                <br>
                T·ªïng ƒëi·ªÉm ƒë√£ ƒë·ªïi: ${redeemedPoints.toLocaleString()} ƒêi·ªÉm
                <br>
                T·ªïng chi ti√™u (Ti·ªÅn c√∫ng Y√†ng): ${formattedTotal}
            </div>
            <p style="text-align: center; margin-top: 15px;">
                L·∫ßn t·ªõi gh√© Bu√¥n L√†ng, nh·ªõ g·ªçi th√™m m√≥n ƒë·ªÉ t√≠ch ƒëi·ªÉm nh√©!
            </p>
          `;
          resultDiv.className = "info";
      }


    } catch (error) {
      console.error("L·ªói tra c·ª©u ƒëi·ªÉm:", error);
      // ƒê·ªïi HTML ƒë·ªÉ ph√π h·ª£p v·ªõi UI m·ªõi
      resultDiv.innerHTML = "<span class='result-title'>L·ªói K·∫øt N·ªëi</span><br>H·ªá th·ªëng ƒëang ngh·ªâ ng∆°i! Kh√¥ng th·ªÉ tra c·ª©u ƒë∆∞·ª£c. Xin b·∫°n th√¥ng c·∫£m.";
      resultDiv.className = "error";
    }
  }
  
  // Expose the function globally (KH√îNG S·ª¨A LOGIC)
  window.getLoyaltyPoints = getLoyaltyPoints;

</script>

</body>
</html>
