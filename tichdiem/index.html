<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>·∫®m Th·ª±c Bu√¥n M√™ - ƒêi·ªÉm Th√¢n Quen</title>
  
  <style>
    /* * ----------------------------------------
     * 1. H∆†I TH·ªû T√ÇY NGUY√äN (VARIABLES)
     * ----------------------------------------
     */
    :root {
      --color-primary: #5D3A1A;
      --color-secondary: #8B5A2B;
      --color-accent: #D4A373;
      --color-gold: #B8860B;
      --color-bg: #FDFBF7;
      --color-card: #FFFFFF;
      --color-text: #2D241E;
      --color-text-light: #6D5D51;
      --radius-lg: 20px;
      --radius-md: 12px;
      --shadow: 0 6px 20px rgba(93, 58, 26, 0.06);
      --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

    body {
      font-family: -apple-system, system-ui, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background-color: var(--color-bg);
      color: var(--color-text);
      margin: 0;
      padding: 15px 10px;
      line-height: 1.4;
      display: flex;
      justify-content: center;
      min-height: 100vh;
    }

    .app-container {
      width: 100%;
      max-width: 480px;
      animation: fadeIn 0.6s ease-out;
      position: relative;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* * ----------------------------------------
     * 2. HEADER & NH·∫¨P LI·ªÜU
     * ----------------------------------------
     */
    .header-section {
        text-align: center;
        margin-bottom: 20px;
        position: relative;
    }

    .header-section h2 {
        color: var(--color-primary);
        font-size: 24px;
        margin: 0 0 5px 0;
        font-weight: 800;
    }

    .header-section p {
        color: var(--color-text-light);
        font-size: 14px;
        margin: 0;
    }

    .query-box {
      background: var(--color-card);
      padding: 15px;
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow);
      border: 1px solid rgba(139, 90, 43, 0.1);
      margin-bottom: 15px;
    }
    
    .input-group {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    input[type="text"] {
      width: 100% !important;
      padding: 14px 15px;
      border: 2px solid #F1EDE9;
      border-radius: var(--radius-md);
      background-color: #FAFAF8;
      font-size: 16px;
      color: var(--color-primary);
      outline: none;
    }

    button {
      width: 100% !important;
      padding: 14px;
      background: linear-gradient(135deg, var(--color-primary), var(--color-secondary));
      color: white;
      border: none;
      border-radius: var(--radius-md);
      cursor: pointer;
      font-size: 16px;
      font-weight: 700;
      box-shadow: 0 4px 12px rgba(93, 58, 26, 0.2);
    }

    .btn-back {
      position: absolute;
      top: 5px;
      left: 0;
      width: auto !important;
      padding: 8px 12px;
      background: #F1EDE9;
      color: var(--color-primary);
      font-size: 12px;
      font-weight: 600;
      border-radius: 8px;
      box-shadow: none;
      border: 1px solid #E5E0DA;
    }

    /* * ----------------------------------------
     * 3. K·∫æT QU·∫¢ HI·ªÇN TH·ªä
     * ----------------------------------------
     */
    #loyaltyPointsResult {
      margin-top: 5px;
      padding: 15px;
      border-radius: var(--radius-lg);
      font-size: 14px;
      text-align: center;
      min-height: 80px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      box-shadow: var(--shadow);
    }
    
    .info { background: #F4F1EE; color: var(--color-primary); border: 1px dashed var(--color-accent); }
    .success { background: linear-gradient(180deg, #FFFFFF, #FDFCF0); color: var(--color-primary); border: 1px solid var(--color-gold); }
    .error { background: #FFF5F5; color: #A52A2A; border: 1px solid #FFDADA; }
    
    .current-points-display {
        display: block;
        font-size: 32px; 
        font-weight: 850;
        margin: 5px 0;
        color: var(--color-primary);
    }

    .note {
        margin-top: 10px;
        font-size: 12px;
        color: var(--color-text-light);
        padding: 8px;
        border-radius: var(--radius-md);
        background-color: rgba(93, 58, 26, 0.05);
    }

    /* * ----------------------------------------
     * 4. VOUCHER SECTIONS
     * ----------------------------------------
     */
    .voucher-section {
        margin-top: 25px;
    }
    
    .voucher-section h3 {
        font-size: 18px;
        color: var(--color-primary);
        margin-bottom: 15px;
        font-weight: 800;
        text-align: center;
    }
    
    .voucher-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
    }

    .voucher-card {
        background: var(--color-card);
        border-radius: var(--radius-md);
        box-shadow: var(--shadow);
        padding: 12px;
        border: 1px solid #F1EDE9;
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
        position: relative;
    }

    .voucher-card.complete {
        border: 2px solid var(--color-gold);
        background: #FFFDF5;
    }

    .voucher-icon {
        background: #F8F3ED;
        color: var(--color-primary);
        width: 45px;
        height: 45px;
        border-radius: 10px;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 15px;
        font-weight: 800;
        margin-bottom: 8px;
    }

    .complete .voucher-icon {
        background: var(--color-gold);
        color: white;
    }
    
    .voucher-details h4 { margin: 0; font-size: 14px; font-weight: 700; color: var(--color-primary); }
    .voucher-details p { margin: 2px 0; font-size: 11px; color: var(--color-text-light); line-height: 1.2; }
    
    .voucher-diff-text {
        margin-top: 5px; font-size: 10px; color: var(--color-secondary); font-weight: 600;
    }

    .voucher-cost {
        margin-top: 8px;
        padding-top: 8px;
        width: 100%;
        border-top: 1px dashed #EEE;
        font-weight: 800;
        font-size: 16px;
        color: var(--color-primary);
    }
    
    .voucher-cost small { font-size: 9px; display: block; color: var(--color-text-light); }

    .group-voucher .voucher-card { border-top: 4px solid var(--color-accent); }

    /* Controls */
    #loyaltyPointsResult { display: none; }
  </style>
</head>
<body>

<div class="app-container">

    <div class="header-section">
        <button id="backBtn" class="btn-back" style="display: none;" onclick="resetForm()">‚Üê Quay l·∫°i</button>
        <h2>·∫®m Th·ª±c Bu√¥n M√™</h2>
        <p>M·ªói l·∫ßn gh√© Bu√¥n - Th√™m ph·∫ßn g·∫Øn b√≥</p>
    </div>

    <div id="inputContainer">
        <div class="query-box">
            <div class="input-group">
                <input type="text" id="customerPhoneInput" placeholder="S·ªë ƒëi·ªán tho·∫°i kh√°ch qu√Ω" />
                <button onclick="getLoyaltyPoints()">V√†o Bu√¥n Tra C·ª©u</button>
            </div>
        </div>
        <div id="statusMessage" class="info" style="padding: 15px; border-radius: var(--radius-lg); text-align: center; border: 1px dashed var(--color-accent);">
          G√µ s·ªë ƒëi·ªán tho·∫°i ƒë·ªÉ Bu√¥n M√™ ƒë√≥n ch√†o b·∫°n nh√©!
        </div>
    </div>

    <div id="loyaltyPointsResult"></div>

    <div id="voucherContainer">
        <div class="voucher-section">
            <h3>üéÅ Qu√† Bu√¥n L√†ng üéÅ</h3>
            <div class="voucher-grid">
                <div class="voucher-card" id="card-100">
                    <div class="voucher-icon">50k</div>
                    <div class="voucher-details">
                        <h4>Phi·∫øu 50k</h4>
                        <p>Bill t·ª´ 500k</p>
                        <p class="voucher-diff-text" id="diff-100">C·∫ßn th√™m ƒëi·ªÉm...</p>
                    </div>
                    <div class="voucher-cost">100<small>ƒêi·ªÉm √ä ƒê√™</small></div>
                </div>

                <div class="voucher-card" id="card-200">
                    <div class="voucher-icon">100k</div> 
                    <div class="voucher-details">
                        <h4>Phi·∫øu 100k</h4>
                        <p>Tr·ª´ tr·ª±c ti·∫øp bill</p>
                        <p class="voucher-diff-text" id="diff-200">C·∫ßn th√™m ƒëi·ªÉm...</p>
                    </div>
                    <div class="voucher-cost">200<small>ƒêi·ªÉm √ä ƒê√™</small></div>
                </div>
                
                <div class="voucher-card" id="card-300">
                    <div class="voucher-icon">150k</div>
                    <div class="voucher-details">
                        <h4>Phi·∫øu 150k</h4>
                        <p>M·ªçi h√≥a ƒë∆°n</p>
                        <p class="voucher-diff-text" id="diff-300">C·∫ßn th√™m ƒëi·ªÉm...</p>
                    </div>
                    <div class="voucher-cost">300<small>ƒêi·ªÉm √ä ƒê√™</small></div>
                </div>
                
                <div class="voucher-card" id="card-400">
                    <div class="voucher-icon">200k</div>
                    <div class="voucher-details">
                        <h4>Ti·ªác L·ªõn 200k</h4>
                        <p>Sum h·ªçp gia ƒë√¨nh</p>
                        <p class="voucher-diff-text" id="diff-400">C·∫ßn th√™m ƒëi·ªÉm...</p>
                    </div>
                    <div class="voucher-cost">400<small>ƒêi·ªÉm √ä ƒê√™</small></div>
                </div>

                <div class="voucher-card" id="card-1000" style="grid-column: span 2;">
                    <div class="voucher-icon" style="width: 100px; margin: 0 auto 8px;">Tri √Çn</div>
                    <div class="voucher-details">
                        <h4>M√≥n Qu√† Cao Qu√Ω 500k</h4>
                        <p>Kh√°ch h√†ng th√¢n thi·∫øt nh·∫•t</p>
                        <p class="voucher-diff-text" id="diff-1000">C·∫ßn th√™m ƒëi·ªÉm...</p>
                    </div>
                    <div class="voucher-cost">1000<small>ƒêi·ªÉm √ä ƒê√™</small></div>
                </div>
            </div>
        </div>

        <div class="voucher-section group-voucher">
            <h3>üë• ∆Øu ƒê√£i ƒêi Nh√≥m üë•</h3>
            <div class="voucher-grid">
                <div class="voucher-card">
                    <div class="voucher-icon">5%</div>
                    <div class="voucher-details"><h4>K·∫øt Th√¢n</h4><p>Nh√≥m t·ª´ 4 ng∆∞·ªùi</p></div>
                    <div class="voucher-cost">Nh√≥m 4</div>
                </div>
                <div class="voucher-card">
                    <div class="voucher-icon">10%</div>
                    <div class="voucher-details"><h4>B·∫£n L√†ng</h4><p>Nh√≥m t·ª´ 8 ng∆∞·ªùi</p></div>
                    <div class="voucher-cost">Nh√≥m 8</div>
                </div>
                <div class="voucher-card" style="grid-column: span 2;">
                    <div class="voucher-icon" style="width: 120px; margin: 0 auto 8px;">Gi·∫£m 15%</div>
                    <div class="voucher-details"><h4>ƒê·∫°i Gia ƒê√¨nh Sum H·ªçp</h4><p>∆Øu ƒë√£i 15% t·ªïng bill (t·ª´ 15 ng∆∞·ªùi)</p></div>
                    <div class="voucher-cost">Nh√≥m 15</div>
                </div>
            </div>
        </div>
    </div>

</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getDatabase, ref, get, set } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js"; 

  const firebaseConfig = {
    apiKey: "AIzaSyB8uLkLJFlzmCodcawJhs2dRckHQzO5y10",
    authDomain: "chitieu-7263e.firebaseapp.com",
    databaseURL: "https://chitieu-7263e-default-rtdb.firebaseio.com",
    projectId: "chitieu-7263e",
    storageBucket: "chitieu-7263e.firebasestorage.app",
    messagingSenderId: "83833140682",
    appId: "1:83833140682:web:f9254b418ace3a659fcb33",
    measurementId: "G-523X74K18N"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const POINTS_PER_MILLION = 100; 

  function standardizePhoneKey(phone) { return phone.replace(/[^0-9]/g, ''); }

  function showResultScreen() {
      document.getElementById("inputContainer").style.display = "none";
      document.getElementById("loyaltyPointsResult").style.display = "flex";
      document.getElementById("backBtn").style.display = "block";
  }

  function resetForm() {
      document.getElementById("inputContainer").style.display = "block";
      document.getElementById("loyaltyPointsResult").style.display = "none";
      document.getElementById("backBtn").style.display = "none";
      document.getElementById("customerPhoneInput").value = "";
      document.getElementById("statusMessage").innerHTML = "G√µ s·ªë ƒëi·ªán tho·∫°i ƒë·ªÉ Bu√¥n M√™ ƒë√≥n ch√†o b·∫°n nh√©!";
      document.getElementById("statusMessage").className = "info";
      updateVoucherDifference(-9999); // Reset voucher state
  }

  async function updateLoyaltyDataInDB(phone, totalAmount, accumulatedPoints, redeemedPoints, currentPoints) {
    try {
        const phoneKey = standardizePhoneKey(phone);
        await set(ref(db, 'loyalty_points/' + phoneKey), {
            phone: phone, totalAmount: totalAmount,
            accumulatedPoints: accumulatedPoints, redeemedPoints: redeemedPoints,
            currentPoints: currentPoints, lastUpdated: new Date().toISOString()
        });
    } catch (error) { console.error("L·ªói l∆∞u DB:", error); }
  }

  function updateVoucherDifference(currentPoints) {
        const vouchers = [
            { id: 'diff-100', cost: 100, cardId: 'card-100' },
            { id: 'diff-200', cost: 200, cardId: 'card-200' },
            { id: 'diff-300', cost: 300, cardId: 'card-300' },
            { id: 'diff-400', cost: 400, cardId: 'card-400' },
            { id: 'diff-1000', cost: 1000, cardId: 'card-1000' }
        ];

        vouchers.forEach(v => {
            const diffElement = document.getElementById(v.id);
            const cardElement = document.getElementById(v.cardId);
            if (diffElement && cardElement) {
                const requiredPoints = v.cost - currentPoints;
                if (requiredPoints <= 0) {
                    diffElement.innerHTML = `üåü ƒê·ªß ƒëi·ªÉm!`;
                    diffElement.className = "voucher-diff-text complete";
                    cardElement.classList.add('complete'); 
                } else {
                    const formatted = requiredPoints > 2000 ? v.cost : requiredPoints.toFixed(1).replace(/\.0$/, '');
                    diffElement.innerHTML = `Thi·∫øu ${formatted} ƒëi·ªÉm √ä ƒê√™`;
                    diffElement.className = "voucher-diff-text";
                    cardElement.classList.remove('complete'); 
                }
            }
        });
  }

  async function getLoyaltyPoints() {
    const phoneInput = document.getElementById("customerPhoneInput");
    const phone = phoneInput.value.trim();
    const phoneKey = standardizePhoneKey(phone);
    const resultDiv = document.getElementById("loyaltyPointsResult");
    const statusMsg = document.getElementById("statusMessage");
    
    if (!phone) {
      statusMsg.innerHTML = "Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i kh√°ch qu√Ω nh√©!";
      statusMsg.className = "error";
      return;
    }

    statusMsg.innerHTML = `ƒêang t√¨m...`;
    statusMsg.className = "info";

    try {
      const paymentHistoryRef = ref(db, 'payment_history');
      const historySnapshot = await get(paymentHistoryRef);

      if (!historySnapshot.exists()) {
        statusMsg.innerHTML = `H·ªá th·ªëng b·∫≠n.`;
        statusMsg.className = "error";
        return;
      }

      let totalAmount = 0;
      let billFound = false; 

      historySnapshot.forEach(child => {
        const data = child.val();
        if (data.customerPhone && standardizePhoneKey(data.customerPhone) === phoneKey) {
            billFound = true; 
            const finalTotal = parseFloat(data.finalTotal);
            if (!isNaN(finalTotal) && finalTotal > 0) totalAmount += finalTotal;
        }
      });
      
      if (!billFound) {
          statusMsg.innerHTML = `SƒêT **${phone}** ch∆∞a c√≥ ƒëi·ªÉm. M·ªùi b·∫°n gh√© bu√¥n ch∆°i nh√©!`;
          statusMsg.className = "error";
          return;
      } 
      
      showResultScreen();

      const accumulatedPoints = (totalAmount / 1000000) * POINTS_PER_MILLION;
      const loyaltyRef = ref(db, 'loyalty_points/' + phoneKey);
      const loyaltySnapshot = await get(loyaltyRef);
      let redeemedPoints = 0;
      if (loyaltySnapshot.exists()) redeemedPoints = loyaltySnapshot.val().redeemedPoints || 0;

      const currentPoints = Math.max(0, accumulatedPoints - redeemedPoints);
      updateVoucherDifference(currentPoints);
      await updateLoyaltyDataInDB(phone, totalAmount, accumulatedPoints, redeemedPoints, currentPoints);

      const formattedCurrent = currentPoints.toFixed(1).replace(/\.0$/, '');

      resultDiv.innerHTML = `
        <span class='result-title'>Ch√†o Kh√°ch Qu√Ω!</span>
        <span class="current-points-display">${formattedCurrent} ƒêi·ªÉm √ä ƒê√™</span>
        <div class="note">
            T√≠ch: ${accumulatedPoints.toFixed(1)} | ƒê√£ ƒë·ªïi: ${redeemedPoints} <br>
            T·ªïng chi ti√™u: ${totalAmount.toLocaleString('vi-VN')}ƒë
        </div>
      `;
      resultDiv.className = "success";

    } catch (error) {
      statusMsg.innerHTML = "L·ªói k·∫øt n·ªëi!";
      statusMsg.className = "error";
    }
  }
  
  window.getLoyaltyPoints = getLoyaltyPoints;
  window.resetForm = resetForm;
</script>

</body>
</html>
