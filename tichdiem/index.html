<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>·∫®m Th·ª±c Bu√¥n M√™ - ƒêi·ªÉm Th√¢n Quen</title>
  
  <style>
    /* * ----------------------------------------
     * 1. H∆†I TH·ªû T√ÇY NGUY√äN (VARIABLES)
     * ----------------------------------------
     */
    :root {
      --color-primary: #5D3A1A;
      --color-secondary: #8B5A2B;
      --color-accent: #D4A373;
      --color-gold: #B8860B;
      --color-bg: #FDFBF7;
      /* M√†u k√≠nh trong su·ªët */
      --color-glass: rgba(255, 255, 255, 0.7);
      --color-text: #2D241E;
      --color-text-light: #6D5D51;
      --radius-lg: 20px;
      --radius-md: 12px;
      --shadow: 0 8px 32px rgba(93, 58, 26, 0.08);
      --transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; scroll-behavior: smooth; }

    body {
      font-family: -apple-system, system-ui, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background-color: var(--color-bg);
      background-image: radial-gradient(circle at 50% 50%, #ffffff 0%, #fdfbf7 100%);
      color: var(--color-text);
      margin: 0;
      padding: 15px 10px;
      line-height: 1.4;
      display: flex;
      justify-content: center;
      min-height: 100vh;
    }

    .app-container {
      width: 100%;
      max-width: 480px;
      animation: fadeIn 0.6s ease-out;
      position: relative;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* * ----------------------------------------
     * 2. HEADER & NH·∫¨P LI·ªÜU (TRONG SU·ªêT)
     * ----------------------------------------
     */
    .header-section {
        text-align: center;
        margin-bottom: 20px;
        position: relative;
    }

    .header-section h2 {
        color: var(--color-primary);
        font-size: 24px;
        margin: 0 0 5px 0;
        font-weight: 800;
    }

    .query-box {
      background: var(--color-glass);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      padding: 15px;
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow);
      border: 1px solid rgba(255, 255, 255, 0.5);
      margin-bottom: 15px;
    }
    
    .input-group {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    input[type="text"] {
      width: 100% !important;
      padding: 14px 15px;
      border: 1px solid rgba(139, 90, 43, 0.1);
      border-radius: var(--radius-md);
      background-color: rgba(255, 255, 255, 0.5);
      font-size: 16px;
      color: var(--color-primary);
      outline: none;
    }

    button {
      width: 100% !important;
      padding: 14px;
      background: linear-gradient(135deg, var(--color-primary), var(--color-secondary));
      color: white;
      border: none;
      border-radius: var(--radius-md);
      cursor: pointer;
      font-size: 16px;
      font-weight: 700;
      box-shadow: 0 4px 12px rgba(93, 58, 26, 0.2);
    }

    .btn-back {
      position: absolute;
      top: 5px;
      left: 0;
      width: auto !important;
      padding: 8px 12px;
      background: rgba(255, 255, 255, 0.6);
      backdrop-filter: blur(5px);
      color: var(--color-primary);
      font-size: 12px;
      font-weight: 600;
      border-radius: 8px;
      border: 1px solid rgba(0,0,0,0.05);
    }

    /* * ----------------------------------------
     * 3. K·∫æT QU·∫¢ HI·ªÇN TH·ªä TRONG SU·ªêT
     * ----------------------------------------
     */
    #loyaltyPointsResult {
      margin-top: 5px;
      padding: 25px 15px;
      border-radius: var(--radius-lg);
      text-align: center;
      display: flex;
      flex-direction: column;
      justify-content: center;
      box-shadow: var(--shadow);
      background: var(--color-glass);
      backdrop-filter: blur(15px);
      border: 1px solid rgba(255, 255, 255, 0.5);
    }
    
    .info { color: var(--color-primary); }
    .success { border: 2px solid var(--color-gold); }
    .error { background: rgba(255, 245, 245, 0.8) !important; color: #A52A2A; }
    
    .tier-badge {
        display: inline-block;
        padding: 6px 20px;
        border-radius: 50px;
        background: linear-gradient(135deg, var(--color-primary), var(--color-secondary));
        color: white;
        font-weight: 800;
        font-size: 16px;
        margin-bottom: 15px;
        text-transform: uppercase;
        box-shadow: 0 4px 10px rgba(93, 58, 26, 0.2);
    }

    .accumulated-box {
        margin-top: 15px;
        padding: 15px;
        background: rgba(253, 244, 227, 0.6);
        border-radius: var(--radius-md);
        border: 1px solid rgba(184, 134, 11, 0.3);
    }

    .accumulated-points-value {
        font-size: 42px;
        font-weight: 900;
        color: var(--color-gold);
        line-height: 1;
    }

    /* B·∫£ng ph√¢n h·∫°ng TRONG SU·ªêT */
    .tier-table {
        width: 100%;
        margin-top: 20px;
        border-collapse: separate;
        border-spacing: 0 8px;
    }
    .tier-row {
        background: rgba(255, 255, 255, 0.4);
        border-radius: 10px;
    }
    .tier-row td { padding: 12px 10px; }
    .tier-row td:first-child { border-radius: 10px 0 0 10px; text-align: left; }
    .tier-row td:last-child { border-radius: 0 10px 10px 0; text-align: right; }

    /* Ph√¢n c·∫•p to d·∫ßn */
    .tier-1 { font-size: 13px; opacity: 0.8; }
    .tier-2 { font-size: 16px; font-weight: 600; }
    .tier-3 { font-size: 20px; font-weight: 700; color: var(--color-primary); }
    .tier-4 { font-size: 24px; font-weight: 900; color: var(--color-gold); }

    .tier-row.active-tier {
        background: rgba(255, 253, 240, 0.9) !important;
        outline: 2px solid var(--color-gold);
        transform: scale(1.02);
        box-shadow: 0 10px 20px rgba(184, 134, 11, 0.1);
    }

    /* * ----------------------------------------
     * 4. VOUCHER TRONG SU·ªêT & HI·ªÜU ·ª®NG
     * ----------------------------------------
     */
    .collapsible-header {
        background: var(--color-glass);
        backdrop-filter: blur(10px);
        padding: 15px;
        border-radius: var(--radius-md);
        box-shadow: var(--shadow);
        border: 1px solid rgba(255, 255, 255, 0.5);
        transition: var(--transition);
        margin-top: 15px;
    }

    .collapsible-header.active {
        background: var(--color-primary);
        color: white;
    }
    
    .collapsible-content {
        max-height: 0;
        overflow: hidden;
        opacity: 0;
        transform: scale(0.95);
        transition: max-height 0.5s ease, opacity 0.4s ease, transform 0.5s var(--transition);
    }

    .collapsible-header.active + .collapsible-content {
        max-height: 1200px;
        opacity: 1;
        transform: scale(1);
        padding: 20px 5px;
    }

    .voucher-card {
        background: rgba(255, 255, 255, 0.5);
        backdrop-filter: blur(5px);
        border-radius: var(--radius-md);
        padding: 12px;
        border: 1px solid rgba(255, 255, 255, 0.3);
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
        box-shadow: var(--shadow);
    }

    .voucher-card.complete {
        border: 2px solid var(--color-gold);
        background: rgba(255, 253, 245, 0.8);
    }

    .voucher-icon {
        background: rgba(93, 58, 26, 0.1);
        color: var(--color-primary);
        width: 45px; height: 45px;
        border-radius: 10px;
        display: flex; justify-content: center; align-items: center;
        font-size: 15px; font-weight: 800; margin-bottom: 8px;
    }

    .complete .voucher-icon { background: var(--color-gold); color: white; }
    
    #loyaltyPointsResult { display: none; }
  </style>
</head>
<body>

<div class="app-container">

    <div class="header-section">
        <button id="backBtn" class="btn-back" style="display: none;" onclick="resetForm()">‚Üê Quay l·∫°i</button>
        <h2>·∫®m Th·ª±c Bu√¥n M√™</h2>
        <p>M·ªói l·∫ßn gh√© Bu√¥n - Th√™m ph·∫ßn g·∫Øn b√≥</p>
    </div>

    <div id="inputContainer">
        <div class="query-box">
            <div class="input-group">
                <input type="text" id="customerPhoneInput" placeholder="S·ªë ƒëi·ªán tho·∫°i kh√°ch qu√Ω" />
                <button onclick="getLoyaltyPoints()">V√†o Bu√¥n Tra C·ª©u</button>
            </div>
        </div>
        <div id="statusMessage" class="query-box info" style="text-align: center;">
          G√µ s·ªë ƒëi·ªán tho·∫°i ƒë·ªÉ Bu√¥n M√™ ƒë√≥n ch√†o b·∫°n nh√©!
        </div>
    </div>

    <div id="loyaltyPointsResult"></div>

    <div id="voucherContainer">
        <div class="voucher-section" id="section-qua">
            <div class="collapsible-header" onclick="toggleCollapsible(this, 'section-qua')">
                <h3 style="margin:0; font-size:16px;">üéÅ Qu√† Bu√¥n L√†ng üéÅ</h3>
                <span class="arrow-icon">‚ñº</span>
            </div>
            <div class="collapsible-content">
                <div class="voucher-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                    <div class="voucher-card" id="card-100">
                        <div class="voucher-icon">50k</div>
                        <div class="voucher-details"><h4>Phi·∫øu 50k</h4><p style="font-size:11px; margin:2px 0;">Bill t·ª´ 500k</p><p class="voucher-diff-text" id="diff-100" style="font-size:10px; color:var(--color-secondary);">C·∫ßn th√™m...</p></div>
                        <div style="margin-top:8px; border-top:1px dashed #ccc; width:100%; padding-top:5px; font-weight:800;">100<small style="display:block; font-size:9px;">ƒêi·ªÉm</small></div>
                    </div>
                    <div class="voucher-card" id="card-200">
                        <div class="voucher-icon">100k</div>
                        <div class="voucher-details"><h4>Phi·∫øu 100k</h4><p style="font-size:11px; margin:2px 0;">Tr·ª±c ti·∫øp bill</p><p class="voucher-diff-text" id="diff-200" style="font-size:10px; color:var(--color-secondary);">C·∫ßn th√™m...</p></div>
                        <div style="margin-top:8px; border-top:1px dashed #ccc; width:100%; padding-top:5px; font-weight:800;">200<small style="display:block; font-size:9px;">ƒêi·ªÉm</small></div>
                    </div>
                    <div class="voucher-card" id="card-300">
                        <div class="voucher-icon">150k</div>
                        <div class="voucher-details"><h4>Phi·∫øu 150k</h4><p style="font-size:11px; margin:2px 0;">M·ªçi h√≥a ƒë∆°n</p><p class="voucher-diff-text" id="diff-300" style="font-size:10px; color:var(--color-secondary);">C·∫ßn th√™m...</p></div>
                        <div style="margin-top:8px; border-top:1px dashed #ccc; width:100%; padding-top:5px; font-weight:800;">300<small style="display:block; font-size:9px;">ƒêi·ªÉm</small></div>
                    </div>
                    <div class="voucher-card" id="card-400">
                        <div class="voucher-icon">200k</div>
                        <div class="voucher-details"><h4>Ti·ªác 200k</h4><p style="font-size:11px; margin:2px 0;">Gia ƒë√¨nh</p><p class="voucher-diff-text" id="diff-400" style="font-size:10px; color:var(--color-secondary);">C·∫ßn th√™m...</p></div>
                        <div style="margin-top:8px; border-top:1px dashed #ccc; width:100%; padding-top:5px; font-weight:800;">400<small style="display:block; font-size:9px;">ƒêi·ªÉm</small></div>
                    </div>
                    <div class="voucher-card" id="card-1000" style="grid-column: span 2;">
                        <div class="voucher-icon" style="width:100px;">Tri √Çn</div>
                        <div class="voucher-details"><h4>M√≥n Qu√† 500k</h4><p style="font-size:11px; margin:2px 0;">Kh√°ch h√†ng th√¢n thi·∫øt nh·∫•t</p><p id="diff-1000" style="font-size:10px; color:var(--color-secondary);">C·∫ßn th√™m...</p></div>
                        <div style="margin-top:8px; border-top:1px dashed #ccc; width:100%; padding-top:5px; font-weight:800;">1000<small style="display:block; font-size:9px;">ƒêi·ªÉm</small></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="voucher-section" id="section-nhom">
            <div class="collapsible-header" onclick="toggleCollapsible(this, 'section-nhom')">
                <h3 style="margin:0; font-size:16px;">üë• ∆Øu ƒê√£i ƒêi Nh√≥m üë•</h3>
                <span class="arrow-icon">‚ñº</span>
            </div>
            <div class="collapsible-content">
                <div class="voucher-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                    <div class="voucher-card">
                        <div class="voucher-icon">5%</div>
                        <div class="voucher-details"><h4>K·∫øt Th√¢n</h4><p style="font-size:11px;">Nh√≥m t·ª´ 4 ng∆∞·ªùi</p></div>
                    </div>
                    <div class="voucher-card">
                        <div class="voucher-icon">10%</div>
                        <div class="voucher-details"><h4>B·∫£n L√†ng</h4><p style="font-size:11px;">Nh√≥m t·ª´ 8 ng∆∞·ªùi</p></div>
                    </div>
                    <div class="voucher-card" style="grid-column: span 2;">
                        <div class="voucher-icon" style="width:80px;">15%</div>
                        <div class="voucher-details"><h4>ƒê·∫°i Gia ƒê√¨nh</h4><p style="font-size:11px;">Nh√≥m ƒëi tr√™n 14 ng∆∞·ªùi</p></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getDatabase, ref, get, set } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js"; 

  const firebaseConfig = {
    apiKey: "AIzaSyB8uLkLJFlzmCodcawJhs2dRckHQzO5y10",
    authDomain: "chitieu-7263e.firebaseapp.com",
    databaseURL: "https://chitieu-7263e-default-rtdb.firebaseio.com",
    projectId: "chitieu-7263e",
    storageBucket: "chitieu-7263e.firebasestorage.app",
    messagingSenderId: "83833140682",
    appId: "1:83833140682:web:f9254b418ace3a659fcb33",
    measurementId: "G-523X74K18N"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const POINTS_PER_MILLION = 100; 

  function standardizePhoneKey(phone) { return phone.replace(/[^0-9]/g, ''); }

  function toggleCollapsible(element, sectionId) {
      const isOpening = !element.classList.contains("active");
      element.classList.toggle("active");
      if (isOpening) {
          setTimeout(() => {
              const section = document.getElementById(sectionId);
              const offset = section.getBoundingClientRect().top + window.pageYOffset - (window.innerHeight / 4);
              window.scrollTo({ top: offset, behavior: 'smooth' });
          }, 300);
      }
  }

  function showResultScreen() {
      document.getElementById("inputContainer").style.display = "none";
      document.getElementById("loyaltyPointsResult").style.display = "flex";
      document.getElementById("backBtn").style.display = "block";
  }

  function resetForm() {
      document.getElementById("inputContainer").style.display = "block";
      document.getElementById("loyaltyPointsResult").style.display = "none";
      document.getElementById("backBtn").style.display = "none";
      document.getElementById("customerPhoneInput").value = "";
      document.getElementById("statusMessage").innerHTML = "G√µ s·ªë ƒëi·ªán tho·∫°i ƒë·ªÉ Bu√¥n M√™ ƒë√≥n ch√†o b·∫°n nh√©!";
      updateVoucherDifference(-9999); 
  }

  function getCustomerTier(accumulatedPoints) {
      if (accumulatedPoints >= 1000) return "Ng∆∞·ªùi Nh√† Bu√¥n";
      if (accumulatedPoints >= 500) return "Th√¢n Bu√¥n";
      if (accumulatedPoints >= 200) return "Quen Bu√¥n";
      return "Gh√© Bu√¥n";
  }

  async function updateLoyaltyDataInDB(phone, totalAmount, accumulatedPoints, redeemedPoints, currentPoints) {
    try {
        const phoneKey = standardizePhoneKey(phone);
        await set(ref(db, 'loyalty_points/' + phoneKey), {
            phone: phone, totalAmount: totalAmount,
            accumulatedPoints: accumulatedPoints, redeemedPoints: redeemedPoints,
            currentPoints: currentPoints, lastUpdated: new Date().toISOString()
        });
    } catch (error) {}
  }

  function updateVoucherDifference(currentPoints) {
        const vouchers = [{id:'diff-100',cost:100,card:'card-100'},{id:'diff-200',cost:200,card:'card-200'},{id:'diff-300',cost:300,card:'card-300'},{id:'diff-400',cost:400,card:'card-400'},{id:'diff-1000',cost:1000,card:'card-1000'}];
        vouchers.forEach(v => {
            const d = document.getElementById(v.id);
            const c = document.getElementById(v.card);
            if (d && c) {
                const diff = v.cost - currentPoints;
                if (diff <= 0) { d.innerHTML = `üåü ƒê·ªß ƒëi·ªÉm!`; c.classList.add('complete'); }
                else { d.innerHTML = `Thi·∫øu ${diff.toFixed(1).replace(/\.0$/, '')} ƒëi·ªÉm`; c.classList.remove('complete'); }
            }
        });
  }

  async function getLoyaltyPoints() {
    const phone = document.getElementById("customerPhoneInput").value.trim();
    const phoneKey = standardizePhoneKey(phone);
    const resultDiv = document.getElementById("loyaltyPointsResult");
    const statusMsg = document.getElementById("statusMessage");
    
    if (!phone) { statusMsg.innerHTML = "Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i nh√©!"; return; }
    statusMsg.innerHTML = `ƒêang t√¨m...`;

    try {
      const historySnapshot = await get(ref(db, 'payment_history'));
      let totalAmount = 0; let billFound = false; 

      historySnapshot.forEach(child => {
        const data = child.val();
        if (data.customerPhone && standardizePhoneKey(data.customerPhone) === phoneKey) {
            billFound = true; 
            const finalTotal = parseFloat(data.finalTotal);
            if (!isNaN(finalTotal) && finalTotal > 0) totalAmount += finalTotal;
        }
      });
      
      if (!billFound) { statusMsg.innerHTML = `SƒêT **${phone}** ch∆∞a c√≥ ƒëi·ªÉm.`; return; } 
      
      showResultScreen();
      const accumulatedPoints = (totalAmount / 1000000) * POINTS_PER_MILLION;
      const loyaltySnapshot = await get(ref(db, 'loyalty_points/' + phoneKey));
      let redeemedPoints = 0;
      if (loyaltySnapshot.exists()) redeemedPoints = loyaltySnapshot.val().redeemedPoints || 0;

      const currentPoints = Math.max(0, accumulatedPoints - redeemedPoints);
      const tierName = getCustomerTier(accumulatedPoints);
      
      updateVoucherDifference(currentPoints);
      await updateLoyaltyDataInDB(phone, totalAmount, accumulatedPoints, redeemedPoints, currentPoints);

      const tiers = [
          { name: "Gh√© Bu√¥n", range: "0 ‚Äì 199", cls: "tier-1" },
          { name: "Quen Bu√¥n", range: "200 ‚Äì 499", cls: "tier-2" },
          { name: "Th√¢n Bu√¥n", range: "500 ‚Äì 999", cls: "tier-3" },
          { name: "Ng∆∞·ªùi Nh√† Bu√¥n", range: "‚â• 1000", cls: "tier-4" }
      ];

      let tierTableHTML = `<table class="tier-table"><tbody>`;
      tiers.forEach(t => {
          const isActive = (tierName === t.name) ? 'active-tier' : '';
          tierTableHTML += `<tr class="tier-row ${isActive} ${t.cls}"><td>${t.name} ${isActive?'üëë':''}</td><td>${t.range}</td></tr>`;
      });
      tierTableHTML += `</tbody></table>`;

      resultDiv.innerHTML = `
        <div style="font-size:12px; font-weight:600; color:var(--color-text-light);">Th·ª© h·∫°ng c·ªßa b·∫°n</div>
        <div class="tier-badge">${tierName}</div>
        <div class="accumulated-box">
            <span style="font-size:14px; font-weight:700; color:var(--color-secondary);">T·ªîNG T√çCH L≈®Y</span>
            <div class="accumulated-points-value">${accumulatedPoints.toFixed(1).replace(/\.0$/, '')} <small style="font-size:16px;">ƒêi·ªÉm</small></div>
        </div>
        ${tierTableHTML}
        <div style="margin-top:15px; font-size:12px; color:var(--color-text-light); padding:10px; border-radius:12px; background:rgba(0,0,0,0.03);">
            ƒêi·ªÉm hi·ªán c√≥: <b>${currentPoints.toFixed(1).replace(/\.0$/, '')} ƒêi·ªÉm</b> <br>
            Chi ti√™u: ${totalAmount.toLocaleString('vi-VN')}ƒë
        </div>
      `;
      resultDiv.className = "success";

    } catch (error) { statusMsg.innerHTML = "L·ªói k·∫øt n·ªëi!"; }
  }
  
  window.getLoyaltyPoints = getLoyaltyPoints;
  window.resetForm = resetForm;
  window.toggleCollapsible = toggleCollapsible;
</script>

</body>
</html>
