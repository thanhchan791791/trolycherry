
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ch·ªânh S·ª≠a & Qu·∫£n L√Ω Th·ª±c ƒê∆°n</title>
    
    <style>
        /* ========================================= */
        /* I. FONT & BASE STYLES */
        /* ========================================= */
        :root {
            /* Light Mode Colors */
            --ios-bg-light: #F9FAFB;
            --ios-card-bg: #FFFFFF;
            --ios-text-primary: #1C1C1E;
            --ios-text-secondary: #6A6A6F;
            --ios-blue: #007AFF;
            --ios-green: #34C759; /* M√†u xanh l√° b·∫≠t */
            --ios-red: #FF3B30; 
            --ios-yellow: #FFCC00; /* M√†u v√†ng cho n√∫t s·ª≠a */
            --ios-gray-off: #78788029; /* M√†u x√°m t·∫Øt (rgba) */
            --ios-shadow-color: rgba(0, 0, 0, 0.08);
            --ios-ease: cubic-bezier(0.25, 0.1, 0.25, 1);
        }

        /* Dark Mode Colors */
        @media (prefers-color-scheme: dark) {
            :root {
                --ios-bg-light: #1C1C1E;
                --ios-card-bg: #2C2C2E;
                --ios-text-primary: #F2F2F7;
                --ios-text-secondary: #AEAEB2;
                --ios-green: #30D158;
                --ios-red: #FF453A;
                --ios-gray-off: #7878804D;
                --ios-shadow-color: rgba(0, 0, 0, 0.4);
            }
        }

        .sd-body {
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "Helvetica Neue", Roboto, sans-serif;
            margin: 0;
            padding-top: 110px;
            background-color: var(--ios-bg-light);
            color: var(--ios-text-primary);
            transition: background-color 0.3s, color 0.3s;
            scroll-behavior: smooth;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .sd-body::-webkit-scrollbar {
            display: none;
        }

        /* ========================================= */
        /* II. HEADER & SEARCH BAR */
        /* ========================================= */
        .sd-fixed-top-area {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            background-color: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            padding: 12px 12px 8px 12px;
        }
        @media (prefers-color-scheme: dark) {
            .sd-fixed-top-area {
                background-color: rgba(44, 44, 46, 0.95);
                border-bottom: 1px solid rgba(255, 255, 255, 0.08);
            }
        }
        
        .sd-header {
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 10px;
        }
        .sd-header h1 {
            font-size: 17px;
            font-weight: 700;
            color: var(--ios-blue);
            margin: 0;
            flex-grow: 1; 
            text-align: center; 
        }
        
        /* NEW: N√∫t th√™m */
        .sd-add-btn {
            background: none;
            border: none;
            color: var(--ios-blue);
            font-size: 30px;
            font-weight: 300;
            cursor: pointer;
            line-height: 1;
            padding: 0 5px;
            transition: opacity 0.2s;
        }
        .sd-add-btn:active {
            opacity: 0.7;
        }

        .sd-search-container {
            position: relative;
        }
        #search-input {
            width: 100%;
            padding: 8px 10px 8px 35px;
            border-radius: 10px;
            border: none;
            background-color: #EFEFF4;
            font-size: 16px;
            color: var(--ios-text-primary);
            transition: background-color 0.3s;
        }
        @media (prefers-color-scheme: dark) {
            #search-input {
                background-color: #3A3A3C;
                color: var(--ios-text-primary);
            }
        }
        #search-input:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.3);
        }
        .sd-search-container::before {
            content: "üîç";
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--ios-text-secondary);
            pointer-events: none;
            font-size: 14px;
        }

        /* ========================================= */
        /* III. LAYOUT & ITEM CARD */
        /* ========================================= */
        #menu-container {
            padding: 12px;
        }
        
        .sd-menu-category {
            margin-bottom: 20px;
        }

        .sd-menu-category h2 {
            font-size: 22px;
            font-weight: 700;
            color: var(--ios-text-primary);
            margin: 20px 0 10px 0;
            padding-left: 5px;
        }
        
        .sd-menu-category.sd-filtered h2 {
            display: none;
        }
        
        .sd-menu-item-card {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px;
            margin-bottom: 10px;
            
            background-color: var(--ios-card-bg);
            border-radius: 16px;
            box-shadow: 0 4px 10px var(--ios-shadow-color);
            
            cursor: default; 
            transition: all 0.25s var(--ios-ease), opacity 0.3s, transform 0.3s;
            
            opacity: 0; 
            transform: translateY(15px);
        }
        
        .sd-menu-item-card.sd-hidden {
            display: none;
        }

        .sd-item-details {
            flex-grow: 1;
            padding-right: 15px;
            user-select: none; 
        }

        .sd-item-details strong {
            font-size: 17px;
            font-weight: 600;
            color: var(--ios-text-primary);
            display: block;
            line-height: 1.3;
        }

        .sd-item-details span {
            font-size: 15px;
            color: var(--ios-text-secondary);
            display: block;
            margin-top: 2px;
        }
        
        /* ========================================= */
        /* IV. IOS TOGGLE SWITCH (N√∫t G·∫°t) */
        /* ========================================= */
        .sd-ios-switch-container {
            position: relative;
            display: inline-block;
            width: 51px;
            height: 31px;
        }

        .sd-ios-switch {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .sd-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--ios-gray-off);
            transition: background-color 0.4s var(--ios-ease);
            border-radius: 31px;
            pointer-events: all;
        }
        
        /* N√∫m g·∫°t (thumb) */
        .sd-slider:before {
            position: absolute;
            content: "";
            height: 27px;
            width: 27px;
            left: 2px;
            bottom: 2px;
            background-color: white;
            transition: transform 0.4s var(--ios-ease), box-shadow 0.4s var(--ios-ease);
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        /* B·∫¨T - M√†u xanh l√° */
        .sd-ios-switch:checked + .sd-slider {
            background-color: var(--ios-green);
        }

        /* B·∫¨T - G·∫°t thumb sang ph·∫£i */
        .sd-ios-switch:checked + .sd-slider:before {
            transform: translateX(20px);
        }
        
        /* Tr·∫°ng th√°i loading/disabled */
        .sd-ios-switch-container.sd-disabled .sd-slider {
            opacity: 0.6;
            pointer-events: none;
        }
        
        /* Hi·ªáu ·ª©ng Glow/Flash khi c·∫≠p nh·∫≠t (√Åp d·ª•ng cho container) */
        .sd-ios-switch-container.sd-glow-green {
            box-shadow: 0 0 10px var(--ios-green), 0 0 20px rgba(52, 199, 89, 0.4);
            border-radius: 31px;
        }
        .sd-ios-switch-container.sd-glow-red {
            box-shadow: 0 0 10px var(--ios-red), 0 0 20px rgba(255, 59, 48, 0.4);
            border-radius: 31px;
        }

        /* ========================================= */
        /* V. CONTROL BUTTONS (EDIT & DELETE) */
        /* ========================================= */
        .sd-item-controls { 
            display: flex;
            align-items: center;
            gap: 5px; /* Kho·∫£ng c√°ch gi·ªØa c√°c control */
        }
        
        .sd-control-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s var(--ios-ease), opacity 0.2s;
            outline: none;
            flex-shrink: 0; 
        }
        
        .sd-control-btn.sd-edit-btn {
            color: var(--ios-blue); /* M√†u xanh d∆∞∆°ng cho n√∫t s·ª≠a */
            font-size: 20px;
        }
        
        .sd-control-btn.sd-delete-btn {
            color: var(--ios-red); 
            font-size: 24px;
        }
        
        .sd-control-btn:active {
            transform: scale(0.85);
            opacity: 0.8;
        }
        
        .sd-control-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }
        
        /* ========================================= */
        /* VI. HUD NOTIFICATION & NO RESULTS */
        /* ========================================= */
        .sd-update-message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            max-width: 220px;
            min-width: 150px;
            padding: 20px 25px;
            border-radius: 18px;
            text-align: center;
            font-weight: 600;
            font-size: 16px;
            line-height: 1.3;
            z-index: 2000;
            background-color: rgba(0, 0, 0, 0.85);
            color: white;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.5);
            opacity: 0; 
            visibility: hidden;
            transition: opacity 0.3s var(--ios-ease), transform 0.3s var(--ios-ease);
        }

        .sd-update-message.sd-visible {
            opacity: 1;
            visibility: visible;
            transform: translate(-50%, -50%);
        }
        
        .sd-update-message .sd-icon {
            font-size: 36px;
            display: block;
            margin-bottom: 5px;
        }
        
        .sd-update-message strong {
            font-weight: 700;
        }
        
        .sd-no-results {
            text-align: center;
            padding: 20px;
            font-style: italic;
            color: var(--ios-text-secondary);
            display: none; 
        }

        /* ========================================= */
        /* VII. ADD/EDIT ITEM MODAL */
        /* ========================================= */
        .sd-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.4);
            z-index: 3000;
            display: none;
            justify-content: center;
            align-items: center;
        }

        .sd-modal-content {
            background-color: var(--ios-card-bg);
            padding: 25px;
            border-radius: 16px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.25);
            transform: scale(0.95);
            opacity: 0;
            transition: all 0.3s var(--ios-ease);
        }
        
        .sd-modal-overlay.sd-active .sd-modal-content {
            transform: scale(1);
            opacity: 1;
        }

        .sd-modal-content h3 {
            margin-top: 0;
            margin-bottom: 20px;
            font-size: 20px;
            font-weight: 700;
            text-align: center;
            color: var(--ios-text-primary);
        }

        .sd-modal-form label {
            display: block;
            margin-bottom: 5px;
            font-size: 15px;
            font-weight: 600;
            color: var(--ios-text-secondary);
        }

        .sd-modal-form input[type="text"], 
        .sd-modal-form input[type="number"],
        .sd-modal-form select {
            width: 100%;
            padding: 10px 12px;
            margin-bottom: 15px;
            border: 1px solid #D1D1D6;
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 16px;
            color: var(--ios-text-primary);
            background-color: var(--ios-bg-light);
            transition: border-color 0.2s;
        }
        
        .sd-modal-form input:focus,
        .sd-modal-form select:focus {
            outline: none;
            border-color: var(--ios-blue);
            box-shadow: 0 0 0 2px rgba(0, 122, 255, 0.2);
        }
        
        /* ·∫®n/Hi·ªán tr∆∞·ªùng Nh√≥m M√≥n v√† Category khi S·ª≠a */
        .sd-hidden-field {
            display: none;
        }
        #item-category-container.sd-disabled,
        #item-group-container.sd-disabled {
            opacity: 0.6;
            pointer-events: none;
        }

        .sd-modal-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }

        .sd-modal-buttons button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 10px;
            font-size: 17px;
            font-weight: 600;
            cursor: pointer;
            transition: opacity 0.2s;
            margin: 0 5px;
        }
        
        .sd-modal-buttons button:first-child {
            margin-left: 0;
        }
        .sd-modal-buttons button:last-child {
            margin-right: 0;
        }

        #add-item-submit {
            background-color: var(--ios-blue);
            color: white;
        }
        
        /* M√†u cho n√∫t C·∫≠p Nh·∫≠t khi ·ªü ch·∫ø ƒë·ªô Edit */
        .sd-edit-mode #add-item-submit {
            background-color: var(--ios-yellow);
            color: var(--ios-text-primary);
        }

        #add-item-cancel {
            background-color: #E5E5EA;
            color: var(--ios-text-primary);
        }
        
        .sd-modal-buttons button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        @media (prefers-color-scheme: dark) {
            .sd-modal-form input[type="text"], 
            .sd-modal-form input[type="number"],
            .sd-modal-form select {
                border: 1px solid #48484A;
                background-color: var(--ios-card-bg);
                color: var(--ios-text-primary);
            }
            #add-item-cancel {
                background-color: #48484A;
                color: var(--ios-text-primary);
            }
            .sd-edit-mode #add-item-submit {
                background-color: var(--ios-yellow);
                color: black;
            }
        }
    </style>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
</head>
<body class="sd-body">
    <div class="sd-fixed-top-area">
        <div class="sd-header">
            <button class="sd-add-btn" id="open-add-modal" aria-label="Th√™m m√≥n ƒÉn/ƒë·ªì u·ªëng">+</button> 
            <h1>üçΩÔ∏è Ch·ªânh S·ª≠a Th·ª±c ƒê∆°n</h1>
            <span style="width: 40px;"></span>
        </div>
        <div class="sd-search-container">
            <input type="text" id="search-input" placeholder="T√¨m ki·∫øm m√≥n ƒÉn, ƒë·ªì u·ªëng...">
        </div>
    </div>
    
    <div id="menu-container" class="sd-loading">ƒêang t·∫£i d·ªØ li·ªáu...</div>
    <div id="no-results" class="sd-no-results">Kh√¥ng t√¨m th·∫•y m√≥n ƒÉn n√†o ph√π h·ª£p.</div>
    
    <div id="update-message" class="sd-update-message"></div>
    
    <div id="add-item-modal" class="sd-modal-overlay">
        <div class="sd-modal-content">
            <h3 id="modal-title">Th√™m M√≥n M·ªõi v√†o Th·ª±c ƒê∆°n</h3>
            <form id="add-item-form" class="sd-modal-form">
                <input type="hidden" id="edit-item-key">
                <input type="hidden" id="edit-item-old-category">
                <input type="hidden" id="edit-item-old-group">
                
                <label for="item-name">T√™n M√≥n ƒÇn/ƒê·ªì U·ªëng</label>
                <input type="text" id="item-name" placeholder="V√≠ d·ª•: C√† Ph√™ S·ªØa ƒê√°" required>
                
                <div id="item-category-container">
                    <label for="item-category">Lo·∫°i (Category)</label>
                    <select id="item-category" required>
                        <option value="" disabled selected>Ch·ªçn lo·∫°i</option>
                        <option value="food">M√≥n ƒÇn</option>
                        <option value="drink">ƒê·ªì U·ªëng</option>
                    </select>
                </div>
                
                <div id="item-group-container" class="sd-hidden-field">
                    <label for="item-group">Nh√≥m M√≥n (Group)</label>
                    <select id="item-group" required>
                        <option value="" disabled selected>Vui l√≤ng ch·ªçn nh√≥m</option>
                        </select>
                </div>

                <label for="item-price">Gi√° (VNƒê)</label>
                <input type="number" id="item-price" placeholder="V√≠ d·ª•: 25000" min="1000" required>
                
                <div class="sd-modal-buttons">
                    <button type="button" id="add-item-cancel">H·ªßy</button>
                    <button type="submit" id="add-item-submit">Th√™m M√≥n</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // =========================================
        // JAVASCRIPT & FIREBASE LOGIC
        // =========================================
        
        // 1. C·∫•u h√¨nh Firebase (Thay th·∫ø b·∫±ng c·∫•u h√¨nh th·ª±c t·∫ø c·ªßa b·∫°n)
        const firebaseConfig = {
            apiKey: "AIzaSyAV7r-rjXo6U62LX1AA7c7DAHb8GhOOOsg",
            authDomain: "saigon-dalat.firebaseapp.com",
            databaseURL: "https://saigon-dalat-default-rtdb.firebaseio.com",
            projectId: "saigon-dalat",
            storageBucket: "saigon-dalat.firebasestorage.app",
            messagingSenderId: "339735183485",
            appId: "1:339735183485:web:bc23cd740104d272577114",
            measurementId: "G-FDLZXR2X8P"
        };

        const app = firebase.initializeApp(firebaseConfig);
        const database = app.database();
        const menuRef = database.ref('menu'); 
        const menuGroupsRef = database.ref('menuGroups');

        const menuContainer = document.getElementById('menu-container');
        const updateMessage = document.getElementById('update-message');
        const searchInput = document.getElementById('search-input');
        const noResultsMessage = document.getElementById('no-results');
        
        // Modal Elements
        const addItemModal = document.getElementById('add-item-modal');
        const modalTitle = document.getElementById('modal-title');
        const openAddModalBtn = document.getElementById('open-add-modal');
        const addItemCancelBtn = document.getElementById('add-item-cancel');
        const addItemForm = document.getElementById('add-item-form');
        const submitBtn = document.getElementById('add-item-submit');
        
        // Form Fields
        const itemNameInput = document.getElementById('item-name');
        const itemPriceInput = document.getElementById('item-price');
        const itemCategoryContainer = document.getElementById('item-category-container');
        const itemCategorySelect = document.getElementById('item-category');
        const itemGroupContainer = document.getElementById('item-group-container');
        const itemGroupSelect = document.getElementById('item-group');
        const editItemKeyInput = document.getElementById('edit-item-key');
        const editItemOldCategoryInput = document.getElementById('edit-item-old-category');
        const editItemOldGroupInput = document.getElementById('edit-item-old-group');

        let allMenuData = {}; 
        let allMenuGroups = {}; 
        let isEditMode = false; // Tr·∫°ng th√°i: Th√™m (false) hay S·ª≠a (true)

        // H√†m hi·ªÉn th·ªã th√¥ng b√°o HUD
        function showMessage(text, type, icon) {
            updateMessage.innerHTML = `<span class="sd-icon">${icon}</span><strong>${text}</strong>`;
            updateMessage.className = `sd-update-message sd-visible ${type}`;
            
            setTimeout(() => {
                updateMessage.classList.remove('sd-visible');
            }, 1800); 
        }
        
        function showStatusMessage(itemName, newStatus, type) {
            const statusText = newStatus === 'available' ? 'C√íN M√ìN' : 'H·∫æT M√ìN';
            const icon = newStatus === 'available' ? '‚úÖ' : '‚ùå';
            
            updateMessage.innerHTML = `<span class="sd-icon">${icon}</span><strong>${statusText}</strong><br/>${itemName}`;
            updateMessage.className = `sd-update-message sd-visible ${type}`;
            
            setTimeout(() => {
                updateMessage.classList.remove('sd-visible');
            }, 1800); 
        }

        // 2. H√†m c·∫≠p nh·∫≠t tr·∫°ng th√°i l√™n Firebase (Kh√¥ng thay ƒë·ªïi)
        function updateStatus(category, itemKey, itemName, newStatus, switchElement) {
            const updates = {};
            updates[`menu/${category}/${itemKey}/status`] = newStatus;
            
            const containerElement = switchElement.closest('.sd-ios-switch-container');
            const itemCard = switchElement.closest('.sd-menu-item-card');
            const controls = itemCard.querySelector('.sd-item-controls');

            controls.querySelectorAll('button, input').forEach(el => el.disabled = true);
            containerElement.classList.add('sd-disabled');
            
            const glowClass = newStatus === 'available' ? 'sd-glow-green' : 'sd-glow-red';
            containerElement.classList.add(glowClass);

            database.ref().update(updates)
                .then(() => {
                    showStatusMessage(itemName, newStatus, 'success'); 
                    
                    setTimeout(() => {
                        containerElement.classList.remove(glowClass);
                        controls.querySelectorAll('button, input').forEach(el => el.disabled = false);
                        containerElement.classList.remove('sd-disabled');
                        if (allMenuData[category] && allMenuData[category][itemKey]) {
                            allMenuData[category][itemKey].status = newStatus;
                        }
                    }, 50); 
                })
                .catch(error => {
                    console.error("L·ªói c·∫≠p nh·∫≠t tr·∫°ng th√°i: ", error);
                    showStatusMessage(`${itemName}<br/>L·ªói C·∫≠p Nh·∫≠t`, newStatus, 'error'); 
                    containerElement.classList.remove(glowClass);
                    switchElement.checked = newStatus !== 'available';
                    controls.querySelectorAll('button, input').forEach(el => el.disabled = false);
                    containerElement.classList.remove('sd-disabled');
                });
        }
        
        // 3. H√†m x√≥a m√≥n ƒÉn kh·ªèi Firebase
        function deleteItem(category, itemKey, itemName, itemCard) {
            if (!confirm(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën X√ìA m√≥n "${itemName}" kh·ªèi th·ª±c ƒë∆°n kh√¥ng?`)) {
                return;
            }
            
            const updates = {};
            updates[`menu/${category}/${itemKey}`] = null; 
            
            // T√¨m v√† x√≥a kh·ªèi menuGroups
            if (allMenuGroups[category]) {
                for (const groupKey in allMenuGroups[category]) {
                    if (allMenuGroups[category][groupKey] && allMenuGroups[category][groupKey][itemKey]) {
                        updates[`menuGroups/${category}/${groupKey}/${itemKey}`] = null;
                        break; 
                    }
                }
            }

            const controls = itemCard.querySelector('.sd-item-controls');
            controls.style.opacity = '0.5';
            controls.querySelectorAll('button, input').forEach(el => el.disabled = true);
            itemCard.style.cursor = 'wait';

            database.ref().update(updates)
                .then(() => {
                    showMessage(`ƒê√£ X√ìA<br/>${itemName}`, 'success', 'üóëÔ∏è'); 
                    itemCard.style.transition = 'opacity 0.3s ease, transform 0.3s ease, height 0.3s ease, margin 0.3s ease';
                    itemCard.style.opacity = '0';
                    itemCard.style.transform = 'translateY(-10px)';
                    itemCard.style.height = '0';
                    itemCard.style.marginBottom = '0';

                    setTimeout(() => {
                        itemCard.remove();
                        if (allMenuData[category] && allMenuData[category][itemKey]) {
                            delete allMenuData[category][itemKey];
                            filterItems(); 
                        }
                    }, 350); 
                })
                .catch(error => {
                    console.error("L·ªói x√≥a m√≥n ƒÉn: ", error);
                    showMessage(`L·ªói X√ìA<br/>${itemName}`, 'error', '‚ö†Ô∏è');
                    controls.style.opacity = '1';
                    controls.querySelectorAll('button, input').forEach(el => el.disabled = false);
                    itemCard.style.cursor = 'default';
                });
        }

        // 4. H√†m t·∫°o HTML cho m√≥n ƒÉn (C·∫≠p nh·∫≠t th√™m n√∫t Edit)
        function createMenuItemHTML(category, key, item) {
            const isAvailable = item.status === 'available';
            
            const itemDiv = document.createElement('div');
            itemDiv.className = 'sd-menu-item-card';
            itemDiv.setAttribute('data-key', key); 
            itemDiv.setAttribute('data-category', category); // Th√™m category
            itemDiv.setAttribute('data-name', item.name.toLowerCase()); 

            itemDiv.innerHTML = `
                <div class="sd-item-details">
                    <strong>${item.name}</strong> 
                    <span>${item.price.toLocaleString('vi-VN')} VNƒê</span>
                </div>
                <div class="sd-item-controls">
                    <button class="sd-control-btn sd-edit-btn" aria-label="S·ª≠a m√≥n ƒÉn">‚úèÔ∏è</button>
                    <div class="sd-ios-switch-container">
                        <input type="checkbox" id="switch-${key}" class="sd-ios-switch" ${isAvailable ? 'checked' : ''}>
                        <label for="switch-${key}" class="sd-slider"></label>
                    </div>
                    <button class="sd-control-btn sd-delete-btn" aria-label="X√≥a m√≥n ƒÉn">üóëÔ∏è</button>
                </div>
            `;

            const switchElement = itemDiv.querySelector(`#switch-${key}`);
            switchElement.addEventListener('change', (event) => {
                const isChecked = event.target.checked;
                const newStatus = isChecked ? 'available' : 'sold-out';
                const itemName = allMenuData[category][key].name;
                updateStatus(category, key, itemName, newStatus, switchElement);
            });
            
            const editButton = itemDiv.querySelector('.sd-edit-btn');
            editButton.addEventListener('click', (event) => {
                event.stopPropagation(); 
                openEditModal(category, key);
            });
            
            const deleteButton = itemDiv.querySelector('.sd-delete-btn');
            deleteButton.addEventListener('click', (event) => {
                event.stopPropagation(); 
                const itemName = allMenuData[category][key].name;
                deleteItem(category, key, itemName, itemDiv);
            });

            return itemDiv;
        }
        
        // ... (renderMenu v√† filterItems gi·ªØ nguy√™n) ...

        function renderMenu(menuData) {
            menuContainer.innerHTML = ''; 
            const itemCards = [];

            for (const category in menuData) {
                if (menuData.hasOwnProperty(category)) {
                    const categoryData = menuData[category];
                    const categoryName = category === 'food' ? 'M√≥n ƒÇn üçΩÔ∏è' : 'ƒê·ªì U·ªëng üçπ';
                    
                    const categoryDiv = document.createElement('div');
                    categoryDiv.className = 'sd-menu-category';
                    categoryDiv.id = `category-${category}`;
                    categoryDiv.innerHTML = `<h2>${categoryName}</h2>`;

                    let categoryHasItems = false;
                    for (const itemKey in categoryData) {
                        if (categoryData.hasOwnProperty(itemKey)) {
                            categoryHasItems = true;
                            const item = categoryData[itemKey];
                            const itemHTML = createMenuItemHTML(category, itemKey, item);
                            categoryDiv.appendChild(itemHTML);
                            itemCards.push(itemHTML); 
                        }
                    }
                    
                    if (categoryHasItems) {
                        menuContainer.appendChild(categoryDiv);
                    }
                }
            }
            
            itemCards.forEach((card, index) => {
                setTimeout(() => {
                    card.style.opacity = 1;
                    card.style.transform = 'translateY(0)';
                }, index * 50); 
            });
            
            filterItems();
        }

        function filterItems() {
            const query = searchInput.value.toLowerCase().trim();
            const categories = document.querySelectorAll('.sd-menu-category');
            
            let visibleCount = 0;

            categories.forEach(categoryDiv => {
                let categoryVisibleCount = 0;
                const items = categoryDiv.querySelectorAll('.sd-menu-item-card');
                
                let categoryHasItems = items.length > 0;

                items.forEach(card => {
                    const itemName = card.getAttribute('data-name');
                    
                    if (itemName.includes(query) || query === '') {
                        card.classList.remove('sd-hidden');
                        card.style.display = 'flex'; 
                        categoryVisibleCount++;
                        visibleCount++;
                    } else {
                        card.classList.add('sd-hidden');
                        card.style.display = 'none'; 
                    }
                });
                
                if (categoryVisibleCount === 0 && categoryHasItems) {
                     categoryDiv.classList.add('sd-filtered');
                } else {
                     categoryDiv.classList.remove('sd-filtered');
                }
            });

            if (visibleCount === 0 && query !== '') {
                noResultsMessage.style.display = 'block';
            } else {
                noResultsMessage.style.display = 'none';
            }
        }
        
        searchInput.addEventListener('input', filterItems);


        // 5. ƒê·ªçc d·ªØ li·ªáu t·ª´ Firebase Realtime Database
        menuRef.on('value', (snapshot) => {
            const menuData = snapshot.val();
            if (menuData) {
                allMenuData = menuData;
                renderMenu(menuData);
                menuContainer.classList.remove('sd-loading');
            } else {
                menuContainer.innerHTML = '<p class="sd-loading" style="color:var(--ios-text-secondary);">Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu th·ª±c ƒë∆°n.</p>';
            }
        }, (error) => {
            console.error("L·ªói ƒë·ªçc d·ªØ li·ªáu menu: ", error);
            menuContainer.innerHTML = `<p class="sd-loading sd-error">‚ùå L·ªói: Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu th·ª±c ƒë∆°n.</p>`;
        });
        
        menuGroupsRef.on('value', (snapshot) => {
            const groupsData = snapshot.val();
            if (groupsData) {
                allMenuGroups = groupsData;
            } else {
                allMenuGroups = {};
                console.warn("Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu nh√≥m m√≥n.");
            }
        }, (error) => {
            console.error("L·ªói ƒë·ªçc d·ªØ li·ªáu nh√≥m m√≥n: ", error);
        });


        /* ========================================= */
        /* 6. LOGIC TH√äM/S·ª¨A M√ìN M·ªöI */
        /* ========================================= */

        // H√†m chuy·ªÉn key nh√≥m th√†nh d·∫°ng d·ªÖ ƒë·ªçc
        function formatGroupKey(key) {
            // Ch·ªâ l√† v√≠ d·ª•, b·∫°n c√≥ th·ªÉ t·∫°o m·ªôt ƒë·ªëi t∆∞·ª£ng map n·∫øu c√≥ nhi·ªÅu nh√≥m
            if (key === 'monLau') return 'M√≥n L·∫©u';
            if (key === 'monChinh') return 'M√≥n Ch√≠nh';
            if (key === 'nuocEp') return 'N∆∞·ªõc √âp';
            if (key === 'coCon') return 'C√≥ C·ªìn';
            if (key === 'giaiKhat') return 'Gi·∫£i Kh√°t';
            if (key === 'monRau') return 'M√≥n Rau';
            return key.charAt(0).toUpperCase() + key.slice(1);
        }
        
        // H√†m t√¨m key nh√≥m hi·ªán t·∫°i c·ªßa m√≥n ƒÉn
        function findItemGroupKey(category, itemKey) {
            if (allMenuGroups[category]) {
                for (const groupKey in allMenuGroups[category]) {
                    if (allMenuGroups[category][groupKey] && allMenuGroups[category][groupKey][itemKey]) {
                        return groupKey;
                    }
                }
            }
            return null;
        }

        // H√†m ƒëi·ªÅn c√°c nh√≥m m√≥n v√†o √¥ select d·ª±a tr√™n category
        function populateGroupOptions(category, selectedGroupKey = null) {
            itemGroupSelect.innerHTML = '<option value="" disabled selected>Vui l√≤ng ch·ªçn nh√≥m</option>';
            
            const groups = allMenuGroups[category];
            if (groups) {
                for (const key in groups) {
                    const option = document.createElement('option');
                    option.value = key;
                    option.textContent = formatGroupKey(key); 
                    if (key === selectedGroupKey) {
                        option.selected = true;
                    }
                    itemGroupSelect.appendChild(option);
                }
                itemGroupContainer.classList.remove('sd-hidden-field');
                itemGroupSelect.required = true;
            } else {
                itemGroupContainer.classList.add('sd-hidden-field');
                itemGroupSelect.required = false;
            }
        }

        // S·ª± ki·ªán thay ƒë·ªïi Category
        itemCategorySelect.addEventListener('change', (event) => {
            const category = event.target.value;
            populateGroupOptions(category);
        });

        // H√†m m·ªü Modal ·ªü ch·∫ø ƒë·ªô Th√™m
        openAddModalBtn.addEventListener('click', () => {
            isEditMode = false;
            addItemForm.reset(); 
            modalTitle.textContent = 'Th√™m M√≥n M·ªõi v√†o Th·ª±c ƒê∆°n';
            submitBtn.textContent = 'Th√™m M√≥n';
            addItemForm.classList.remove('sd-edit-mode');
            
            // B·∫≠t l·∫°i c√°c tr∆∞·ªùng
            itemCategoryContainer.classList.remove('sd-disabled');
            itemGroupContainer.classList.add('sd-hidden-field');
            itemGroupSelect.required = false;

            addItemModal.style.display = 'flex';
            setTimeout(() => {
                addItemModal.classList.add('sd-active');
            }, 10);
        });

        // H√†m m·ªü Modal ·ªü ch·∫ø ƒë·ªô S·ª≠a
        function openEditModal(category, itemKey) {
            isEditMode = true;
            addItemForm.reset(); 
            modalTitle.textContent = 'S·ª≠a Th√¥ng Tin M√≥n ƒÇn';
            submitBtn.textContent = 'C·∫≠p Nh·∫≠t';
            addItemForm.classList.add('sd-edit-mode');
            
            const item = allMenuData[category][itemKey];
            const currentGroupKey = findItemGroupKey(category, itemKey);
            
            // ƒêi·ªÅn d·ªØ li·ªáu v√†o c√°c tr∆∞·ªùng ·∫©n
            editItemKeyInput.value = itemKey;
            editItemOldCategoryInput.value = category;
            editItemOldGroupInput.value = currentGroupKey || '';

            // ƒêi·ªÅn d·ªØ li·ªáu v√†o form
            itemNameInput.value = item.name;
            itemPriceInput.value = item.price;
            
            // Ch·ªçn Category (Disabled)
            itemCategorySelect.value = category;
            itemCategoryContainer.classList.add('sd-disabled');

            // Ch·ªçn Group
            populateGroupOptions(category, currentGroupKey);
            itemGroupContainer.classList.remove('sd-disabled');

            addItemModal.style.display = 'flex';
            setTimeout(() => {
                addItemModal.classList.add('sd-active');
            }, 10);
        }

        // H√†m ƒë√≥ng Modal
        function hideModal() {
            addItemModal.classList.remove('sd-active');
            setTimeout(() => {
                addItemModal.style.display = 'none';
            }, 300);
        }
        
        addItemCancelBtn.addEventListener('click', hideModal);

        // ƒê√≥ng Modal khi click ra ngo√†i
        addItemModal.addEventListener('click', (event) => {
            if (event.target === addItemModal) {
                hideModal();
            }
        });
        
        // H√ÄM CH√çNH: C·∫¨P NH·∫¨T M√ìN (D√πng cho c·∫£ Th√™m v√† S·ª≠a)

        // H√†m th√™m m√≥n m·ªõi
        function addNewItem(name, category, groupKey, price) {
            submitBtn.disabled = true;
            
            const newItem = {
                name: name.trim(),
                price: parseInt(price),
                status: 'available',
                // T√πy ch·ªçn: imageUrl: 'img2/default.webp', description: 'M√≥n m·ªõi'
            };
            
            // 1. ƒê·∫©y m√≥n m·ªõi v√†o /menu/[category] (ph·∫ßn ch√≠nh)
            const newRef = menuRef.child(category).push(newItem);
            const itemKey = newRef.key;
            
            // 2. C·∫≠p nh·∫≠t ƒë·ªìng th·ªùi v√†o /menuGroups/[category]/[groupKey]
            const updates = {};
            updates[`menuGroups/${category}/${groupKey}/${itemKey}`] = {
                name: newItem.name,
                price: newItem.price
            };

            database.ref().update(updates)
            .then(() => {
                showMessage(`ƒê√£ Th√™m M√≥n<br/>${name}`, 'success', '‚ú®');
                hideModal();
                // Reset form state
                itemGroupContainer.classList.add('sd-hidden-field');
            })
            .catch(error => {
                console.error("L·ªói khi th√™m m√≥n m·ªõi: ", error);
                showMessage(`L·ªói Th√™m M√≥n<br/>${name}`, 'error', '‚ö†Ô∏è');
            })
            .finally(() => {
                 submitBtn.disabled = false;
                 addItemForm.reset(); 
            });
        }
        
        // H√ÄM M·ªöI: C·∫≠p nh·∫≠t th√¥ng tin m√≥n ƒÉn
        function updateItem(itemKey, oldCategory, oldGroupKey, newName, newPrice, newGroupKey) {
            submitBtn.disabled = true;
            
            const updates = {};
            
            const newPriceInt = parseInt(newPrice);
            
            // 1. C·∫≠p nh·∫≠t trong /menu (Ch·ªâ c·∫ßn c·∫≠p nh·∫≠t name v√† price)
            updates[`menu/${oldCategory}/${itemKey}/name`] = newName.trim();
            updates[`menu/${oldCategory}/${itemKey}/price`] = newPriceInt;
            
            // 2. C·∫≠p nh·∫≠t/Di chuy·ªÉn trong /menuGroups
            
            // N·∫øu nh√≥m c≈© kh√°c nh√≥m m·ªõi (c·∫ßn di chuy·ªÉn)
            if (oldGroupKey !== newGroupKey) {
                // X√≥a kh·ªèi nh√≥m c≈©
                if (oldGroupKey) {
                    updates[`menuGroups/${oldCategory}/${oldGroupKey}/${itemKey}`] = null;
                }
                
                // Th√™m v√†o nh√≥m m·ªõi
                updates[`menuGroups/${oldCategory}/${newGroupKey}/${itemKey}`] = {
                    name: newName.trim(),
                    price: newPriceInt
                };
            } else {
                // Ch·ªâ c·∫≠p nh·∫≠t name v√† price trong nh√≥m c≈©
                updates[`menuGroups/${oldCategory}/${oldGroupKey}/${itemKey}/name`] = newName.trim();
                updates[`menuGroups/${oldCategory}/${oldGroupKey}/${itemKey}/price`] = newPriceInt;
            }

            database.ref().update(updates)
                .then(() => {
                    showMessage(`ƒê√£ C·∫≠p Nh·∫≠t<br/>${newName}`, 'success', '‚úÖ');
                    hideModal();
                })
                .catch(error => {
                    console.error("L·ªói khi c·∫≠p nh·∫≠t m√≥n: ", error);
                    showMessage(`L·ªói C·∫≠p Nh·∫≠t<br/>${newName}`, 'error', '‚ö†Ô∏è');
                })
                .finally(() => {
                     submitBtn.disabled = false;
                });
        }

        // X·ª≠ l√Ω Submit Form (D√πng chung cho c·∫£ Th√™m v√† S·ª≠a)
        addItemForm.addEventListener('submit', (event) => {
            event.preventDefault();
            
            const name = itemNameInput.value;
            const price = itemPriceInput.value;
            const category = itemCategorySelect.value;
            const groupKey = itemGroupSelect.value;
            
            if (!name || !price || !category) {
                alert("Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß T√™n M√≥n, Gi√° v√† Lo·∫°i.");
                return;
            }
            
            // Ki·ªÉm tra Group Key c√≥ ƒë∆∞·ª£c ch·ªçn kh√¥ng n·∫øu container hi·ªÉn th·ªã
            if (!itemGroupContainer.classList.contains('sd-hidden-field') && !groupKey) {
                alert("Vui l√≤ng ch·ªçn Nh√≥m M√≥n.");
                return;
            }

            if (isEditMode) {
                const itemKey = editItemKeyInput.value;
                const oldCategory = editItemOldCategoryInput.value;
                const oldGroupKey = editItemOldGroupInput.value;
                
                updateItem(itemKey, oldCategory, oldGroupKey, name, price, groupKey);
                
            } else {
                // Ch·∫ø ƒë·ªô Th√™m M·ªõi
                addNewItem(name, category, groupKey, price);
            }
        });

    </script>
</body>
</html>
