<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ch·ªânh S·ª≠a Tr·∫°ng Th√°i Th·ª±c ƒê∆°n - iOS Switch (SD)</title>
    
    <style>
        /* ========================================= */
        /* I. FONT & BASE STYLES */
        /* ========================================= */
        :root {
            /* Light Mode Colors */
            --ios-bg-light: #F9FAFB;
            --ios-card-bg: #FFFFFF;
            --ios-text-primary: #1C1C1E;
            --ios-text-secondary: #6A6A6F;
            --ios-blue: #007AFF;
            --ios-green: #34C759; /* M√†u xanh l√° b·∫≠t */
            --ios-red: #FF3B30; 
            --ios-gray-off: #78788029; /* M√†u x√°m t·∫Øt (rgba) */
            --ios-shadow-color: rgba(0, 0, 0, 0.08);
            --ios-ease: cubic-bezier(0.25, 0.1, 0.25, 1);
        }

        /* Dark Mode Colors */
        @media (prefers-color-scheme: dark) {
            :root {
                --ios-bg-light: #1C1C1E;
                --ios-card-bg: #2C2C2E;
                --ios-text-primary: #F2F2F7;
                --ios-text-secondary: #AEAEB2;
                --ios-green: #30D158;
                --ios-red: #FF453A;
                --ios-gray-off: #7878804D;
                --ios-shadow-color: rgba(0, 0, 0, 0.4);
            }
        }

        .sd-body { /* ƒê·ªïi: body -> .sd-body */
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "Helvetica Neue", Roboto, sans-serif;
            margin: 0;
            padding-top: 110px;
            background-color: var(--ios-bg-light);
            color: var(--ios-text-primary);
            transition: background-color 0.3s, color 0.3s;
            scroll-behavior: smooth;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .sd-body::-webkit-scrollbar {
            display: none;
        }

        /* ========================================= */
        /* II. HEADER & SEARCH BAR */
        /* ========================================= */
        .sd-fixed-top-area { /* ƒê·ªïi: .fixed-top-area -> .sd-fixed-top-area */
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            background-color: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            padding: 12px 12px 8px 12px;
        }
        @media (prefers-color-scheme: dark) {
            .sd-fixed-top-area {
                background-color: rgba(44, 44, 46, 0.95);
                border-bottom: 1px solid rgba(255, 255, 255, 0.08);
            }
        }
        
        .sd-header { /* ƒê·ªïi: .header -> .sd-header */
            text-align: center;
            margin-bottom: 10px;
        }
        .sd-header h1 {
            font-size: 17px;
            font-weight: 700;
            color: var(--ios-blue);
            margin: 0;
        }

        .sd-search-container { /* ƒê·ªïi: .search-container -> .sd-search-container */
            position: relative;
        }
        #search-input {
            width: 100%;
            padding: 8px 10px 8px 35px;
            border-radius: 10px;
            border: none;
            background-color: #EFEFF4;
            font-size: 16px;
            color: var(--ios-text-primary);
            transition: background-color 0.3s;
        }
        @media (prefers-color-scheme: dark) {
            #search-input {
                background-color: #3A3A3C;
                color: var(--ios-text-primary);
            }
        }
        #search-input:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.3);
        }
        .sd-search-container::before {
            content: "üîç";
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--ios-text-secondary);
            pointer-events: none;
            font-size: 14px;
        }

        /* ========================================= */
        /* III. LAYOUT & ITEM CARD */
        /* ========================================= */
        #menu-container {
            padding: 12px;
        }
        
        .sd-menu-category { /* ƒê·ªïi: .menu-category -> .sd-menu-category */
            margin-bottom: 20px;
        }

        .sd-menu-category h2 {
            font-size: 22px;
            font-weight: 700;
            color: var(--ios-text-primary);
            margin: 20px 0 10px 0;
            padding-left: 5px;
        }
        
        .sd-menu-category.sd-filtered h2 { /* ƒê·ªïi: .filtered -> .sd-filtered */
            display: none;
        }
        
        .sd-menu-item-card { /* ƒê·ªïi: .menu-item-card -> .sd-menu-item-card */
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px;
            margin-bottom: 10px;
            
            background-color: var(--ios-card-bg);
            border-radius: 16px;
            box-shadow: 0 4px 10px var(--ios-shadow-color);
            
            cursor: pointer;
            transition: all 0.25s var(--ios-ease), opacity 0.3s, transform 0.3s;
            
            opacity: 0; 
            transform: translateY(15px);
        }
        
        .sd-menu-item-card:active {
            transform: scale(0.98); 
            box-shadow: 0 2px 6px var(--ios-shadow-color);
        }
        
        .sd-menu-item-card.sd-hidden { /* ƒê·ªïi: .hidden -> .sd-hidden */
            display: none;
        }

        .sd-item-details { /* ƒê·ªïi: .item-details -> .sd-item-details */
            flex-grow: 1;
            padding-right: 15px;
        }

        .sd-item-details strong {
            font-size: 17px;
            font-weight: 600;
            color: var(--ios-text-primary);
            display: block;
            line-height: 1.3;
        }

        .sd-item-details span {
            font-size: 15px;
            color: var(--ios-text-secondary);
            display: block;
            margin-top: 2px;
        }
        
        /* ========================================= */
        /* IV. IOS TOGGLE SWITCH (N√∫t G·∫°t) */
        /* ========================================= */
        .sd-ios-switch-container { /* ƒê·ªïi: .ios-switch-container -> .sd-ios-switch-container */
            position: relative;
            display: inline-block;
            width: 51px; /* Chi·ªÅu r·ªông chu·∫©n iOS */
            height: 31px; /* Chi·ªÅu cao chu·∫©n iOS */
        }

        .sd-ios-switch { /* ƒê·ªïi: .ios-switch -> .sd-ios-switch */
            opacity: 0;
            width: 0;
            height: 0;
        }

        .sd-slider { /* ƒê·ªïi: .slider -> .sd-slider */
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--ios-gray-off); /* M√†u n·ªÅn x√°m khi T·∫ÆT */
            transition: background-color 0.4s var(--ios-ease); /* Transition m∆∞·ª£t */
            border-radius: 31px; /* Bo tr√≤n */
            pointer-events: all; /* Cho ph√©p t∆∞∆°ng t√°c */
        }
        
        /* N√∫m g·∫°t (thumb) */
        .sd-slider:before {
            position: absolute;
            content: "";
            height: 27px; /* K√≠ch th∆∞·ªõc thumb */
            width: 27px;
            left: 2px;
            bottom: 2px;
            background-color: white;
            transition: transform 0.4s var(--ios-ease), box-shadow 0.4s var(--ios-ease);
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2); /* Shadow nh·∫π cho thumb */
        }

        /* B·∫¨T - M√†u xanh l√° */
        .sd-ios-switch:checked + .sd-slider {
            background-color: var(--ios-green);
        }

        /* B·∫¨T - G·∫°t thumb sang ph·∫£i */
        .sd-ios-switch:checked + .sd-slider:before {
            transform: translateX(20px);
        }
        
        /* Tr·∫°ng th√°i loading/disabled */
        .sd-ios-switch-container.sd-disabled .sd-slider { /* ƒê·ªïi: .disabled -> .sd-disabled */
            opacity: 0.6;
            pointer-events: none;
        }
        
        /* Hi·ªáu ·ª©ng Glow/Flash khi c·∫≠p nh·∫≠t (√Åp d·ª•ng cho container) */
        .sd-ios-switch-container.sd-glow-green { /* ƒê·ªïi: .glow-green -> .sd-glow-green */
            box-shadow: 0 0 10px var(--ios-green), 0 0 20px rgba(52, 199, 89, 0.4);
            border-radius: 31px;
        }
        .sd-ios-switch-container.sd-glow-red { /* ƒê·ªïi: .glow-red -> .sd-glow-red */
            box-shadow: 0 0 10px var(--ios-red), 0 0 20px rgba(255, 59, 48, 0.4);
            border-radius: 31px;
        }

        /* ========================================= */
        /* V. HUD NOTIFICATION */
        /* ========================================= */
        .sd-update-message { /* ƒê·ªïi: .update-message -> .sd-update-message */
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            max-width: 220px;
            min-width: 150px;
            padding: 20px 25px;
            border-radius: 18px;
            text-align: center;
            font-weight: 600;
            font-size: 16px;
            line-height: 1.3;
            z-index: 2000;
            background-color: rgba(0, 0, 0, 0.85);
            color: white;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.5);
            opacity: 0; 
            visibility: hidden;
            transition: opacity 0.3s var(--ios-ease), transform 0.3s var(--ios-ease);
        }

        .sd-update-message.sd-visible { /* ƒê·ªïi: .visible -> .sd-visible */
            opacity: 1;
            visibility: visible;
            transform: translate(-50%, -50%);
        }
        
        .sd-update-message .sd-icon { /* ƒê·ªïi: .icon -> .sd-icon */
            font-size: 36px;
            display: block;
            margin-bottom: 5px;
        }
        
        .sd-update-message strong {
            font-weight: 700;
        }
        
        .sd-no-results { /* ƒê·ªïi: .no-results -> .sd-no-results */
            text-align: center;
            padding: 20px;
            font-style: italic;
            color: var(--ios-text-secondary);
            display: none; 
        }
    </style>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
</head>
<body class="sd-body"> <div class="sd-fixed-top-area">
        <div class="sd-header">
            <h1>üçΩÔ∏è Ch·ªânh S·ª≠a Th·ª±c ƒê∆°n</h1>
        </div>
        <div class="sd-search-container">
            <input type="text" id="search-input" placeholder="T√¨m ki·∫øm m√≥n ƒÉn, ƒë·ªì u·ªëng...">
        </div>
    </div>
    
    <div id="menu-container" class="sd-loading">ƒêang t·∫£i d·ªØ li·ªáu...</div> <div id="no-results" class="sd-no-results">Kh√¥ng t√¨m th·∫•y m√≥n ƒÉn n√†o ph√π h·ª£p.</div>
    
    <div id="update-message" class="sd-update-message"></div>

    <script>
        // =========================================
        // JAVASCRIPT & FIREBASE LOGIC
        // =========================================
        
        // 1. C·∫•u h√¨nh Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyAV7r-rjXo6U62LX1AA7c7DAHb8GhOOOsg",
            authDomain: "saigon-dalat.firebaseapp.com",
            databaseURL: "https://saigon-dalat-default-rtdb.firebaseio.com",
            projectId: "saigon-dalat",
            storageBucket: "saigon-dalat.firebasestorage.app",
            messagingSenderId: "339735183485",
            appId: "1:339735183485:web:bc23cd740104d272577114",
            measurementId: "G-FDLZXR2X8P"
        };

        const app = firebase.initializeApp(firebaseConfig);
        const database = app.database();
        const menuRef = database.ref('menu'); 

        const menuContainer = document.getElementById('menu-container');
        const updateMessage = document.getElementById('update-message');
        const searchInput = document.getElementById('search-input');
        const noResultsMessage = document.getElementById('no-results');
        
        let allMenuData = {}; 

        // H√†m hi·ªÉn th·ªã th√¥ng b√°o HUD
        function showMessage(itemName, newStatus, type) {
            const statusText = newStatus === 'available' ? 'C√íN M√ìN' : 'H·∫æT M√ìN';
            const icon = newStatus === 'available' ? '‚úÖ' : '‚ùå';
            
            updateMessage.innerHTML = `<span class="sd-icon">${icon}</span><strong>${statusText}</strong><br/>${itemName}`; // ƒê·ªïi class: .icon -> .sd-icon
            updateMessage.className = `sd-update-message sd-visible ${type}`; // ƒê·ªïi class: .update-message, .visible -> .sd-update-message, .sd-visible
            
            setTimeout(() => {
                updateMessage.classList.remove('sd-visible');
            }, 1800); 
        }

        // 2. H√†m c·∫≠p nh·∫≠t tr·∫°ng th√°i l√™n Firebase
        function updateStatus(category, itemKey, itemName, newStatus, switchElement) {
            const path = `${category}/${itemKey}/status`;
            const containerElement = switchElement.closest('.sd-ios-switch-container'); // ƒê·ªïi class

            // ‚ùå NGƒÇN CH·∫∂N NH·∫§N L·∫∂P L·∫†I: V√¥ hi·ªáu h√≥a switch ngay l·∫≠p t·ª©c
            containerElement.classList.add('sd-disabled'); // ƒê·ªïi class
            
            // Th√™m hi·ªáu ·ª©ng flash glow
            const glowClass = newStatus === 'available' ? 'sd-glow-green' : 'sd-glow-red'; // ƒê·ªïi class
            containerElement.classList.add(glowClass);

            menuRef.child(path).set(newStatus)
                .then(() => {
                    console.log(`C·∫≠p nh·∫≠t th√†nh c√¥ng: ${itemName} -> ${newStatus}`);
                    showMessage(itemName, newStatus, 'success'); 
                    
                    // C·∫≠p nh·∫≠t giao di·ªán sau khi Firebase th√†nh c√¥ng
                    setTimeout(() => {
                        containerElement.classList.remove(glowClass);
                        
                        // ‚úÖ K√çCH HO·∫†T L·∫†I N√öT
                        containerElement.classList.remove('sd-disabled'); // ƒê·ªïi class

                        // C·∫≠p nh·∫≠t tr·∫°ng th√°i trong d·ªØ li·ªáu local
                        if (allMenuData[category] && allMenuData[category][itemKey]) {
                            allMenuData[category][itemKey].status = newStatus;
                        }
                    }, 50); 
                })
                .catch(error => {
                    console.error("L·ªói c·∫≠p nh·∫≠t tr·∫°ng th√°i: ", error);
                    showMessage(itemName, newStatus, 'error'); 
                    containerElement.classList.remove(glowClass);
                    
                    // X·ª≠ l√Ω khi l·ªói: ƒê∆∞a switch tr·ªü l·∫°i tr·∫°ng th√°i c≈©
                    switchElement.checked = newStatus !== 'available'; // New status l√† 'available', th√¨ checked = false
                    
                    // ‚úÖ K√çCH HO·∫†T L·∫†I N√öT
                    containerElement.classList.remove('sd-disabled'); // ƒê·ªïi class
                });
        }

        // 3. H√†m t·∫°o HTML cho m·ªôt m·ª•c menu (S·ª≠ d·ª•ng iOS Switch)
        function createMenuItemHTML(category, key, item) {
            const isAvailable = item.status === 'available';
            
            const itemDiv = document.createElement('div');
            itemDiv.className = 'sd-menu-item-card'; // ƒê·ªïi class
            itemDiv.setAttribute('data-key', key); 
            itemDiv.setAttribute('data-name', item.name.toLowerCase()); 

            itemDiv.innerHTML = `
                <div class="sd-item-details">
                    <strong>${item.name}</strong> 
                    <span>${item.price.toLocaleString('vi-VN')} VNƒê</span>
                </div>
                <div class="sd-ios-switch-container">
                    <input type="checkbox" id="switch-${key}" class="sd-ios-switch" ${isAvailable ? 'checked' : ''}>
                    <label for="switch-${key}" class="sd-slider"></label>
                </div>
            `; // ƒê·ªïi class

            // T∆∞∆°ng t√°c khi g·∫°t switch
            const switchElement = itemDiv.querySelector(`#switch-${key}`);
            switchElement.addEventListener('change', (event) => {
                const isChecked = event.target.checked;
                const newStatus = isChecked ? 'available' : 'sold-out';
                
                // Tr·∫°ng th√°i hi·ªán t·∫°i (tr∆∞·ªõc khi g·∫°t) ƒë∆∞·ª£c l·∫•y t·ª´ d·ªØ li·ªáu local ƒë·ªÉ x·ª≠ l√Ω l·ªói
                const currentStatus = allMenuData[category][key].status;
                const itemName = allMenuData[category][key].name;

                // C·∫≠p nh·∫≠t l√™n Firebase
                updateStatus(category, key, itemName, newStatus, switchElement);
            });

            return itemDiv;
        }

        // 4. H√†m hi·ªÉn th·ªã to√†n b·ªô menu (Stagger Animation)
        function renderMenu(menuData) {
            menuContainer.innerHTML = ''; 
            const itemCards = [];

            for (const category in menuData) {
                if (menuData.hasOwnProperty(category)) {
                    const categoryData = menuData[category];
                    const categoryName = category === 'food' ? 'M√≥n ƒÇn üçΩÔ∏è' : 'ƒê·ªì U·ªëng üçπ';
                    
                    const categoryDiv = document.createElement('div');
                    categoryDiv.className = 'sd-menu-category'; // ƒê·ªïi class
                    categoryDiv.id = `category-${category}`;
                    categoryDiv.innerHTML = `<h2>${categoryName}</h2>`;

                    for (const itemKey in categoryData) {
                        if (categoryData.hasOwnProperty(itemKey)) {
                            const item = categoryData[itemKey];
                            const itemHTML = createMenuItemHTML(category, itemKey, item);
                            categoryDiv.appendChild(itemHTML);
                            itemCards.push(itemHTML); 
                        }
                    }

                    menuContainer.appendChild(categoryDiv);
                }
            }
            
            // Stagger Animation (Fade-in t·ª´ d∆∞·ªõi l√™n)
            itemCards.forEach((card, index) => {
                setTimeout(() => {
                    card.style.opacity = 1;
                    card.style.transform = 'translateY(0)';
                }, index * 50); 
            });
            
            filterItems();
        }
        
        // 5. H√†m l·ªçc m√≥n ƒÉn theo t·ª´ kh√≥a (REAL-TIME FILTER)
        function filterItems() {
            const query = searchInput.value.toLowerCase().trim();
            const categories = document.querySelectorAll('.sd-menu-category'); // ƒê·ªïi class
            
            let visibleCount = 0;

            categories.forEach(categoryDiv => {
                let categoryVisibleCount = 0;
                categoryDiv.classList.remove('sd-filtered'); // ƒê·ªïi class
                
                const items = categoryDiv.querySelectorAll('.sd-menu-item-card'); // ƒê·ªïi class
                items.forEach(card => {
                    const itemName = card.getAttribute('data-name');
                    
                    if (itemName.includes(query) || query === '') {
                        card.classList.remove('sd-hidden'); // ƒê·ªïi class
                        card.style.display = 'flex'; 
                        categoryVisibleCount++;
                        visibleCount++;
                    } else {
                        card.classList.add('sd-hidden'); // ƒê·ªïi class
                        card.style.display = 'none'; 
                    }
                });
                
                if (categoryVisibleCount === 0 && items.length > 0) {
                     categoryDiv.classList.add('sd-filtered'); // ƒê·ªïi class
                }
            });

            if (visibleCount === 0 && query !== '') {
                noResultsMessage.style.display = 'block';
            } else {
                noResultsMessage.style.display = 'none';
            }
        }
        
        searchInput.addEventListener('input', filterItems);


        // 6. ƒê·ªçc d·ªØ li·ªáu t·ª´ Firebase Realtime Database
        menuRef.on('value', (snapshot) => {
            const menuData = snapshot.val();
            if (menuData) {
                allMenuData = menuData; // L∆∞u tr·ªØ d·ªØ li·ªáu
                renderMenu(menuData);
                menuContainer.classList.remove('sd-loading');
            } else {
                menuContainer.innerHTML = '<p class="sd-loading" style="color:var(--ios-text-secondary);">Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu th·ª±c ƒë∆°n.</p>';
            }
        }, (error) => {
            console.error("L·ªói ƒë·ªçc d·ªØ li·ªáu t·ª´ Firebase: ", error);
            menuContainer.innerHTML = `<p class="sd-loading sd-error">‚ùå L·ªói: Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu th·ª±c ƒë∆°n.</p>`;
        });
    </script>
</body>
</html>
