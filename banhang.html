<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªá th·ªëng qu·∫£n l√Ω nh√† h√†ng - Qu·∫£n l√Ω B√°n h√†ng</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* START: UI n√¢ng c·∫•p - iOS Style */
        :root {
            /* M√†u s·∫Øc iOS */
            --ios-blue: #007AFF;
            --ios-green: #34C759;
            --ios-red: #FF3B30;
            --ios-light-gray: #EFEFF4;
            --ios-system-fill: #F2F2F7;
            --ios-separator: rgba(0, 0, 0, 0.1);
            
            /* Mapping sang bi·∫øn g·ªëc */
            --primary-color: var(--ios-blue); /* Thay th·∫ø m√†u xanh l√° b·∫±ng iOS Blue */
            --secondary-color: #555; /* ƒê·∫≠m h∆°n ch√∫t so v·ªõi text color */
            --info-color: var(--ios-blue);
            --success-color: var(--ios-green);
            --warning-color: #FF9500; /* M√†u v√†ng cam iOS */
            --bg-color: var(--ios-system-fill); /* N·ªÅn h·ªá th·ªëng */
            --card-bg: #fff;
            --text-color: #000;
            --border-color: var(--ios-separator);
            --box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1), 0 0 0 0.5px var(--ios-separator); /* Shadow nh·∫π + border m·ªèng */
        }

        body {
            /* Font iOS - S·∫Ω s·ª≠ d·ª•ng 'system-ui' ho·∫∑c font t∆∞∆°ng t·ª± n·∫øu kh√¥ng ph·∫£i iOS */
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
            margin: 0;
            padding: 0; /* Padding ƒë∆∞·ª£c chuy·ªÉn v√†o container */
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-bottom: 90px; /* TƒÉng padding d∆∞·ªõi cho nav bar ki·ªÉu iOS */
        }

        .container {
            width: 100%;
            max-width: 1400px;
            background-color: transparent; /* Container kh√¥ng c√≥ n·ªÅn */
            border-radius: 0;
            box-shadow: none;
            padding: 0 15px; /* Padding ngang ki·ªÉu iOS */
            margin-bottom: 20px;
        }

        .header {
            text-align: center;
            margin: 20px 0;
            padding: 10px 0;
            /* Thi·∫øt k·∫ø ki·ªÉu Navigation Bar */
            background-color: var(--card-bg);
            border-bottom: 1px solid var(--ios-separator);
            box-shadow: 0 0.5px 0 rgba(0, 0, 0, 0.05);
            /* Position c·ªë ƒë·ªãnh ki·ªÉu iOS Top Bar (t√πy ch·ªçn) */
            /* position: sticky; top: 0; z-index: 999; */ 
        }

        .header h1 {
            font-size: 1.5em;
            font-weight: 600; /* Semibold */
            color: var(--text-color);
            margin: 0;
        }

        /* N√¢ng c·∫•p Tab Bar iOS */
        .nav-buttons {
            position: fixed;
            bottom: 0;
            left: 0; /* K√©o r·ªông to√†n m√†n h√¨nh */
            transform: none; /* B·ªè transform */
            width: 100%;
            max-width: none;
            display: flex;
            justify-content: space-around;
            padding: 5px 0;
            background-color: #f7f7f7; /* M√†u n·ªÅn Tab Bar */
            box-shadow: 0 -1px 0 rgba(0, 0, 0, 0.1); /* Shadow tr√™n nh·∫π */
            z-index: 1000;
            height: 60px; /* Chi·ªÅu cao Tab Bar */
            border-top: 1px solid var(--ios-separator);
        }

        .nav-button {
            padding: 5px 10px; /* Gi·∫£m padding */
            border: none;
            border-radius: 0; /* B·ªè bo g√≥c */
            background-color: transparent; /* N·ªÅn trong su·ªët */
            color: #8E8E93; /* M√†u icon/text m·∫∑c ƒë·ªãnh (iOS Gray) */
            font-size: 12px; /* Font nh·ªè h∆°n cho Tab Bar */
            cursor: pointer;
            transition: color 0.2s, background-color 0.2s;
            flex-grow: 1;
            margin: 0;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 3px; /* Kho·∫£ng c√°ch icon v√† text */
        }

        .nav-button:hover {
            background-color: transparent;
            color: var(--ios-blue); /* Hover ƒë·ªïi m√†u iOS Blue */
            transform: none; /* B·ªè transform */
        }

        .nav-button.active {
            background-color: transparent;
            color: var(--ios-blue); /* M√†u active l√† iOS Blue */
        }
        
        .nav-button i {
            font-size: 1.5em; /* Icon to h∆°n */
        }
        
        .nav-button span {
            font-weight: 500; /* Medium */
        }
        /* END: UI n√¢ng c·∫•p - iOS Style */

        .content-section {
            display: none;
            animation: fadeIn 0.5s ease-in-out;
            padding-top: 1px; /* Kh·∫Øc ph·ª•c l·ªói margin collapse v·ªõi header */
        }

        .content-section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* START: UI n√¢ng c·∫•p - iOS Card/List Style */
        .card {
            background-color: var(--card-bg);
            border-radius: 10px; /* Bo g√≥c tr√≤n h∆°n */
            padding: 15px; /* Padding nh·∫π h∆°n */
            margin-bottom: 15px;
            box-shadow: 0 0 0 0.5px var(--ios-separator), 0 2px 4px rgba(0, 0, 0, 0.04); /* Border m·ªèng v√† shadow nh·∫π */
            border: none; /* B·ªè border g·ªëc */
            overflow: hidden; /* C·∫ßn thi·∫øt cho input b√™n trong */
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--ios-separator); /* Separator */
        }

        h2, h3 {
            color: var(--text-color); /* M√†u ch·ªØ ƒëen/text-color */
            font-weight: 600; /* Semibold */
            margin: 0;
        }
        
        h3 {
            font-size: 1.1em;
            color: var(--secondary-color);
        }

        /* iOS Input Style */
        input[type="text"], input[type="number"], select {
            width: 100%;
            padding: 10px 15px;
            margin-bottom: 10px;
            border: 1px solid #ccc;
            border-radius: 8px; /* Bo g√≥c tr√≤n */
            box-sizing: border-box;
            background-color: var(--card-bg);
            transition: border-color 0.3s;
        }

        input[type="text"]:focus, input[type="number"]:focus, select:focus {
            border-color: var(--ios-blue);
            outline: none;
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.2);
        }
        /* END: UI n√¢ng c·∫•p - iOS Card/List Style */

        /* START: UI n√¢ng c·∫•p - iOS Button Style */
        .add-button, .remove-button, .select-table-btn, .checkout-table-btn, .pay-button, .print-button {
            border: none;
            padding: 10px 20px;
            border-radius: 10px; /* Bo g√≥c l·ªõn ki·ªÉu iOS */
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s, box-shadow 0.2s;
            font-weight: 600;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .add-button, .select-table-btn {
            background-color: var(--ios-blue);
            color: white;
        }
        
        .add-button:hover, .select-table-btn:hover {
            background-color: #0071E3; /* M√†u ƒë·∫≠m h∆°n khi hover */
            transform: translateY(-1px);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.15);
        }

        .add-button:active, .select-table-btn:active {
            transform: translateY(0);
            box-shadow: none;
        }

        .remove-button, .checkout-table-btn {
            background-color: var(--ios-red); /* M√†u ƒë·ªè iOS */
            color: white;
        }
        
        .remove-button:hover, .checkout-table-btn:hover {
            background-color: #D62D26;
            transform: translateY(-1px);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.15);
        }

        .remove-button:active, .checkout-table-btn:active {
            transform: translateY(0);
            box-shadow: none;
        }
        
        .pay-button {
            background-color: var(--ios-green);
        }
        
        .pay-button:hover {
            background-color: #30B453;
        }
        
        .print-button {
            background-color: var(--ios-blue);
        }

        .table-card .btn-group button {
             padding: 8px 15px;
             border-radius: 8px;
        }

        .order-item .complete-btn {
            background-color: var(--ios-blue);
            border-radius: 8px;
            padding: 6px 12px;
            font-weight: 500;
        }
        
        .order-item .complete-btn:hover {
            background-color: #1e88e5;
        }
        /* END: UI n√¢ng c·∫•p - iOS Button Style */

        /* B·∫£ng & Danh s√°ch */
        .list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .tables-list-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px; /* Gi·∫£m kho·∫£ng c√°ch */
            margin-top: 15px;
        }
        
        .table-card {
            background-color: var(--card-bg); /* Gi·ªØ m√†u card n·ªÅn tr·∫Øng */
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 0 0 0.5px var(--ios-separator), 0 2px 5px rgba(0, 0, 0, 0.05);
            border: none;
            text-align: center;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .table-card:hover {
            transform: scale(1.02); /* Hi·ªáu ·ª©ng n·ªïi nh·∫π */
            box-shadow: 0 0 0 0.5px var(--ios-blue), 0 4px 10px rgba(0, 0, 0, 0.1);
        }
        
        .table-card h3 {
            font-size: 1.3em;
            margin: 0 0 8px 0;
            color: var(--text-color);
        }

        .table-card .status {
            display: block; /* Hi·ªÉn th·ªã block */
            margin-bottom: 10px;
            padding: 5px 10px;
            border-radius: 6px;
            font-weight: 500;
        }

        .table-card .status.available {
            background-color: #E8F5E9;
            color: var(--ios-green);
        }
        
        .table-card .status.occupied {
            background-color: #FFF3E0;
            color: var(--warning-color);
        }

        .list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: var(--card-bg);
            padding: 12px 15px;
            border-bottom: 1px solid var(--ios-separator);
            cursor: pointer;
            transition: background-color 0.1s;
        }
        
        .list-item.selected {
            background-color: #E6F0FF; /* N·ªÅn xanh nh·∫°t iOS */
            border-left: 5px solid var(--ios-blue);
        }

        .list-item:last-child {
            border-bottom: none;
        }

        .list-item span {
            font-weight: 500;
        }

        .order-item {
            background-color: var(--card-bg);
            border-left: 5px solid var(--ios-blue);
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        /* Status Badges */
        .status {
            font-weight: 600;
            padding: 3px 8px;
            border-radius: 12px; /* Pill shape */
            font-size: 0.85em;
        }

        .status.pending {
            color: var(--warning-color);
            background-color: #FFF3E0;
            border: none;
        }
        
        .status.completed {
            color: var(--ios-green);
            background-color: #E8F5E9;
            border: none;
        }
        
        .status.paid {
            color: var(--ios-blue);
            background-color: #E6F0FF;
            border: none;
        }

        .table-view {
            display: none;
        }
        
        .table-view.active {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
        }

        .menu-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); /* Gi·∫£m k√≠ch th∆∞·ªõc item */
            gap: 10px;
        }

        .menu-item {
            background-color: var(--ios-light-gray); /* N·ªÅn nh·∫π */
            border: none;
            border-radius: 10px;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            transition: transform 0.1s, box-shadow 0.2s, background-color 0.2s;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }
        
        .menu-item:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            background-color: #E5E5EA; /* M√†u nh·∫•n nh·∫π */
        }
        
        .menu-item:active {
            transform: scale(0.98);
            box-shadow: none;
        }
        
        .menu-item h4 {
            margin: 0 0 3px 0;
            font-size: 1em;
            font-weight: 500;
            color: var(--text-color);
        }
        
        .menu-item p {
            margin: 0;
            font-weight: 600;
            color: var(--ios-red); /* Gi√° m√†u ƒë·ªè n·ªïi b·∫≠t */
            font-size: 1.1em;
        }
        
        .order-summary {
            background-color: var(--ios-system-fill); /* N·ªÅn t·ªïng quan nh·∫π */
            padding: 15px;
            border-radius: 8px;
            min-height: 150px;
        }
        
        .order-summary-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid var(--ios-separator); /* Separator m·ªèng */
        }
        
        .quantity-controls button {
            background-color: #F7F7F7;
            border: 1px solid #ccc;
            padding: 2px 7px;
            cursor: pointer;
            font-weight: bold;
            border-radius: 50%; /* N√∫t tr√≤n */
            width: 25px;
            height: 25px;
            line-height: 1;
            display: inline-flex;
            justify-content: center;
            align-items: center;
        }

        /* Modal cho H√≥a ƒë∆°n (Gi·ªØ nguy√™n c·∫•u tr√∫c ƒë·ªÉ ƒë·∫£m b·∫£o Print ho·∫°t ƒë·ªông) */
        .modal {
            display: none;
            position: fixed;
            z-index: 1001;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.6); /* N·ªÅn t·ªëi h∆°n cho iOS */
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.3s;
        }

        .modal-content {
            background-color: #fefefe;
            padding: 30px;
            border-radius: 14px; /* Bo g√≥c l·ªõn h∆°n */
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
            max-width: 450px;
            width: 90%;
            text-align: center;
            position: relative;
        }
        
        .close-button {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 35px; /* To h∆°n ƒë·ªÉ d·ªÖ b·∫•m */
            font-weight: 300; /* Light */
            cursor: pointer;
            color: #555;
            transition: color 0.2s;
        }
        
        .close-button:hover {
            color: var(--ios-red);
        }

        /* Bill-specific styles (Ch·ªânh s·ª≠a ƒë·ªÉ cƒÉn l·ªÅ tr√°i ƒë·ªÅu v√† ƒë·∫πp) */
        .bill-header, .bill-summary {
            text-align: left; /* CƒÉn l·ªÅ tr√°i cho header v√† summary */
            color: #000;
            font-weight: 500;
        }
        
        .bill-header p {
            margin: 5px 0;
        }

        .bill-header h2 {
            font-size: 2.2em;
            color: #000;
            margin: 0;
            font-weight: 800;
            text-align: center; /* Gi·ªØ ti√™u ƒë·ªÅ trung t√¢m */
        }
        
        .bill-header h5 {
            text-align: center;
            margin: 5px 0 15px 0;
        }
        
        .bill-details {
             /* ƒê·∫£m b·∫£o b·∫£ng cƒÉn l·ªÅ tr√°i ƒë·ªÅu */
             width: 100%;
             margin: 15px 0;
        }
        
        .bill-details table {
            width: 100%;
            border-collapse: collapse;
            text-align: left; /* CƒÉn l·ªÅ tr√°i cho b·∫£ng */
        }
        
        .bill-details th, .bill-details td {
            font-size: 1.2em;
            color: #000;
            font-weight: 500;
            padding: 8px 0; /* Th√™m padding d·ªçc cho d·ªÖ ƒë·ªçc */
        }

        .bill-details th {
            border-bottom: 2px solid #000;
            font-weight: 700;
        }
        
        .bill-details td.item-name {
            width: 45%; /* T√™n m√≥n chi·∫øm nhi·ªÅu di·ªán t√≠ch h∆°n */
        }
        .bill-details th.item-qty, .bill-details td.item-qty {
            width: 15%;
            text-align: center; /* S·ªë l∆∞·ª£ng trung t√¢m */
        }
        .bill-details th.item-price, .bill-details td.item-price, 
        .bill-details th.item-total, .bill-details td.item-total {
             width: 20%;
             text-align: right; /* Gi√° ti·ªÅn cƒÉn ph·∫£i */
        }
        
        .bill-summary p {
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
            font-size: 1.1em;
            padding: 3px 0;
        }
        
        .bill-summary p span:first-child {
            font-weight: 500;
        }
        
        .bill-summary p span:last-child {
            font-weight: 700;
            text-align: right;
        }

        .bill-total-price {
            font-weight: 800 !important;
            font-size: 1.4em !important;
            color: var(--ios-red) !important; /* M√†u ƒë·ªè n·ªïi b·∫≠t cho t·ªïng */
        }
        
        .bill-qr-container {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px dashed #ccc;
            text-align: center;
        }
        
        .bill-qr-container img {
            max-width: 200px;
            height: auto;
            border: 2px solid #000; /* TƒÉng ƒë·ªô ƒë·∫≠m c·ªßa border */
            padding: 10px; /* TƒÉng padding ƒë·ªÉ QR n·ªïi b·∫≠t h∆°n */
            border-radius: 8px; /* Bo g√≥c nh·∫π */
        }

        /* Group button */
        .button-group-bill {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }
        
        /* Print styles - Gi·ªØ nguy√™n */
        @media print {
            @page { 
                margin: 0;
            }
            body * {
                visibility: hidden;
            }
            .modal-content, .modal-content * {
                visibility: visible;
                -webkit-print-color-adjust: exact; 
                print-color-adjust: exact;
                color: #000 !important;
                font-weight: bold !important;
            }
            .modal-content {
                position: absolute;
                left: 50%;
                top: 0;
                transform: translateX(-50%);
                width: 90%;
                max-width: 450px;
                padding: 10px;
                box-shadow: none;
                margin: 0 auto;
            }
            .close-button, .button-group-bill, .nav-buttons { 
                display: none !important;
            }
            /* Ch·ªânh s·ª≠a th√™m cho in ·∫•n ƒë·ªÉ ƒë·∫£m b·∫£o cƒÉn ch·ªânh ƒë·ªÅu */
             .bill-details table {
                 table-layout: fixed; /* Gi·ªØ nguy√™n chi·ªÅu r·ªông c·ªôt */
             }
             .bill-details th, .bill-details td {
                 padding: 4px 0; 
                 font-size: 1.1em !important; /* Gi·∫£m font size cho in nhi·ªát */
                 font-weight: 500 !important;
             }
             .bill-details th {
                 font-weight: 700 !important;
             }
             .bill-details td.item-price, .bill-details td.item-total {
                 text-align: right !important;
             }
             .bill-details th.item-total {
                 text-align: right !important;
             }
             .bill-details td.item-qty {
                 text-align: center !important;
             }
             .bill-summary p span:last-child {
                text-align: right;
             }
             .bill-total-price {
                 font-size: 1.4em !important;
             }
             .bill-qr-container img {
                 border: 2px solid #000;
             }
            .modal-content {
                overflow: visible !important; 
            }
        }
        /* END: UI n√¢ng c·∫•p */
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>H·ªá th·ªëng qu·∫£n l√Ω nh√† h√†ng üçΩÔ∏è</h1>
        </div>
        <div id="tables" class="content-section active">
            <div id="tableViewList" class="card">
                <div class="card-header">
                    <h2>Qu·∫£n l√Ω B√†n</h2>
                </div>
                <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                    <input type="text" id="tableNameInput" placeholder="T√™n b√†n (v√≠ d·ª•: B√†n 1, VIP 2)" style="flex-grow: 1;">
                    <button id="addTableButton" class="add-button">Th√™m b√†n</button>
                </div>
                <div id="tablesList" class="tables-list-container"></div>
            </div>
            
            <div id="tableOrderView" class="table-view">
                <div class="column-left">
                    <div class="card">
                        <div class="card-header">
                            <h2 id="currentTableName"></h2>
                            <button id="backToTables" class="remove-button" style="background-color: var(--ios-blue);"><i class="fas fa-arrow-left"></i> Quay l·∫°i</button>
                        </div>
                    </div>

                    <div class="card">
                        <h3>T√¨m ki·∫øm m√≥n</h3>
                        <input type="text" id="orderSearchInput" placeholder="T√¨m ki·∫øm m√≥n ƒÉn, th·ª©c u·ªëng...">
                    </div>
                    
                    <div class="card">
                        <h3>Menu ƒê·ªì ƒÉn</h3>
                        <div id="foodMenuOrderList" class="menu-list"></div>
                    </div>

                    <div class="card">
                        <h3>Menu Th·ª©c u·ªëng</h3>
                        <div id="drinkMenuOrderList" class="menu-list"></div>
                    </div>
                </div>

                <div class="column-right">
                    <div class="card">
                        <h3>Order hi·ªán t·∫°i</h3>
                        <div id="currentOrderSummary" class="order-summary">
                            <p>Ch·ªçn m√≥n t·ª´ menu ƒë·ªÉ th√™m v√†o order.</p>
                        </div>
                        <button id="sendOrderButton" class="add-button" style="width: 100%; margin-top: 15px;">G·ª≠i Order</button>
                    </div>
                    <div class="card">
                        <h3>ƒê∆°n ƒë√£ g·ª≠i</h3>
                        <ul id="sentOrdersList" class="list"></ul>
                        <button id="checkoutButton" class="checkout-table-btn" style="width: 100%; margin-top: 15px; display: none; background-color: var(--ios-red);">Thanh to√°n</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="paymentModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <div id="billContent"> 
                <div class="bill-header" style="text-align: center;">
                    <h2>·∫®m th·ª±c bu√¥n m√™</h2>
                    <h5>ƒê·∫≠m ƒë√† h∆∞∆°ng v·ªã c∆°m ƒë·ªìng b√†o √ä-ƒë√™</h5>
                    <div style="text-align: left; margin: 15px 0;">
                        <p>ƒê·ªãa ch·ªâ: 285/94b C√°ch M·∫°ng Th√°ng 8</p>
                        <p>Ng√†y: <span id="billDate"></span></p>
                        <p>Th·ªùi gian in: <span id="billTime"></span></p>
                        <p>B√†n: <span id="billTableInfo"></span></p>
                        <p>M√£ Hƒê: <span id="billId"></span></p>
                    </div>
                    </div>
                <div class="bill-details">
                    <table>
                        <thead>
                            <tr>
                                <th class="item-name" style="text-align: left;">T√™n m√≥n</th>
                                <th class="item-qty" style="text-align: center;">SL</th>
                                <th class="item-price" style="text-align: right;">ƒê∆°n gi√°</th>
                                <th class="item-total" style="text-align: right;">Th√†nh ti·ªÅn</th>
                            </tr>
                        </thead>
                        <tbody id="billDetailsBody"></tbody>
                    </table>
                </div>
                <div class="bill-summary">
                    <p><span>T·ªïng ti·ªÅn:</span> <span id="billTotalPrice"></span></p>
                    <p><span>Thanh to√°n:</span> <span id="billTotalPaid" class="bill-total-price"></span></p>
                    
                    <div class="bill-qr-container">
                        <p style="font-weight: 700; color: #000; margin-bottom: 10px; font-size: 1.2em;">Thanh to√°n b·∫±ng VietQR</p>
                        <img id="vietQrCode" alt="M√£ VietQR" style="width: 100%; max-width: 250px; display: block; margin: 0 auto;"/>
                        <p style="font-weight: 500; color: #000; margin-top: 5px;">NG√ÇN H√ÄNG: MB Bank</p>
                        <p style="font-weight: 500; color: #000; margin: 0;">S·ªê TK: 0909650816</p>
                        <p style="font-weight: 500; color: #000; margin: 0;">CH·ª¶ TK: TRAN VU NGOC THANH</p>
                    </div>
                    <p style="font-size: 1.2em; text-align: center; margin-top: 15px; font-weight: 700; color: #000;">C·∫£m ∆°n qu√Ω kh√°ch v√† h·∫πn g·∫∑p l·∫°i!</p>
                </div>
            </div>
            <div class="button-group-bill">
                <button id="printBillButton" class="print-button">In H√≥a ƒë∆°n</button> 
                <button id="confirmPaymentButton" class="pay-button">X√°c nh·∫≠n thanh to√°n</button>
            </div>
        </div>
    </div>
    
    <div class="nav-buttons">
        <button class="nav-button active" data-section="tables">
            <i class="fas fa-utensils"></i>
            <span>B√°n h√†ng</span>
        </button>
        </div>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

    <script>
        // Your Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyB8uLkLJFlzmCodcawJhs2dRckHQzO5y10",
            authDomain: "chitieu-7263e.firebaseapp.com",
            databaseURL: "https://chitieu-7263e-default-rtdb.firebaseio.com",
            projectId: "chitieu-7263e",
            storageBucket: "chitieu-7263e.firebasestorage.app",
            messagingSenderId: "83833140682",
            appId: "1:83833140682:web:f9254b418ace3a659fcb33",
            measurementId: "G-523X74K18N"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        
        // Telegram Bot Configuration
        const TELEGRAM_BOT_TOKEN = "7807531189:AAGhMQ9jjew7Q9ywMDSTaGDy4Ns6XtPQUrI";
        const TELEGRAM_CHAT_ID = "-4954039835";
        
        // --- NEW CONFIGURATION ---
        const OPEN_CASH_URL = "http://192.168.156.102:5000/opencash"; // ƒê·ªãa ch·ªâ m·ªü k√©t ti·ªÅn
        // --- END NEW CONFIGURATION ---

        // DOM elements
        const navButtons = document.querySelectorAll('.nav-button');
        const sections = document.querySelectorAll('.content-section');
        const tableNameInput = document.getElementById('tableNameInput');
        const addTableButton = document.getElementById('addTableButton');
        const tablesList = document.getElementById('tablesList');
        
        // New elements for table view
        const tableViewList = document.getElementById('tableViewList');
        const tableOrderView = document.getElementById('tableOrderView');
        const currentTableName = document.getElementById('currentTableName');
        const backToTables = document.getElementById('backToTables');
        const foodMenuOrderList = document.getElementById('foodMenuOrderList');
        const drinkMenuOrderList = document.getElementById('drinkMenuOrderList');
        const currentOrderSummary = document.getElementById('currentOrderSummary');
        const sendOrderButton = document.getElementById('sendOrderButton');
        const sentOrdersList = document.getElementById('sentOrdersList');
        const checkoutButton = document.getElementById('checkoutButton');
        const orderSearchInput = document.getElementById('orderSearchInput');
        
       // Modal elements
        const paymentModal = document.getElementById('paymentModal');
        const closeButton = document.querySelector('.close-button');
        const billTableInfo = document.getElementById('billTableInfo');
        const billDate = document.getElementById('billDate');
        const billTime = document.getElementById('billTime'); 
        const billId = document.getElementById('billId');
        const billDetailsBody = document.getElementById('billDetailsBody');
        const billTotalPrice = document.getElementById('billTotalPrice');
        // const billVatPrice = document.getElementById('billVatPrice'); // ƒê√£ x√≥a kh·ªèi HTML, kh√¥ng c·∫ßn DOM
        const billTotalPaid = document.getElementById('billTotalPaid');
        const confirmPaymentButton = document.getElementById('confirmPaymentButton');
        const printBillButton = document.getElementById('printBillButton'); 
        
        // VietQR Element
        const vietQrCode = document.getElementById('vietQrCode');

        let currentTableId = null;
        let currentTableNameValue = '';
        let currentOrderItems = {}; // { menuId: { name, price, type, quantity } }
        let allMenuItems = [];

        // >> START: CODE M·ªöI CHO REAL-TIME LISTENER
        let activeListeners = [];

        // H√†m d·ªçn d·∫πp t·∫•t c·∫£ c√°c listener hi·ªán t·∫°i
        function cleanupListeners() {
            activeListeners.forEach(listener => {
                if (listener.ref && listener.callback) {
                    listener.ref.off('value', listener.callback);
                }
            });
            activeListeners = [];
        }
        // << END: CODE M·ªöI CHO REAL-TIME LISTENER

        // --- Telegram Notification Function ---
        function sendTelegramMessage(message) {
            const url = `https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`;
            const payload = {
                chat_id: TELEGRAM_CHAT_ID,
                text: message,
                parse_mode: 'HTML'
            };
            
            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            }).then(response => {
                if (!response.ok) {
                    console.error("L·ªói khi g·ª≠i tin nh·∫Øn Telegram.");
                }
            }).catch(error => {
                console.error("L·ªói m·∫°ng khi g·ª≠i tin nh·∫Øn Telegram:", error);
            });
        }
        
        // --- Main Navigation Logic ---
        navButtons.forEach(button => {
            button.addEventListener('click', () => {
                navButtons.forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                
                sections.forEach(sec => sec.classList.remove('active'));
                const sectionId = button.getAttribute('data-section');
                document.getElementById(sectionId).classList.add('active');
                
                if (sectionId === 'tables') {
                    // Khi chuy·ªÉn kh·ªèi ch·∫ø ƒë·ªô xem Order, d·ªçn d·∫πp Listener
                    cleanupListeners(); 
                    tableViewList.style.display = 'block';
                    tableOrderView.style.display = 'none';
                    // KH√îNG C·∫¶N G·ªåI renderTables() ·ªû ƒê√ÇY, v√¨ listener ch√≠nh ƒë√£ ƒë∆∞·ª£c thi·∫øt l·∫≠p ·ªü DOMContentLoaded
                    // Khi checkout th√†nh c√¥ng, l·ªánh renderTables() ·ªü confirmPayment ƒë√£ g·ªçi l·∫°i list
                }
            });
        });

        // --- Tables Management ---
        addTableButton.addEventListener('click', () => {
            const tableName = tableNameInput.value.trim();
            if (tableName) {
                const newTableRef = database.ref('tables').push();
                newTableRef.set({
                    name: tableName,
                    status: 'available'
                }).then(() => {
                    tableNameInput.value = '';
                }).catch(error => {
                    console.error("L·ªói khi th√™m b√†n:", error);
                });
            }
        });

       // B·ªé LISTENER FIREBASE RA KH·ªéI H√ÄM N√ÄY ƒê·ªÇ TR√ÅNH L·∫∂P L·∫†I (FIX L·ªñI HI·ªÇN TH·ªä 2 L·∫¶N)
       async function renderTables(snapshot) {
            tablesList.innerHTML = '';
            
            const tablesData = [];
            snapshot.forEach((childSnapshot) => {
                tablesData.push({
                    id: childSnapshot.key,
                    ...childSnapshot.val()
                });
            });

            // 1. T·∫£i T·∫§T C·∫¢ orders hi·ªán c√≥ trong kitchen_bar_orders
            // S·ª≠ d·ª•ng Promise ƒë·ªÉ ƒë·ª£i d·ªØ li·ªáu kitchen/bar
            const kitchenOrdersSnapshot = await database.ref('kitchen_bar_orders').once('value');
            const kitchenOrders = kitchenOrdersSnapshot.val() || {};
            
            // 2. Gom nh√≥m c√°c ƒë∆°n h√†ng theo T√äN B√ÄN (tableName)
            const occupiedTables = new Set();
            Object.values(kitchenOrders).forEach(order => {
                // N·∫øu c√≥ b·∫•t k·ª≥ order n√†o tr√πng tableName, coi b√†n ƒë√≥ l√† ƒëang s·ª≠ d·ª•ng
                if (order.tableName) {
                    occupiedTables.add(order.tableName);
                }
            });

            // 3. Render danh s√°ch b√†n
            tablesData.forEach((table) => {
                const tableId = table.id;
                const tableName = table.name;
                
                // X√ÅC ƒê·ªäNH TR·∫†NG TH√ÅI M·ªöI D·ª∞A TR√äN occupiedTables
                let currentStatus = 'available'; // M·∫∑c ƒë·ªãnh l√† 'available'
                if (occupiedTables.has(tableName)) {
                    currentStatus = 'occupied'; // N·∫øu t√™n b√†n t·ªìn t·∫°i trong kitchen_bar_orders, set l√† 'occupied'
                } 
                // KH√îNG C·∫¶N C·∫¨P NH·∫¨T TR·ªû L·∫†I FIREBASE ·ªû ƒê√ÇY, CH·ªà C·∫¨P NH·∫¨T TR√äN UI (UI s·∫Ω ƒë·ªìng b·ªô)

                const statusText = currentStatus === 'available' ? 'C√≥ s·∫µn' : 'ƒêang s·ª≠ d·ª•ng';
                const statusClass = currentStatus === 'available' ? 'available' : 'occupied';
                
                const card = document.createElement('div');
                card.classList.add('table-card');
                
                card.innerHTML = `
                    <h3>${tableName}</h3>
                    <span class="status ${statusClass}">${statusText}</span>
                    <div class="btn-group">
                        <button class="select-table-btn add-button" data-table-id="${tableId}" data-table-name="${tableName}">Ch·ªçn b√†n</button>
                        <button class="checkout-table-btn remove-button" data-table-id="${tableId}" data-table-name="${tableName}" style="display: ${currentStatus === 'available' ? 'none' : 'inline-block'};">Thanh to√°n</button>
                    </div>
                `;
                tablesList.appendChild(card);

                card.querySelector('.select-table-btn').addEventListener('click', () => {
                    currentTableId = tableId;
                    currentTableNameValue = tableName;
                    currentOrderItems = {};
                    currentTableName.textContent = `B√†n: ${currentTableNameValue}`;
                    tableViewList.style.display = 'none';
                    tableOrderView.style.display = 'grid';
                    loadAllMenuItems();
                    renderTableSentOrders();
                    updateOrderSummary();
                    updateCheckoutButtonVisibility();
                });
                
                const checkoutBtn = card.querySelector('.checkout-table-btn');
                if (checkoutBtn) {
                    checkoutBtn.addEventListener('click', () => showPaymentModal(tableId, tableName));
                }
            });
       }
        
        // --- Table Order View ---
        backToTables.addEventListener('click', () => {
            cleanupListeners(); // D·ªçn d·∫πp listener khi quay l·∫°i danh s√°ch b√†n
            tableViewList.style.display = 'block';
            tableOrderView.style.display = 'none';
        });

        checkoutButton.addEventListener('click', () => {
            showPaymentModal(currentTableId, currentTableNameValue);
        });

        function loadAllMenuItems() {
            allMenuItems = [];
            foodMenuOrderList.innerHTML = '';
            drinkMenuOrderList.innerHTML = '';

            // T·∫£i Menu ƒê·ªì ƒÉn
            database.ref('menu/food').once('value', (snapshot) => {
                snapshot.forEach((childSnapshot) => {
                    allMenuItems.push({
                        id: childSnapshot.key,
                        ...childSnapshot.val(),
                        type: 'food'
                    });
                });
                renderMenuForOrder();
            });

            // T·∫£i Menu Th·ª©c u·ªëng
            database.ref('menu/drink').once('value', (snapshot) => {
                snapshot.forEach((childSnapshot) => {
                    allMenuItems.push({
                        id: childSnapshot.key,
                        ...childSnapshot.val(),
                        type: 'drink'
                    });
                });
                renderMenuForOrder();
            });
        }

        function renderMenuForOrder() {
            foodMenuOrderList.innerHTML = '';
            drinkMenuOrderList.innerHTML = '';
            allMenuItems.forEach(item => {
                const div = document.createElement('div');
                div.classList.add('menu-item');
                div.setAttribute('data-id', item.id);
                div.setAttribute('data-type', item.type);
                div.setAttribute('data-name', item.name);
                div.setAttribute('data-price', item.price);
                div.innerHTML = `
                    <h4>${item.name}</h4>
                    <p>${parseFloat(item.price).toLocaleString('vi-VN')}‚Ç´</p>
                `;

                if (item.type === 'food') {
                    foodMenuOrderList.appendChild(div);
                } else if (item.type === 'drink') {
                    drinkMenuOrderList.appendChild(div);
                }
            });
            addMenuListeners();
        }

        orderSearchInput.addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            filterMenuItems(searchTerm);
        });

        function filterMenuItems(searchTerm) {
            const foodItems = document.querySelectorAll('#foodMenuOrderList .menu-item');
            const drinkItems = document.querySelectorAll('#drinkMenuOrderList .menu-item');
            
            foodItems.forEach(item => {
                const itemName = item.getAttribute('data-name').toLowerCase();
                if (itemName.includes(searchTerm)) {
                    item.style.display = 'block';
                } else {
                    item.style.display = 'none';
                }
            });

            drinkItems.forEach(item => {
                const itemName = item.getAttribute('data-name').toLowerCase();
                if (itemName.includes(searchTerm)) {
                    item.style.display = 'block';
                } else {
                    item.style.display = 'none';
                }
            });
        }
        
        function addMenuListeners() {
            const menuItems = document.querySelectorAll('.menu-item');
            menuItems.forEach(item => {
                item.removeEventListener('click', handleMenuClick);
                item.addEventListener('click', handleMenuClick);
            });
        }

        function handleMenuClick(event) {
            const item = event.currentTarget;
            const menuId = item.getAttribute('data-id');
            const name = item.getAttribute('data-name');
            const price = parseFloat(item.getAttribute('data-price'));
            const type = item.getAttribute('data-type');

            if (currentOrderItems[menuId]) {
                currentOrderItems[menuId].quantity += 1;
            } else {
                currentOrderItems[menuId] = { name, price, type, quantity: 1 };
            }
            updateOrderSummary();
        }

        function updateOrderSummary() {
            let total = 0;
            currentOrderSummary.innerHTML = '';

            const orderedItems = Object.values(currentOrderItems);
            if (orderedItems.length === 0) {
                currentOrderSummary.innerHTML = '<p>Ch·ªçn m√≥n t·ª´ menu ƒë·ªÉ th√™m v√†o order.</p>';
                return;
            }

            orderedItems.forEach(item => {
                const div = document.createElement('div');
                div.classList.add('order-summary-item');
                div.innerHTML = `
                    <span>${item.name}</span>
                    <div class="quantity-controls">
                        <span>x${item.quantity}</span>
                        <span>${(item.price * item.quantity).toLocaleString('vi-VN')}‚Ç´</span>
                        <button class="decrement-btn" data-name="${item.name}">-</button>
                    </div>
                `;
                currentOrderSummary.appendChild(div);
                total += item.price * item.quantity;
            });
            
            const totalDiv = document.createElement('div');
            // UI n√¢ng c·∫•p: M√†u t·ªïng ti·ªÅn ƒë·∫≠m h∆°n
            totalDiv.innerHTML = `<p style="font-weight: bold; margin-top: 10px;">T·ªïng ti·ªÅn: <span style="color: var(--ios-red); font-weight: 700;">${total.toLocaleString('vi-VN')}‚Ç´</span></p>`;
            currentOrderSummary.appendChild(totalDiv);

            currentOrderSummary.querySelectorAll('.decrement-btn').forEach(button => {
                button.addEventListener('click', (event) => {
                    const itemName = event.target.getAttribute('data-name');
                    // T√¨m menuId d·ª±a tr√™n t√™n m√≥n (c·∫ßn t√¨m l·∫°i key)
                    const menuId = Object.keys(currentOrderItems).find(key => currentOrderItems[key].name === itemName);

                    if (currentOrderItems[menuId] && currentOrderItems[menuId].quantity > 1) {
                        currentOrderItems[menuId].quantity -= 1;
                    } else if (currentOrderItems[menuId]) {
                        delete currentOrderItems[menuId];
                    }
                    updateOrderSummary();
                });
            });
        }
        
        // >> START: H√ÄM G·ª¨I ORDER ƒê√É C·∫¨P NH·∫¨T L∆ØU GI√Å V√ÄO B·∫æP V√Ä B√ÄN
        sendOrderButton.addEventListener('click', () => {
            if (Object.keys(currentOrderItems).length === 0) {
                alert("ƒê∆°n h√†ng r·ªóng. Vui l√≤ng ch·ªçn m√≥n.");
                return;
            }

            const timestamp = new Date().toISOString();
            const tableOrderRef = database.ref('tables').child(currentTableId).child('sentOrders').push();

            database.ref(`tables/${currentTableId}`).update({ status: 'occupied' });

            const itemsForSentList = {};
            const updates = {};
            
            Object.keys(currentOrderItems).forEach(menuId => {
                const item = currentOrderItems[menuId];
                
                if (!updates[`kitchen_bar_orders/${tableOrderRef.key}`]) {
                    updates[`kitchen_bar_orders/${tableOrderRef.key}`] = {
                        tableId: currentTableId,
                        tableName: currentTableNameValue,
                        timestamp: timestamp,
                        type: item.type, 
                        items: {}
                    };
                }
                
                // L∆ØU TR·ªÆ GI√Å V√ÄO KITCHEN_BAR_ORDERS
                updates[`kitchen_bar_orders/${tableOrderRef.key}`].items[menuId] = {
                    itemName: item.name,
                    quantity: item.quantity,
                    type: item.type,
                    status: 'pending',
                    price: item.price // << L∆ØU GI√Å V√ÄO B·∫æP
                };

                // L∆ØU TR·ªÆ GI√Å V√ÄO SENT ORDERS C·ª¶A B√ÄN
                itemsForSentList[menuId] = {
                    name: item.name,
                    price: item.price, // << L∆ØU GI√Å V√ÄO B√ÄN
                    type: item.type,
                    quantity: item.quantity,
                    status: 'pending' 
                };
            });
            
            updates[`tables/${currentTableId}/sentOrders/${tableOrderRef.key}`] = {
                items: itemsForSentList,
                timestamp: timestamp
            };
            
            database.ref().update(updates).then(() => {
                alert("ƒê∆°n h√†ng ƒë√£ ƒë∆∞·ª£c g·ª≠i th√†nh c√¥ng!");
                
                let totalItems = 0;
                let messageText = `<b>üìù Order m·ªõi t·ª´: B√†n ${currentTableNameValue}</b>\n\n`;
                
                Object.values(currentOrderItems).forEach(item => {
                    messageText += `‚Ä¢ ${item.name} x ${item.quantity}\n`;
                    totalItems += item.quantity;
                });
                
                messageText += `\nT·ªïng s·ªë m√≥n: ${totalItems}`;
                messageText += `\nTh·ªùi gian: ${new Date().toLocaleTimeString('vi-VN')}`;

                sendTelegramMessage(messageText);

                currentOrderItems = {}; 
                updateOrderSummary();
            });
        });
        // >> END: H√ÄM G·ª¨I ORDER ƒê√É C·∫¨P NH·∫¨T L∆ØU GI√Å V√ÄO B·∫æP V√Ä B√ÄN

// >> START: CODE ƒê√É CH·ªàNH S·ª¨A CH·ªà L·∫§Y T·ª™ KITCHEN_BAR_ORDERS

// H√†m kh·ªüi t·∫°o Listener ph·ª• cho tr·∫°ng th√°i m√≥n ƒÉn (theo d√µi tr·∫°ng th√°i tr√™n kitchen_bar_orders)
function startKitchenOrderListener(orderId, sentOrderItems) {
    const kitchenOrderRef = database.ref(`kitchen_bar_orders/${orderId}/items`);
    const kitchenOrderCallback = kitchenOrderRef.on('value', (kitchenItemsSnapshot) => {
        let itemsListHtml = '';
        const kitchenItems = kitchenItemsSnapshot.val() || {};
        
        // L·∫∑p qua c√°c m√≥n ƒë√£ ƒë∆∞·ª£c l∆∞u trong Order (T·∫°m coi l√† ƒë√£ l·∫•y t·ª´ kitchen_bar_orders)
        Object.keys(sentOrderItems).forEach(itemId => {
            const item = sentOrderItems[itemId];
            let currentStatus = item.status || 'pending'; // D√πng status ƒë√£ l∆∞u ban ƒë·∫ßu
            
            // L·∫•y tr·∫°ng th√°i m·ªõi nh·∫•t t·ª´ B·∫øp (n·∫øu t·ªìn t·∫°i)
            const kitchenItem = kitchenItems[itemId];
            if (kitchenItem && kitchenItem.status) {
                currentStatus = kitchenItem.status;
            }
            
            const statusText = currentStatus === 'completed' ? 'ƒê√£ xong' : 'ƒêang l√†m';
            const statusClass = currentStatus === 'completed' ? 'completed' : 'pending';
            
            itemsListHtml += `
                <li style="display: flex; justify-content: space-between; align-items: center; padding: 5px 0; border-bottom: 1px dotted var(--ios-separator);">
                    <span>${item.name} x ${item.quantity}</span>
                    <span class="status ${statusClass}">${statusText}</span>
                </li>`;
        });
        
        // C·∫≠p nh·∫≠t HTML c·ªßa danh s√°ch m√≥n ƒÉn
        const itemsListElement = document.getElementById(`order-items-list-${orderId}`);
        if (itemsListElement) {
            itemsListElement.innerHTML = itemsListHtml;
        }

        // C·∫≠p nh·∫≠t n√∫t Thanh to√°n sau m·ªói l·∫ßn c·∫≠p nh·∫≠t tr·∫°ng th√°i
        updateCheckoutButtonVisibility();
    });

    // L∆∞u tr·ªØ listener ph·ª• ƒë·ªÉ d·ªçn d·∫πp
    activeListeners.push({ ref: kitchenOrderRef, callback: kitchenOrderCallback });
}


function renderTableSentOrders() {
    // D·ªçn d·∫πp t·∫•t c·∫£ listener c≈© khi h√†m ƒë∆∞·ª£c g·ªçi
    cleanupListeners();

    sentOrdersList.innerHTML = '';
    if (!currentTableId || !currentTableNameValue) return;

    // >> CH·ªà L·∫ÆNG NGHE T·ª™ KITCHEN_BAR_ORDERS D√ôNG QUERY THEO T√äN B√ÄN <<
    const kitchenOrdersRef = database.ref('kitchen_bar_orders').orderByChild('tableName').equalTo(currentTableNameValue);

    
    // L∆∞u tr·ªØ d·ªØ li·ªáu order
    let externalOrders = {};
    
    // H√†m render Order
    const renderOrders = (snapshot) => {
        externalOrders = snapshot.val() || {};
        
        sentOrdersList.innerHTML = '';
        const allOrders = [];

        // Th√™m Orders t·ª´ Kitchen/Bar
        Object.keys(externalOrders).forEach(orderId => {
            const order = externalOrders[orderId];
            
            // T·∫°o c·∫•u tr√∫c items ƒë·ªÉ t√°i s·ª≠ d·ª•ng logic
            const itemsForTableSent = {};
            if(order.items) {
                Object.keys(order.items).forEach(itemId => {
                    const item = order.items[itemId];
                    itemsForTableSent[itemId] = {
                        name: item.itemName, // Kitchen d√πng 'itemName'
                        price: item.price,
                        type: item.type,
                        quantity: item.quantity,
                        status: item.status // L·∫•y status tr·ª±c ti·∫øp t·ª´ kitchen order item
                    };
                });
            }
            
            // Ch·ªâ th√™m n·∫øu c√≥ items h·ª£p l·ªá
            if (Object.keys(itemsForTableSent).length > 0) {
                allOrders.push({
                    id: orderId,
                    timestamp: order.timestamp,
                    items: itemsForTableSent,
                    source: 'external' // ƒê√°nh d·∫•u l√† ngu·ªìn ngo√†i (t·ª´ kitchen_bar_orders)
                });
            }
        });
        
        // S·∫Øp x·∫øp theo th·ªùi gian m·ªõi nh·∫•t l√™n ƒë·∫ßu
        allOrders.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));


        // Render Order List
        allOrders.forEach(order => {
            const time = new Date(order.timestamp).toLocaleTimeString('vi-VN');

            const li = document.createElement('li');
            li.classList.add('order-item');
            li.id = `order-list-item-${order.id}`;

            // Ghi ch√∫ ngu·ªìn
            const sourceNote = '<span style="color: var(--warning-color); font-weight: 500;">(ƒê√£ g·ª≠i)</span>';

            let orderDetailsHtml = `<p><strong>Th·ªùi gian:</strong> ${time} ${sourceNote}</p><hr><ul id="order-items-list-${order.id}" style="list-style-type: none; padding: 0;"></ul>`;
            li.innerHTML = orderDetailsHtml;
            sentOrdersList.appendChild(li);

            // B·∫Øt ƒë·∫ßu l·∫Øng nghe tr·∫°ng th√°i c·ªßa m√≥n trong order n√†y (t·ª´ Kitchen/Bar)
            startKitchenOrderListener(order.id, order.items);
        });
        
        // C·∫≠p nh·∫≠t n√∫t Thanh to√°n sau khi render xong
        updateCheckoutButtonVisibility();
    };


    // Listener ch√≠nh cho Orders t·ª´ kitchen_bar_orders
    const externalCallback = kitchenOrdersRef.on('value', renderOrders);
    activeListeners.push({ ref: kitchenOrdersRef, callback: externalCallback });
}
// >> END: CODE ƒê√É CH·ªàNH S·ª¨A CH·ªà L·∫§Y T·ª™ KITCHEN_BAR_ORDERS
        // >> START: H√ÄM KI·ªÇM TRA CHECKOUT ƒê√É C·∫¨P NH·∫¨T
        function updateCheckoutButtonVisibility() {
            if (!currentTableId) {
                checkoutButton.style.display = 'none';
                return;
            }
            
            // Ki·ªÉm tra xem c√≥ m√≥n n√†o c√≥ tr·∫°ng th√°i 'completed' hay kh√¥ng
            database.ref(`tables/${currentTableId}/sentOrders`).once('value', snapshot => {
                let anyCompleted = false;
                
                // S·ª≠ d·ª•ng Promise.all ƒë·ªÉ ƒë·ª£i t·∫•t c·∫£ c√°c l·∫ßn ki·ªÉm tra tr·∫°ng th√°i t·ª´ B·∫øp
                const checkPromises = [];

                snapshot.forEach(sentOrderSnapshot => {
                    const sentOrder = sentOrderSnapshot.val();
                    if (sentOrder.items) {
                        const sentOrderId = sentOrderSnapshot.key;
                        
                        const promise = database.ref(`kitchen_bar_orders/${sentOrderId}/items`).once('value').then(kitchenItemsSnapshot => {
                            kitchenItemsSnapshot.forEach(itemSnapshot => {
                                if (itemSnapshot.val().status === 'completed') {
                                    anyCompleted = true;
                                }
                            });
                        });
                        checkPromises.push(promise);
                    }
                });
                
                Promise.all(checkPromises).then(() => {
                    // Sau khi t·∫•t c·∫£ c√°c l·∫ßn ki·ªÉm tra ho√†n t·∫•t, c·∫≠p nh·∫≠t visibility
                    checkoutButton.style.display = anyCompleted ? 'block' : 'none';
                });

                if (!snapshot.exists()) {
                    checkoutButton.style.display = 'none';
                }
            });
        }
        // >> END: H√ÄM KI·ªÇM TRA CHECKOUT ƒê√É C·∫¨P NH·∫¨T
// >> H√ÄM SHOW PAYMENT ƒê√É CH·ªàNH S·ª¨A L·∫†I LOGIC CH·ªêT ƒê∆†N V√Ä D√ôNG ASYNC/AWAIT (B·ªé VAT) <<
async function showPaymentModal(tableId, tableName) {
    const now = new Date();
    paymentModal.style.display = 'flex';
    billTableInfo.textContent = tableName;
    billDate.textContent = now.toLocaleDateString('vi-VN');
    billTime.textContent = now.toLocaleTimeString('vi-VN'); 
    
    // T·∫°m th·ªùi t·∫°o m√£ h√≥a ƒë∆°n
    const newBillRef = database.ref('payment_history').push();
    billId.textContent = newBillRef.key;
    
    billDetailsBody.innerHTML = '';
    
    let totalAmount = 0;
    // D√πng ƒë·ªÉ c·ªông d·ªìn c√°c m√≥n (Key: T√™n m√≥n + Gi√°)
    let combinedCompletedItems = {};
    const orderIdsForDeletion = new Set(); // Danh s√°ch Order ID c·∫ßn x√≥a kh·ªèi kitchen_bar_orders
    let hasCompletedItemsToPay = false;
    
    // 1. T·∫£i t·∫•t c·∫£ c√°c ƒë∆°n h√†ng t·ª´ kitchen_bar_orders theo T√™n B√†n
    const kitchenOrdersRef = database.ref('kitchen_bar_orders').orderByChild('tableName').equalTo(tableName);
    const kitchenOrdersSnapshot = await kitchenOrdersRef.once('value');
    
    if (kitchenOrdersSnapshot.exists()) {
        kitchenOrdersSnapshot.forEach(orderSnapshot => {
            const orderId = orderSnapshot.key;
            const order = orderSnapshot.val();
            
            // Th√™m OrderId v√†o danh s√°ch x√≥a (k·ªÉ c·∫£ nh·ªØng ƒë∆°n c√≥ m√≥n ch∆∞a ho√†n th√†nh, v√¨ ta c·∫ßn x√≥a to√†n b·ªô ƒë∆°n li√™n quan ƒë·∫øn b√†n)
            orderIdsForDeletion.add(orderId); 

            if (order.items) {
                // L·∫∑p qua c√°c m√≥n trong order
                Object.keys(order.items).forEach(itemId => {
                    const item = order.items[itemId];
                    
                    // CH·ªà T√çNH C√ÅC M√ìN C√ì TR·∫†NG TH√ÅI 'completed' T·ª™ KITCHEN_BAR_ORDERS
                    if (item && item.status === 'completed') {
                        hasCompletedItemsToPay = true;
                        
                        // kitchen_bar_orders d√πng item.itemName, ta s·ª≠ d·ª•ng n√≥ ƒë·ªÉ gom nh√≥m
                        const itemNameKey = item.itemName; 
                        const itemPrice = parseFloat(item.price);
                        const itemQuantity = item.quantity;
                        
                        if (itemPrice > 0) {
                            if (combinedCompletedItems[itemNameKey]) {
                                // C·ªông d·ªìn s·ªë l∆∞·ª£ng
                                combinedCompletedItems[itemNameKey].quantity += itemQuantity;
                            } else {
                                // Th√™m m√≥n m·ªõi
                                combinedCompletedItems[itemNameKey] = { 
                                    name: item.itemName, 
                                    quantity: itemQuantity,
                                    price: itemPrice, 
                                    type: item.type,
                                    // L∆∞u l·∫°i orderId ƒë·ªÉ tham chi·∫øu
                                    sourceOrderId: orderId
                                };
                            }
                            // C·ªông d·ªìn v√†o t·ªïng ti·ªÅn
                            totalAmount += (itemPrice * itemQuantity);
                        }
                    }
                });
            }
        });
    }

    // 2. B·∫Øt ƒë·∫ßu hi·ªÉn th·ªã h√≥a ƒë∆°n sau khi ƒë√£ t·ªïng h·ª£p xong
    let billItemsHtml = '';
    
    // T·ªïng ti·ªÅn thanh to√°n ch√≠nh l√† t·ªïng ti·ªÅn ch∆∞a thu·∫ø v√¨ ta kh√¥ng t√≠nh VAT
    const finalTotal = totalAmount; 
    
    if (hasCompletedItemsToPay) {
        // Bi·∫øn n√†y s·∫Ω ch·ª©a c√°c m√≥n ƒë√£ ƒë∆∞·ª£c c·ªông d·ªìn, d√πng ƒë·ªÉ l∆∞u v√†o payment_history
        const finalItemsForBill = []; 
        
        Object.values(combinedCompletedItems).forEach((item, index) => {
            const itemPrice = item.price; 
            const itemTotal = itemPrice * item.quantity;
            
            // Chu·∫©n b·ªã item ƒë·ªÉ l∆∞u v√†o payment_history
            finalItemsForBill.push({
                id: `aggregated-${index}`,
                name: item.name,
                price: item.price,
                quantity: item.quantity,
                type: item.type,
                subTotal: itemTotal
            });
            
            billItemsHtml += `
                <tr>
                    <td class="item-name" style="text-align: left;">${index + 1}. ${item.name}</td>
                    <td class="item-qty" style="text-align: center;">${item.quantity}</td>
                    <td class="item-price" style="text-align: right;">${itemPrice.toLocaleString('vi-VN')}</td>
                    <td class="item-total" style="text-align: right;">${itemTotal.toLocaleString('vi-VN')}</td>
                </tr>
            `;
        });

        // L∆∞u tr·ªØ d·ªØ li·ªáu c·∫ßn thi·∫øt cho h√†m processPayment
        window.tempPaymentData = {
            tableId: tableId,
            tableName: tableName,
            finalItemsForBill: finalItemsForBill, // ƒê√£ ƒë∆∞·ª£c c·ªông d·ªìn
            orderIdsToDelete: Array.from(orderIdsForDeletion), // Danh s√°ch OrderID c·∫ßn x√≥a
            totalAmount: totalAmount, // T·ªïng ti·ªÅn kh√¥ng thu·∫ø
            finalTotal: finalTotal, // T·ªïng ti·ªÅn thanh to√°n (b·∫±ng TotalAmount)
            billId: newBillRef.key
        };
        
    } else {
        billItemsHtml = '<tr><td colspan="4" style="text-align: center; font-style: italic;">Ch∆∞a c√≥ m√≥n n√†o ƒë∆∞·ª£c B·∫øp/Bar ho√†n th√†nh.</td></tr>';
        window.tempPaymentData = null; // ƒê·∫∑t null n·∫øu kh√¥ng c√≥ g√¨ ƒë·ªÉ thanh to√°n
    }

    billDetailsBody.innerHTML = billItemsHtml;
    
    billTotalPrice.textContent = totalAmount.toLocaleString('vi-VN') + '‚Ç´';
    billTotalPaid.textContent = finalTotal.toLocaleString('vi-VN') + '‚Ç´';
    
    // --- C·∫≠p nh·∫≠t VietQR ---
    const acqId = "970422"; // MB Bank Napas acqId
    const accountNo = "0909650816";
    
    let tableCode = tableName.replace(/[^a-zA-Z0-9]/g, '').toUpperCase(); 
    let fullBillCode = billId.textContent ? billId.textContent : ''; 
    let transferContent = `${tableCode}.${fullBillCode}`; 
    let qrUrl = `https://img.vietqr.io/image/${acqId}-${accountNo}-compact.png`;

    if (totalAmount > 0) {
        // C·∫≠p nh·∫≠t l·∫°i URL VietQR v·ªõi t·ªïng s·ªë ti·ªÅn v√† n·ªôi dung chuy·ªÉn kho·∫£n
        qrUrl = `https://img.vietqr.io/image/${acqId}-${accountNo}-compact.png?amount=${Math.round(finalTotal)}&addInfo=${encodeURIComponent(transferContent)}`;
        vietQrCode.src = qrUrl;
    } else {
        // ƒê·∫∑t QR code m·∫∑c ƒë·ªãnh n·∫øu t·ªïng ti·ªÅn = 0
        qrUrl = `https://img.vietqr.io/image/${acqId}-${accountNo}-compact.png?addInfo=${encodeURIComponent(transferContent)}`;
        vietQrCode.src = qrUrl;
    }

    // --- C·∫≠p nh·∫≠t n√∫t Thanh to√°n ---
    confirmPaymentButton.onclick = () => confirmPayment(tableId, tableName);
    if (totalAmount === 0) {
        confirmPaymentButton.style.display = 'none';
        printBillButton.style.display = 'none';
    } else {
        confirmPaymentButton.style.display = 'block';
        printBillButton.style.display = 'block';
    }
}
// >> END: CODE ƒê√É CH·ªàNH S·ª¨A CHO H√ÄM THANH TO√ÅN

        function generateBillId() {
            const now = new Date();
            const year = now.getFullYear().toString().slice(-2);
            const month = (now.getMonth() + 1).toString().padStart(2, '0');
            const day = now.getDate().toString().padStart(2, '0');
            const hour = now.getHours().toString().padStart(2, '0');
            const minute = now.getMinutes().toString().padStart(2, '0');
            const second = now.getSeconds().toString().padStart(2, '0');
            return `HD${year}${month}${day}${hour}${minute}${second}`;
        }
        
 // >> CODE S·ª¨A H√ÄM confirmPayment (B·ªé VAT)
async function confirmPayment(tableId, tableName) {
    // 1. L·∫•y d·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c t√≠nh to√°n trong showPaymentModal
    const paymentData = window.tempPaymentData;

    if (!paymentData || !paymentData.finalItemsForBill || paymentData.finalItemsForBill.length === 0) {
        alert("Kh√¥ng c√≥ m√≥n ƒÉn n√†o ƒë√£ ho√†n th√†nh ƒë·ªÉ thanh to√°n.");
        return;
    }
    
    // L·∫•y c√°c gi√° tr·ªã ƒë√£ ƒë∆∞·ª£c t√≠nh to√°n
    const { 
        finalItemsForBill, 
        orderIdsToDelete, // Danh s√°ch Order ID c·∫ßn x√≥a
        totalAmount, 
        finalTotal, // ƒê√£ l√† TotalAmount v√¨ kh√¥ng c√≥ VAT
        billId: billKey
    } = paymentData;

    const updates = {};
    const paymentTimestamp = new Date().toISOString();
    
    // 2. X√≥a t·∫•t c·∫£ c√°c ƒë∆°n h√†ng li√™n quan ƒë·∫øn b√†n n√†y kh·ªèi kitchen_bar_orders
    // ƒê√¢y l√† b∆∞·ªõc quan tr·ªçng nh·∫•t ƒë·ªÉ x√≥a ƒë∆°n QR Code v√† ƒë∆°n ƒë√£ g·ª≠i
    orderIdsToDelete.forEach(orderId => {
        updates[`kitchen_bar_orders/${orderId}`] = null; 
    });

    // 3. X√≥a ƒë∆°n h√†ng kh·ªèi tables/{tableId}/sentOrders (ƒê·∫£m b·∫£o d·ªçn d·∫πp nh√°nh n√†y, n·∫øu n√≥ c√≤n t·ªìn t·∫°i)
    updates[`tables/${tableId}/sentOrders`] = null; 

    // 4. L∆∞u h√≥a ƒë∆°n v√†o payment_history
    updates[`payment_history/${billKey}`] = {
        billId: billKey,
        tableId: tableId,
        tableName: tableName,
        timestamp: paymentTimestamp,
        items: finalItemsForBill, // ƒê√£ ƒë∆∞·ª£c gom nh√≥m v√† t√≠nh to√°n
        totalAmount: totalAmount,
        // vatAmount: 0, // B·ªè h·∫≥n ho·∫∑c g√°n = 0 n·∫øu c·∫ßn schema
        finalTotal: finalTotal // B·∫±ng totalAmount
    };

    // 5. C·∫≠p nh·∫≠t tr·∫°ng th√°i b√†n v·ªÅ 'available' sau khi ƒë√£ thanh to√°n
    updates[`tables/${tableId}/status`] = 'available';

    // 6. Th·ª±c hi·ªán c√°c c·∫≠p nh·∫≠t l√™n Firebase
    database.ref().update(updates).then(() => {
        alert('Thanh to√°n th√†nh c√¥ng!');
        paymentModal.style.display = 'none';
        
        // D·ªçn d·∫πp d·ªØ li·ªáu t·∫°m
        delete window.tempPaymentData; 
        
        // --- START: TH√äM L·ªÜNH M·ªû K√âT TI·ªÄN (S·ª¨ D·ª§NG fetch) ---
        fetch(OPEN_CASH_URL, {
            method: 'POST',
            mode: 'no-cors' // C·∫ßn thi·∫øt n·∫øu API kh√¥ng c√≥ CORS headers
        }).then(response => {
            // Do mode: 'no-cors', response.ok lu√¥n l√† false, n√™n ch·ªâ c·∫ßn log l√† ƒë∆∞·ª£c
            console.log("ƒê√£ g·ª≠i y√™u c·∫ßu m·ªü k√©t ti·ªÅn:", OPEN_CASH_URL);
        }).catch(error => {
            console.error("L·ªói khi g·ª≠i y√™u c·∫ßu m·ªü k√©t ti·ªÅn:", error);
            // C√≥ th·ªÉ th√™m th√¥ng b√°o l·ªói nh·∫π ·ªü ƒë√¢y n·∫øu mu·ªën
        });
        // --- END: TH√äM L·ªÜNH M·ªû K√âT TI·ªÄN ---
        
    }).catch(error => {
        console.error("L·ªói khi thanh to√°n:", error);
    });
}
// >> END: CODE S·ª¨A H√ÄM confirmPayment
        
        // --- Print Bill Functionality ---
        printBillButton.addEventListener('click', () => {
            window.print(); 
        });
        
        closeButton.onclick = () => paymentModal.style.display = 'none';
        window.onclick = (event) => {
            if (event.target == paymentModal) {
                paymentModal.style.display = 'none';
            }
        };

        document.addEventListener('DOMContentLoaded', () => {
            // FIX: Thi·∫øt l·∫≠p listener Firebase cho danh s√°ch b√†n ch·ªâ 1 L·∫¶N DUY NH·∫§T khi ·ª©ng d·ª•ng kh·ªüi ƒë·ªông.
            database.ref('tables').on('value', renderTables);
        });
    </script>
</body>
</html>
