<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Quản lý Menu & Kho</title>
    
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        :root {
            --ios-bg: #F2F2F7;
            --ios-card: #FFFFFF;
            --ios-blue: #007AFF;
            --ios-red: #FF3B30;
            --ios-green: #34C759;
            --ios-gray: #8E8E93;
            --ios-gray-light: #E5E5EA;
            --ios-separator: #C6C6C8;
            --safe-area-top: env(safe-area-inset-top, 20px);
            --safe-area-bottom: env(safe-area-inset-bottom, 20px);
        }

        /* --- RESET & BASE --- */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            background-color: var(--ios-bg);
            color: #000;
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 0;
            padding-top: calc(50px + var(--safe-area-top)); 
            padding-bottom: calc(85px + var(--safe-area-bottom)); 
            height: 100vh;
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
        }

        /* --- ANIMATIONS --- */
        @keyframes pulse {
            0% { transform: scale(1); box-shadow: 0 4px 12px rgba(0,122,255,0.4); }
            50% { transform: scale(1.05); box-shadow: 0 6px 20px rgba(0,122,255,0.6); }
            100% { transform: scale(1); box-shadow: 0 4px 12px rgba(0,122,255,0.4); }
        }

        /* --- NAVIGATION BAR --- */
        header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: calc(50px + var(--safe-area-top));
            padding-top: var(--safe-area-top);
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: saturate(180%) blur(20px);
            -webkit-backdrop-filter: saturate(180%) blur(20px);
            border-bottom: 0.5px solid rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        /* Nút Ghi chú nổi */
        .note-trigger {
            position: fixed;
            right: 20px;
            bottom: calc(70px + var(--safe-area-bottom));
            width: 56px;
            height: 56px;
            background: var(--ios-blue);
            border-radius: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            z-index: 1500;
            cursor: pointer;
            animation: pulse 3s infinite ease-in-out;
            transition: transform 0.2s;
        }
        .note-trigger:active { transform: scale(0.9); }

        h1 { font-size: 17px; font-weight: 600; margin: 0; color: #000; display: flex; align-items: center; gap: 6px; }

        /* --- TAB BAR --- */
        .tab-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: calc(50px + var(--safe-area-bottom));
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-top: 0.5px solid rgba(0,0,0,0.15);
            display: flex;
            justify-content: space-around;
            padding-bottom: var(--safe-area-bottom);
            z-index: 1000;
        }

        .tab-bar button {
            background: transparent !important;
            color: var(--ios-gray);
            font-size: 10px;
            font-weight: 500;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border: none;
            padding: 5px 0;
            width: 33%;
            margin: 0 !important;
            transition: all 0.2s;
        }

        .tab-bar button.active {
            color: var(--ios-blue);
        }

        .tab-bar button i {
            margin-bottom: 2px;
            transition: transform 0.2s;
        }
        .tab-bar button:active i { transform: scale(1.2); }

        /* --- MODAL GHI CHÚ --- */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 3000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }
        .modal-overlay.active { opacity: 1; pointer-events: auto; }

        .note-modal {
            width: 90%;
            max-width: 400px;
            background: var(--ios-card);
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            max-height: 80vh;
            display: flex;
            flex-direction: column;
        }

        .note-modal h2 { font-size: 20px; margin-top: 0; display: flex; align-items: center; gap: 8px; }
        
        .note-input-area textarea {
            width: 100%;
            height: 80px;
            border-radius: 12px;
            background: var(--ios-gray-light);
            border: none;
            padding: 12px;
            font-family: inherit;
            font-size: 16px;
            margin-bottom: 10px;
            resize: none;
        }

        .note-list {
            flex: 1;
            overflow-y: auto;
            margin-top: 15px;
            border-top: 0.5px solid var(--ios-separator);
            padding-top: 10px;
        }

        .note-item {
            padding: 10px;
            border-bottom: 0.5px solid var(--ios-separator);
            position: relative;
        }

        .note-item .time { font-size: 11px; color: var(--ios-gray); display: block; margin-bottom: 4px; }
        .note-item .text { font-size: 15px; color: #333; line-height: 1.4; }
        .note-item .delete-note { color: var(--ios-red); font-size: 12px; margin-top: 5px; cursor: pointer; float: right; display: flex; align-items: center; gap: 3px; }

        /* --- OLD STYLES RE-USED --- */
        .box { background: var(--ios-card); border-radius: 20px; padding: 20px; margin: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.03); }
        h2 { font-size: 28px; font-weight: 700; margin: 10px 0 20px 0; }
        h3 { font-size: 13px; font-weight: 600; text-transform: uppercase; color: var(--ios-gray); margin: 25px 0 10px 10px; }
        
        .search-container { position: relative; width: 100%; margin-bottom: 15px; }
        .search-container i { position: absolute; left: 12px; top: 12px; color: var(--ios-gray); width: 18px; height: 18px; }
        .search-container input { padding-left: 40px !important; margin-bottom: 0 !important; }

        input[type="text"], input[type="number"], select { width: 100%; height: 44px; padding: 0 15px; background: var(--ios-gray-light); border: none; border-radius: 12px; font-size: 17px; margin-bottom: 15px; }
        
        button:not(.tab-bar button):not(.small-btn):not(.btn-delete-item):not(.btn-edit-item) { 
            width: 100%; padding: 14px; background: var(--ios-blue); color: white; font-size: 17px; font-weight: 600; 
            border-radius: 14px; margin-bottom: 12px; border: none; display: flex; align-items: center; justify-content: center; gap: 8px;
            transition: opacity 0.2s;
        }
        button:active { opacity: 0.7; }

        ul { background: var(--ios-card); border-radius: 16px; overflow: hidden; margin: 0; padding: 0; }
        li { padding: 16px; background: #fff; border-bottom: 0.5px solid var(--ios-separator); display: flex; justify-content: space-between; align-items: center; }
        .hidden { display: none !important; }
        .recipe-qty-unit-group { display: flex; align-items: center; gap: 5px; }
        #recipeFormSection { position: fixed; top: var(--safe-area-top); left: 0; right: 0; bottom: 0; z-index: 2000; background: #fff; overflow-y: auto; padding: 20px; }
        .log-console { background: #000; color: #0f0; font-family: monospace; padding: 15px; border-radius: 12px; font-size: 12px; margin-top: 20px; }
        
        .btn-delete-item {
            background-color: var(--ios-red) !important;
            width: auto !important;
            padding: 6px 10px !important;
            font-size: 13px !important;
            margin: 0 !important;
            border-radius: 8px !important;
            color: white; border: none;
            display: flex; align-items: center; gap: 4px;
        }

        .btn-edit-item {
            background-color: var(--ios-blue) !important;
            width: auto !important;
            padding: 6px 10px !important;
            font-size: 13px !important;
            margin: 0 5px 0 0 !important;
            border-radius: 8px !important;
            color: white; border: none;
            display: flex; align-items: center; gap: 4px;
        }

        .action-group {
            display: flex;
            align-items: center;
        }
    </style>
</head>
<body>

    <header>
        <h1><i data-lucide="chef-hat" style="width: 20px;"></i> Quản Lý Bếp</h1>
    </header>

    <div class="note-trigger" id="btnOpenNote">
        <i data-lucide="pencil-line"></i>
    </div>

    <div class="modal-overlay" id="noteModalOverlay">
        <div class="note-modal">
            <h2><i data-lucide="sticky-note"></i> Ghi chú nhanh</h2>
            <div class="note-input-area">
                <textarea id="noteContent" placeholder="Nhập nội dung ghi chú..."></textarea>
                <button id="btnSaveNote" style="margin-bottom: 5px;">
                    <i data-lucide="save" style="width: 18px;"></i> Lưu ghi chú
                </button>
                <button id="btnCloseNote" style="background: var(--ios-gray-light) !important; color: var(--ios-blue) !important;">Đóng</button>
            </div>
            <div class="note-list" id="noteList"></div>
        </div>
    </div>

    <div class="tab-bar">
        <button id="btnShowMenu" class="active">
            <i data-lucide="utensils-crossbars"></i>
            <span>Menu</span>
        </button>
        <button id="btnIngredient">
            <i data-lucide="package"></i>
            <span>Kho</span>
        </button>
        <button id="btnShowTest">
            <i data-lucide="flask-conical"></i>
            <span>Test</span>
        </button>
    </div>

    <div class="main-content">
        <div id="menuSection" class="box">
            <h2>Món Ăn</h2>
            <div class="search-container">
                <i data-lucide="search"></i>
                <input type="text" id="menuSearchInput" placeholder="Tìm kiếm món ăn...">
            </div>
            <button id="btnToggleAddMenuForm">
                <i data-lucide="plus-circle"></i> Thêm món ăn mới
            </button> 
            <div id="menuFormContainer" class="hidden" style="background: var(--ios-gray-light); padding: 16px; border-radius: 12px; margin-top: 15px; margin-bottom: 20px;">
                <label class="label">Tên món ăn</label>
                <input type="text" id="menuName" placeholder="Ví dụ: Phở Bò">
                <label class="label">Loại</label>
                <select id="menuType"><option value="food">Food</option><option value="drink">Drink</option></select>
                <button id="btnAddMenu"><i data-lucide="save" style="width:18px"></i> Lưu Món Ăn</button>
                <button id="btnCancelMenuEdit" style="background:none; color:var(--ios-blue);">Hủy</button> 
            </div>
            <h3>Food</h3><ul id="foodList"></ul>
            <h3>Drink</h3><ul id="drinkList"></ul>
        </div>

        <div id="ingredientSection" class="hidden box">
            <h2>Nguyên Liệu</h2>
            <div class="search-container">
                <i data-lucide="search"></i>
                <input type="text" id="ingredientSearchInput" placeholder="Tìm kiếm...">
            </div>
            <button id="btnToggleAddForm">
                <i data-lucide="plus-circle"></i> Thêm nguyên liệu
            </button> 
            <div id="ingredientFormContainer" class="hidden" style="background: var(--ios-gray-light); padding: 16px; border-radius: 12px; margin-top: 15px;">
                <input type="text" id="ingName" placeholder="Tên nguyên liệu">
                <input type="number" id="ingQty" placeholder="Số lượng">
                <select id="ingUnit">
                    <option value="kg">kg</option>
                    <option value="g">g</option>
                    <option value="con">con</option>
                    <option value="trái">trái</option>
                    <option value="cái">cái</option>
                    <option value="hộp">hộp</option>
                    <option value="lon">lon</option>
                    <option value="chai">chai</option>
                    <option value="thùng">thùng</option>
                    <option value="ml">ml</option>
                    <option value="lít">lít</option>
                    <option value="can">can</option>
                    <option value="gói">gói</option>
                </select>
                <input type="number" id="ingMinQty" placeholder="SL tối thiểu">
                <button id="btnAddIngredient"><i data-lucide="save" style="width:18px"></i> Lưu</button>
                <button id="btnCancelEdit" style="background:none; color:var(--ios-blue);">Hủy</button> 
            </div>
            <h3>Danh sách kho</h3>
            <ul id="ingredientList"></ul>
        </div>

        <div id="testSection" class="hidden box">
            <h2>Test Trừ Kho</h2>
            <input type="text" id="testDishName" list="dishSuggestions" placeholder="Tên món ăn...">
            <datalist id="dishSuggestions"></datalist>
            <input type="number" id="testDishQty" value="1">
            <button id="btnRunTest" style="background: var(--ios-green) !important;">
                <i data-lucide="play-circle"></i> Chạy Trừ Kho
            </button>
            <div id="testLog" class="hidden log-console"></div>
        </div>

        <div id="recipeFormSection" class="hidden">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h2 id="recipeTitle" style="margin:0">Công thức</h2>
                <button id="btnCloseRecipe" style="width: auto; padding: 8px 16px;">Đóng</button>
            </div>
            <hr>
            <h3>Định lượng hiện tại</h3>
            <ul id="currentRecipeList"></ul>
            <h3>Điều chỉnh</h3>
            <div class="search-container">
                <i data-lucide="search"></i>
                <input type="text" id="recipeIngredientSearchInput" placeholder="Tìm nguyên liệu...">
            </div>
            <div id="recipeIngredients"></div>
            <button id="btnSaveRecipe" style="margin-top:20px;">
                <i data-lucide="save"></i> Lưu Công Thức
            </button>
        </div>
    </div>

    <script type="module">
        const firebaseConfig = {
            apiKey: "AIzaSyB8uLkLJFlzmCodcawJhs2dRckHQzO5y10",
            authDomain: "chitieu-7263e.firebaseapp.com",
            databaseURL: "https://chitieu-7263e-default-rtdb.firebaseio.com",
            projectId: "chitieu-7263e",
            storageBucket: "chitieu-7263e.firebasestorage.app",
            messagingSenderId: "83833140682",
            appId: "1:83833140682:web:f9254b418ace3a659fcb33",
            measurementId: "G-523X74K18N"
        };

        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
        import { getDatabase, ref, push, set, onValue, get, remove, update } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // Khởi tạo Lucide
        lucide.createIcons();

        // --- GHI CHÚ LOGIC ---
        const btnOpenNote = document.getElementById("btnOpenNote");
        const btnCloseNote = document.getElementById("btnCloseNote");
        const btnSaveNote = document.getElementById("btnSaveNote");
        const noteModalOverlay = document.getElementById("noteModalOverlay");
        const noteContent = document.getElementById("noteContent");
        const noteList = document.getElementById("noteList");

        btnOpenNote.addEventListener("click", () => noteModalOverlay.classList.add("active"));
        btnCloseNote.addEventListener("click", () => noteModalOverlay.classList.remove("active"));
        
        btnSaveNote.addEventListener("click", () => {
            const text = noteContent.value.trim();
            if (!text) return;
            const now = new Date();
            const timeStr = `${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')} - ${now.getDate()}/${now.getMonth()+1}`;
            
            push(ref(db, "notes"), {
                text: text,
                time: timeStr,
                timestamp: Date.now()
            }).then(() => {
                noteContent.value = "";
            });
        });

        onValue(ref(db, "notes"), (snap) => {
            noteList.innerHTML = "";
            const data = snap.val();
            if (data) {
                const sortedKeys = Object.keys(data).sort((a,b) => data[b].timestamp - data[a].timestamp);
                sortedKeys.forEach(key => {
                    const item = data[key];
                    const div = document.createElement("div");
                    div.className = "note-item";
                    div.innerHTML = `
                        <span class="time">${item.time}</span>
                        <div class="text">${item.text}</div>
                        <span class="delete-note" data-id="${key}"><i data-lucide="trash-2" style="width:12px"></i> Xóa</span>
                    `;
                    div.querySelector(".delete-note").onclick = () => {
                        if(confirm("Xóa ghi chú này?")) remove(ref(db, `notes/${key}`));
                    };
                    noteList.appendChild(div);
                });
                lucide.createIcons();
            }
        });

        // --- NAVIGATION ---
        const tabs = document.querySelectorAll(".tab-bar button");
        const sections = {
            btnShowMenu: document.getElementById("menuSection"),
            btnIngredient: document.getElementById("ingredientSection"),
            btnShowTest: document.getElementById("testSection")
        };

        tabs.forEach(tab => {
            tab.addEventListener("click", () => {
                tabs.forEach(t => t.classList.remove("active"));
                tab.classList.add("active");
                Object.values(sections).forEach(s => s.classList.add("hidden"));
                document.getElementById("recipeFormSection").classList.add("hidden");
                sections[tab.id].classList.remove("hidden");
                if(tab.id === "btnShowTest") updateDishSuggestions();
            });
        });

        // State & Ingredients
        let allIngredients = {};
        let allFoodData = {};
        let allDrinkData = {};
        let currentRecipe = { id: null, name: null };
        let editingIngId = null;

        // --- TÌM KIẾM NGUYÊN LIỆU ---
        const ingredientSearchInput = document.getElementById("ingredientSearchInput");
        ingredientSearchInput.oninput = () => renderIngredients();

        onValue(ref(db, "ingredients"), snap => {
            allIngredients = snap.val() || {};
            renderIngredients();
        });

        function renderIngredients() {
            const list = document.getElementById("ingredientList");
            const searchTerm = ingredientSearchInput.value.toLowerCase();
            list.innerHTML = "";
            
            Object.keys(allIngredients).forEach(id => {
                const item = allIngredients[id];
                if (item.name.toLowerCase().includes(searchTerm)) {
                    const li = document.createElement("li");
                    li.innerHTML = `<div><b>${item.name}</b><br><small>${item.qty} ${item.unit}</small></div>`;
                    
                    const actionGroup = document.createElement("div");
                    actionGroup.className = "action-group";

                    const btnEdit = document.createElement("button");
                    btnEdit.innerHTML = `<i data-lucide="edit-3" style="width:14px"></i> Sửa`;
                    btnEdit.className = "btn-edit-item";
                    btnEdit.onclick = () => editIngredient(id, item);

                    const btnDel = document.createElement("button");
                    btnDel.innerHTML = `<i data-lucide="trash-2" style="width:14px"></i> Xóa`;
                    btnDel.className = "btn-delete-item";
                    btnDel.onclick = () => {
                        if(confirm(`Xóa nguyên liệu "${item.name}"?`)) remove(ref(db, `ingredients/${id}`));
                    }

                    actionGroup.appendChild(btnEdit);
                    actionGroup.appendChild(btnDel);
                    li.appendChild(actionGroup);
                    list.appendChild(li);
                }
            });
            lucide.createIcons();
        }

        function editIngredient(id, data) {
            editingIngId = id;
            document.getElementById("ingName").value = data.name;
            document.getElementById("ingQty").value = data.qty;
            document.getElementById("ingUnit").value = data.unit;
            document.getElementById("ingMinQty").value = data.minQty || 0;
            
            document.getElementById("btnAddIngredient").innerHTML = `<i data-lucide="refresh-cw" style="width:18px"></i> Cập nhật`;
            document.getElementById("ingredientFormContainer").classList.remove("hidden");
            window.scrollTo({ top: 0, behavior: 'smooth' });
            lucide.createIcons();
        }

        function resetIngForm() {
            editingIngId = null;
            document.getElementById("ingName").value = "";
            document.getElementById("ingQty").value = "";
            document.getElementById("ingMinQty").value = "";
            document.getElementById("btnAddIngredient").innerHTML = `<i data-lucide="save" style="width:18px"></i> Lưu`;
            document.getElementById("ingredientFormContainer").classList.add("hidden");
            lucide.createIcons();
        }

        document.getElementById("btnAddIngredient").onclick = () => {
            const data = {
                name: document.getElementById("ingName").value,
                qty: Number(document.getElementById("ingQty").value),
                unit: document.getElementById("ingUnit").value,
                minQty: Number(document.getElementById("ingMinQty").value)
            };
            
            if (editingIngId) {
                set(ref(db, `ingredients/${editingIngId}`), data).then(() => {
                    alert("Đã cập nhật!");
                    resetIngForm();
                });
            } else {
                push(ref(db, "ingredients"), data).then(() => {
                    resetIngForm();
                });
            }
        };

        document.getElementById("btnCancelEdit").onclick = () => resetIngForm();

        // --- TÌM KIẾM MENU ---
        const menuSearchInput = document.getElementById("menuSearchInput");
        menuSearchInput.oninput = () => {
            renderMenu("foodList", allFoodData);
            renderMenu("drinkList", allDrinkData);
        };

        onValue(ref(db, "menu/food"), snap => { allFoodData = snap.val() || {}; renderMenu("foodList", allFoodData); });
        onValue(ref(db, "menu/drink"), snap => { allDrinkData = snap.val() || {}; renderMenu("drinkList", allDrinkData); });

        function renderMenu(elementId, data) {
            const list = document.getElementById(elementId);
            const searchTerm = menuSearchInput.value.toLowerCase();
            list.innerHTML = "";
            const type = elementId === "foodList" ? "food" : "drink";

            Object.keys(data).forEach(id => {
                const item = data[id];
                if (item.name.toLowerCase().includes(searchTerm)) {
                    const li = document.createElement("li");
                    const nameSpan = document.createElement("span");
                    nameSpan.textContent = item.name;
                    nameSpan.style.flex = "1";
                    nameSpan.style.cursor = "pointer";
                    nameSpan.onclick = () => openRecipe(id, item.name);
                    
                    const btnDel = document.createElement("button");
                    btnDel.innerHTML = `<i data-lucide="trash-2" style="width:14px"></i> Xóa`;
                    btnDel.className = "btn-delete-item";
                    btnDel.onclick = (e) => {
                        e.stopPropagation();
                        if(confirm(`Xóa món "${item.name}" khỏi menu?`)) {
                            remove(ref(db, `menu/${type}/${id}`));
                        }
                    };

                    li.appendChild(nameSpan);
                    li.appendChild(btnDel);
                    list.appendChild(li);
                }
            });
            lucide.createIcons();
        }

        document.getElementById("btnAddMenu").onclick = () => {
            const type = document.getElementById("menuType").value;
            const name = document.getElementById("menuName").value;
            if(!name) return;
            push(ref(db, `menu/${type}`), { name: name });
            document.getElementById("menuName").value = "";
            document.getElementById("menuFormContainer").classList.add("hidden");
        };

        async function openRecipe(id, name) {
            currentRecipe = { id, name };
            // Ẩn tất cả section
            Object.values(sections).forEach(s => s.classList.add("hidden"));
            document.getElementById("recipeFormSection").classList.remove("hidden");
            document.getElementById("recipeTitle").textContent = "Công thức: " + name;
            
            const snap = await get(ref(db, `recipes/${name}`));
            const existing = snap.val() || {};
            
            const currentList = document.getElementById("currentRecipeList");
            currentList.innerHTML = "";
            Object.keys(existing).forEach(ingId => {
                const item = existing[ingId];
                const li = document.createElement("li");
                li.textContent = `${item.name}: ${item.qty} ${item.unit}`;
                currentList.appendChild(li);
            });

            const editArea = document.getElementById("recipeIngredients");
            editArea.innerHTML = "";
            Object.keys(allIngredients).forEach(ingId => {
                const ing = allIngredients[ingId];
                const div = document.createElement("div");
                div.className = "recipe-qty-unit-group";
                div.style.margin = "10px 0";
                div.innerHTML = `
                    <span style="flex:1">${ing.name}</span>
                    <input type="number" style="width:70px; margin:0" data-id="${ingId}" value="${existing[ingId]?.qty || ''}">
                    <span>${ing.unit}</span>
                `;
                editArea.appendChild(div);
            });
            lucide.createIcons();
        }

        document.getElementById("btnSaveRecipe").onclick = () => {
            const inputs = document.querySelectorAll("#recipeIngredients input");
            const recipeData = {};
            inputs.forEach(input => {
                const val = Number(input.value);
                if (val > 0) {
                    const ingId = input.dataset.id;
                    recipeData[ingId] = {
                        name: allIngredients[ingId].name,
                        qty: val,
                        unit: allIngredients[ingId].unit
                    };
                }
            });
            set(ref(db, `recipes/${currentRecipe.name}`), recipeData).then(() => alert("Đã lưu!"));
        };

        document.getElementById("btnCloseRecipe").onclick = () => { 
            document.getElementById("recipeFormSection").classList.add("hidden"); 
            document.getElementById("menuSection").classList.remove("hidden"); 
        };

        function updateDishSuggestions() {
            const dl = document.getElementById("dishSuggestions");
            dl.innerHTML = "";
            [...Object.values(allFoodData), ...Object.values(allDrinkData)].forEach(m => {
                const opt = document.createElement("option");
                opt.value = m.name;
                dl.appendChild(opt);
            });
        }

        document.getElementById("btnRunTest").onclick = async () => {
            const name = document.getElementById("testDishName").value;
            const orderQty = Number(document.getElementById("testDishQty").value);
            const log = document.getElementById("testLog");
            log.classList.remove("hidden");
            log.innerHTML = "Đang tính toán...";

            const snap = await get(ref(db, `recipes/${name}`));
            if (!snap.exists()) { log.innerHTML = "Không thấy công thức!"; return; }

            const recipe = snap.val();
            const updates = {};
            let logTxt = `Trừ kho món ${name}:<br>`;

            for (let ingId in recipe) {
                const req = recipe[ingId].qty * orderQty;
                const currentStock = allIngredients[ingId].qty;
                updates[`ingredients/${ingId}/qty`] = currentStock - req;
                logTxt += `- ${recipe[ingId].name}: ${currentStock} -> ${currentStock - req}<br>`;
            }

            update(ref(db), updates).then(() => {
                log.innerHTML = logTxt + "<b>Thành công!</b>";
            });
        };

        // UI Toggles
        document.getElementById("btnToggleAddMenuForm").onclick = () => document.getElementById("menuFormContainer").classList.toggle("hidden");
        document.getElementById("btnToggleAddForm").onclick = () => {
            resetIngForm();
            document.getElementById("ingredientFormContainer").classList.toggle("hidden");
        };
        document.getElementById("btnCancelMenuEdit").onclick = () => document.getElementById("menuFormContainer").classList.add("hidden");

    </script>
</body>
</html>
