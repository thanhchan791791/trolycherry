<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Ví Tài Chính Pro - Detail</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        :root {
            --ios-bg: #F2F2F7;
            --ios-card: #FFFFFF;
            --ios-blue: #007AFF;
            --ios-red: #FF3B30;
            --ios-green: #34C759;
            --ios-gray: #8E8E93;
            --ios-separator: #E5E5EA;
            --safe-area-bottom: env(safe-area-inset-bottom, 20px);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", sans-serif;
            background: var(--ios-bg);
            margin: 0;
            color: #000;
            overflow: hidden;
            height: 100vh;
        }

        /* --- DASHBOARD TRUNG TÂM --- */
        .dashboard {
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            text-align: center;
        }

        .main-balance-label {
            font-size: 14px;
            color: var(--ios-gray);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }

        .main-balance-value {
            font-size: 48px;
            font-weight: 800;
            letter-spacing: -1px;
            margin-bottom: 10px;
        }

        .profit-loss-container {
            font-size: 20px;
            font-weight: 600;
            padding: 8px 20px;
            border-radius: 20px;
            background: rgba(255,255,255,0.5);
            margin-bottom: 40px;
        }

        /* --- NÚT BẤM TỐI GIẢN --- */
        .action-grid {
            display: flex;
            gap: 30px;
            margin-bottom: 50px;
        }

        .btn-action {
            width: 70px;
            height: 70px;
            border-radius: 35px;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
            transition: transform 0.2s;
            cursor: pointer;
        }

        .btn-action:active { transform: scale(0.9); }
        .btn-thu { background: var(--ios-green); }
        .btn-chi { background: var(--ios-red); }

        /* --- NÚT LỊCH SỬ --- */
        .history-trigger {
            position: fixed;
            bottom: calc(30px + var(--safe-area-bottom));
            display: flex;
            flex-direction: column;
            align-items: center;
            color: var(--ios-blue);
            cursor: pointer;
            font-weight: 600;
            font-size: 13px;
            gap: 5px;
        }

        /* --- BẢNG LỊCH SỬ TRƯỢT (SLIDE SHEET) --- */
        .slide-sheet {
            position: fixed;
            bottom: 0; left: 0; right: 0;
            height: 85vh;
            background: var(--ios-card);
            border-radius: 30px 30px 0 0;
            box-shadow: 0 -10px 40px rgba(0,0,0,0.15);
            z-index: 2000;
            transform: translateY(100%);
            transition: transform 0.4s cubic-bezier(0.25, 1, 0.5, 1);
            display: flex;
            flex-direction: column;
        }

        .slide-sheet.open { transform: translateY(0); }

        .sheet-header {
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 0.5px solid var(--ios-separator);
        }

        .sheet-handle {
            width: 40px; height: 5px; background: #D1D1D6; border-radius: 3px;
            margin: 10px auto;
        }

        .sheet-content {
            flex: 1;
            overflow-y: auto;
            padding: 10px 20px 40px 20px;
        }

        /* --- ITEM LỊCH SỬ --- */
        .daily-item {
            padding: 18px;
            background: #F9F9F9;
            border-radius: 18px;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: background 0.2s;
        }
        .daily-item:active { background: #E5E5EA; }

        .item-date { font-weight: 700; font-size: 17px; }
        .item-amounts { text-align: right; font-size: 14px; }

        /* --- CHI TIẾT GIAO DỊCH --- */
        .detail-row {
            padding: 15px 0;
            border-bottom: 0.5px solid var(--ios-separator);
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }
        .detail-info { flex: 1; }
        .detail-note { font-size: 14px; color: var(--ios-gray); margin-top: 4px; }
        .detail-amount { font-weight: 600; font-size: 16px; }

        /* --- FORM NHẬP LIỆU --- */
        #inputOverlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5); backdrop-filter: blur(5px);
            z-index: 3000; opacity: 0; visibility: hidden; transition: 0.3s;
            display: flex; align-items: center; justify-content: center;
        }
        #inputOverlay.show { opacity: 1; visibility: visible; }

        .form-card {
            width: 90%; max-width: 350px; background: #fff; border-radius: 25px; padding: 25px;
            transform: scale(0.9); transition: 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        #inputOverlay.show .form-card { transform: scale(1); }

        input, textarea {
            width: 100%; padding: 15px; margin-bottom: 15px; border-radius: 12px;
            border: 1px solid #E5E5EA; background: #F9F9F9; font-size: 16px; box-sizing: border-box;
        }

        #saveBtn {
            width: 100%; padding: 15px; border-radius: 12px; border: none;
            background: var(--ios-blue); color: #fff; font-size: 17px; font-weight: 600;
        }

    </style>
</head>
<body>

    <div class="dashboard">
        <div class="main-balance-label">Tổng số dư</div>
        <div id="sodu-value" class="main-balance-value">0 đ</div>
        
        <div id="profit-container" class="profit-loss-container">
            Lời/Lỗ: <span id="loi-lo-value">0 đ</span>
        </div>

        <div class="action-grid">
            <button class="btn-action btn-thu" onclick="openForm('thu')">
                <i data-lucide="plus" style="width: 35px; height: 35px;"></i>
            </button>
            <button class="btn-action btn-chi" onclick="openForm('chi')">
                <i data-lucide="minus" style="width: 35px; height: 35px;"></i>
            </button>
        </div>

        <div class="history-trigger" onclick="toggleHistory(true)">
            <i data-lucide="history" style="width: 28px; height: 28px;"></i>
            Lịch sử giao dịch
        </div>
    </div>

    <div id="historySheet" class="slide-sheet">
        <div class="sheet-handle"></div>
        <div class="sheet-header">
            <h3 style="margin:0">Lịch sử</h3>
            <button onclick="toggleHistory(false)" style="border:none; background:none; color:var(--ios-blue); font-size: 16px; font-weight: 600;">Đóng</button>
        </div>
        <div class="sheet-content" id="historyContent"></div>
    </div>

    <div id="detailSheet" class="slide-sheet" style="z-index: 2100;">
        <div class="sheet-handle"></div>
        <div class="sheet-header">
            <button onclick="toggleDetail(false)" style="border:none; background:none; color:var(--ios-blue); display:flex; align-items:center; gap:5px; font-size: 16px; font-weight: 600;">
                <i data-lucide="chevron-left"></i> Quay lại
            </button>
            <h3 id="detailDateTitle" style="margin:0">Chi tiết</h3>
            <div style="width:60px"></div>
        </div>
        <div class="sheet-content" id="detailContent"></div>
    </div>

    <div id="inputOverlay" onclick="if(event.target === this) closeForm()">
        <div class="form-card">
            <h2 id="formTitle" style="margin-top:0"></h2>
            <input type="date" id="ngay">
            <input type="text" id="sotien" placeholder="Số tiền" oninput="formatNumber(this)" inputmode="numeric">
            <textarea id="chitiet" placeholder="Ghi chú..."></textarea>
            <button id="saveBtn" onclick="saveData()">Lưu giao dịch</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, push, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB8uLkLJFlzmCodcawJhs2dRckHQzO5y10",
            authDomain: "chitieu-7263e.firebaseapp.com",
            databaseURL: "https://chitieu-7263e-default-rtdb.firebaseio.com",
            projectId: "chitieu-7263e",
            storageBucket: "chitieu-7263e.firebasestorage.app",
            messagingSenderId: "83833140682",
            appId: "1:83833140682:web:f9254b418ace3a659fcb33",
            measurementId: "G-523X74K18N"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const lichsuRef = ref(db, "vi/lichsu");

        lucide.createIcons();

        let currentType = "";
        window.fullDataStore = {}; // Lưu trữ array các item theo ngày

        window.toggleHistory = (open) => document.getElementById('historySheet').classList.toggle('open', open);
        window.toggleDetail = (open) => document.getElementById('detailSheet').classList.toggle('open', open);

        window.formatNumber = (input) => {
            let value = input.value.replace(/\D/g, '');
            if (value) {
                input.setAttribute('data-val', value);
                input.value = Number(value).toLocaleString('vi-VN') + " đ";
            }
        };

        window.openForm = (type) => {
            currentType = type;
            document.getElementById('formTitle').innerHTML = type === 'thu' ? 
                '<span style="color:var(--ios-green)">+ Khoản Thu</span>' : 
                '<span style="color:var(--ios-red)">- Khoản Chi</span>';
            document.getElementById('ngay').value = new Date().toISOString().split('T')[0];
            document.getElementById('inputOverlay').classList.add('show');
        };

        window.closeForm = () => document.getElementById('inputOverlay').classList.remove('show');

        window.saveData = () => {
            const sotien = Number(document.getElementById('sotien').getAttribute('data-val') || 0);
            const ngay = document.getElementById('ngay').value;
            const chitiet = document.getElementById('chitiet').value;
            if (!sotien) return alert("Nhập số tiền!");

            push(lichsuRef, { loai: currentType, ngay, sotien, chitiet, time: Date.now() })
            .then(() => { closeForm(); document.getElementById('sotien').value = ""; document.getElementById('chitiet').value = ""; });
        };

        // --- HIỂN THỊ CHI TIẾT ---
        window.showDayDetail = (date) => {
            const items = window.fullDataStore[date] || [];
            const container = document.getElementById("detailContent");
            document.getElementById("detailDateTitle").innerText = date.split('-').reverse().join('/');
            
            let html = "";
            items.forEach(item => {
                const isThu = item.loai === 'thu';
                html += `
                    <div class="detail-row">
                        <div class="detail-info">
                            <div style="font-weight:600">${isThu ? 'Thu nhập' : 'Chi tiêu'}</div>
                            <div class="detail-note">${item.chitiet || 'Không có ghi chú'}</div>
                        </div>
                        <div class="detail-amount" style="color:${isThu ? 'var(--ios-green)' : 'var(--ios-red)'}">
                            ${isThu ? '+' : '-'}${item.sotien.toLocaleString('vi-VN')} đ
                        </div>
                    </div>
                `;
            });
            container.innerHTML = html;
            toggleDetail(true);
            lucide.createIcons();
        };

        // --- FIREBASE LISTENER ---
        onValue(lichsuRef, snapshot => {
            const data = snapshot.val();
            const historyContent = document.getElementById("historyContent");
            
            let totalRevenue = 0;
            let totalExpense = 0;
            window.fullDataStore = {};

            if (!data) {
                historyContent.innerHTML = "<p style='text-align:center; color:grey;'>Chưa có dữ liệu</p>";
                return;
            }

            // Group data by Date
            Object.values(data).forEach(item => {
                const date = item.ngay;
                if (!window.fullDataStore[date]) window.fullDataStore[date] = [];
                window.fullDataStore[date].push(item);

                if (item.loai === 'thu') totalRevenue += item.sotien;
                else totalExpense += item.sotien;
            });

            // Update Dashboard
            const soDu = totalRevenue - totalExpense;
            document.getElementById("sodu-value").innerText = soDu.toLocaleString('vi-VN') + " đ";
            const loiLoElement = document.getElementById("loi-lo-value");
            loiLoElement.innerText = (totalRevenue - totalExpense).toLocaleString('vi-VN') + " đ";
            loiLoElement.style.color = (soDu >= 0) ? "var(--ios-green)" : "var(--ios-red)";

            // Render Lịch sử Tổng hợp
            let html = "";
            const sortedDates = Object.keys(window.fullDataStore).sort((a,b) => new Date(b) - new Date(a));
            
            sortedDates.forEach(date => {
                const items = window.fullDataStore[date];
                const dayThu = items.filter(i => i.loai === 'thu').reduce((sum, i) => sum + i.sotien, 0);
                const dayChi = items.filter(i => i.loai === 'chi').reduce((sum, i) => sum + i.sotien, 0);

                html += `
                    <div class="daily-item" onclick="showDayDetail('${date}')">
                        <div class="item-date">${date.split('-').reverse().join('/')}</div>
                        <div class="item-amounts">
                            <div style="color:var(--ios-green); font-weight:600;">+${dayThu.toLocaleString('vi-VN')} đ</div>
                            <div style="color:var(--ios-red); font-weight:600;">-${dayChi.toLocaleString('vi-VN')} đ</div>
                        </div>
                        <i data-lucide="chevron-right" style="color:var(--ios-gray); width:18px;"></i>
                    </div>
                `;
            });
            historyContent.innerHTML = html;
            lucide.createIcons();
        });
    </script>
</body>
</html>
