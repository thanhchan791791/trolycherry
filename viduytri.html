<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Ví Tài Chính Pro - Gentle Pulse</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        :root {
            --ios-bg: #F2F2F7;
            --ios-card: #FFFFFF;
            --ios-blue: #007AFF;
            --ios-red: #FF3B30;
            --ios-green: #34C759;
            --ios-gray: #8E8E93;
            --ios-separator: #E5E5EA;
            --safe-area-bottom: env(safe-area-inset-bottom, 20px);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", sans-serif;
            background: var(--ios-bg);
            margin: 0;
            color: #000;
            overflow: hidden;
            height: 100vh;
        }

        /* --- DASHBOARD TRUNG TÂM --- */
        .dashboard {
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            text-align: center;
        }

        .main-balance-label {
            font-size: 14px;
            color: var(--ios-gray);
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 5px;
        }

        /* NHỊP ĐẬP NHẸ NHÀNG (ĐÃ ĐIỀU CHỈNH) */
        .main-balance-value {
            font-size: 58px;
            font-weight: 900;
            letter-spacing: -2px;
            margin-bottom: 5px;
            display: inline-block;
            /* Thay đổi thời gian thành 3s và dùng ease-in-out để đập chậm rãi hơn */
            animation: gentlePulse 3s infinite ease-in-out;
            transition: color 0.5s ease;
        }

        @keyframes gentlePulse {
            0% { transform: scale(1); filter: drop-shadow(0 0 0px rgba(0,0,0,0)); }
            50% { transform: scale(1.08); filter: drop-shadow(0 0 15px currentColor); }
            100% { transform: scale(1); filter: drop-shadow(0 0 0px rgba(0,0,0,0)); }
        }

        .status-badge {
            font-size: 18px;
            font-weight: 800;
            padding: 6px 16px;
            border-radius: 50px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 20px;
        }

        .status-profit { background: rgba(52, 199, 89, 0.1); color: var(--ios-green); border: 1.5px solid var(--ios-green); }
        .status-loss { background: rgba(255, 59, 48, 0.1); color: var(--ios-red); border: 1.5px solid var(--ios-red); }

        /* TỔNG THU TỔNG CHI */
        .stats-summary {
            display: flex;
            gap: 20px;
            margin-bottom: 40px;
        }
        .stat-box {
            background: var(--ios-card);
            padding: 10px 15px;
            border-radius: 15px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            min-width: 100px;
        }
        .stat-label { font-size: 11px; color: var(--ios-gray); text-transform: uppercase; margin-bottom: 2px; }
        .stat-val { font-size: 16px; font-weight: 700; }

        /* NÚT BẤM */
        .action-grid {
            display: flex;
            gap: 40px;
            margin-bottom: 60px;
        }
        .btn-action {
            width: 75px; height: 75px; border-radius: 40px; border: none;
            display: flex; align-items: center; justify-content: center; color: white;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1); transition: all 0.2s; cursor: pointer;
        }
        .btn-action:active { transform: scale(0.85); opacity: 0.8; }
        .btn-thu { background: linear-gradient(145deg, #34C759, #28a745); }
        .btn-chi { background: linear-gradient(145deg, #FF3B30, #d93025); }

        /* SLIDE SHEETS */
        .slide-sheet {
            position: fixed; bottom: 0; left: 0; right: 0; height: 85vh;
            background: var(--ios-card); border-radius: 30px 30px 0 0;
            box-shadow: 0 -15px 50px rgba(0,0,0,0.15); z-index: 2000;
            transform: translateY(100%); transition: transform 0.4s cubic-bezier(0.25, 1, 0.5, 1);
            display: flex; flex-direction: column;
        }
        .slide-sheet.open { transform: translateY(0); }
        .sheet-header { padding: 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 0.5px solid var(--ios-separator); }
        .sheet-handle { width: 40px; height: 5px; background: #D1D1D6; border-radius: 3px; margin: 10px auto; }
        .sheet-content { flex: 1; overflow-y: auto; padding: 10px 20px 40px 20px; }

        .history-trigger { position: fixed; bottom: calc(40px + var(--safe-area-bottom)); display: flex; flex-direction: column; align-items: center; color: var(--ios-blue); cursor: pointer; font-weight: 600; font-size: 13px; gap: 8px; }
        .daily-item { padding: 18px; background: #F9F9F9; border-radius: 18px; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        
        /* FORM OVERLAY */
        #inputOverlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.4); backdrop-filter: blur(8px); z-index: 3000; opacity: 0; visibility: hidden; transition: 0.3s; display: flex; align-items: center; justify-content: center; }
        #inputOverlay.show { opacity: 1; visibility: visible; }
        .form-card { width: 90%; max-width: 350px; background: #fff; border-radius: 28px; padding: 30px; transform: scale(0.8); transition: 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        #inputOverlay.show .form-card { transform: scale(1); }
        input, textarea { width: 100%; padding: 16px; margin-bottom: 15px; border-radius: 15px; border: 1px solid #E5E5EA; background: #F2F2F7; font-size: 16px; box-sizing: border-box; outline: none; }
        #saveBtn { width: 100%; padding: 16px; border-radius: 15px; border: none; background: var(--ios-blue); color: #fff; font-size: 17px; font-weight: 700; }
        .detail-row { padding: 15px 0; border-bottom: 0.5px solid var(--ios-separator); display: flex; justify-content: space-between; align-items: center; }
    </style>
</head>
<body>

    <div class="dashboard">
        <div class="main-balance-label">Số dư hiện tại</div>
        <div id="sodu-value" class="main-balance-value">0 đ</div>
        
        <div id="status-badge" class="status-badge">
            <span id="status-text">...</span>
            <span id="loi-lo-value">0 đ</span>
        </div>

        <div class="stats-summary">
            <div class="stat-box">
                <div class="stat-label">Tổng Thu</div>
                <div id="sum-thu" class="stat-val" style="color:var(--ios-green)">0 đ</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">Tổng Chi</div>
                <div id="sum-chi" class="stat-val" style="color:var(--ios-red)">0 đ</div>
            </div>
        </div>

        <div class="action-grid">
            <button class="btn-action btn-thu" onclick="openForm('thu')">
                <i data-lucide="plus" style="width: 38px; height: 38px;"></i>
            </button>
            <button class="btn-action btn-chi" onclick="openForm('chi')">
                <i data-lucide="minus" style="width: 38px; height: 38px;"></i>
            </button>
        </div>

        <div class="history-trigger" onclick="toggleHistory(true)">
            <i data-lucide="layout-list" style="width: 28px; height: 28px;"></i>
            LỊCH SỬ GIAO DỊCH
        </div>
    </div>

    <div id="historySheet" class="slide-sheet">
        <div class="sheet-handle"></div>
        <div class="sheet-header">
            <h3 style="margin:0">Lịch sử giao dịch</h3>
            <button onclick="toggleHistory(false)" style="border:none; background:none; color:var(--ios-blue); font-size: 16px; font-weight: 600;">Đóng</button>
        </div>
        <div class="sheet-content" id="historyContent"></div>
    </div>

    <div id="detailSheet" class="slide-sheet" style="z-index: 2100;">
        <div class="sheet-handle"></div>
        <div class="sheet-header">
            <button onclick="toggleDetail(false)" style="border:none; background:none; color:var(--ios-blue); display:flex; align-items:center; gap:5px; font-size: 16px; font-weight: 600;">
                <i data-lucide="chevron-left"></i> Quay lại
            </button>
            <h3 id="detailDateTitle" style="margin:0">Ngày</h3>
            <div style="width:60px"></div>
        </div>
        <div class="sheet-content" id="detailContent"></div>
    </div>

    <div id="inputOverlay" onclick="if(event.target === this) closeForm()">
        <div class="form-card">
            <h2 id="formTitle" style="margin-top:0; text-align:center"></h2>
            <input type="date" id="ngay">
            <input type="text" id="sotien" placeholder="0" oninput="formatNumber(this)" inputmode="numeric">
            <textarea id="chitiet" placeholder="Ghi chú nội dung..."></textarea>
            <button id="saveBtn" onclick="saveData()">XÁC NHẬN LƯU</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, push, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB8uLkLJFlzmCodcawJhs2dRckHQzO5y10",
            authDomain: "chitieu-7263e.firebaseapp.com",
            databaseURL: "https://chitieu-7263e-default-rtdb.firebaseio.com",
            projectId: "chitieu-7263e",
            storageBucket: "chitieu-7263e.firebasestorage.app",
            messagingSenderId: "83833140682",
            appId: "1:83833140682:web:f9254b418ace3a659fcb33",
            measurementId: "G-523X74K18N"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const lichsuRef = ref(db, "vi/lichsu");

        lucide.createIcons();
        window.fullDataStore = {};

        window.toggleHistory = (open) => document.getElementById('historySheet').classList.toggle('open', open);
        window.toggleDetail = (open) => document.getElementById('detailSheet').classList.toggle('open', open);

        window.formatNumber = (input) => {
            let value = input.value.replace(/\D/g, '');
            if (value) {
                input.setAttribute('data-val', value);
                input.value = Number(value).toLocaleString('vi-VN') + " đ";
            }
        };

        window.openForm = (type) => {
            window.currentType = type;
            document.getElementById('formTitle').innerHTML = type === 'thu' ? 
                '<span style="color:var(--ios-green)">THU NHẬP</span>' : 
                '<span style="color:var(--ios-red)">CHI TIÊU</span>';
            document.getElementById('ngay').value = new Date().toISOString().split('T')[0];
            document.getElementById('inputOverlay').classList.add('show');
        };

        window.closeForm = () => document.getElementById('inputOverlay').classList.remove('show');

        window.saveData = () => {
            const sotien = Number(document.getElementById('sotien').getAttribute('data-val') || 0);
            const ngay = document.getElementById('ngay').value;
            const chitiet = document.getElementById('chitiet').value;
            if (!sotien) return;

            push(lichsuRef, { loai: window.currentType, ngay, sotien, chitiet, time: Date.now() })
            .then(() => { closeForm(); document.getElementById('sotien').value = ""; document.getElementById('chitiet').value = ""; });
        };

        window.showDayDetail = (date) => {
            const items = window.fullDataStore[date] || [];
            const container = document.getElementById("detailContent");
            document.getElementById("detailDateTitle").innerText = date.split('-').reverse().join('/');
            let html = "";
            items.forEach(item => {
                const isThu = item.loai === 'thu';
                html += `<div class="detail-row">
                    <div><div style="font-weight:700">${isThu ? 'Thu' : 'Chi'}</div><div style="font-size:13px; color:gray">${item.chitiet || '...'}</div></div>
                    <div style="font-weight:700; color:${isThu ? 'var(--ios-green)' : 'var(--ios-red)'}">${isThu ? '+' : '-'}${item.sotien.toLocaleString('vi-VN')}</div>
                </div>`;
            });
            container.innerHTML = html;
            toggleDetail(true);
            lucide.createIcons();
        };

        onValue(lichsuRef, snapshot => {
            const data = snapshot.val();
            const historyContent = document.getElementById("historyContent");
            let totalRevenue = 0, totalExpense = 0;
            window.fullDataStore = {};

            if (data) {
                Object.values(data).forEach(item => {
                    if (!window.fullDataStore[item.ngay]) window.fullDataStore[item.ngay] = [];
                    window.fullDataStore[item.ngay].push(item);
                    if (item.loai === 'thu') totalRevenue += item.sotien;
                    else totalExpense += item.sotien;
                });
            }

            const soDu = totalRevenue - totalExpense;
            document.getElementById("sodu-value").innerText = soDu.toLocaleString('vi-VN') + " đ";
            document.getElementById("loi-lo-value").innerText = Math.abs(soDu).toLocaleString('vi-VN') + " đ";
            document.getElementById("sum-thu").innerText = totalRevenue.toLocaleString('vi-VN') + " đ";
            document.getElementById("sum-chi").innerText = totalExpense.toLocaleString('vi-VN') + " đ";

            const soduEl = document.getElementById("sodu-value");
            const badgeEl = document.getElementById("status-badge");
            const statusTxt = document.getElementById("status-text");

            if (soDu >= 0) {
                soduEl.style.color = "var(--ios-green)";
                statusTxt.innerText = "LỜI";
                badgeEl.className = "status-badge status-profit";
            } else {
                soduEl.style.color = "var(--ios-red)";
                statusTxt.innerText = "LỖ";
                badgeEl.className = "status-badge status-loss";
            }

            let html = "";
            const sortedDates = Object.keys(window.fullDataStore).sort((a,b) => new Date(b) - new Date(a));
            sortedDates.forEach(date => {
                const items = window.fullDataStore[date];
                const dThu = items.filter(i => i.loai === 'thu').reduce((s, i) => s + i.sotien, 0);
                const dChi = items.filter(i => i.loai === 'chi').reduce((s, i) => s + i.sotien, 0);
                html += `<div class="daily-item" onclick="showDayDetail('${date}')">
                    <div class="item-date">${date.split('-').reverse().join('/')}</div>
                    <div style="text-align:right">
                        <div style="color:var(--ios-green); font-size:13px">+${dThu.toLocaleString('vi-VN')}</div>
                        <div style="color:var(--ios-red); font-size:13px">-${dChi.toLocaleString('vi-VN')}</div>
                    </div>
                    <i data-lucide="chevron-right" style="width:16px; color:#C7C7CC"></i>
                </div>`;
            });
            historyContent.innerHTML = html || "<p style='text-align:center; color:gray'>Chưa có dữ liệu</p>";
            lucide.createIcons();
        });
    </script>
</body>
</html>
