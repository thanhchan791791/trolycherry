<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Ví Thu Chi Firebase</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">

<style>
    /* VARIABLES */
    :root {
        --ios-background: #F2F2F7;
        --ios-card-bg: #FFFFFF;
        --ios-blue: #007AFF;
        --ios-red: #FF3B30;
        --ios-green: #34C759;
        --ios-text-primary: #1C1C1E;
        --ios-text-secondary: #8E8E93;
        --ios-separator: #E5E5EA;
        
        /* Colors for List */
        --bg-chi-light: #FFF0F0;
        --bg-thu-light: #F0FFF4;
        
        --ios-border-radius-xl: 28px;
        --ios-border-radius-large: 16px;
    }

    /* GLOBAL STYLES */
    body {
        font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "SF Pro Text", sans-serif;
        background: var(--ios-background);
        padding: 0;
        margin: 0;
        color: var(--ios-text-primary);
        padding-bottom: 90px;
        overflow-x: hidden;
        -webkit-tap-highlight-color: transparent;
    }

    .container { padding: 0 20px; }
    
    /* Navigation Bar */
    .navigation-bar {
        position: sticky;
        top: 0;
        z-index: 100;
        padding: 50px 20px 10px 20px;
        background-color: rgba(242, 242, 247, 0.9);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border-bottom: 0.5px solid var(--ios-separator);
    }
    .navigation-bar h2 {
        font-size: 34px;
        font-weight: 700;
        margin: 0;
    }

    /* Cards */
    .ios-card {
        background: var(--ios-card-bg);
        border-radius: var(--ios-border-radius-xl);
        margin: 0 20px 25px 20px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        overflow: hidden;
    }

    /* BALANCE CARD */
    #sodu {
        padding: 25px 20px;
        text-align: center;
        margin-top: 15px;
    }
    #sodu::before {
        content: "Số dư hiện tại";
        display: block;
        font-size: 15px;
        color: var(--ios-text-secondary);
        margin-bottom: 8px;
    }
    #sodu-value {
        font-size: 40px;
        font-weight: 700;
        color: var(--ios-text-primary);
        letter-spacing: -0.5px;
    }

    /* SUMMARY BOX */
    #summary-box {
        padding: 15px 20px;
        display: flex;
        justify-content: space-between;
        font-size: 16px;
        font-weight: 500;
        text-align: center;
        border-radius: var(--ios-border-radius-large);
        margin: 0 20px 25px 20px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        background: var(--ios-card-bg);
    }
    .summary-item { flex: 1; padding: 5px 0; }
    .summary-item:not(:last-child) { border-right: 0.5px solid var(--ios-separator); }
    .summary-item-label { font-size: 13px; color: var(--ios-text-secondary); margin-bottom: 3px; display: block; }
    .summary-item-value { font-size: 18px; font-weight: 600; }
    .thu-text { color: var(--ios-green); }
    .chi-text { color: var(--ios-red); }

    /* ACTION BUTTONS */
    .btn-box {
        display: flex;
        justify-content: space-around;
        gap: 15px;
        margin: 0 20px 30px 20px;
    }
    .action-button {
        flex: 1;
        height: 52px;
        font-size: 18px;
        border: none;
        border-radius: var(--ios-border-radius-large);
        cursor: pointer;
        font-weight: 600;
        transition: transform 0.1s;
        box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
    }
    .action-button:active { transform: scale(0.96); opacity: 0.9; }
    .thu { background: var(--ios-green); color: white; }
    .chi { background: var(--ios-red); color: white; }
    
    /* ========================================= */
    /* NEW INPUT FORM STYLES (CENTER POPUP)      */
    /* ========================================= */
    
    /* Lớp phủ mờ nền */
    #input-form-overlay {
        position: fixed;
        top: 0; left: 0; right: 0; bottom: 0;
        background-color: rgba(0, 0, 0, 0.4);
        backdrop-filter: blur(4px);
        -webkit-backdrop-filter: blur(4px);
        z-index: 2000;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s ease, visibility 0.3s;
    }
    
    #input-form-overlay.show {
        opacity: 1;
        visibility: visible;
    }

    /* Form chính */
    .form-box {
        position: fixed;
        top: 50%;
        left: 50%;
        width: 85%;
        max-width: 350px;
        background: var(--ios-card-bg);
        padding: 25px 20px;
        border-radius: 24px;
        box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        z-index: 2001;
        
        /* Hiệu ứng trượt và scale */
        transform: translate(-50%, -40%) scale(0.9);
        opacity: 0;
        pointer-events: none;
        transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    .form-box.show {
        transform: translate(-50%, -50%) scale(1);
        opacity: 1;
        pointer-events: auto;
    }

    /* Header của Form */
    .form-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    .form-header h3 {
        margin: 0;
        padding: 0;
        font-size: 22px;
        font-weight: 700;
    }

    .close-form-btn {
        background: #F2F2F7;
        border: none;
        width: 32px;
        height: 32px;
        border-radius: 50%;
        color: #8E8E93;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 16px;
    }

    /* Các input trong form */
    input, textarea {
        width: 100%;
        padding: 14px 15px;
        margin-bottom: 15px;
        border-radius: 14px;
        border: 1px solid var(--ios-separator); 
        font-size: 17px;
        box-sizing: border-box;
        font-family: inherit;
        -webkit-appearance: none;
        background: #F9F9F9;
    }
    input:focus, textarea:focus { 
        border-color: var(--ios-blue); 
        background: #fff;
        outline: none; 
    }
    
    #save-btn {
        background: var(--ios-blue); 
        color: white; 
        width: 100%; 
        height: 50px;
        border-radius: 14px; 
        font-size: 17px; 
        font-weight: 600;
        border: none; 
        margin-top: 10px;
        cursor: pointer;
        box-shadow: 0 4px 12px rgba(0, 122, 255, 0.3);
    }
    #save-btn:active { transform: scale(0.98); opacity: 0.9; }

    /* HISTORY LIST */
    h3.section-title { margin: 25px 0 10px 0; padding: 0 20px; font-size: 20px; font-weight: 600; }
    #history { margin: 0 20px; }

    .daily-summary-item {
        background: var(--ios-card-bg);
        padding: 15px;
        margin-top: 10px;
        border-radius: var(--ios-border-radius-large);
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        display: flex;
        justify-content: space-between;
        align-items: center;
        cursor: pointer;
        transition: background 0.2s;
    }
    .daily-summary-item:active { background-color: #f2f2f7; }

    .summary-left { display: flex; flex-direction: column; }
    .summary-date { font-size: 17px; font-weight: 600; margin-bottom: 4px; }
    .summary-mini-total { font-size: 13px; color: var(--ios-text-secondary); }

    .detail-btn {
        background-color: transparent;
        color: var(--ios-blue);
        border: none;
        font-weight: 500;
        font-size: 14px;
        cursor: pointer;
    }

    /* ========================================= */
    /* DETAIL MODAL STYLES (View Details)        */
    /* ========================================= */
    
    #detail-modal-overlay {
        display: none;
        position: fixed;
        top: 0; left: 0; width: 100%; height: 100%;
        background-color: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(4px);
        -webkit-backdrop-filter: blur(4px);
        z-index: 3000;
        justify-content: center;
        align-items: center;
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    #detail-modal-overlay.show { display: flex; opacity: 1; }

    .detail-modal-card {
        background: #fff;
        width: 90%;
        max-width: 400px;
        max-height: 80vh;
        border-radius: 24px;
        box-shadow: 0 20px 50px rgba(0,0,0,0.3);
        display: flex;
        flex-direction: column;
        overflow: hidden;
        transform: scale(0.95);
        transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    #detail-modal-overlay.show .detail-modal-card { transform: scale(1); }

    .modal-header {
        padding: 20px 20px 10px 20px;
        background: #fff;
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: sticky;
        top: 0;
        z-index: 10;
    }

    .modal-title { font-size: 18px; font-weight: 700; color: #000; }

    .close-modal-btn {
        background: #E5E5EA;
        border: none;
        width: 30px;
        height: 30px;
        border-radius: 50%;
        color: #636366;
        font-size: 14px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .modal-body {
        padding: 10px 15px 20px 15px;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
    }

    /* ITEM GIAO DỊCH */
    .modal-trans-item {
        background: #fff;
        border-radius: 18px;
        padding: 12px 15px;
        margin-bottom: 12px;
        position: relative;
        display: flex;
        align-items: center;
        overflow: hidden; 
    }

    .modal-trans-item::before {
        content: ''; position: absolute; left: 0; top: 10px; bottom: 10px; width: 4px; border-radius: 0 4px 4px 0;
    }

    .modal-trans-item.thu { background-color: var(--bg-thu-light); }
    .modal-trans-item.thu::before { background-color: var(--ios-green); }

    .modal-trans-item.chi { background-color: var(--bg-chi-light); }
    .modal-trans-item.chi::before { background-color: var(--ios-red); }

    .trans-icon-circle {
        width: 45px; height: 45px; border-radius: 50%;
        display: flex; align-items: center; justify-content: center;
        font-size: 20px; margin-right: 12px; flex-shrink: 0; margin-left: 5px;
    }

    .thu .trans-icon-circle { background: rgba(52, 199, 89, 0.2); color: var(--ios-green); }
    .chi .trans-icon-circle { background: rgba(255, 59, 48, 0.2); color: var(--ios-red); }

    .trans-content { flex: 1; display: flex; flex-direction: column; justify-content: center; }
    .trans-row-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
    .trans-meta { display: flex; align-items: center; gap: 6px; }
    .trans-time { font-size: 13px; color: var(--ios-text-secondary); font-weight: 500; }
    
    .trans-badge {
        font-size: 10px; font-weight: 700; padding: 2px 6px; border-radius: 4px; text-transform: uppercase;
    }
    .thu .trans-badge { background: rgba(52, 199, 89, 0.15); color: var(--ios-green); }
    .chi .trans-badge { background: rgba(255, 59, 48, 0.15); color: var(--ios-red); }

    .trans-amount { font-size: 16px; font-weight: 700; }
    .thu .trans-amount { color: var(--ios-green); }
    .chi .trans-amount { color: var(--ios-red); }

    .trans-note {
        font-size: 14px; color: #000; font-weight: 400;
        white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 200px;
    }

    /* ALERT */
    #custom-alert {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background-color: rgba(0, 0, 0, 0.4); z-index: 4000;
        display: none; justify-content: center; align-items: center;
    }
    #custom-alert.show { display: flex; }
    .alert-content {
        background: #fff; border-radius: 14px; width: 80%; max-width: 280px;
        padding: 20px; text-align: center;
        box-shadow: 0 5px 20px rgba(0,0,0,0.2);
    }
    .alert-button {
        background: var(--ios-blue); color: white; border: none; border-radius: 8px;
        padding: 10px; width: 100%; font-size: 16px; font-weight: 600; cursor: pointer; margin-top: 10px;
    }

</style>
</head>
<body>

<div id="custom-alert">
    <div class="alert-content">
        <p id="alert-message" style="margin-bottom: 15px; font-weight: 500; font-size: 16px;"></p>
        <button class="alert-button" onclick="closeAlert()">OK</button>
    </div>
</div>

<div class="navigation-bar">
    <h2><i class="fas fa-wallet" style="color: var(--ios-blue); margin-right: 5px;"></i> Ví Thu Chi</h2>
</div>

<div class="container">
    <div id="sodu" class="ios-card">
        <span id="sodu-value">0 đ</span>
    </div>

    <div id="summary-box">
        <div class="summary-item">
            <span class="summary-item-label">Tổng Thu</span>
            <span id="tong-thu" class="summary-item-value thu-text">0 đ</span>
        </div>
        <div class="summary-item">
            <span class="summary-item-label">Tổng Chi</span>
            <span id="tong-chi" class="summary-item-value chi-text">0 đ</span>
        </div>
        <div class="summary-item">
            <span class="summary-item-label">Tổng Dư</span>
            <span id="tong-du" class="summary-item-value">0 đ</span>
        </div>
    </div>
    
    <div class="btn-box">
        <button class="thu action-button" onclick="openForm('thu')">
            <i class="fas fa-arrow-up"></i> Thu
        </button>
        <button class="chi action-button" onclick="openForm('chi')">
            <i class="fas fa-arrow-down"></i> Chi
        </button>
    </div>

    <h3 class="section-title">Lịch sử</h3>
    <div id="history"></div>
</div>

<div id="input-form-overlay" onclick="closeForm()"></div>

<div class="form-box" id="formBox">
    <div class="form-header">
        <h3 id="formTitle"></h3>
        <button class="close-form-btn" onclick="closeForm()">
            <i class="fas fa-times"></i>
        </button>
    </div>
    
    <label for="ngay" style="font-size: 15px; color: var(--ios-text-secondary); margin-left: 2px;">Ngày giao dịch</label>
    <input type="date" id="ngay">
    
    <label for="sotien" style="font-size: 15px; color: var(--ios-text-secondary); margin-left: 2px;">Số tiền</label>
    <input type="text" id="sotien" placeholder="0 đ" oninput="formatAndSanitizeNumber(this)" inputmode="numeric">
    
    <label for="chitiet" style="font-size: 15px; color: var(--ios-text-secondary); margin-left: 2px;">Chi tiết</label>
    <textarea id="chitiet" rows="3" placeholder="Ví dụ: Ăn sáng, tiền nhà..."></textarea>
    
    <button id="save-btn" onclick="saveData()">Lưu giao dịch</button>
</div>

<div id="detail-modal-overlay">
    <div class="detail-modal-card">
        <div class="modal-header">
            <span class="modal-title" id="modal-date-title">Ngày ...</span>
            <button class="close-modal-btn" onclick="closeDetailModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body" id="modal-body-content">
            </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, push, onValue }
        from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyB8uLkLJFlzmCodcawJhs2dRckHQzO5y10",
        authDomain: "chitieu-7263e.firebaseapp.com",
        databaseURL: "https://chitieu-7263e-default-rtdb.firebaseio.com",
        projectId: "chitieu-7263e",
        storageBucket: "chitieu-7263e.firebasestorage.app",
        messagingSenderId: "83833140682",
        appId: "1:83833140682:web:f9254b418ace3a659fcb33",
        measurementId: "G-523X74K18N"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    let currentType = "";
    const lichsuRef = ref(db, "vi/lichsu");
    
    window.dailyDataStore = {};

    function getVietnameseDateString(dateStr) {
        const date = new Date(dateStr);
        const daysVN = ['Chủ Nhật', 'Thứ Hai', 'Thứ Ba', 'Thứ Tư', 'Thứ Năm', 'Thứ Sáu', 'Thứ Bảy'];
        const dayName = daysVN[date.getDay()];
        const day = String(date.getDate()).padStart(2, '0');
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const year = date.getFullYear();
        return `${dayName}, ${day}/${month}/${year}`;
    }

    const today = new Date();
    const yyyy = today.getFullYear();
    const mm = String(today.getMonth() + 1).padStart(2, "0");
    const dd = String(today.getDate()).padStart(2, "0");
    const todayDateString = `${yyyy}-${mm}-${dd}`;
    
    window.formatAndSanitizeNumber = function(input) {
        let value = input.value.replace(/\D/g, '');
        if (value) {
            input.setAttribute('data-numeric-value', value);
            input.value = Number(value).toLocaleString('vi-VN');
        } else {
            input.setAttribute('data-numeric-value', '0');
            input.value = '';
        }
    }

    window.showAlert = function(message) {
        document.getElementById('alert-message').innerText = message;
        document.getElementById('custom-alert').classList.add('show');
    }
    window.closeAlert = function() {
        document.getElementById('custom-alert').classList.remove('show');
    }

    // --- MODIFIED: OPEN FORM CENTER ANIMATION ---
    window.openForm = function(type) {
        currentType = type;
        const formBox = document.getElementById("formBox");
        const overlay = document.getElementById("input-form-overlay");
        
        document.getElementById("ngay").value = todayDateString;
        document.getElementById("sotien").value = "";
        document.getElementById("sotien").removeAttribute('data-numeric-value');
        document.getElementById("chitiet").value = "";

        // Show Overlay & Form
        overlay.classList.add("show");
        formBox.classList.add("show");
        
        document.getElementById("formTitle").innerHTML =
            type === "thu" ? '<span style="color:var(--ios-green)">Thêm khoản Thu</span>' : '<span style="color:var(--ios-red)">Thêm khoản Chi</span>';
    };

    // --- NEW: CLOSE FORM FUNCTION ---
    window.closeForm = function() {
        document.getElementById("formBox").classList.remove("show");
        document.getElementById("input-form-overlay").classList.remove("show");
    }

    window.saveData = function() {
        let ngay = document.getElementById("ngay").value;
        let sotienElement = document.getElementById("sotien");
        let sotien = Number(sotienElement.getAttribute('data-numeric-value') || 0);
        let chitiet = document.getElementById("chitiet").value;

        if (!ngay || !sotien || sotien <= 0) {
            showAlert("Vui lòng nhập đủ thông tin!");
            return;
        }

        push(lichsuRef, {
            loai: currentType,
            ngay,
            sotien,
            chitiet,
            time: Date.now()
        });
        
        // Close form on success
        closeForm();
        
        // Clear data
        document.getElementById("ngay").value = "";
        document.getElementById("sotien").value = "";
        document.getElementById("sotien").removeAttribute('data-numeric-value');
        document.getElementById("chitiet").value = "";
        
        showAlert("Đã lưu thành công!");
    };

    // ===========================================
    // VIEW DETAIL MODAL LOGIC
    // ===========================================
    window.openDetailModal = function(dateKey) {
        const data = window.dailyDataStore[dateKey];
        if (!data) return;

        document.getElementById('modal-date-title').innerText = getVietnameseDateString(dateKey);
        
        const modalBody = document.getElementById('modal-body-content');
        let html = '';

        const sortedTrans = data.transactions.sort((a, b) => b.time - a.time);

        if(sortedTrans.length === 0) {
             html = '<p style="text-align:center; color:#999; margin-top:20px;">Trống</p>';
        } else {
            sortedTrans.forEach(item => {
                const isThu = item.loai === 'thu';
                const className = isThu ? 'thu' : 'chi';
                const sign = isThu ? '+' : '-';
                const iconClass = isThu ? 'fa-piggy-bank' : 'fa-bag-shopping';
                const badgeText = isThu ? 'THU' : 'CHI';
                
                const timeObj = new Date(item.time);
                const timeString = timeObj.getHours().toString().padStart(2, '0') + ':' + 
                                   timeObj.getMinutes().toString().padStart(2, '0');

                html += `
                    <div class="modal-trans-item ${className}">
                        <div class="trans-icon-circle">
                            <i class="fa-solid ${iconClass}"></i>
                        </div>
                        <div class="trans-content">
                            <div class="trans-row-top">
                                <div class="trans-meta">
                                    <span class="trans-time">${timeString}</span>
                                    <span class="trans-badge">${badgeText}</span>
                                </div>
                                <span class="trans-amount">${sign}${item.sotien.toLocaleString('vi-VN')} đ</span>
                            </div>
                            <div class="trans-note">
                                ${item.chitiet || "Không có ghi chú"}
                            </div>
                        </div>
                    </div>
                `;
            });
        }

        modalBody.innerHTML = html;
        document.getElementById('detail-modal-overlay').classList.add('show');
    };

    window.closeDetailModal = function() {
        document.getElementById('detail-modal-overlay').classList.remove('show');
    };

    document.getElementById('detail-modal-overlay').addEventListener('click', function(e) {
        if (e.target === this) {
            closeDetailModal();
        }
    });

    // ===========================================
    // FIREBASE LISTENER
    // ===========================================
    onValue(lichsuRef, snapshot => {
        const historyData = snapshot.val();
        const historyElement = document.getElementById("history");
        
        let totalRevenue = 0;
        let totalExpense = 0;
        let finalBalance = 0;

        window.dailyDataStore = {};

        if (!historyData) {
            historyElement.innerHTML = "<p style='text-align: center; color: var(--ios-text-secondary); margin-top: 20px;'>Chưa có giao dịch.</p>";
            return;
        }

        const transactions = Object.entries(historyData)
            .map(([key, value]) => ({ id: key, ...value }))
            .sort((a, b) => b.time - a.time);

        transactions.forEach(d => {
            if (d.loai !== 'thu' && d.loai !== 'chi') return;
            
            const ngay = d.ngay;
            if (!window.dailyDataStore[ngay]) {
                window.dailyDataStore[ngay] = { totalThu: 0, totalChi: 0, transactions: [] };
            }

            const sotien = d.sotien || 0;
            if (d.loai === 'thu') {
                window.dailyDataStore[ngay].totalThu += sotien;
                totalRevenue += sotien;
                finalBalance += sotien;
            } else if (d.loai === 'chi') {
                window.dailyDataStore[ngay].totalChi += sotien;
                totalExpense += sotien;
                finalBalance -= sotien;
            }
            window.dailyDataStore[ngay].transactions.push(d);
        });

        document.getElementById("sodu-value").innerText = finalBalance.toLocaleString('vi-VN') + " đ";
        document.getElementById("tong-thu").innerText = totalRevenue.toLocaleString('vi-VN') + " đ";
        document.getElementById("tong-chi").innerText = totalExpense.toLocaleString('vi-VN') + " đ";
        document.getElementById("tong-du").innerText = finalBalance.toLocaleString('vi-VN') + " đ";
        
        let html = "";
        
        const sortedDates = Object.keys(window.dailyDataStore).sort((a,b) => new Date(b) - new Date(a));

        for (const ngay of sortedDates) {
            const summary = window.dailyDataStore[ngay];
            const dateDisplay = getVietnameseDateString(ngay);

            html += `
                <div class="daily-summary-item" onclick="openDetailModal('${ngay}')">
                    <div class="summary-left">
                        <span class="summary-date">${dateDisplay}</span>
                        <span class="summary-mini-total">
                            <span style="color:var(--ios-green)">+${summary.totalThu.toLocaleString('vi-VN')}</span>
                            &nbsp;/&nbsp; 
                            <span style="color:var(--ios-red)">-${summary.totalChi.toLocaleString('vi-VN')}</span>
                        </span>
                    </div>
                    
                    <button class="detail-btn">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            `;
        }
        
        historyElement.innerHTML = html;
    });
</script>

</body>
</html>
