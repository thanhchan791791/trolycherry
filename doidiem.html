<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Giao Di·ªán ƒê·ªïi ƒêi·ªÉm √äƒë√™ Bu√¥n L√†ng (Nh√¢n Vi√™n)</title>
  
  <style>
    /* * ----------------------------------------
     * 1. IOS STYLES & VARIABLES
     * ----------------------------------------
     */
    :root {
      /* Colors */
      --color-ios-bg: #F2F2F7; /* N·ªÅn chu·∫©n iOS */
      --color-ios-card: #FFFFFF;
      --color-ios-primary: #007AFF; /* Xanh d∆∞∆°ng chu·∫©n iOS */
      --color-ios-separator: #C7C7CC; /* M√†u ph√¢n c√°ch */
      
      --color-primary-edebl: #8B4513; /* N√¢u ƒë·∫•t/C√† ph√™ ƒë·∫≠m (Cho ti√™u ƒë·ªÅ) */
      --color-text-dark: #1C1C1E; /* T·ªëi g·∫ßn ƒëen chu·∫©n iOS */
      --color-text-secondary: #6C6C70; /* Text ph·ª• */
      
      /* Redeem Specific Colors (Green) */
      --color-redeem-action: #34C759; /* Xanh l√° h√†nh ƒë·ªông chu·∫©n iOS */
      --color-redeem-primary: #38761D; /* Xanh l√° ƒë·∫≠m g·ªëc */
      --color-redeem-secondary: #A9D18E;
      
      /* New Bill Button Color (Blue/Indigo) */
      --color-bill-action: #5856D6; /* T√≠m/Xanh Indigo chu·∫©n iOS */
      
      /* Radius & Shadow */
      --border-radius-card: 20px; /* Bo g√≥c l·ªõn cho Card */
      --border-radius-lg: 14px;   /* Bo g√≥c cho Button, Input */
      --border-radius-sm: 10px;
      --shadow-soft: 0 12px 30px rgba(0, 0, 0, 0.08); /* ƒê·ªï b√≥ng m·ªÅm iOS */
      
      /* Animation */
      --transition-duration: 0.3s;
      --transition-bezier: cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* Reset & Base Styles */
    *, *::before, *::after {
        box-sizing: border-box;
        transition: all var(--transition-duration) var(--transition-bezier); /* Transition chung */
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display",
                   "SF Pro Text", "Inter", system-ui, sans-serif;
      padding: 20px;
      max-width: 480px; /* TƒÉng nh·∫π max-width cho c·∫£m gi√°c App View */
      margin: auto;
      text-align: center;
      background-color: var(--color-ios-bg);
      color: var(--color-text-dark);
      overflow-x: hidden;
    }
    
    /* Animation khi load trang (Fade + Slide Up) */
    .app-container {
        opacity: 0;
        transform: translateY(15px);
        animation: pageLoadFadeIn 0.8s var(--transition-bezier) forwards;
    }
    
    @keyframes pageLoadFadeIn {
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    /* Active State (Tap Scale) */
    .card:active, button:active, .input-like-element:active, .bill-button:active {
        transform: scale(0.98);
        transition-duration: 0.1s;
    }

    /* Typography */
    .app-header {
        font-size: 28px;
        font-weight: 700;
        color: var(--color-text-dark);
        margin-bottom: 25px;
        line-height: 1.2;
    }
    
    .card-title {
      color: var(--color-primary-edebl);
      font-size: 24px;
      font-weight: 600;
      line-height: 1.3;
      margin-top: 0;
      margin-bottom: 15px;
    }
    
    /* * ----------------------------------------
     * 2. UI COMPONENTS: CARD, INPUT, BUTTON
     * ----------------------------------------
     */
    .redeem-box {
      background: var(--color-ios-card);
      padding: 30px 20px;
      border-radius: var(--border-radius-card);
      box-shadow: var(--shadow-soft);
      margin-top: 20px;
      border: none; /* B·ªè vi·ªÅn c·ª©ng, ch·ªâ d√πng b√≥ng */
    }
    
    .redeem-box h3 {
        color: var(--color-redeem-action); /* M√†u xanh l√° cho ch·ª©c nƒÉng ch√≠nh */
        text-transform: uppercase;
        font-size: 18px;
        font-weight: 600;
        letter-spacing: 0.5px;
        margin-bottom: 25px;
     }
     
     .redeem-input-group {
        display: flex;
        flex-direction: column;
        gap: 15px;
        align-items: stretch;
        margin-bottom: 20px;
     }

    input[type="text"], select {
      height: 52px; /* Chu·∫©n ch·∫°m iOS */
      padding: 0 15px;
      border: 1px solid #E5E5E5; /* Vi·ªÅn m·ªèng nh·∫π */
      border-radius: var(--border-radius-lg);
      background-color: var(--color-ios-card); 
      font-size: 16px;
      color: var(--color-text-dark);
      box-sizing: border-box;
      transition: box-shadow 0.3s, border-color 0.3s;
      width: 100%;
      -webkit-appearance: none; /* B·ªè style default c·ªßa select/input */
      appearance: none;
    }
    
    select {
        /* Icon m≈©i t√™n custom cho select */
        background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='%236C6C70'%3e%3cpath fill-rule='evenodd' d='M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z' clip-rule='evenodd' /%3e%3c/svg%3e");
        background-repeat: no-repeat;
        background-position: right 15px center;
        background-size: 18px;
        padding-right: 40px;
    }

    input[type="text"]:focus, select:focus {
      border-color: var(--color-ios-primary);
      box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.25); /* Ring focus chu·∫©n iOS */
      outline: none;
    }
    
    /* Input ƒë·∫∑c bi·ªát hi·ªÉn th·ªã ƒëi·ªÉm hi·ªán t·∫°i (nh∆∞ m·ªôt Info Cell) */
    #currentPointsDisplay {
        text-align: center; 
        color: var(--color-redeem-action); 
        font-weight: 600; 
        background-color: #F8F8F8; /* N·ªÅn nh·∫π ƒë·ªÉ n·ªïi b·∫≠t */
        border: 1px solid #E5E5E5;
        box-shadow: none;
        pointer-events: none; /* Kh√¥ng cho focus */
    }
    
    /* Button Base Style */
    button {
      height: 52px; /* Chu·∫©n ch·∫°m l·ªõn h∆°n */
      padding: 0 20px;
      color: white;
      border: none;
      border-radius: var(--border-radius-lg); 
      cursor: pointer;
      font-size: 17px;
      font-weight: 600;
      transition: background-color 0.2s, transform 0.1s var(--transition-bezier), box-shadow 0.2s;
      width: 100%; 
      margin: 0;
      margin-top: 10px;
      letter-spacing: 0.2px;
    }
    
    button:hover:not(:disabled) {
        opacity: 0.9;
    }
    
    button:disabled {
        background: var(--color-ios-separator) !important;
        cursor: not-allowed;
        box-shadow: none !important;
        color: white;
    }

    /* Style cho n√∫t Ki·ªÉm Tra (M√†u N√¢u ƒë·∫•t) */
    .check-button {
      background: var(--color-primary-edebl); 
      box-shadow: 0 5px 15px rgba(139, 69, 19, 0.25);
    }
    
    /* Style ri√™ng cho n√∫t ƒë·ªïi ƒëi·ªÉm (M√†u xanh l√° - Action) */
    #redeemButton {
        background: var(--color-redeem-action);
        box-shadow: 0 5px 15px rgba(52, 199, 89, 0.4);
        margin-top: 20px !important;
    }
    
    /* Style ri√™ng cho n√∫t C·∫≠p Nh·∫≠t Bill (M√†u T√≠m/Indigo) */
    .bill-button {
        background: var(--color-bill-action);
        box-shadow: 0 5px 15px rgba(88, 86, 214, 0.4);
    }
    
    /* * ----------------------------------------
     * 3. RESULT BOX & IFRAME MODAL
     * ----------------------------------------
     */
    #redeemResult {
      margin-top: 25px;
      padding: 20px;
      border-radius: 12px; /* Bo g√≥c nh·∫π h∆°n cho Result Box */
      font-size: 16px;
      font-weight: 400;
      line-height: 1.5;
      text-align: left;
      border: none;
      transition: background-color 0.3s, color 0.3s, box-shadow 0.3s;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    
    #redeemResult p {
        margin: 5px 0;
    }
    
    .result-title {
        display: block;
        font-weight: 600;
        color: var(--color-text-dark);
        margin-bottom: 8px;
        text-align: center;
        font-size: 17px;
    }
    
    /* Success: M√†u xanh l√° c√¢y/xanh r√™u nh·∫°t ·∫•m */
    .success {
      background-color: #E6F3E6; 
      color: #1A7A2A; 
      border-left: 5px solid var(--color-redeem-action);
    }
    
    /* Error: M√†u ƒë·ªè ƒë·∫≠m ·∫•m */
    .error {
      background-color: #FBEFEF; 
      color: #990000; 
      border-left: 5px solid #FF3B30; /* ƒê·ªè chu·∫©n iOS */
    }
    
    /* Info/Default: M√†u v√†ng kem ·∫•m */
    .info {
      background-color: #FFF8E1; 
      color: #9C6500;
      border-left: 5px solid #FF9500; /* Cam/V√†ng chu·∫©n iOS */
    }
    
    /* IFRAME MODAL STYLES */
    .iframe-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: var(--color-ios-bg); /* N·ªÅn nh·∫π ph√≠a sau */
        z-index: 1000;
        display: none; /* M·∫∑c ƒë·ªãnh ·∫©n */
        flex-direction: column;
        opacity: 0;
        transition: opacity 0.3s ease-in-out;
    }

    .iframe-modal.active {
        display: flex;
        opacity: 1;
    }
    
    .iframe-header {
        height: 50px;
        background-color: var(--color-ios-card);
        display: flex;
        align-items: center;
        justify-content: flex-end; /* N√∫t ƒë√≥ng ·ªü b√™n ph·∫£i */
        padding: 0 15px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        z-index: 1001;
    }
    
    .close-button {
        background: var(--color-ios-primary);
        color: white;
        border: none;
        border-radius: 10px;
        padding: 5px 15px;
        font-size: 16px;
        font-weight: 500;
        cursor: pointer;
        height: auto;
        margin-top: 0; /* Override button margin-top */
    }
    
    .bill-iframe {
        flex-grow: 1; /* Cho iframe chi·∫øm h·∫øt kh√¥ng gian c√≤n l·∫°i */
        width: 100%;
        border: none;
    }

  </style>
  </head>
<body>

<div class="app-container">
    
    <header class="app-header">
        √äƒë√™ Bu√¥n L√†ng
    </header>
    
    <div class="redeem-box card">
        <h3 class="card-title">üéØ Giao Di·ªán ƒê·ªïi ƒêi·ªÉm (Nh√¢n Vi√™n) üéØ</h3>
        
        <div class="redeem-input-group">
            <input type="text" id="redeemPhoneInput" placeholder="Nh·∫≠p S·ªë ƒëi·ªán tho·∫°i kh√°ch h√†ng" class="input-like-element" />
            
            <select id="voucherSelect" class="input-like-element">
                <option value="" disabled selected>Ch·ªçn Voucher Kh√°ch Mu·ªën ƒê·ªïi</option>
                <option value="100">100 ƒêi·ªÉm - Voucher Gi·∫£m 50.000 VNƒê</option>
                <option value="200">200 ƒêi·ªÉm - Voucher Gi·∫£m 100.000 VNƒê</option>
                <option value="300">300 ƒêi·ªÉm - Voucher Gi·∫£m 150.000 VNƒê</option>
                <option value="400">400 ƒêi·ªÉm - Voucher Ti·ªác L·ªõn 200.000 VNƒê</option>
            </select>
            
            <input type="text" id="currentPointsDisplay" value="ƒêi·ªÉm hi·ªán t·∫°i: --" readonly disabled class="input-like-element" />
        </div>
        
        <button onclick="checkRedeemPoints()" class="check-button">Ki·ªÉm Tra ƒêi·ªÉm Tr∆∞·ªõc Khi ƒê·ªïi</button>
        
        <button onclick="openBillIframe()" class="bill-button">üßæ C·∫≠p Nh·∫≠t Bill G·∫ßn Nh·∫•t</button>
        
        <button id="redeemButton" onclick="redeemLoyaltyPoints()" disabled>‚ùå Vui l√≤ng Ki·ªÉm Tra ƒêi·ªÉm tr∆∞·ªõc</button>
        
        <div id="redeemResult" class="info">
          Nh·∫≠p SƒêT, ch·ªçn Voucher v√† nh·∫•n "Ki·ªÉm Tra ƒêi·ªÉm".
        </div>
    </div>

</div>

<div id="billIframeModal" class="iframe-modal">
    <div class="iframe-header">
        <button class="close-button" onclick="closeBillIframe()">ƒê√≥ng</button>
    </div>
    <iframe id="billIframe" src="about:blank" class="bill-iframe"></iframe>
</div>
<script type="module">
  // Import Firebase SDK
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getDatabase, ref, get, set, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js"; 

  // Firebase config c·ªßa b·∫°n (gi·ªØ nguy√™n)
  const firebaseConfig = {
    apiKey: "AIzaSyB8uLkLJFlzmCodcawJhs2dRckHQzO5y10",
    authDomain: "chitieu-7263e.firebaseapp.com",
    databaseURL: "https://chitieu-7263e-default-rtdb.firebaseio.com",
    projectId: "chitieu-7263e",
    storageBucket: "chitieu-7263e.firebasestorage.app",
    messagingSenderId: "83833140682",
    appId: "1:83833140682:web:f9254b418ace3a659fcb33",
    measurementId: "G-523X74K18N"
  };

  // Kh·ªüi t·∫°o Firebase
  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  // Quy t·∫Øc t√≠nh ƒëi·ªÉm: 1,000,000 VNƒê = 100 ƒëi·ªÉm √äƒë√™.
  const POINTS_PER_MILLION = 100; 
  
  // Bi·∫øn to√†n c·ª•c ƒë·ªÉ l∆∞u ƒëi·ªÉm hi·ªán t·∫°i c·ªßa SƒêT ƒëang ƒë∆∞·ª£c tra c·ª©u ƒë·ªïi ƒëi·ªÉm
  let currentRedeemPoints = 0;
  let currentRedeemPhoneKey = '';

  /**
   * Chu·∫©n h√≥a SƒêT th√†nh key ch·ªâ ch·ª©a s·ªë.
   * @param {string} phone - S·ªë ƒëi·ªán tho·∫°i th√¥.
   * @returns {string} - S·ªë ƒëi·ªán tho·∫°i ch·ªâ ch·ª©a s·ªë.
   */
  function standardizePhoneKey(phone) {
    return phone.replace(/[^0-9]/g, ''); 
  }

  /**
   * C·∫≠p nh·∫≠t ƒëi·ªÉm t√≠ch l≈©y, ƒëi·ªÉm ƒë√£ ƒë·ªïi, v√† ƒëi·ªÉm hi·ªán t·∫°i v√†o Firebase Realtime Database
   */
  async function updateLoyaltyDataInDB(phone, totalAmount, accumulatedPoints, redeemedPoints, currentPoints) {
    try {
        const phoneKey = standardizePhoneKey(phone);
        await set(ref(db, 'loyalty_points/' + phoneKey), {
            phone: phone,
            totalAmount: totalAmount,
            accumulatedPoints: accumulatedPoints, // T·ªïng ƒëi·ªÉm t√≠ch l≈©y t·ª´ bill
            redeemedPoints: redeemedPoints,       // T·ªïng ƒëi·ªÉm ƒë√£ ƒë·ªïi 
            currentPoints: currentPoints,         // ƒêi·ªÉm hi·ªán t·∫°i (accumulatedPoints - redeemedPoints)
            lastUpdated: new Date().toISOString()
        });
        console.log(`ƒê√£ c·∫≠p nh·∫≠t d·ªØ li·ªáu ƒëi·ªÉm th√†nh c√¥ng cho SƒêT: ${phone}`);
    } catch (error) {
        console.error("L·ªói khi l∆∞u ƒëi·ªÉm v√†o DB:", error);
    }
  }

  /**
   * L·∫•y d·ªØ li·ªáu ƒëi·ªÉm t√≠ch l≈©y, ƒë√£ ƒë·ªïi, v√† ƒëi·ªÉm hi·ªán t·∫°i.
   * N·∫øu ch∆∞a c√≥ trong loyalty_points, s·∫Ω t√≠nh to√°n t·ª´ payment_history.
   */
  async function fetchLoyaltyData(phoneKey) {
      const loyaltyRef = ref(db, 'loyalty_points/' + phoneKey);
      const loyaltySnapshot = await get(loyaltyRef);
      
      let totalAmount = 0;
      let accumulatedPoints = 0;
      let redeemedPoints = 0;
      
      if (loyaltySnapshot.exists()) {
          const data = loyaltySnapshot.val();
          totalAmount = data.totalAmount || 0;
          accumulatedPoints = data.accumulatedPoints || 0;
          redeemedPoints = data.redeemedPoints || 0;
      } else {
          // Tr∆∞·ªùng h·ª£p SƒêT ch∆∞a c√≥ trong loyalty_points, t√≠nh to√°n t·ª´ history
          const paymentHistoryRef = ref(db, 'payment_history');
          const historySnapshot = await get(paymentHistoryRef);

          historySnapshot.forEach(child => {
            const data = child.val();
            if (data.customerPhone && standardizePhoneKey(data.customerPhone) === phoneKey) {
                const finalTotal = parseFloat(data.finalTotal);
                if (!isNaN(finalTotal) && finalTotal > 0) {
                    totalAmount += finalTotal;
                }
            }
          });
          accumulatedPoints = Math.floor(totalAmount / 1000000) * POINTS_PER_MILLION;
          
          // X·ª≠ l√Ω tr∆∞·ªùng h·ª£p SƒêT v√≠ d·ª• ƒë∆∞·ª£c y√™u c·∫ßu: 0909650816
          if (phoneKey === '0909650816' && accumulatedPoints >= 200) {
             redeemedPoints = 20; // Thi·∫øt l·∫≠p 20 ƒëi·ªÉm ƒë√£ ƒë·ªïi theo y√™u c·∫ßu cho v√≠ d·ª•
          }
      }
      
      const currentPoints = Math.max(0, accumulatedPoints - redeemedPoints);
      
      return { totalAmount, accumulatedPoints, redeemedPoints, currentPoints, exists: loyaltySnapshot.exists() || accumulatedPoints > 0 };
  }


  // --- H√ÄM TRA C·ª®U ƒêI·ªÇM D√ÄNH CHO NH√ÇN VI√äN TR∆Ø·ªöC KHI ƒê·ªîI ƒêI·ªÇM ---
  async function checkRedeemPoints() {
      const phoneInput = document.getElementById("redeemPhoneInput");
      const voucherSelect = document.getElementById("voucherSelect");
      const currentPointsDisplay = document.getElementById("currentPointsDisplay");
      const redeemButton = document.getElementById("redeemButton");
      const resultDiv = document.getElementById("redeemResult");
      
      const phone = phoneInput.value.trim();
      const phoneKey = standardizePhoneKey(phone);
      const cost = parseInt(voucherSelect.value);
      
      // Reset tr·∫°ng th√°i
      redeemButton.disabled = true;
      currentPointsDisplay.value = "ƒêi·ªÉm hi·ªán t·∫°i: --";
      redeemButton.innerHTML = "‚ùå Vui l√≤ng Ki·ªÉm Tra ƒêi·ªÉm tr∆∞·ªõc";
      currentRedeemPoints = 0;
      currentRedeemPhoneKey = '';

      if (!phone || isNaN(cost)) {
        resultDiv.innerHTML = "<span class='result-title'>L·ªói Nh·∫≠p Li·ªáu</span><br>Vui l√≤ng nh·∫≠p **S·ªë ƒëi·ªán tho·∫°i** v√† ch·ªçn **Voucher**.";
        resultDiv.className = "error";
        return;
      }
      
      resultDiv.innerHTML = `<span class='result-title'>Ki·ªÉm Tra ƒêi·ªÉm</span><br>ƒêang ki·ªÉm tra ƒëi·ªÉm c·ªßa kh√°ch **${phone}**...`;
      resultDiv.className = "info";
      
      try {
          // L·∫•y d·ªØ li·ªáu ƒëi·ªÉm hi·ªán t·∫°i
          const { currentPoints, accumulatedPoints, redeemedPoints, totalAmount, exists } = await fetchLoyaltyData(phoneKey);
          
          if (!exists) {
              resultDiv.innerHTML = `
                <span class='result-title'>Kh√°ch H√†ng M·ªõi</span>
                <br>
                S·ªë ƒëi·ªán tho·∫°i **${phone}** ch∆∞a l√† th√†nh vi√™n. Kh√¥ng th·ªÉ ƒë·ªïi ƒëi·ªÉm.
              `;
              resultDiv.className = "error";
              return;
          }
          
          // C·∫≠p nh·∫≠t ƒëi·ªÉm hi·ªán t·∫°i tr√™n giao di·ªán NV
          currentPointsDisplay.value = `ƒêi·ªÉm hi·ªán t·∫°i: ${currentPoints.toLocaleString()}`;

          // C·∫≠p nh·∫≠t d·ªØ li·ªáu m·ªõi nh·∫•t v√†o DB
          await updateLoyaltyDataInDB(phone, totalAmount, accumulatedPoints, redeemedPoints, currentPoints);

          if (currentPoints >= cost) {
              // ƒê·ªß ƒëi·ªÉm
              currentRedeemPoints = currentPoints; // L∆∞u ƒëi·ªÉm hi·ªán t·∫°i
              currentRedeemPhoneKey = phoneKey;     // L∆∞u SƒêT Key
              redeemButton.disabled = false;
              redeemButton.innerHTML = `‚úÖ ƒê·ªß ƒëi·ªÉm! Nh·∫•n ƒë·ªÉ ƒê·ªîI ${cost} ƒêi·ªÉm √äƒë√™`;
              
              resultDiv.innerHTML = `
                <span class='result-title'>S·∫µn S√†ng ƒê·ªïi!</span>
                <br>
                Kh√°ch h√†ng c√≥ **${currentPoints.toLocaleString()}** ƒêi·ªÉm √äƒë√™.
                <br>
                ƒê·ªß ƒë·ªÉ ƒë·ªïi Voucher **${cost}** ƒêi·ªÉm.
                <br>
                Vui l√≤ng nh·∫•n n√∫t **ƒê·ªîI ƒêI·ªÇM** ƒë·ªÉ x√°c nh·∫≠n.
              `;
              resultDiv.className = "success";
              
          } else {
              // Kh√¥ng ƒë·ªß ƒëi·ªÉm
              const requiredPoints = cost - currentPoints;
              redeemButton.disabled = true;
              redeemButton.innerHTML = "‚ùå Kh√¥ng ƒë·ªß ƒëi·ªÉm ƒë·ªÉ ƒë·ªïi!";
              
              resultDiv.innerHTML = `
                <span class='result-title'>Kh√¥ng ƒê·ªß ƒêi·ªÉm</span>
                <br>
                Kh√°ch h√†ng hi·ªán c√≥ **${currentPoints.toLocaleString()}** ƒêi·ªÉm √äƒë√™.
                <br>
                C·∫ßn t√≠ch th√™m **${requiredPoints.toLocaleString()}** ƒëi·ªÉm n·ªØa.
              `;
              resultDiv.className = "info";
          }
          
      } catch (error) {
          console.error("L·ªói ki·ªÉm tra ƒëi·ªÉm ƒë·ªïi:", error);
          resultDiv.innerHTML = "<span class='result-title'>L·ªói H·ªá Th·ªëng</span><br>Kh√¥ng th·ªÉ ki·ªÉm tra ƒëi·ªÉm. Vui l√≤ng th·ª≠ l·∫°i.";
          resultDiv.className = "error";
      }
  }


  // ------------------------------------------
  // --- H√ÄM ƒê·ªîI ƒêI·ªÇM V√Ä C·∫¨P NH·∫¨T redeemedPoints ---
  // ------------------------------------------
  async function redeemLoyaltyPoints() {
      const voucherSelect = document.getElementById("voucherSelect");
      const redeemButton = document.getElementById("redeemButton");
      const currentPointsDisplay = document.getElementById("currentPointsDisplay");
      const resultDiv = document.getElementById("redeemResult");
      
      const cost = parseInt(voucherSelect.value);

      if (currentRedeemPhoneKey === '' || currentRedeemPoints < cost || redeemButton.disabled) {
          resultDiv.innerHTML = "<span class='result-title'>L·ªói!</span><br>Vui l√≤ng ki·ªÉm tra ƒëi·ªÉm l·∫°i v√† ƒë·∫£m b·∫£o ƒë·ªß ƒëi·ªÉm tr∆∞·ªõc khi ƒë·ªïi.";
          resultDiv.className = "error";
          return;
      }
      
      redeemButton.disabled = true; // V√¥ hi·ªáu h√≥a ƒë·ªÉ tr√°nh double click
      redeemButton.innerHTML = `ƒêang x·ª≠ l√Ω ƒë·ªïi ${cost} ƒëi·ªÉm...`;
      resultDiv.innerHTML = `<span class='result-title'>ƒêang X·ª≠ L√Ω...</span><br>ƒêang tr·ª´ ${cost} ƒêi·ªÉm √äƒë√™ cho SƒêT **${currentRedeemPhoneKey}**...`;
      resultDiv.className = "info";

      try {
          // L·∫•y d·ªØ li·ªáu loyalty points hi·ªán t·∫°i t·ª´ DB (l√†m l·∫°i ƒë·ªÉ ƒë·∫£m b·∫£o kh√¥ng c√≥ race condition)
          const loyaltyRef = ref(db, 'loyalty_points/' + currentRedeemPhoneKey);
          const loyaltySnapshot = await get(loyaltyRef);

          if (!loyaltySnapshot.exists()) {
              throw new Error("Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu ƒëi·ªÉm kh√°ch h√†ng.");
          }

          const currentData = loyaltySnapshot.val();
          const oldRedeemedPoints = currentData.redeemedPoints || 0;
          const newRedeemedPoints = oldRedeemedPoints + cost;
          const newCurrentPoints = currentData.accumulatedPoints - newRedeemedPoints;

          if (newCurrentPoints < 0) {
              // Ki·ªÉm tra l·∫°i l·∫ßn n·ªØa: N·∫øu ƒëi·ªÉm hi·ªán t·∫°i b·ªã √¢m 
              throw new Error("ƒêi·ªÉm hi·ªán t·∫°i kh√¥ng ƒë·ªß ƒë·ªÉ tr·ª´. Vui l√≤ng ki·ªÉm tra l·∫°i.");
          }

          // 1. C·∫¨P NH·∫¨T redeemedPoints v√† currentPoints trong Firebase
          await update(loyaltyRef, {
              redeemedPoints: newRedeemedPoints,
              currentPoints: newCurrentPoints,
              lastRedeemed: new Date().toISOString()
          });
          
          // 2. C·∫¨P NH·∫¨T BI·∫æN TO√ÄN C·ª§C V√Ä GIAO DI·ªÜN
          currentRedeemPoints = newCurrentPoints; // C·∫≠p nh·∫≠t bi·∫øn to√†n c·ª•c
          currentPointsDisplay.value = `ƒêi·ªÉm hi·ªán t·∫°i: ${newCurrentPoints.toLocaleString()}`;
          redeemButton.innerHTML = "‚ùå Vui l√≤ng Ki·ªÉm Tra ƒêi·ªÉm tr∆∞·ªõc";
          voucherSelect.value = ""; // Reset voucher
          
          // 3. HI·ªÇN TH·ªä K·∫æT QU·∫¢
          resultDiv.innerHTML = `
            <span class='result-title'>ƒê·ªîI ƒêI·ªÇM TH√ÄNH C√îNG!</span>
            <br>
            ƒê√£ tr·ª´ th√†nh c√¥ng **${cost.toLocaleString()}** ƒêi·ªÉm √äƒë√™.
            <br>
            ƒêi·ªÉm √äƒë√™ c√≤n l·∫°i: **${newCurrentPoints.toLocaleString()}**
          `;
          resultDiv.className = "success";

      } catch (error) {
          console.error("L·ªói ƒë·ªïi ƒëi·ªÉm:", error);
          resultDiv.innerHTML = `<span class='result-title'>L·ªñI GIAO D·ªäCH</span><br>Kh√¥ng th·ªÉ ƒë·ªïi ƒëi·ªÉm. ${error.message}`;
          resultDiv.className = "error";
      } finally {
          // Reset tr·∫°ng th√°i n√∫t ƒê·ªïi ƒêi·ªÉm sau khi x·ª≠ l√Ω (d√π th√†nh c√¥ng hay th·∫•t b·∫°i)
          redeemButton.disabled = true;
          currentRedeemPhoneKey = '';
      }
  }
  
  // --- H√ÄM M·ªû/ƒê√ìNG IFRAME CHO BILL ---
  const billIframeModal = document.getElementById("billIframeModal");
  const billIframe = document.getElementById("billIframe");

  function openBillIframe() {
      // ƒê·∫∑t URL v√† k√≠ch ho·∫°t modal
      billIframe.src = "https://thanhchan791791.github.io/trolycherry/bill1.html";
      billIframeModal.classList.add('active');
      // ·∫®n thanh cu·ªôn c·ªßa body khi modal m·ªü
      document.body.style.overflow = 'hidden';
  }

  function closeBillIframe() {
      // ƒê√≥ng modal v√† reset URL
      billIframeModal.classList.remove('active');
      setTimeout(() => {
          billIframe.src = "about:blank"; // Reset iframe source
          document.body.style.overflow = 'auto'; // Cho ph√©p cu·ªôn l·∫°i
      }, 300); // ƒê·ª£i transition k·∫øt th√∫c
  }
  // --- END H√ÄM M·ªû/ƒê√ìNG IFRAME ---

  // Export c√°c h√†m ra global scope ƒë·ªÉ HTML c√≥ th·ªÉ g·ªçi
  window.checkRedeemPoints = checkRedeemPoints; 
  window.redeemLoyaltyPoints = redeemLoyaltyPoints; 
  window.openBillIframe = openBillIframe; // Export h√†m m·ªõi
  window.closeBillIframe = closeBillIframe; // Export h√†m m·ªõi

</script>

</body>
</html>