<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Theo Dõi Trạng Thái Bàn - Realtime</title>
    <!-- Load Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /*
         * --- iOS STYLE BASE ---
         * Font: San Francisco (SF Pro Display) or system fallback
         * Dark Mode: Automatic using prefers-color-scheme
         */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        :root {
            /* iOS Light Mode Colors */
            --background-primary: #f2f2f7; /* Lighter than white for depth */
            --background-secondary: #ffffff; /* Card/Container background */
            --text-primary: #1c1c1e;
            --accent-blue: #007aff;
            --accent-orange: #ff9500;
        }

        @media (prefers-color-scheme: dark) {
            /* iOS Dark Mode Colors */
            :root {
                --background-primary: #000000;
                --background-secondary: #1c1c1e;
                --text-primary: #ffffff;
                /* Accent colors remain vibrant */
            }
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, 'Inter', sans-serif;
            background-color: var(--background-primary);
            color: var(--text-primary);
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        /* --- Custom Animations (for smooth iOS-like appearance) --- */

        /* Keyframes for soft fade/slide in */
        @keyframes fadeInSlideUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Keyframes for Modal entry */
        @keyframes modalFadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* --- Element Styles --- */

        /* 1. iOS Card Style (Floating, Large Radius) */
        .ios-card {
            border-radius: 20px; /* Large rounded corners (16-24px) */
            background-color: var(--background-secondary);
            /* Soft, lifted shadow for floating effect */
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08); 
            transition: all 0.2s cubic-bezier(0.17, 0.67, 0.83, 0.67); /* Smooth transition */
            padding: 24px; /* Standard iOS spacing */
        }

        /* 2. Interactive Table Card (Hover/Tap Effects) */
        .table-card {
            cursor: pointer;
            user-select: none;
        }
        .table-card:hover {
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.12); /* Lift slightly on hover */
            transform: translateY(-2px);
        }
        .table-card:active {
            transform: scale(0.97); /* iOS tap effect */
            box-shadow: none; /* Shadow disappears on press */
        }

        /* 3. iOS Button Styling (Shared for all primary buttons) */
        .ios-button {
            border-radius: 12px;
            font-weight: 600;
            transition: transform 0.15s ease, box-shadow 0.15s ease, background-color 0.15s ease;
        }
        .ios-button:active {
            transform: scale(0.97);
            box-shadow: none;
        }

        /* 4. Modal Backdrop (Glassmorphism/Blur Effect) */
        .modal-backdrop {
            display: flex;
            animation: modalFadeIn 0.3s ease-out;
            /* iOS Control Center Blur Effect */
            backdrop-filter: blur(20px); 
            -webkit-backdrop-filter: blur(20px);
            background-color: rgba(0, 0, 0, 0.4);
        }

        /* 5. Modal Content Styling */
        #modal-content {
            border-radius: 32px; /* Extra large radius for modal */
            background-color: rgba(255, 255, 255, 0.9); /* Semi-transparent white */
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            opacity: 0;
            transform: scale(0.95);
            animation: fadeInSlideUp 0.3s forwards cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        
        @media (prefers-color-scheme: dark) {
             #modal-content {
                background-color: rgba(28, 28, 30, 0.9); /* Semi-transparent dark gray */
            }
        }

        /* 6. List/Order Item Styling */
        .ios-list-item {
            background-color: var(--background-secondary);
            padding: 12px 16px;
            border-radius: 12px;
            box-shadow: none;
            border: 1px solid rgba(0, 0, 0, 0.05); /* Very subtle border */
            transition: all 0.2s ease;
        }
        @media (prefers-color-scheme: dark) {
             .ios-list-item {
                border: 1px solid rgba(255, 255, 255, 0.1); 
            }
        }
        
    </style>
</head>
<body class="min-h-screen">

    <div class="container mx-auto p-4 md:p-8">
        <!-- Header (iOS Title Bar style) -->
        <header class="py-4 mb-6">
            <h1 class="text-3xl font-bold text-left md:text-4xl text-primary">
                Trạng Thái <span class="text-red-600">Bàn</span>
            </h1>
            <p class="text-sm text-gray-500 mt-1">Quản lý Realtime</p>
        </header>

        <!-- Loading Indicator -->
        <div id="loading" class="text-center p-8 text-gray-500">
            <svg class="animate-spin h-8 w-8 text-accent-blue mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" style="color: var(--accent-blue);">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="mt-3 text-sm">Đang kết nối tới Firebase...</p>
        </div>

        <!-- Tables Grid Container -->
        <!-- Use iOS-style 16px gap -->
        <div id="tables-container" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4"> 
            <!-- Table cards will be inserted here by JavaScript -->
        </div>

        <!-- Error Message -->
        <div id="error-message" class="hidden text-center p-4 mt-6 ios-card bg-red-50" role="alert">
            <p class="font-bold text-red-600">Lỗi Kết Nối</p>
            <p class="text-sm text-red-700">Không thể tải dữ liệu bàn. Vui lòng kiểm tra console log.</p>
        </div>
    </div>

    <!-- Modal Popup for Table Actions and Orders (Start) -->
    <!-- Apply modal-backdrop class for blur effect -->
    <div id="table-modal" class="fixed inset-0 z-50 hidden items-center justify-center p-4"> 
        <!-- Modal size adjusted for mobile/tablet viewing -->
        <!-- Tailwind classes adapted for new iOS style and animation -->
        <div id="modal-content" class="w-full max-w-4xl h-[90vh] overflow-hidden flex flex-col">
            
            <!-- Modal Header (Slightly opaque background for depth) -->
            <div id="modal-header" class="p-4 border-b border-gray-200 flex justify-between items-center flex-shrink-0 bg-white/70" 
                 style="backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);">
                <h3 id="modal-table-name" class="text-xl font-bold text-primary">Thông tin Bàn</h3>
                <!-- Close Button (iOS style) -->
                <button onclick="closeTableModal()" class="w-8 h-8 rounded-full bg-gray-200 hover:bg-gray-300 flex items-center justify-center text-gray-700 ios-button">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" stroke-width="3"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            
            <!-- Modal Body Container (Content Area) -->
            <div id="modal-body-container" class="flex-grow overflow-y-auto p-4 space-y-4">
                
                <!-- 1. Main Action Buttons Section (View 1: Default/Orders List) -->
                <div id="main-actions-section" class="space-y-4">
                    <!-- iOS Accent Blue Button -->
                    <button id="btn-order" data-table-name="" class="ios-button w-full py-3 text-lg font-semibold text-white" 
                            style="background-color: var(--accent-blue); box-shadow: 0 4px 10px rgba(0, 122, 255, 0.3);">
                        &#x1F37D; Đặt Món (Mở Menu tại chỗ)
                    </button>
                    <!-- iOS Accent Orange Button -->
                    <button id="btn-view-orders" class="ios-button w-full py-3 text-lg font-semibold text-white" 
                            style="background-color: var(--accent-orange); box-shadow: 0 4px 10px rgba(255, 149, 0, 0.3);">
                        &#x1F4DC; Xem Món Đã Order
                    </button>
                    
                    <!-- Ordered Items Display (Card style) -->
                    <div id="ordered-items-display" class="hidden mt-4 ios-card p-4">
                        <p class="font-bold text-lg border-b pb-3 mb-3 text-primary flex justify-between items-center">
                            Danh sách Món Đã Order 
                            <span id="order-status-indicator" class="text-sm font-normal text-red-600"></span>
                        </p>
                        <!-- Updated list style to use ios-list-item for smooth appearance -->
                        <ul id="order-list" class="space-y-2 text-sm divide-y divide-gray-100"> 
                            <!-- Items populated by JS -->
                        </ul>
                    </div>
                </div>

                <!-- 2. Menu Iframe Section (View 2: Iframe Menu) -->
                <div id="iframe-section" class="hidden w-full h-full flex flex-col absolute inset-0 rounded-[32px] overflow-hidden">
                    <div class="p-3 border-b border-gray-200 flex items-center flex-shrink-0 bg-white/80" 
                        style="backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);">
                        <!-- iOS Back Button (Chevron style) -->
                        <button id="btn-back-to-actions" class="flex items-center text-sm font-medium text-accent-blue ios-button p-1 -ml-1">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" style="stroke-width: 2.5;">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"></path>
                            </svg>
                            Quay Lại
                        </button>
                        <span class="font-bold text-base text-primary mx-auto pr-8">Đặt Món (Bàn <span id="iframe-table-name"></span>)</span>
                    </div>
                    <!-- The iframe loads the menu URL -->
                    <!-- Removed border and added background for seamless look -->
                    <iframe id="menu-iframe" src="" class="flex-grow w-full border-0 bg-white"></iframe> 
                </div>

            </div>
            
            <!-- Modal Footer (Only shown in Main Action View) -->
            <div id="modal-footer" class="p-4 border-t border-gray-200 text-right flex-shrink-0 bg-white/70"
                 style="backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);">
                <!-- iOS Tertiary Button -->
                <button onclick="closeTableModal()" class="ios-button px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 shadow-sm">Đóng</button>
            </div>
        </div>
    </div>
    <!-- Modal Popup (End) -->


    <!-- Firebase SDK Imports (type="module" is required) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";

        // Your web app's Firebase configuration (using the configuration provided by the user)
        // ** DO NOT MODIFY THIS BLOCK **
        const firebaseConfig = {
            apiKey: "AIzaSyB8uLkLJFlzmCodcawJhs2dRckHQzO5y10",
            authDomain: "chitieu-7263e.firebaseapp.com",
            databaseURL: "https://chitieu-7263e-default-rtdb.firebaseio.com",
            projectId: "chitieu-7263e",
            storageBucket: "chitieu-7263e.firebasestorage.app",
            messagingSenderId: "83833140682",
            appId: "1:83833140682:web:f9254b418ace3a659fcb33",
            measurementId: "G-523X74K18N"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        
        // --- GLOBAL STATE & CONSTANTS ---
        let allTablesData = {};
        let allOrders = {};
        // UPDATED: Sử dụng địa chỉ IP và cổng cục bộ theo yêu cầu.
        const MENU_BASE_URL = "http://192.168.156.106:5000/?table="; 

        // References to DOM elements
        const tablesContainer = document.getElementById('tables-container');
        const loadingIndicator = document.getElementById('loading');
        const errorMessage = document.getElementById('error-message');
        
        // References for the Modal
        const tableModal = document.getElementById('table-modal');
        const modalContent = document.getElementById('modal-content');
        const modalTableName = document.getElementById('modal-table-name');
        const modalFooter = document.getElementById('modal-footer');
        
        const mainActionsSection = document.getElementById('main-actions-section');
        const iframeSection = document.getElementById('iframe-section');
        const menuIframe = document.getElementById('menu-iframe');
        const btnOrder = document.getElementById('btn-order');
        const btnViewOrders = document.getElementById('btn-view-orders');
        const btnBackToActions = document.getElementById('btn-back-to-actions');
        const iframeTableNameSpan = document.getElementById('iframe-table-name');

        const orderedItemsDisplay = document.getElementById('ordered-items-display');
        const orderList = document.getElementById('order-list');
        const orderStatusIndicator = document.getElementById('order-status-indicator');

        // --- MODAL VIEW MANAGEMENT FUNCTIONS ---

        /**
         * Sets the modal view to show the main action buttons and order summary.
         * @param {string} tableName - The user-friendly name of the table.
         */
        function showActionButtonsView(tableName) {
            // Revert modal size for action view
            modalContent.classList.remove('max-w-4xl', 'h-[90vh]');
            modalContent.classList.add('max-w-md', 'h-auto', 'max-h-[90vh]'); // Set back to smaller width

            // Update header and view visibility
            modalTableName.textContent = `Thao tác với Bàn: ${tableName}`;
            iframeSection.classList.add('hidden');
            mainActionsSection.classList.remove('hidden');
            orderedItemsDisplay.classList.add('hidden'); 
            modalFooter.classList.remove('hidden');
        }

        /**
         * Sets the modal view to show the menu iframe.
         * @param {string} tableId - The Firebase key of the table.
         * @param {string} tableName - The user-friendly name of the table.
         */
        function showMenuIframeView(tableId, tableName) {
            // Adjust modal size for iframe view
            modalContent.classList.remove('max-w-md', 'h-auto');
            modalContent.classList.add('max-w-4xl', 'h-[90vh]'); // Set to larger size

            // Update header and view visibility
            modalTableName.textContent = `Đặt Món cho Bàn: ${tableName}`;
            iframeTableNameSpan.textContent = tableName;

            // Đảm bảo tên bàn có khoảng trắng (ví dụ: "VIP 1") được mã hóa thành "VIP%201"
            const encodedTableName = encodeURIComponent(tableName);
            
            // Load URL với tham số tên bàn đã được mã hóa
            const menuUrlWithTable = `${MENU_BASE_URL}${encodedTableName}`;
            menuIframe.src = menuUrlWithTable; 
            console.log("Loading Menu URL:", menuUrlWithTable);

            // Swap views
            mainActionsSection.classList.add('hidden');
            iframeSection.classList.remove('hidden');
            modalFooter.classList.add('hidden'); // Hide footer close button
        }


        /**
         * Closes the action modal.
         */
        window.closeTableModal = () => {
            // Remove animation class before hiding
            tableModal.classList.remove('modal-backdrop');
            modalContent.style.animation = 'none';

            // Wait a moment for the reverse animation (optional, but good for cleanup)
            setTimeout(() => {
                tableModal.classList.add('hidden');
                modalContent.style.animation = ''; // Reset animation style
                menuIframe.src = ''; // Clean up iframe source
            }, 100); 
        };
        
        /**
         * Renders the orders for a specific table ID.
         * @param {string} tableId - The Firebase key of the table.
         * @param {string} tableName - The user-friendly name of the table.
         */
        function displayTableOrders(tableId, tableName) {
            orderList.innerHTML = ''; // Clear previous items
            let totalItemsCount = 0;
            let totalPrice = 0;
            let hasPending = false;
            let foundOrder = false;
            
            // Normalize tableName for case-insensitive matching
            const normalizedTableName = tableName.toLowerCase();

            // Iterate through all top-level orders
            Object.entries(allOrders).forEach(([orderKey, orderValue]) => {
                
                // *** LOGIC ĐỐI SÁNH ĐƠN HÀNG (QUAN TRỌNG) ***
                // Kiểm tra orderValue.tableId (ID Firebase) HOẶC orderValue.tableName (tên thân thiện) 
                // có khớp với ID hoặc Tên thân thiện của bàn đang được xem hay không.
                const orderTableId = orderValue.tableId || '';
                const orderTableName = (orderValue.tableName || '').toLowerCase();
                
                const isMatch = (
                    orderTableId === tableId || 
                    orderTableName === normalizedTableName
                );

                if (isMatch && orderValue.items) {
                    foundOrder = true;
                    // Iterate through the items of this specific order
                    Object.values(orderValue.items).forEach(item => {
                        const itemTotal = (item.price || 0) * (item.quantity || 1);
                        totalPrice += itemTotal;
                        totalItemsCount += (item.quantity || 1);
                        
                        const status = (item.status || 'pending').toLowerCase(); // Default to pending
                        
                        // Check for pending status to flag the order
                        if (status === 'pending') {
                            hasPending = true;
                        }
                        
                        // Formatting price
                        const formattedPrice = (item.price || 0).toLocaleString('vi-VN');
                        
                        // Sử dụng tên trạng thái tiếng Việt
                        let statusText = '';
                        let statusClass = '';
                        
                        switch (status) {
                            case 'pending':
                                statusText = 'Chưa Xong';
                                statusClass = 'bg-red-500 text-white';
                                break;
                            case 'done':
                            case 'served':
                            case 'completed': 
                                statusText = 'Đã Xong';
                                statusClass = 'bg-green-500 text-white';
                                break;
                            default:
                                statusText = 'Không rõ';
                                statusClass = 'bg-gray-300 text-gray-800';
                                break;
                        }

                        const itemHtml = `
                            <li class="flex justify-between items-center py-2 border-b border-gray-100 last:border-b-0">
                                <div class="flex-1 min-w-0">
                                    <span class="font-medium text-primary">${item.itemName || 'Món không tên'}</span>
                                    <span class="block text-xs text-gray-500 italic">(${item.type || 'Khác'})</span>
                                </div>
                                <div class="flex flex-col items-end pl-3">
                                    <span class="text-sm font-semibold">${item.quantity || 1} x ${formattedPrice} VNĐ</span>
                                    <!-- Hiển thị trạng thái tiếng Việt -->
                                    <span class="text-xs font-medium uppercase mt-1 px-2 py-0.5 rounded-full ${statusClass}">
                                        ${statusText}
                                    </span>
                                </div>
                            </li>
                        `;
                        orderList.insertAdjacentHTML('beforeend', itemHtml);
                    });
                }
            });

            // Update status indicator and summary
            if (hasPending) {
                orderStatusIndicator.textContent = '(Có món Chưa Xong)';
                orderStatusIndicator.classList.remove('text-green-600');
                orderStatusIndicator.classList.add('text-red-600');
            } else if (foundOrder) {
                orderStatusIndicator.textContent = '(Tất cả đã Xong)';
                orderStatusIndicator.classList.remove('text-red-600');
                orderStatusIndicator.classList.add('text-green-600');
            } else {
                 // Nếu không tìm thấy đơn hàng nào
                 orderStatusIndicator.textContent = '';
                 orderStatusIndicator.classList.remove('text-red-600', 'text-green-600');
            }


            if (totalItemsCount === 0) {
                orderList.innerHTML = '<p class="text-center italic text-gray-500 p-4 text-sm">Bàn này chưa có món nào được đặt.</p>';
            } else {
                // Add total summary (iOS style: bold, distinct color)
                const summaryHtml = `
                    <li class="mt-4 pt-3 border-t-2 border-gray-300 flex justify-between items-center font-extrabold text-base" style="color: var(--accent-blue);">
                        <span>TỔNG CỘNG (${totalItemsCount} món)</span>
                        <span>${totalPrice.toLocaleString('vi-VN')} VNĐ</span>
                    </li>
                `;
                orderList.insertAdjacentHTML('beforeend', summaryHtml);
            }

            // Show the order list section
            orderedItemsDisplay.classList.remove('hidden');
        }


        /**
         * Opens the modal for a specific table.
         * @param {string} tableId - The Firebase key of the table.
         * @param {string} tableName - The user-friendly name of the table (e.g., "B1").
         */
        window.openTableModal = (tableId, tableName) => {
            // Set initial view to action buttons
            showActionButtonsView(tableName); 

            // Set data attributes for button handlers
            btnOrder.setAttribute('data-table-id', tableId);
            btnOrder.setAttribute('data-table-name', tableName);
            btnViewOrders.setAttribute('data-table-id', tableId);

            // Show the modal backdrop and trigger iOS animation
            tableModal.classList.remove('hidden');
            tableModal.classList.add('modal-backdrop');
            modalContent.style.animation = 'fadeInSlideUp 0.3s forwards cubic-bezier(0.2, 0.8, 0.2, 1)';
        };

        // --- EVENT LISTENERS FOR MODAL BUTTONS ---

        // 1. Order Button: Displays the menu iframe
        btnOrder.addEventListener('click', () => {
            const tableId = btnOrder.getAttribute('data-table-id');
            const tableName = btnOrder.getAttribute('data-table-name');
            showMenuIframeView(tableId, tableName);
        });

        // 2. View Orders Button: Displays the order list
        btnViewOrders.addEventListener('click', (event) => {
            const tableId = event.currentTarget.getAttribute('data-table-id');
            const tableName = allTablesData[tableId]?.name || `[ID: ${tableId}]`;
            displayTableOrders(tableId, tableName);
        });

        // 3. Back Button (Quay Lại): Returns from iframe to action buttons
        btnBackToActions.addEventListener('click', () => {
            const tableName = btnOrder.getAttribute('data-table-name');
            showActionButtonsView(tableName);
            menuIframe.src = ''; // Clear iframe content
        });

        // --- FIREBASE LISTENERS ---

        /**
         * Renders the table list based on the snapshot data.
         * @param {object} tablesData - An object containing table data keyed by their IDs.
         */
        function renderTables(tablesData) {
            allTablesData = tablesData; // Update global table data state
            tablesContainer.innerHTML = '';
            
            const tableEntries = tablesData ? Object.entries(tablesData) : [];
            
            // Sort tables alphabetically by name (e.g., B1, B2, VIP 1, VIP 2)
            tableEntries.sort(([, a], [, b]) => {
                const nameA = a.name || "";
                const nameB = b.name || "";
                return nameA.localeCompare(nameB, undefined, { numeric: true, sensitivity: 'base' });
            });

            if (tableEntries.length === 0) {
                 tablesContainer.innerHTML = '<p class="text-center col-span-full text-gray-500 p-10 ios-card">Không tìm thấy dữ liệu bàn nào.</p>';
                 return;
            }

            tableEntries.forEach(([key, table], index) => {
                const name = table.name || `[ID: ${key}]`;
                const status = (table.status || 'unknown').toLowerCase();
                
                let statusText = '';
                let statusColorClass = 'bg-gray-400';
                let icon = ''; 
                let innerTextColor = 'text-primary';
                let animationStyle = `animation: fadeInSlideUp 0.3s ease-out forwards; animation-delay: ${index * 0.05}s; opacity: 0;`;

                switch (status) {
                    case 'occupied':
                        statusText = 'Đang có Khách';
                        statusColorClass = 'bg-red-500 text-white';
                        icon = '&#x1F6D1;'; // Red sign
                        innerTextColor = 'text-white';
                        break;
                    case 'available':
                        statusText = 'Sẵn sàng';
                        statusColorClass = 'bg-green-500 text-white';
                        icon = '&#x2705;'; // Check mark
                        innerTextColor = 'text-white';
                        break;
                    default:
                        statusText = 'Không rõ';
                        statusColorClass = 'bg-gray-300 text-gray-800';
                        icon = '&#x2753;'; // Question mark
                        innerTextColor = 'text-primary';
                        break;
                }
                
                // Construct inner content with appropriate colors
                let contentColorClass = innerTextColor;
                let titleColorClass = innerTextColor;

                // Adjust text colors for contrast on colored backgrounds
                if (status === 'occupied' || status === 'available') {
                    contentColorClass = 'text-white/90';
                    titleColorClass = 'text-white';
                } else {
                    contentColorClass = 'text-gray-500';
                    titleColorClass = 'text-primary';
                }

                // Add the onclick handler to call openTableModal with key (ID) and name
                const cardHtml = `
                    <button onclick="openTableModal('${key}', '${name}')" 
                            class="table-card p-4 h-36 flex flex-col justify-between ios-card ${statusColorClass}" 
                            style="${animationStyle}">
                        <div class="flex items-center justify-between">
                            <h2 class="text-3xl font-bold ${titleColorClass}">${name}</h2>
                            <span class="text-4xl leading-none">${icon}</span>
                        </div>
                        <div class="border-t border-opacity-30 pt-3">
                            <p class="text-xs font-semibold ${contentColorClass} opacity-80">Trạng thái:</p>
                            <p class="text-lg font-extrabold uppercase ${titleColorClass}">${statusText}</p>
                        </div>
                    </button>
                `;
                
                tablesContainer.insertAdjacentHTML('beforeend', cardHtml);
            });
        }

        /**
         * Setup Realtime Database listener for the 'tables' node (Table Status).
         */
        function setupTableListener() {
            const tablesRef = ref(db, 'tables');

            try {
                onValue(tablesRef, (snapshot) => {
                    loadingIndicator.classList.add('hidden');
                    
                    if (snapshot.exists()) {
                        const tablesData = snapshot.val();
                        console.log("Firebase Table Data Received:", tablesData);
                        renderTables(tablesData);
                    } else {
                        console.log("No data available at /tables");
                        renderTables(null);
                    }
                }, 
                (error) => {
                    loadingIndicator.classList.add('hidden');
                    errorMessage.classList.remove('hidden');
                    console.error("Firebase Read Error:", error);
                });
            } catch (e) {
                loadingIndicator.classList.add('hidden');
                errorMessage.classList.remove('hidden');
                console.error("Initialization or Listener Setup Error:", e);
            }
        }

        /**
         * Setup Realtime Database listener for the 'kitchen_bar_orders' node (Order Data).
         */
        function setupOrderListener() {
            const ordersRef = ref(db, 'kitchen_bar_orders');
            onValue(ordersRef, (snapshot) => {
                if (snapshot.exists()) {
                    allOrders = snapshot.val();
                    console.log("Firebase Order Data Received:", allOrders);
                    // Khi dữ liệu order thay đổi, nếu modal đang mở, cập nhật lại danh sách order
                    const currentTableId = btnViewOrders.getAttribute('data-table-id');
                    if (tableModal.classList.contains('modal-backdrop') && currentTableId) {
                        const currentTableName = btnOrder.getAttribute('data-table-name');
                        // Chỉ cập nhật nếu đang ở chế độ xem đơn hàng (đảm bảo orderedItemsDisplay không ẩn)
                        if (!orderedItemsDisplay.classList.contains('hidden')) {
                            displayTableOrders(currentTableId, currentTableName);
                        }
                    }
                } else {
                    allOrders = {};
                }
            }, (error) => {
                console.error("Firebase Order Read Error:", error);
            });
        }


        // Start the process when the script loads
        setupTableListener();
        setupOrderListener();

    </script>
</body>
</html>
