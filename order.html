<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªá th·ªëng qu·∫£n l√Ω nh√† h√†ng - Qu·∫£n l√Ω B√°n h√†ng</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* START: UI n√¢ng c·∫•p - iOS Style */
        :root {
            /* M√†u s·∫Øc iOS */
            --ios-blue: #007AFF;
            --ios-green: #34C759;
            --ios-red: #FF3B30;
            --ios-light-gray: #EFEFF4;
            --ios-system-fill: #F2F2F7;
            --ios-separator: rgba(0, 0, 0, 0.1);
            
            /* Mapping sang bi·∫øn g·ªëc */
            --primary-color: var(--ios-blue); /* Thay th·∫ø m√†u xanh l√° b·∫±ng iOS Blue */
            --secondary-color: #555; /* ƒê·∫≠m h∆°n ch√∫t so v·ªõi text color */
            --info-color: var(--ios-blue);
            --success-color: var(--ios-green);
            --warning-color: #FF9500; /* M√†u v√†ng cam iOS */
            --bg-color: var(--ios-system-fill); /* N·ªÅn h·ªá th·ªëng */
            --card-bg: #fff;
            --text-color: #000;
            --border-color: var(--ios-separator);
            --box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1), 0 0 0 0.5px var(--ios-separator); /* Shadow nh·∫π + border m·ªèng */
        }

        body {
            /* Font iOS - S·∫Ω s·ª≠ d·ª•ng 'system-ui' ho·∫∑c font t∆∞∆°ng t·ª± n·∫øu kh√¥ng ph·∫£i iOS */
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
            margin: 0;
            padding: 0; /* Padding ƒë∆∞·ª£c chuy·ªÉn v√†o container */
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-bottom: 90px; /* TƒÉng padding d∆∞·ªõi cho nav bar ki·ªÉu iOS */
        }

        .container {
            width: 100%;
            max-width: 1400px;
            background-color: transparent; /* Container kh√¥ng c√≥ n·ªÅn */
            border-radius: 0;
            box-shadow: none;
            padding: 0 15px; /* Padding ngang ki·ªÉu iOS */
            margin-bottom: 20px;
        }

        .header {
            text-align: center;
            margin: 20px 0;
            padding: 10px 0;
            /* Thi·∫øt k·∫ø ki·ªÉu Navigation Bar */
            background-color: var(--card-bg);
            border-bottom: 1px solid var(--ios-separator);
            box-shadow: 0 0.5px 0 rgba(0, 0, 0, 0.05);
            /* Position c·ªë ƒë·ªãnh ki·ªÉu iOS Top Bar (t√πy ch·ªçn) */
            /* position: sticky; top: 0; z-index: 999; */ 
        }

        .header h1 {
            font-size: 1.5em;
            font-weight: 600; /* Semibold */
            color: var(--text-color);
            margin: 0;
        }

        /* N√¢ng c·∫•p Tab Bar iOS */
        .nav-buttons {
            position: fixed;
            bottom: 0;
            left: 0; /* K√©o r·ªông to√†n m√†n h√¨nh */
            transform: none; /* B·ªè transform */
            width: 100%;
            max-width: none;
            display: flex;
            justify-content: space-around;
            padding: 5px 0;
            background-color: #f7f7f7; /* M√†u n·ªÅn Tab Bar */
            box-shadow: 0 -1px 0 rgba(0, 0, 0, 0.1); /* Shadow tr√™n nh·∫π */
            z-index: 1000;
            height: 60px; /* Chi·ªÅu cao Tab Bar */
            border-top: 1px solid var(--ios-separator);
        }

        .nav-button {
            padding: 5px 10px; /* Gi·∫£m padding */
            border: none;
            border-radius: 0; /* B·ªè bo g√≥c */
            background-color: transparent; /* N·ªÅn trong su·ªët */
            color: #8E8E93; /* M√†u icon/text m·∫∑c ƒë·ªãnh (iOS Gray) */
            font-size: 12px; /* Font nh·ªè h∆°n cho Tab Bar */
            cursor: pointer;
            transition: color 0.2s, background-color 0.2s;
            flex-grow: 1;
            margin: 0;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 3px; /* Kho·∫£ng c√°ch icon v√† text */
        }

        .nav-button:hover {
            background-color: transparent;
            color: var(--ios-blue); /* Hover ƒë·ªïi m√†u iOS Blue */
            transform: none; /* B·ªè transform */
        }

        .nav-button.active {
            background-color: transparent;
            color: var(--ios-blue); /* M√†u active l√† iOS Blue */
        }
        
        .nav-button i {
            font-size: 1.5em; /* Icon to h∆°n */
        }
        
        .nav-button span {
            font-weight: 500; /* Medium */
        }
        /* END: UI n√¢ng c·∫•p - iOS Style */

        .content-section {
            display: none;
            animation: fadeIn 0.5s ease-in-out;
            padding-top: 1px; /* Kh·∫Øc ph·ª•c l·ªói margin collapse v·ªõi header */
        }

        .content-section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* START: UI n√¢ng c·∫•p - iOS Card/List Style */
        .card {
            background-color: var(--card-bg);
            border-radius: 10px; /* Bo g√≥c tr√≤n h∆°n */
            padding: 15px; /* Padding nh·∫π h∆°n */
            margin-bottom: 15px;
            box-shadow: 0 0 0 0.5px var(--ios-separator), 0 2px 4px rgba(0, 0, 0, 0.04); /* Border m·ªèng v√† shadow nh·∫π */
            border: none; /* B·ªè border g·ªëc */
            overflow: hidden; /* C·∫ßn thi·∫øt cho input b√™n trong */
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--ios-separator); /* Separator */
        }

        h2, h3 {
            color: var(--text-color); /* M√†u ch·ªØ ƒëen/text-color */
            font-weight: 600; /* Semibold */
            margin: 0;
        }
        
        h3 {
            font-size: 1.1em;
            color: var(--secondary-color);
        }

        /* iOS Input Style */
        input[type="text"], input[type="number"], select {
            width: 100%;
            padding: 10px 15px;
            margin-bottom: 10px;
            border: 1px solid #ccc;
            border-radius: 8px; /* Bo g√≥c tr√≤n */
            box-sizing: border-box;
            background-color: var(--card-bg);
            transition: border-color 0.3s;
        }

        input[type="text"]:focus, input[type="number"]:focus, select[type="focus"] {
            border-color: var(--ios-blue);
            outline: none;
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.2);
        }
        /* END: UI n√¢ng c·∫•p - iOS Card/List Style */

        /* START: UI n√¢ng c·∫•p - iOS Button Style */
        .add-button, .remove-button, .select-table-btn, .checkout-table-btn, .pay-button, .print-button {
            border: none;
            padding: 10px 20px;
            border-radius: 10px; /* Bo g√≥c l·ªõn ki·ªÉu iOS */
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s, box-shadow 0.2s;
            font-weight: 600;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .add-button, .select-table-btn {
            background-color: var(--ios-blue);
            color: white;
        }
        
        .add-button:hover, .select-table-btn:hover {
            background-color: #0071E3; /* M√†u ƒë·∫≠m h∆°n khi hover */
            transform: translateY(-1px);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.15);
        }

        .add-button:active, .select-table-btn:active {
            transform: translateY(0);
            box-shadow: none;
        }

        .remove-button, .checkout-table-btn {
            background-color: var(--ios-red); /* M√†u ƒë·ªè iOS */
            color: white;
        }
        
        .remove-button:hover, .checkout-table-btn:hover {
            background-color: #D62D26;
            transform: translateY(-1px);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.15);
        }

        .remove-button:active, .checkout-table-btn:active {
            transform: translateY(0);
            box-shadow: none;
        }
        
        .pay-button {
            background-color: var(--ios-green);
        }
        
        .pay-button:hover {
            background-color: #30B453;
        }
        
        .print-button {
            background-color: var(--ios-blue);
        }

        .table-card .btn-group button {
             padding: 8px 15px;
             border-radius: 8px;
        }

        .order-item .complete-btn {
            background-color: var(--ios-blue);
            border-radius: 8px;
            padding: 6px 12px;
            font-weight: 500;
        }
        
        .order-item .complete-btn:hover {
            background-color: #1e88e5;
        }
        /* END: UI n√¢ng c·∫•p - iOS Button Style */

        /* B·∫£ng & Danh s√°ch */
        .list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .tables-list-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px; /* Gi·∫£m kho·∫£ng c√°ch */
            margin-top: 15px;
        }
        
        .table-card {
            background-color: var(--card-bg); /* Gi·ªØ m√†u card n·ªÅn tr·∫Øng */
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 0 0 0.5px var(--ios-separator), 0 2px 5px rgba(0, 0, 0, 0.05);
            border: none;
            text-align: center;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .table-card:hover {
            transform: scale(1.02); /* Hi·ªáu ·ª©ng n·ªïi nh·∫π */
            box-shadow: 0 0 0 0.5px var(--ios-blue), 0 4px 10px rgba(0, 0, 0, 0.1);
        }
        
        .table-card h3 {
            font-size: 1.3em;
            margin: 0 0 8px 0;
            color: var(--text-color);
        }

        .table-card .status {
            display: block; /* Hi·ªÉn th·ªã block */
            margin-bottom: 10px;
            padding: 5px 10px;
            border-radius: 6px;
            font-weight: 500;
        }

        .table-card .status.available {
            background-color: #E8F5E9;
            color: var(--ios-green);
        }
        
        .table-card .status.occupied {
            background-color: #FFF3E0;
            color: var(--warning-color);
        }

        .list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: var(--card-bg);
            padding: 12px 15px;
            border-bottom: 1px solid var(--ios-separator);
            cursor: pointer;
            transition: background-color 0.1s;
        }
        
        .list-item.selected {
            background-color: #E6F0FF; /* N·ªÅn xanh nh·∫°t iOS */
            border-left: 5px solid var(--ios-blue);
        }

        .list-item:last-child {
            border-bottom: none;
        }

        .list-item span {
            font-weight: 500;
        }

        .order-item {
            background-color: var(--card-bg);
            border-left: 5px solid var(--ios-blue);
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        /* Status Badges */
        .status {
            font-weight: 600;
            padding: 3px 8px;
            border-radius: 12px; /* Pill shape */
            font-size: 0.85em;
        }

        .status.pending {
            color: var(--warning-color);
            background-color: #FFF3E0;
            border: none;
        }
        
        .status.completed {
            color: var(--ios-green);
            background-color: #E8F5E9;
            border: none;
        }
        
        .status.paid {
            color: var(--ios-blue);
            background-color: #E6F0FF;
            border: none;
        }

        .table-view {
            display: none;
        }
        
        .table-view.active {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
        }

        .menu-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); /* Gi·∫£m k√≠ch th∆∞·ªõc item */
            gap: 10px;
        }

        .menu-item {
            background-color: var(--ios-light-gray); /* N·ªÅn nh·∫π */
            border: none;
            border-radius: 10px;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            transition: transform 0.1s, box-shadow 0.2s, background-color 0.2s;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }
        
        .menu-item:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            background-color: #E5E5EA; /* M√†u nh·∫•n nh·∫π */
        }
        
        .menu-item:active {
            transform: scale(0.98);
            box-shadow: none;
        }
        
        .menu-item h4 {
            margin: 0 0 3px 0;
            font-size: 1em;
            font-weight: 500;
            color: var(--text-color);
        }
        
        .menu-item p {
            margin: 0;
            font-weight: 600;
            color: var(--ios-red); /* Gi√° m√†u ƒë·ªè n·ªïi b·∫≠t */
            font-size: 1.1em;
        }
        
        .order-summary {
            background-color: var(--ios-system-fill); /* N·ªÅn t·ªïng quan nh·∫π */
            padding: 15px;
            border-radius: 8px;
            min-height: 150px;
        }
        
        .order-summary-item {
            
            align-items: flex-start; /* CƒÉn tr√™n c√πng */
            padding: 8px 0;
            border-bottom: 1px solid var(--ios-separator); /* Separator m·ªèng */
        }
        
        .order-summary-item-content {
            display: flex;
            justify-content: space-between;
            width: 100%;
        }
        
        .order-details-combo {
            font-size: 0.9em;
            color: var(--secondary-color);
            margin-top: 5px;
            padding-left: 10px;
            white-space: pre-wrap; /* Gi·ªØ ƒë·ªãnh d·∫°ng xu·ªëng d√≤ng */
        }

        .quantity-controls button {
            background-color: #F7F7F7;
            border: 1px solid #ccc;
            padding: 2px 7px;
            cursor: pointer;
            font-weight: bold;
            border-radius: 50%; /* N√∫t tr√≤n */
            width: 25px;
            height: 25px;
            line-height: 1;
            display: inline-flex;
            justify-content: center;
            align-items: center;
        }

        /* Modal cho H√≥a ƒë∆°n (Gi·ªØ nguy√™n c·∫•u tr√∫c ƒë·ªÉ ƒë·∫£m b·∫£o Print ho·∫°t ƒë·ªông) */
        .modal {
            display: none;
            position: fixed;
            z-index: 1001;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.6); /* N·ªÅn t·ªëi h∆°n cho iOS */
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.3s;
        }

        .modal-content {
            background-color: #fefefe;
            padding: 30px;
            border-radius: 14px; /* Bo g√≥c l·ªõn h∆°n */
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
            max-width: 450px;
            width: 90%;
            text-align: center;
            position: relative;
        }
        
        /* Modal M·∫πt Combo m·ªõi */
        #comboModal .modal-content {
            max-width: 600px;
            padding: 20px;
        }

        .combo-selection-container {
            text-align: left;
            margin-top: 15px;
        }

        .combo-selection-container h4 {
            color: var(--ios-red);
            margin-top: 15px;
            margin-bottom: 5px;
            font-size: 1.2em;
        }

        .combo-item-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            padding: 10px;
            background-color: var(--ios-system-fill);
            border-radius: 8px;
        }

        .combo-item {
            background-color: var(--card-bg);
            border: 1px solid var(--ios-separator);
            border-radius: 8px;
            padding: 8px 15px;
            cursor: pointer;
            transition: background-color 0.2s, border-color 0.2s;
            font-weight: 500;
        }

        .combo-item.selected {
            background-color: var(--ios-blue);
            color: white;
            border-color: var(--ios-blue);
        }
        
        .combo-item.selected:hover {
            background-color: #0071E3;
        }

        .combo-item:hover {
            background-color: var(--ios-light-gray);
        }
        /* End Modal M·∫πt Combo */
        
        .close-button {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 35px; /* To h∆°n ƒë·ªÉ d·ªÖ b·∫•m */
            font-weight: 300; /* Light */
            cursor: pointer;
            color: #555;
            transition: color 0.2s;
        }
        
        .close-button:hover {
            color: var(--ios-red);
        }

        /* Bill-specific styles (Ch·ªânh s·ª≠a ƒë·ªÉ cƒÉn l·ªÅ tr√°i ƒë·ªÅu v√† ƒë·∫πp) */
        .bill-header, .bill-summary {
            text-align: left; /* CƒÉn l·ªÅ tr√°i cho header v√† summary */
            color: #000;
            font-weight: 500;
        }
        
        .bill-header p {
            margin: 5px 0;
        }

        .bill-header h2 {
            font-size: 2.2em;
            color: #000;
            margin: 0;
            font-weight: 800;
            text-align: center; /* Gi·ªØ ti√™u ƒë·ªÅ trung t√¢m */
        }
        
        .bill-header h5 {
            text-align: center;
            margin: 5px 0 15px 0;
        }
        
        .bill-details {
             /* ƒê·∫£m b·∫£o b·∫£ng cƒÉn l·ªÅ tr√°i ƒë·ªÅu */
             width: 100%;
             margin: 15px 0;
        }
        
        .bill-details table {
            width: 100%;
            border-collapse: collapse;
            text-align: left; /* CƒÉn l·ªÅ tr√°i cho b·∫£ng */
        }
        
        .bill-details th, .bill-details td {
            font-size: 1.2em;
            color: #000;
            font-weight: 500;
            padding: 8px 0; /* Th√™m padding d·ªçc cho d·ªÖ ƒë·ªçc */
        }

        .bill-details th {
            border-bottom: 2px solid #000;
            font-weight: 700;
        }
        
        .bill-details td.item-name {
            width: 45%; /* T√™n m√≥n chi·∫øm nhi·ªÅu di·ªán t√≠ch h∆°n */
        }
        .bill-details th.item-qty, .bill-details td.item-qty {
            width: 15%;
            text-align: center; /* S·ªë l∆∞·ª£ng trung t√¢m */
        }
        .bill-details th.item-price, .bill-details td.item-price, 
        .bill-details th.item-total, .bill-details td.item-total {
             width: 20%;
             text-align: right; /* Gi√° ti·ªÅn cƒÉn ph·∫£i */
        }
        
        .bill-summary p {
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
            font-size: 1.1em;
            padding: 3px 0;
        }
        
        .bill-summary p span:first-child {
            font-weight: 500;
        }
        
        .bill-summary p span:last-child {
            font-weight: 700;
            text-align: right;
        }

        .bill-total-price {
            font-weight: 800 !important;
            font-size: 1.4em !important;
            color: var(--ios-red) !important; /* M√†u ƒë·ªè n·ªïi b·∫≠t cho t·ªïng */
        }
        
        .bill-qr-container {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px dashed #ccc;
            text-align: center;
        }
        
        .bill-qr-container img {
            max-width: 200px;
            height: auto;
            border: 2px solid #000; /* TƒÉng ƒë·ªô ƒë·∫≠m c·ªßa border */
            padding: 10px; /* TƒÉng padding ƒë·ªÉ QR n·ªïi b·∫≠t h∆°n */
            border-radius: 8px; /* Bo g√≥c nh·∫π */
        }

        /* Group button */
        .button-group-bill {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }
        
        /* Print styles - Gi·ªØ nguy√™n */
        @media print {
            @page { 
                margin: 0;
            }
            body * {
                visibility: hidden;
            }
            .modal-content, .modal-content * {
                visibility: visible;
                -webkit-print-color-adjust: exact; 
                print-color-adjust: exact;
                color: #000 !important;
                font-weight: bold !important;
            }
            .modal-content {
                position: absolute;
                left: 50%;
                top: 0;
                transform: translateX(-50%);
                width: 90%;
                max-width: 450px;
                padding: 10px;
                box-shadow: none;
                margin: 0 auto;
            }
            .close-button, .button-group-bill, .nav-buttons { 
                display: none !important;
            }
            /* Ch·ªânh s·ª≠a th√™m cho in ·∫•n ƒë·ªÉ ƒë·∫£m b·∫£o cƒÉn ch·ªânh ƒë·ªÅu */
             .bill-details table {
                 table-layout: fixed; /* Gi·ªØ nguy√™n chi·ªÅu r·ªông c·ªôt */
             }
             .bill-details th, .bill-details td {
                 padding: 4px 0; 
                 font-size: 1.1em !important; /* Gi·∫£m font size cho in nhi·ªát */
                 font-weight: 500 !important;
             }
             .bill-details th {
                 font-weight: 700 !important;
             }
             .bill-details td.item-price, .bill-details td.item-total {
                 text-align: right !important;
             }
             .bill-details th.item-total {
                 text-align: right !important;
             }
             .bill-details td.item-qty {
                 text-align: center !important;
             }
             .bill-summary p span:last-child {
                text-align: right;
             }
             .bill-total-price {
                 font-size: 1.4em !important;
             }
             .bill-qr-container img {
                 border: 2px solid #000;
             }
            .modal-content {
                overflow: visible !important; 
            }
        }
        /* END: UI n√¢ng c·∫•p */
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>H·ªá th·ªëng qu·∫£n l√Ω nh√† h√†ng üçΩÔ∏è</h1>
        </div>
        <div id="tables" class="content-section active">
            <div id="tableViewList" class="card">
                <div class="card-header">
                    <h2>Qu·∫£n l√Ω B√†n</h2>
                </div>
               
                <div id="tablesList" class="tables-list-container"></div>
            </div>
            
            <div id="tableOrderView" class="table-view">
                <div class="column-left">
                    <div class="card">
                        <div class="card-header">
                            <h2 id="currentTableName"></h2>
                            <button id="backToTables" class="remove-button" style="background-color: var(--ios-blue);"><i class="fas fa-arrow-left"></i> Quay l·∫°i</button>
                        </div>
                    </div>

                    <div class="card">
                        <h3>T√¨m ki·∫øm m√≥n</h3>
                        <input type="text" id="orderSearchInput" placeholder="T√¨m ki·∫øm m√≥n ƒÉn, th·ª©c u·ªëng...">
                    </div>
                    
                    <div class="card">
                        <h3>Menu ƒê·ªì ƒÉn</h3>
                        <div id="foodMenuOrderList" class="menu-list"></div>
                    </div>

                    <div class="card">
                        <h3>Menu Th·ª©c u·ªëng</h3>
                        <div id="drinkMenuOrderList" class="menu-list"></div>
                    </div>
                </div>

                <div class="column-right">
                    <div class="card">
                        <h3>Order hi·ªán t·∫°i</h3>
                        <div id="currentOrderSummary" class="order-summary">
                            <p>Ch·ªçn m√≥n t·ª´ menu ƒë·ªÉ th√™m v√†o order.</p>
                        </div>
                        <button id="sendOrderButton" class="add-button" style="width: 100%; margin-top: 15px;">G·ª≠i Order</button>
                    </div>
                    <div class="card">
                        <h3>ƒê∆°n ƒë√£ g·ª≠i</h3>
                        <ul id="sentOrdersList" class="list"></ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="paymentModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <div id="billContent"> 
                <div class="bill-header" style="text-align: center;">
                    <h2>·∫®m th·ª±c bu√¥n m√™</h2>
                    <h5>ƒê·∫≠m ƒë√† h∆∞∆°ng v·ªã c∆°m ƒë·ªìng b√†o √ä-ƒë√™</h5>
                    <div style="text-align: left; margin: 15px 0;">
                        <p>ƒê·ªãa ch·ªâ: 285/94b C√°ch M·∫°ng Th√°ng 8</p>
                        <p>Ng√†y: <span id="billDate"></span></p>
                        <p>Th·ªùi gian in: <span id="billTime"></span></p>
                        <p>B√†n: <span id="billTableInfo"></span></p>
                        <p>M√£ Hƒê: <span id="billId"></span></p>
                    </div>
                    </div>
                <div class="bill-details">
                    <table>
                        <thead>
                            <tr>
                                <th class="item-name" style="text-align: left;">T√™n m√≥n</th>
                                <th class="item-qty" style="text-align: center;">SL</th>
                                <th class="item-price" style="text-align: right;">ƒê∆°n gi√°</th>
                                <th class="item-total" style="text-align: right;">Th√†nh ti·ªÅn</th>
                            </tr>
                        </thead>
                        <tbody id="billDetailsBody"></tbody>
                    </table>
                </div>
                <div class="bill-summary">
                    <p><span>T·ªïng ti·ªÅn (Ch∆∞a VAT):</span> <span id="billTotalPrice"></span></p>
                    <p><span>VAT (10%):</span> <span id="billVatPrice"></span></p>
                    <p><span>Thanh to√°n:</span> <span id="billTotalPaid" class="bill-total-price"></span></p>
                    
                    <div class="bill-qr-container">
                        <p style="font-weight: 700; color: #000; margin-bottom: 10px; font-size: 1.2em;">Thanh to√°n b·∫±ng VietQR</p>
                        <img id="vietQrCode" alt="M√£ VietQR" style="width: 100%; max-width: 250px; display: block; margin: 0 auto;"/>
                        <p style="font-weight: 500; color: #000; margin-top: 5px;">NG√ÇN H√ÄNG: MB Bank</p>
                        <p style="font-weight: 500; color: #000; margin: 0;">S·ªê TK: 0909650816</p>
                        <p style="font-weight: 500; color: #000; margin: 0;">CH·ª¶ TK: TRAN VU NGOC THANH</p>
                    </div>
                    <p style="font-size: 1.2em; text-align: center; margin-top: 15px; font-weight: 700; color: #000;">C·∫£m ∆°n qu√Ω kh√°ch v√† h·∫πn g·∫∑p l·∫°i!</p>
                </div>
            </div>
            <div class="button-group-bill">
                <button id="printBillButton" class="print-button">In H√≥a ƒë∆°n</button> 
                <button id="confirmPaymentButton" class="pay-button">X√°c nh·∫≠n thanh to√°n</button>
            </div>
        </div>
    </div>
    
    <div id="comboModal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="closeComboModal">&times;</span>
            <h2 id="comboModalTitle">Ch·ªçn m√≥n cho M·∫πt Combo</h2>
            <p style="font-style: italic; color: var(--ios-red); font-weight: 500;">Vui l√≤ng ch·ªçn ƒë·ªß s·ªë l∆∞·ª£ng m√≥n</p>
            
            <div class="combo-selection-container">
                <h4 id="meatSelectionTitle">Ch·ªçn M√≥n Th·ªãt (<span id="meatCount">0</span>/<span id="requiredMeat">0</span>)</h4>
                <div id="meatList" class="combo-item-list">
                    </div>

                <h4 id="vegSelectionTitle">Ch·ªçn M√≥n Rau (<span id="vegCount">0</span>/<span id="requiredVeg">0</span>)</h4>
                <div id="vegList" class="combo-item-list">
                    </div>
            </div>
            
            <button id="confirmComboButton" class="add-button" style="width: 100%; margin-top: 20px;" disabled>X√°c nh·∫≠n</button>
        </div>
    </div>
    <div class="nav-buttons">
        <button class="nav-button active" data-section="tables">
            <i class="fas fa-utensils"></i>
            <span>B√°n h√†ng</span>
        </button>
        </div>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

    <script>
        // Your Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyB8uLkLJFlzmCodcawJhs2dRckHQzO5y10",
            authDomain: "chitieu-7263e.firebaseapp.com",
            databaseURL: "https://chitieu-7263e-default-rtdb.firebaseio.com",
            projectId: "chitieu-7263e",
            storageBucket: "chitieu-7263e.firebasestorage.app",
            messagingSenderId: "83833140682",
            appId: "1:83833140682:web:f9254b418ace3a659fcb33",
            measurementId: "G-523X74K18N"
        };
        
        // >> D√íNG TH√äM M·ªöI: API ENDPOINT CHO M√ÅY IN <<
        const PRINT_API_ENDPOINT = "http://192.168.156.210:5000/print";
        // ---------------------------------------------

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        
        // Telegram Bot Configuration
        const TELEGRAM_BOT_TOKEN = "7807531189:AAGhMQ9jjew7Q9ywMDSTaGDy4Ns6XtPQUrI";
        const TELEGRAM_CHAT_ID = "-4954039835";

        // DOM elements
        const navButtons = document.querySelectorAll('.nav-button');
        const sections = document.querySelectorAll('.content-section');
        const tableNameInput = document.getElementById('tableNameInput');

        const tablesList = document.getElementById('tablesList');
        
        // New elements for table view
        const tableViewList = document.getElementById('tableViewList');
        const tableOrderView = document.getElementById('tableOrderView');
        const currentTableName = document.getElementById('currentTableName');
        const backToTables = document.getElementById('backToTables');
        const foodMenuOrderList = document.getElementById('foodMenuOrderList');
        const drinkMenuOrderList = document.getElementById('drinkMenuOrderList');
        const currentOrderSummary = document.getElementById('currentOrderSummary');
        const sendOrderButton = document.getElementById('sendOrderButton');
        const sentOrdersList = document.getElementById('sentOrdersList');
        const orderSearchInput = document.getElementById('orderSearchInput');
        
       // Modal elements
        const paymentModal = document.getElementById('paymentModal');
        const closeButton = document.querySelector('.close-button');
        const billTableInfo = document.getElementById('billTableInfo');
        const billDate = document.getElementById('billDate');
        const billTime = document.getElementById('billTime'); 
        const billId = document.getElementById('billId');
        const billDetailsBody = document.getElementById('billDetailsBody');
        const billTotalPrice = document.getElementById('billTotalPrice');
        const billVatPrice = document.getElementById('billVatPrice');
        const billTotalPaid = document.getElementById('billTotalPaid');
        const confirmPaymentButton = document.getElementById('confirmPaymentButton');
        const printBillButton = document.getElementById('printBillButton'); 
        
        // VietQR Element
        const vietQrCode = document.getElementById('vietQrCode');

        let currentTableId = null;
        let currentTableNameValue = '';
        // C·∫≠p nh·∫≠t: currentOrderItems c√≥ th·ªÉ ch·ª©a th√™m tr∆∞·ªùng 'customizations'
        let currentOrderItems = {}; // { menuId: { name, price, type, quantity, customizations } }
        let allMenuItems = [];
        
        // START: COMBO MODAL VARIABLES
        const comboModal = document.getElementById('comboModal');
        const closeComboModal = document.getElementById('closeComboModal');
        const confirmComboButton = document.getElementById('confirmComboButton');
        const comboModalTitle = document.getElementById('comboModalTitle');
        const meatList = document.getElementById('meatList');
        const vegList = document.getElementById('vegList');
        const meatCountSpan = document.getElementById('meatCount');
        const vegCountSpan = document.getElementById('vegCount');
        const requiredMeatSpan = document.getElementById('requiredMeat');
        const requiredVegSpan = document.getElementById('requiredVeg');
        
        // L∆∞u tr·ªØ item combo ƒëang ƒë∆∞·ª£c ch·ªçn (base menuId, name, price, type)
        let currentComboItem = null; 
        let selectedMeatItems = new Set();
        let selectedVegItems = new Set();
        let requiredMeat = 0;
        let requiredVeg = 0;

        // D·ªØ li·ªáu m·∫´u cho combo (B·∫°n c·∫ßn thay ƒë·ªïi theo th·ª±c t·∫ø c·ªßa nh√† h√†ng)
        const meuComboItems = {
            meat: [
                'Th·ªãt Heo R·ª´ng H·∫•p', 'Th·ªãt Ba Ch·ªâ Cu·ªën', 'G√† N∆∞·ªõng M·∫≠t Ong', 
                'Th·ªãt B√≤ X√†o S·∫£ ·ªöt', 'S∆∞·ªùn Heo N∆∞·ªõng'
            ],
            veg: [
                'L√≤ng G√† X√†o MƒÉng', 'Tr·ª©ng Chi√™n Cu·ªôn', 'Canh Chua C√° L√≥c', 
                'G·ªèi Ng√≥ Sen T√¥m Th·ªãt', 'Rau Lu·ªôc Th·∫≠p C·∫©m'
            ]
        };
        // END: COMBO MODAL VARIABLES

        // >> START: CODE M·ªöI CHO REAL-TIME LISTENER
        let activeListeners = [];

        // H√†m d·ªçn d·∫πp t·∫•t c·∫£ c√°c listener hi·ªán t·∫°i
        function cleanupListeners() {
            activeListeners.forEach(listener => {
                if (listener.ref && listener.callback) {
                    listener.ref.off('value', listener.callback);
                }
            });
            activeListeners = [];
        }
        // << END: CODE M·ªöI CHO REAL-TIME LISTENER
        
        // H√†m chu·∫©n h√≥a chu·ªói (b·ªè d·∫•u, kho·∫£ng tr·∫Øng, chuy·ªÉn v·ªÅ th∆∞·ªùng)
        function normalizeString(str) {
            if (!str) return '';
            return str.toLowerCase()
                      .replace(/ /g, '')
                      .normalize("NFD").replace(/[\u0300-\u036f]/g, "");
        }

        // --- Telegram Notification Function ---
        function sendTelegramMessage(message) {
            const url = `https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`;
            const payload = {
                chat_id: TELEGRAM_CHAT_ID,
                text: message,
                parse_mode: 'HTML'
            };
            
            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            }).then(response => {
                if (!response.ok) {
                    console.error("L·ªói khi g·ª≠i tin nh·∫Øn Telegram.");
                }
            }).catch(error => {
                console.error("L·ªói m·∫°ng khi g·ª≠i tin nh·∫Øn Telegram:", error);
            });
        }
        
        // --- Main Navigation Logic ---
        navButtons.forEach(button => {
            button.addEventListener('click', () => {
                navButtons.forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                
                sections.forEach(sec => sec.classList.remove('active'));
                const sectionId = button.getAttribute('data-section');
                document.getElementById(sectionId).classList.add('active');
                
                if (sectionId === 'tables') {
                    // Khi chuy·ªÉn kh·ªèi ch·∫ø ƒë·ªô xem Order, d·ªçn d·∫πp Listener
                    cleanupListeners(); 
                    tableViewList.style.display = 'block';
                    tableOrderView.style.display = 'none';
                    renderTables();
                }
            });
        });

      

        function renderTables() {
            tablesList.innerHTML = '';
            // L·∫Øng nghe thay ƒë·ªïi tr√™n t·∫•t c·∫£ c√°c b√†n
            database.ref('tables').on('value', (snapshot) => {
                tablesList.innerHTML = '';
                snapshot.forEach((childSnapshot) => {
                    const table = childSnapshot.val();
                    const tableId = childSnapshot.key;
                    
                    const card = document.createElement('div');
                    card.classList.add('table-card');
                    
                    const statusText = table.status === 'available' ? 'C√≥ s·∫µn' : 'ƒêang s·ª≠ d·ª•ng';
                    const statusClass = table.status === 'available' ? 'available' : 'occupied';
                    
                    card.innerHTML = `
                        <h3>${table.name}</h3>
                        <span class="status ${statusClass}">${statusText}</span>
                        <div class="btn-group">
                            <button class="select-table-btn add-button" data-table-id="${tableId}" data-table-name="${table.name}">Ch·ªçn b√†n</button>
                            
                        </div>
                    `;
                    tablesList.appendChild(card);

                    card.querySelector('.select-table-btn').addEventListener('click', () => {
                        currentTableId = tableId;
                        currentTableNameValue = table.name;
                        currentOrderItems = {};
                        currentTableName.textContent = `B√†n: ${currentTableNameValue}`;
                        tableViewList.style.display = 'none';
                        tableOrderView.style.display = 'grid';
                        loadAllMenuItems();
                        renderTableSentOrders();
                        updateCheckoutButtonVisibility();
                    });
                    
                    const checkoutBtn = card.querySelector('.checkout-table-btn');
                    if (checkoutBtn) {
                        checkoutBtn.addEventListener('click', () => showPaymentModal(tableId, table.name));
                    }
                });
            });
        }
        
        // --- Table Order View ---
        backToTables.addEventListener('click', () => {
            cleanupListeners(); // D·ªçn d·∫πp listener khi quay l·∫°i danh s√°ch b√†n
            tableViewList.style.display = 'block';
            tableOrderView.style.display = 'none';
        });

      

        function loadAllMenuItems() {
            allMenuItems = [];
            foodMenuOrderList.innerHTML = '';
            drinkMenuOrderList.innerHTML = '';

            // T·∫£i Menu ƒê·ªì ƒÉn
            database.ref('menu/food').once('value', (snapshot) => {
                snapshot.forEach((childSnapshot) => {
                    allMenuItems.push({
                        id: childSnapshot.key,
                        ...childSnapshot.val(),
                        type: 'food'
                    });
                });
                renderMenuForOrder();
            });

            // T·∫£i Menu Th·ª©c u·ªëng
            database.ref('menu/drink').once('value', (snapshot) => {
                snapshot.forEach((childSnapshot) => {
                    allMenuItems.push({
                        id: childSnapshot.key,
                        ...childSnapshot.val(),
                        type: 'drink'
                    });
                });
                renderMenuForOrder();
            });
        }

        function renderMenuForOrder() {
            foodMenuOrderList.innerHTML = '';
            drinkMenuOrderList.innerHTML = '';
            allMenuItems.forEach(item => {
                const div = document.createElement('div');
                div.classList.add('menu-item');
                div.setAttribute('data-id', item.id);
                div.setAttribute('data-type', item.type);
                div.setAttribute('data-name', item.name);
                div.setAttribute('data-price', item.price);
                
                // Logic ph√°t hi·ªán Combo (ƒê√£ tinh ch·ªânh l·∫°i ƒë·ªÉ ƒë·∫£m b·∫£o t√≠nh ch√≠nh x√°c)
                const normalizedName = normalizeString(item.name);
                
                // *** Vui l√≤ng ki·ªÉm tra t√™n m√≥n trong Firebase c·ªßa b·∫°n, v√≠ d·ª•: "M·∫πt 4 M√≥n" ho·∫∑c "M·∫πt 5 M√≥n" ***
                if (normalizedName.includes('met5mon')) {
                     div.setAttribute('data-combo', '5');
                } else if (normalizedName.includes('met4mon')) {
                     div.setAttribute('data-combo', '4');
                }
                
                div.innerHTML = `
                    <h4>${item.name}</h4>
                    <p>${parseFloat(item.price).toLocaleString('vi-VN')}‚Ç´</p>
                `;

                if (item.type === 'food') {
                    foodMenuOrderList.appendChild(div);
                } else if (item.type === 'drink') {
                    drinkMenuOrderList.appendChild(div);
                }
            });
            addMenuListeners();
        }

        orderSearchInput.addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            filterMenuItems(searchTerm);
        });

        function filterMenuItems(searchTerm) {
            const foodItems = document.querySelectorAll('#foodMenuOrderList .menu-item');
            const drinkItems = document.querySelectorAll('#drinkMenuOrderList .menu-item');
            
            foodItems.forEach(item => {
                const itemName = item.getAttribute('data-name').toLowerCase();
                if (itemName.includes(searchTerm)) {
                    item.style.display = 'block';
                } else {
                    item.style.display = 'none';
                }
            });

            drinkItems.forEach(item => {
                const itemName = item.getAttribute('data-name').toLowerCase();
                if (itemName.includes(searchTerm)) {
                    item.style.display = 'block';
                } else {
                    item.style.display = 'none';
                }
            });
        }
        
        function addMenuListeners() {
            const menuItems = document.querySelectorAll('.menu-item');
            menuItems.forEach(item => {
                item.removeEventListener('click', handleMenuClick);
                item.addEventListener('click', handleMenuClick);
            });
        }

        function handleMenuClick(event) {
            const item = event.currentTarget;
            const menuId = item.getAttribute('data-id');
            const name = item.getAttribute('data-name');
            const price = parseFloat(item.getAttribute('data-price'));
            const type = item.getAttribute('data-type');
            
            // L·∫•y thu·ªôc t√≠nh combo ƒë√£ ƒë∆∞·ª£c ƒë·∫∑t trong renderMenuForOrder
            const isCombo = item.hasAttribute('data-combo'); 
            
            currentComboItem = { menuId, name, price, type };

            if (isCombo) {
                const comboType = item.getAttribute('data-combo'); // '5' ho·∫∑c '4'
                
                // Thi·∫øt l·∫≠p s·ªë l∆∞·ª£ng m√≥n c·∫ßn ch·ªçn
                if (comboType === '5') {
                    requiredMeat = 3;
                    requiredVeg = 2;
                } else if (comboType === '4') {
                    requiredMeat = 2;
                    requiredVeg = 2;
                }
                
                // Reset l·ª±a ch·ªçn c≈©
                selectedMeatItems.clear();
                selectedVegItems.clear();
                
                showComboModal(name, requiredMeat, requiredVeg);
            } else {
                // X·ª≠ l√Ω m√≥n ƒë∆°n b√¨nh th∆∞·ªùng: Kh√¥ng c√≥ customizations
                addToOrder(menuId, name, price, type, 1);
            }
        }
        
        // START: COMBO MODAL LOGIC
        function showComboModal(comboName, meatReq, vegReq) {
            comboModalTitle.textContent = `Ch·ªçn m√≥n cho ${comboName}`;
            requiredMeatSpan.textContent = meatReq;
            requiredVegSpan.textContent = vegReq;
            requiredMeat = meatReq;
            requiredVeg = vegReq;

            // Render danh s√°ch m√≥n
            renderComboList(meatList, meuComboItems.meat, 'meat');
            renderComboList(vegList, meuComboItems.veg, 'veg');
            
            updateComboCounts();
            comboModal.style.display = 'flex';
        }

        function renderComboList(container, items, itemType) {
            container.innerHTML = '';
            items.forEach(itemName => {
                const div = document.createElement('div');
                div.classList.add('combo-item');
                div.textContent = itemName;
                div.setAttribute('data-name', itemName);
                div.setAttribute('data-type', itemType);
                
                // Kh√¥i ph·ª•c tr·∫°ng th√°i ƒë√£ ch·ªçn n·∫øu c√≥
                const selectedSet = itemType === 'meat' ? selectedMeatItems : selectedVegItems;
                if (selectedSet.has(itemName)) {
                    div.classList.add('selected');
                }
                
                div.addEventListener('click', handleComboItemClick);
                container.appendChild(div);
            });
        }

        function handleComboItemClick(event) {
            const item = event.currentTarget;
            const itemName = item.getAttribute('data-name');
            const itemType = item.getAttribute('data-type');
            
            const isSelected = item.classList.contains('selected');

            if (itemType === 'meat') {
                if (isSelected) {
                    selectedMeatItems.delete(itemName);
                    item.classList.remove('selected');
                } else if (selectedMeatItems.size < requiredMeat) {
                    selectedMeatItems.add(itemName);
                    item.classList.add('selected');
                }
            } else if (itemType === 'veg') {
                if (isSelected) {
                    selectedVegItems.delete(itemName);
                    item.classList.remove('selected');
                } else if (selectedVegItems.size < requiredVeg) {
                    selectedVegItems.add(itemName);
                    item.classList.add('selected');
                }
            }
            
            updateComboCounts();
        }
        
        function updateComboCounts() {
            meatCountSpan.textContent = selectedMeatItems.size;
            vegCountSpan.textContent = selectedVegItems.size;
            
            const isMeatFull = selectedMeatItems.size === requiredMeat;
            const isVegFull = selectedVegItems.size === requiredVeg;
            
            confirmComboButton.disabled = !(isMeatFull && isVegFull);
        }

   confirmComboButton.addEventListener('click', () => {
    // X√¢y d·ª±ng chu·ªói chi ti·∫øt combo theo ƒë·ªãnh d·∫°ng [Nh√≥m: M√≥n1, M√≥n2]
    const meatDetails = selectedMeatItems.size > 0 ? `[Th·ªãt: ${[...selectedMeatItems].join(', ')}]` : '';
    const vegDetails = selectedVegItems.size > 0 ? `[Rau: ${[...selectedVegItems].join(', ')}]` : '';
    
    // T√°ch m√≥n canh ra kh·ªèi danh s√°ch rau (Gi·∫£ ƒë·ªãnh m√≥n canh c√≥ ch·ªØ 'Canh' trong t√™n)
    const selectedCanh = [...selectedVegItems].filter(name => name.toLowerCase().includes('canh'));
    const remainingVeg = [...selectedVegItems].filter(name => !name.toLowerCase().includes('canh'));
    
    // C·∫≠p nh·∫≠t chu·ªói rau v√† chu·ªói canh
    const canhDetails = selectedCanh.length > 0 ? `[Canh: ${selectedCanh.join(', ')}]` : '';
    const finalVegDetails = remainingVeg.length > 0 ? `[Rau: ${remainingVeg.join(', ')}]` : '';

    // Th√™m m√≥n combo ch√≠nh v√†o order, g·ªôp t·∫•t c·∫£ chi ti·∫øt
    const parts = [currentComboItem.name, canhDetails, meatDetails, finalVegDetails].filter(p => p !== '').join(' ');
    const comboNameWithDetails = parts.trim().replace(/\s+/g, ' '); 

    // T·∫°o ID duy nh·∫•t cho m√≥n combo c√≥ k√®m chi ti·∫øt ƒë·ªÉ ph√¢n bi·ªát
    const comboDetailId = `${currentComboItem.menuId}_${[...selectedMeatItems, ...selectedVegItems].join('_').replace(/[^a-zA-Z0-9]/g, '')}`;
    
    addToOrder(comboDetailId, comboNameWithDetails, currentComboItem.price, currentComboItem.type, 1);
    comboModal.style.display = 'none';

    // X√≥a l·ª±a ch·ªçn c≈©
    selectedMeatItems.clear();
    selectedVegItems.clear();
});

closeComboModal.onclick = () => {
    selectedMeatItems.clear();
    selectedVegItems.clear();
    comboModal.style.display = 'none';
};
        closeComboModal.onclick = () => comboModal.style.display = 'none';
        // END: COMBO MODAL LOGIC
        
        function addToOrder(menuId, name, price, type, quantity) {
             // Th√™m m√≥n ƒë∆°n (kh√¥ng c√≥ customizations)
             if (currentOrderItems[menuId]) {
                currentOrderItems[menuId].quantity += quantity;
            } else {
                currentOrderItems[menuId] = { 
                    name, 
                    price, 
                    type, 
                    quantity,
                    customizations: {} // << TH√äM TR∆Ø·ªúNG R·ªñNG CHO M√ìN ƒê∆†N
                };
            }
            updateOrderSummary();
        }

        // >> CH·ªàNH S·ª¨A: HI·ªÇN TH·ªä CHI TI·∫æT COMBO TRONG ORDER SUMMARY
        function updateOrderSummary() {
            let total = 0;
            currentOrderSummary.innerHTML = '';

            const orderedItems = Object.values(currentOrderItems);
            if (orderedItems.length === 0) {
                currentOrderSummary.innerHTML = '<p>Ch·ªçn m√≥n t·ª´ menu ƒë·ªÉ th√™m v√†o order.</p>';
                return;
            }

            Object.keys(currentOrderItems).forEach(menuId => {
                const item = currentOrderItems[menuId];
                
                let detailsHtml = '';
                let displayedName = item.name;
                
                if (item.customizations && Object.keys(item.customizations).length > 0) {
                    const allCustomizations = [
                        ...(item.customizations.meat || []),
                        ...(item.customizations.veg || [])
                    ];
                    
                    if (allCustomizations.length > 0) {
                        detailsHtml = `<p class="order-details-combo">(Chi ti·∫øt: ${allCustomizations.join(', ')})</p>`;
                    }
                }
                
                const div = document.createElement('div');
                div.classList.add('order-summary-item');
                div.innerHTML = `
                    <div class="order-summary-item-content">
                        <span style="max-width: 60%;">${displayedName}</span>
                        <div class="quantity-controls">
                            <span>x${item.quantity}</span>
                            <span>${(item.price * item.quantity).toLocaleString('vi-VN')}‚Ç´</span>
                            <button class="decrement-btn" data-id="${menuId}">-</button>
                        </div>
                    </div>
                    ${detailsHtml}
                `;
                currentOrderSummary.appendChild(div);
                total += item.price * item.quantity;
            });
            
            const totalDiv = document.createElement('div');
            // UI n√¢ng c·∫•p: M√†u t·ªïng ti·ªÅn ƒë·∫≠m h∆°n
            totalDiv.innerHTML = `<p style="font-weight: bold; margin-top: 10px;">T·ªïng ti·ªÅn: <span style="color: var(--ios-red); font-weight: 700;">${total.toLocaleString('vi-VN')}‚Ç´</span></p>`;
            currentOrderSummary.appendChild(totalDiv);

            currentOrderSummary.querySelectorAll('.decrement-btn').forEach(button => {
                button.addEventListener('click', (event) => {
                    const itemId = event.target.getAttribute('data-id');

                    if (currentOrderItems[itemId] && currentOrderItems[itemId].quantity > 1) {
                        currentOrderItems[itemId].quantity -= 1;
                    } else if (currentOrderItems[itemId]) {
                        delete currentOrderItems[itemId];
                    }
                    updateOrderSummary();
                });
            });
        }
        // >> K·∫æT TH√öC CH·ªàNH S·ª¨A: HI·ªÇN TH·ªä CHI TI·∫æT COMBO TRONG ORDER SUMMARY
        
       // --- Functionality to send new orders ---
sendOrderButton.addEventListener('click', () => {
    if (Object.keys(currentOrderItems).length === 0) {
        alert("Vui l√≤ng th√™m m√≥n v√†o order tr∆∞·ªõc khi g·ª≠i.");
        return;
    }

    const newOrderRef = database.ref(`orders/${currentTableId}`).push();
    const orderId = newOrderRef.key;
    const timestamp = Date.now();
    const updates = {};
    
    const itemsForFirebase = {};
    const itemsForTelegram = [];
    const itemsForPrint = []; // << D·ªØ li·ªáu m·ªõi theo y√™u c·∫ßu

    let message = `üì£ *ORDER M·ªöI - B√ÄN ${currentTableNameValue}* üì£\n\n`;

    for (const menuId in currentOrderItems) {
        const item = currentOrderItems[menuId];
        
        // D·ªØ li·ªáu cho Firebase
        itemsForFirebase[menuId] = {
            name: item.name,
            price: item.price,
            type: item.type,
            quantity: item.quantity,
            status: 'pending' // Tr·∫°ng th√°i ban ƒë·∫ßu
        };
        
        // D·ªØ li·ªáu cho Telegram
        itemsForTelegram.push(`- ${item.name} x ${item.quantity}`);
        
        // **********************************************
        // LOGIC CHU·∫®N H√ìA CHO M√ÅY IN (THEO Y√äU C·∫¶U C·ª¶A B·∫†N)
        itemsForPrint.push({
            name: item.name, // T√™n m√≥n ƒë√£ bao g·ªìm chi ti·∫øt combo n·∫øu c√≥
            qty: item.quantity
        });
        // **********************************************
    }

    // C·∫•u tr√∫c Payload chu·∫©n h√≥a cho m√°y in
    const printPayload = {
        table: currentTableNameValue,
        items: itemsForPrint
    };

    // Ghi log ƒë·ªÉ ki·ªÉm tra payload
    console.log("Payload g·ª≠i ƒë·∫øn m√°y in (chu·∫©n h√≥a):", JSON.stringify(printPayload, null, 2));


    // 1. C·∫≠p nh·∫≠t Firebase
    const newOrder = {
        orderId: orderId,
        timestamp: timestamp,
        items: itemsForFirebase,
        tableId: currentTableId,
        tableName: currentTableNameValue,
        status: 'pending' 
    };
    updates[`orders/${currentTableId}/${orderId}`] = newOrder;
    updates[`tables/${currentTableId}/status`] = 'occupied';
    
    database.ref().update(updates).then(() => {
        // 2. G·ª≠i th√¥ng b√°o Telegram
        message += itemsForTelegram.join('\n');
        sendTelegramMessage(message);

        // 3. G·ª≠i order ƒë·∫øn API m√°y in
        fetch(PRINT_API_ENDPOINT, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(printPayload) // << Payload ƒë√£ ƒë∆∞·ª£c chu·∫©n h√≥a
        }).then(response => {
            if (!response.ok) {
                console.error("L·ªói khi g·ª≠i order ƒë·∫øn m√°y in:", response.statusText);
            } else {
                console.log("Order ƒë√£ ƒë∆∞·ª£c g·ª≠i th√†nh c√¥ng ƒë·∫øn m√°y in.");
            }
        }).catch(error => {
            console.error("L·ªói m·∫°ng khi g·ª≠i order ƒë·∫øn m√°y in:", error);
        });

        // 4. Reset UI
        currentOrderItems = {};
        updateOrderSummary();
        renderTableSentOrders(); // T·∫£i l·∫°i danh s√°ch ƒë∆°n ƒë√£ g·ª≠i
        alert(`ƒê√£ g·ª≠i order m·ªõi cho b√†n ${currentTableNameValue}!`);
    }).catch(error => {
        console.error("L·ªói khi g·ª≠i order l√™n Firebase:", error);
        alert("L·ªói: Kh√¥ng th·ªÉ g·ª≠i order.");
    });
});
        // >> END: H√ÄM G·ª¨I ORDER (ƒê√É CH·ªàNH S·ª¨A G·ª¨I ƒê√öNG C·∫§U TR√öC JSON IN ·∫§N)

   
// H√†m kh·ªüi t·∫°o Listener ph·ª• cho tr·∫°ng th√°i m√≥n ƒÉn (theo d√µi tr·∫°ng th√°i tr√™n kitchen_bar_orders)
function startKitchenOrderListener(orderId, sentOrderItems) {
    const kitchenOrderRef = database.ref(`kitchen_bar_orders/${orderId}/items`);
    const kitchenOrderCallback = kitchenOrderRef.on('value', (kitchenItemsSnapshot) => {
        let itemsListHtml = '';
        const kitchenItems = kitchenItemsSnapshot.val() || {};
        
        // L·∫∑p qua c√°c m√≥n ƒë√£ ƒë∆∞·ª£c l∆∞u trong Order (T·∫°m coi l√† ƒë√£ l·∫•y t·ª´ kitchen_bar_orders)
        Object.keys(sentOrderItems).forEach(itemId => {
            const item = sentOrderItems[itemId];
            let currentStatus = item.status || 'pending'; // D√πng status ƒë√£ l∆∞u ban ƒë·∫ßu
            
            // L·∫•y tr·∫°ng th√°i m·ªõi nh·∫•t t·ª´ B·∫øp (n·∫øu t·ªìn t·∫°i)
            const kitchenItem = kitchenItems[itemId];
            if (kitchenItem && kitchenItem.status) {
                currentStatus = kitchenItem.status;
            }
            
            const statusText = currentStatus === 'completed' ? 'ƒê√£ xong' : 'ƒêang l√†m';
            const statusClass = currentStatus === 'completed' ? 'completed' : 'pending';
            
            // Hi·ªÉn th·ªã t√™n m√≥n + chi ti·∫øt combo trong danh s√°ch ƒë∆°n ƒë√£ g·ª≠i
            let nameDisplay = item.itemName || item.name;
            if (item.customizations && (item.customizations.meat || item.customizations.veg)) {
                 const allCustomizations = [
                    ...(item.customizations.meat || []),
                    ...(item.customizations.veg || [])
                ];
                 nameDisplay += ` (${allCustomizations.join(', ')})`;
            }

            itemsListHtml += `
                <li style="display: flex; justify-content: space-between; align-items: center; padding: 5px 0; border-bottom: 1px dotted var(--ios-separator);">
                    <span style="max-width: 70%;">${nameDisplay} x ${item.quantity}</span>
                    <span class="status ${statusClass}">${statusText}</span>
                </li>`;
        });
        
        // C·∫≠p nh·∫≠t HTML c·ªßa danh s√°ch m√≥n ƒÉn
        const itemsListElement = document.getElementById(`order-items-list-${orderId}`);
        if (itemsListElement) {
            itemsListElement.innerHTML = itemsListHtml;
        }

        // C·∫≠p nh·∫≠t n√∫t Thanh to√°n sau m·ªói l·∫ßn c·∫≠p nh·∫≠t tr·∫°ng th√°i
        updateCheckoutButtonVisibility();
    });

    // L∆∞u tr·ªØ listener ph·ª• ƒë·ªÉ d·ªçn d·∫πp
    activeListeners.push({ ref: kitchenOrderRef, callback: kitchenOrderCallback });
}


function renderTableSentOrders() {
    // D·ªçn d·∫πp t·∫•t c·∫£ listener c≈© khi h√†m ƒë∆∞·ª£c g·ªçi
    cleanupListeners();

    sentOrdersList.innerHTML = '';
    if (!currentTableId || !currentTableNameValue) return;

    // >> CH·ªà L·∫ÆNG NGHE T·ª™ KITCHEN_BAR_ORDERS D√ôNG QUERY THEO T√äN B√ÄN <<
    const kitchenOrdersRef = database.ref('kitchen_bar_orders').orderByChild('tableName').equalTo(currentTableNameValue);

    
    // L∆∞u tr·ªØ d·ªØ li·ªáu order
    let externalOrders = {};
    
    // H√†m render Order
    const renderOrders = (snapshot) => {
        externalOrders = snapshot.val() || {};
        
        sentOrdersList.innerHTML = '';
        const allOrders = [];

        // Th√™m Orders t·ª´ Kitchen/Bar
        Object.keys(externalOrders).forEach(orderId => {
            const order = externalOrders[orderId];
            
            // T·∫°o c·∫•u tr√∫c items ƒë·ªÉ t√°i s·ª≠ d·ª•ng logic
            const itemsForTableSent = {};
            if(order.items) {
                Object.keys(order.items).forEach(itemId => {
                    const item = order.items[itemId];
                    itemsForTableSent[itemId] = {
                        name: item.itemName, // Kitchen d√πng 'itemName'
                        price: item.price,
                        type: item.type,
                        quantity: item.quantity,
                        status: item.status, // L·∫•y status tr·ª±c ti·∫øp t·ª´ kitchen order item
                        customizations: item.customizations || {} // L·∫•y customizations
                    };
                });
            }
            
            // Ch·ªâ th√™m n·∫øu c√≥ items h·ª£p l·ªá
            if (Object.keys(itemsForTableSent).length > 0) {
                allOrders.push({
                    id: orderId,
                    timestamp: order.timestamp,
                    items: itemsForTableSent,
                    source: 'external' // ƒê√°nh d·∫•u l√† ngu·ªìn ngo√†i (t·ª´ kitchen_bar_orders)
                });
            }
        });
        
        // S·∫Øp x·∫øp theo th·ªùi gian m·ªõi nh·∫•t l√™n ƒë·∫ßu
        allOrders.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));


        // Render Order List
        allOrders.forEach(order => {
            const time = new Date(order.timestamp).toLocaleTimeString('vi-VN');

            const li = document.createElement('li');
            li.classList.add('order-item');
            li.id = `order-list-item-${order.id}`;

            // Ghi ch√∫ ngu·ªìn
            const sourceNote = '<span style="color: var(--warning-color); font-weight: 500;">(ƒê√£ g·ª≠i)</span>';

            let orderDetailsHtml = `<p><strong>Th·ªùi gian:</strong> ${time} ${sourceNote}</p><hr><ul id="order-items-list-${order.id}" style="list-style-type: none; padding: 0;"></ul>`;
            li.innerHTML = orderDetailsHtml;
            sentOrdersList.appendChild(li);

            // B·∫Øt ƒë·∫ßu l·∫Øng nghe tr·∫°ng th√°i c·ªßa m√≥n trong order n√†y (t·ª´ Kitchen/Bar)
            startKitchenOrderListener(order.id, order.items);
        });
        
        // C·∫≠p nh·∫≠t n√∫t Thanh to√°n sau khi render xong
        updateCheckoutButtonVisibility();
    };


    // Listener ch√≠nh cho Orders t·ª´ kitchen_bar_orders
    const externalCallback = kitchenOrdersRef.on('value', renderOrders);
    activeListeners.push({ ref: kitchenOrdersRef, callback: externalCallback });
}
// >> END: CODE ƒê√É CH·ªàNH S·ª¨A CH·ªà L·∫§Y T·ª™ KITCHEN_BAR_ORDERS
        // >> START: H√ÄM KI·ªÇM TRA CHECKOUT ƒê√É C·∫¨P NH·∫¨T
        function updateCheckoutButtonVisibility() {
            if (!currentTableId) {
                checkoutButton.style.display = 'none';
                return;
            }
            
            // Ki·ªÉm tra xem c√≥ m√≥n n√†o c√≥ tr·∫°ng th√°i 'completed' hay kh√¥ng
            database.ref(`tables/${currentTableId}/sentOrders`).once('value', snapshot => {
                let anyCompleted = false;
                
                // S·ª≠ d·ª•ng Promise.all ƒë·ªÉ ƒë·ª£i t·∫•t c·∫£ c√°c l·∫ßn ki·ªÉm tra tr·∫°ng th√°i t·ª´ B·∫øp
                const checkPromises = [];

                snapshot.forEach(sentOrderSnapshot => {
                    const sentOrder = sentOrderSnapshot.val();
                    if (sentOrder.items) {
                        const sentOrderId = sentOrderSnapshot.key;
                        
                        const promise = database.ref(`kitchen_bar_orders/${sentOrderId}/items`).once('value').then(kitchenItemsSnapshot => {
                            kitchenItemsSnapshot.forEach(itemSnapshot => {
                                if (itemSnapshot.val().status === 'completed') {
                                    anyCompleted = true;
                                }
                            });
                        });
                        checkPromises.push(promise);
                    }
                });
                
               

               
            });
        }
        // >> END: H√ÄM KI·ªÇM TRA CHECKOUT ƒê√É C·∫¨P NH·∫¨T
    // >> H√ÄM SHOW PAYMENT ƒê√É CH·ªàNH S·ª¨A L·∫†I LOGIC CH·ªêT ƒê∆†N V√Ä D√ôNG ASYNC/AWAIT <<
async function showPaymentModal(tableId, tableName) {
     const now = new Date();
    paymentModal.style.display = 'flex';
    billTableInfo.textContent = tableName;
    billDate.textContent = now.toLocaleDateString('vi-VN');
    billTime.textContent = now.toLocaleTimeString('vi-VN'); 
    billId.textContent = generateBillId();
    billDetailsBody.innerHTML = '';
    
    let totalAmount = 0;
    let combinedCompletedItems = {}; 
    let hasCompletedItemsToPay = false;
    
  // ...

    // Th√¥ng tin VietQR
    const acqId = "970422"; // MB Bank Napas acqId
    const accountNo = "0909650816";
    const accountName = "TRAN VU NGOC THANH";
    const amount = ""; // ƒë·ªÉ r·ªóng = kh√¥ng g·ª£i √Ω s·ªë ti·ªÅn
    const addInfo = ""; // n·ªôi dung chuy·ªÉn kho·∫£n m·∫∑c ƒë·ªãnh n·∫øu c·∫ßn

  // === N·ªòI DUNG CHUY·ªÇN KHO·∫¢N (ƒê√É S·ª¨A T·ª™ TR∆Ø·ªöC) ===
    let tableCode = tableName.replace(/[^a-zA-Z0-9]/g, '').toUpperCase(); // L·∫•y t√™n b√†n, b·ªè kho·∫£ng tr·∫Øng v√† k√Ω t·ª± ƒë·∫∑c bi·ªát
    let fullBillCode = billId.textContent ? billId.textContent : ''; // << L·∫§Y TO√ÄN B·ªò M√É Hƒê TR√äN BILL
    
    // ƒê·∫∑t n·ªôi dung chuy·ªÉn kho·∫£n l√† S·ªë B√†n v√† M√£ Hƒê (V√≠ d·ª•: BAN1.HD2410300945)
    let transferContent = `${tableCode}.${fullBillCode}`; // << S·ª¨ D·ª§NG FULL M√É Hƒê
    // ===========================================

    // URL VietQR (S·ª≠ d·ª•ng transferContent m·ªõi)
    let qrUrl = `https://img.vietqr.io/image/${acqId}-${accountNo}-compact.png`;
// ...
    // Th√™m n·ªôi dung chuy·ªÉn kho·∫£n v√†o URL (amount s·∫Ω ƒë∆∞·ª£c th√™m sau khi t√≠nh t·ªïng)
    if (transferContent || amount) {
        qrUrl += `?addInfo=${encodeURIComponent(transferContent)}`;
        if (amount) {
            qrUrl += `&amount=${amount}`;
        }
    }
    vietQrCode.src = qrUrl;

    confirmPaymentButton.onclick = () => confirmPayment(tableId, tableName);
    
    // L·∫•y t·∫•t c·∫£ c√°c ƒë∆°n h√†ng ƒë√£ g·ª≠i c·ªßa b√†n
    const sentOrdersSnapshot = await database.ref(`tables/${tableId}/sentOrders`).once('value');
    
    // T·∫°o m·∫£ng c√°c Promise ƒë·ªÉ ki·ªÉm tra tr·∫°ng th√°i B·∫øp/Bar cho t·ª´ng Order
    const checkPromises = [];

    sentOrdersSnapshot.forEach(sentOrderSnapshot => {
        const orderId = sentOrderSnapshot.key;
        const sentOrder = sentOrderSnapshot.val();

        if (sentOrder.items) {
            // L·∫•y tr·∫°ng th√°i chi ti·∫øt t·ª´ B·∫øp/Bar
            const kitchenPromise = database.ref(`kitchen_bar_orders/${orderId}/items`).once('value').then(kitchenItemsSnapshot => {
                const kitchenItems = kitchenItemsSnapshot.val() || {};
                
                // L·∫∑p qua c√°c m√≥n trong order ƒë√£ g·ª≠i c·ªßa b√†n
                Object.keys(sentOrder.items).forEach(itemId => {
                    const item = sentOrder.items[itemId];
                    const kitchenItem = kitchenItems[itemId];
                    
                    // CH·ªà T√çNH C√ÅC M√ìN C√ì TR·∫†NG TH√ÅI 'completed' T·ª™ KITCHEN_BAR_ORDERS
                    if (kitchenItem && kitchenItem.status === 'completed') {
                        hasCompletedItemsToPay = true;
                        
                        // L·∫•y key duy nh·∫•t cho m√≥n ƒë√£ ho√†n th√†nh (bao g·ªìm c·∫£ customizations)
                        const itemNameKey = item.name + (item.customizations ? JSON.stringify(item.customizations) : ''); 
                        const itemPrice = parseFloat(item.price);
                        
                        if (itemPrice > 0) {
                            if (combinedCompletedItems[itemNameKey]) {
                                combinedCompletedItems[itemNameKey].quantity += item.quantity;
                            } else {
                                combinedCompletedItems[itemNameKey] = { 
                                    name: item.name, 
                                    quantity: item.quantity,
                                    price: itemPrice, // L·∫•y gi√° ƒë√£ l∆∞u trong Order
                                    customizations: item.customizations || {} // L·∫•y customizations
                                };
                            }
                        }
                    }
                });
            });
            checkPromises.push(kitchenPromise);
        }
    });

    // ƒê·ª£i t·∫•t c·∫£ c√°c Promise ki·ªÉm tra tr·∫°ng th√°i ho√†n t·∫•t
    await Promise.all(checkPromises);

    // B·∫Øt ƒë·∫ßu hi·ªÉn th·ªã h√≥a ƒë∆°n sau khi ƒë√£ t·ªïng h·ª£p xong
    let billItemsHtml = '';
    if (hasCompletedItemsToPay) {
        Object.values(combinedCompletedItems).forEach((item, index) => {
            const itemPrice = item.price; 
            const itemTotal = itemPrice * item.quantity;
            totalAmount += itemTotal;
            
            // X·ª≠ l√Ω hi·ªÉn th·ªã chi ti·∫øt Combo tr√™n H√≥a ƒë∆°n thanh to√°n
            let displayedName = item.name;
            let detailsHtml = '';

            if (item.customizations && Object.keys(item.customizations).length > 0) {
                 const allCustomizations = [
                    ...(item.customizations.meat || []),
                    ...(item.customizations.veg || [])
                ];
                 detailsHtml = allCustomizations.join(', ');
            }
            
            billItemsHtml += `
                <tr>
                    <td class="item-name" style="text-align: left;">${index + 1}. ${displayedName}</td>
                    <td class="item-qty" style="text-align: center;">${item.quantity}</td>
                    <td class="item-price" style="text-align: right;">${itemPrice.toLocaleString('vi-VN')}</td>
                    <td class="item-total" style="text-align: right;">${itemTotal.toLocaleString('vi-VN')}</td>
                </tr>
            `;

            // N·∫øu l√† Combo, th√™m d√≤ng chi ti·∫øt d∆∞·ªõi d·∫°ng GHI CH√ö
            if (detailsHtml) {
                 billItemsHtml += `
                    <tr>
                        <td class="item-name" colspan="4" style="text-align: left; font-size: 0.9em; padding-left: 20px; font-style: italic; color: #555;">(Chi ti·∫øt: ${detailsHtml})</td>
                    </tr>
                 `;
            }
            
        });
    } else {
         billItemsHtml = '<tr><td colspan="4" style="text-align: center; font-style: italic;">Ch∆∞a c√≥ m√≥n n√†o ƒë∆∞·ª£c B·∫øp/Bar ho√†n th√†nh.</td></tr>';
    }

    billDetailsBody.innerHTML = billItemsHtml;
    const vatAmount = totalAmount * 0.1;
    const finalTotal = totalAmount + vatAmount;

    billTotalPrice.textContent = totalAmount.toLocaleString('vi-VN') + '‚Ç´';
    billVatPrice.textContent = vatAmount.toLocaleString('vi-VN') + '‚Ç´';
    billTotalPaid.textContent = finalTotal.toLocaleString('vi-VN') + '‚Ç´';
    
    // C·∫≠p nh·∫≠t l·∫°i URL VietQR v·ªõi t·ªïng s·ªë ti·ªÅn
    if (totalAmount > 0) {
        qrUrl = `https://img.vietqr.io/image/${acqId}-${accountNo}-compact.png?amount=${Math.round(finalTotal)}&addInfo=${encodeURIComponent(transferContent)}`;
        vietQrCode.src = qrUrl;
    }


    if (totalAmount === 0) {
        confirmPaymentButton.style.display = 'none';
        printBillButton.style.display = 'none';
    } else {
        confirmPaymentButton.style.display = 'block';
        printBillButton.style.display = 'block';
    }
}

        function generateBillId() {
            const now = new Date();
            const year = now.getFullYear().toString().slice(-2);
            const month = (now.getMonth() + 1).toString().padStart(2, '0');
            const day = now.getDate().toString().padStart(2, '0');
            const hour = now.getHours().toString().padStart(2, '0');
            const minute = now.getMinutes().toString().padStart(2, '0');
            const second = now.getSeconds().toString().padStart(2, '0');
            return `HD${year}${month}${day}${hour}${minute}${second}`;
        }
        
 // >> H√ÄM CONFIRM PAYMENT ƒê√É CH·ªàNH S·ª¨A L·∫†I LOGIC X·ª¨ L√ù TR·∫†NG TH√ÅI M√ìN <<
async function confirmPayment(tableId, tableName) {
    const updates = {};
    const itemsForBill = {};
    let totalAmount = 0;
    let hasPendingOrders = false;
    
    const sentOrdersSnapshot = await database.ref(`tables/${tableId}/sentOrders`).once('value');
    const paymentTimestamp = new Date().toISOString();
    
    // L·∫∑p qua t·ª´ng order ƒë√£ g·ª≠i
    const checkPromises = [];
    
    sentOrdersSnapshot.forEach(sentOrderSnapshot => {
        const sentOrderId = sentOrderSnapshot.key;
        const sentOrder = sentOrderSnapshot.val();
        
        if (sentOrder.items) {
            
            const promise = database.ref(`kitchen_bar_orders/${sentOrderId}/items`).once('value').then(kitchenItemsSnapshot => {
                const kitchenItems = kitchenItemsSnapshot.val() || {};
                const itemsToKeepInTableOrder = {};
                const itemsToKeepInKitchenOrder = {};
                
                let orderFullyPaid = true;

                // L·∫∑p qua t·ª´ng m√≥n trong order
                Object.keys(sentOrder.items).forEach(itemId => {
                    const item = sentOrder.items[itemId];
                    const kitchenItem = kitchenItems[itemId];
                    
                    if (kitchenItem && kitchenItem.status === 'completed') {
                        // 1. M√≥n ƒê√£ Xong -> Thanh to√°n
                        const itemPrice = parseFloat(item.price);
                        
                        if (itemPrice > 0) {
                             // T·ªïng h·ª£p m√≥n cho H√≥a ƒë∆°n (payment_history)
                            const itemNameKey = item.name + (item.customizations ? JSON.stringify(item.customizations) : '');
                            
                            if (itemsForBill[itemNameKey]) {
                                itemsForBill[itemNameKey].quantity += item.quantity;
                            } else {
                                itemsForBill[itemNameKey] = {
                                    name: item.name,
                                    quantity: item.quantity,
                                    price: itemPrice,
                                    customizations: item.customizations || {}
                                };
                            }
                            totalAmount += itemPrice * item.quantity;
                        }
                    } else {
                        // 2. M√≥n ƒêang Ch·ªù/Ch∆∞a G·ª≠i -> Gi·ªØ l·∫°i
                        itemsToKeepInTableOrder[itemId] = item;
                        itemsToKeepInKitchenOrder[itemId] = kitchenItem;
                        hasPendingOrders = true;
                        orderFullyPaid = false;
                    }
                });

                // C·∫≠p nh·∫≠t Database
                if (orderFullyPaid) {
                    // X√≥a ho√†n to√†n order kh·ªèi b√†n v√† b·∫øp
                    updates[`tables/${tableId}/sentOrders/${sentOrderId}`] = null;
                    updates[`kitchen_bar_orders/${sentOrderId}`] = null;
                } else if (Object.keys(itemsToKeepInTableOrder).length > 0) {
                    // C·∫≠p nh·∫≠t l·∫°i order c·ªßa b√†n (ch·ªâ c√≤n m√≥n ch∆∞a xong)
                    updates[`tables/${tableId}/sentOrders/${sentOrderId}/items`] = itemsToKeepInTableOrder;
                    // C·∫≠p nh·∫≠t l·∫°i order c·ªßa b·∫øp (ch·ªâ c√≤n m√≥n ch∆∞a xong)
                    updates[`kitchen_bar_orders/${sentOrderId}/items`] = itemsToKeepInKitchenOrder;
                }
            });
            checkPromises.push(promise);
        }
    });
    
    await Promise.all(checkPromises);
    
    if (totalAmount === 0) {
        alert('Kh√¥ng c√≥ m√≥n n√†o ƒë√£ ho√†n th√†nh ƒë·ªÉ thanh to√°n.');
        return;
    }

    // 3. Ghi h√≥a ƒë∆°n v√†o l·ªãch s·ª≠ thanh to√°n
    const newBillRef = database.ref('payment_history').push();
    const finalItemsForBill = Object.values(itemsForBill); // Chuy·ªÉn t·ª´ Object sang Array
    
    const vatAmount = totalAmount * 0.1;
    const finalTotal = totalAmount + vatAmount;

    updates[`payment_history/${newBillRef.key}`] = {
        billId: billId.textContent,
        tableId: tableId,
        tableName: tableName,
        timestamp: paymentTimestamp,
        items: finalItemsForBill,
        totalAmount: totalAmount,
        vatAmount: vatAmount,
        finalTotal: finalTotal
    };

    // Th·ª±c hi·ªán c√°c c·∫≠p nh·∫≠t l√™n Firebase
    database.ref().update(updates).then(() => {
        alert('Thanh to√°n th√†nh c√¥ng!');
        paymentModal.style.display = 'none';
        if (!hasPendingOrders) {
            // N·∫øu kh√¥ng c√≤n b·∫•t k·ª≥ ƒë∆°n n√†o pending tr√™n b√†n, chuy·ªÉn b√†n v·ªÅ 'available'
            database.ref(`tables/${tableId}`).update({ status: 'available' });
        }
        renderTables(); 
    }).catch(error => {
        console.error("L·ªói khi thanh to√°n:", error);
    });
}
        
        // --- Print Bill Functionality ---
        printBillButton.addEventListener('click', () => {
            window.print(); 
        });
        
        closeButton.onclick = () => paymentModal.style.display = 'none';
        window.onclick = (event) => {
            if (event.target == paymentModal || event.target == comboModal) {
                paymentModal.style.display = 'none';
                comboModal.style.display = 'none';
            }
        };

        document.addEventListener('DOMContentLoaded', () => {
            renderTables();
        });
    </script>
</body>
</html>
