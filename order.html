<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Theo Dõi Trạng Thái Bàn - iOS Inspired</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom Font - SF Pro Display Simulation */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Inter', 'SF Pro Display', 'Helvetica Neue', sans-serif;
            background-color: #F2F2F7; /* iOS Background */
            color: #1C1C1E; /* iOS Dark Text */
        }
        
        /* iOS-like soft shadow */
        .shadow-ios {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08), 0 1px 4px rgba(0, 0, 0, 0.05);
        }

        /* Style for the interactive table card (iOS Press Effect) */
        .table-card {
            cursor: pointer;
            transition: transform 0.2s cubic-bezier(0.2, 0, 0, 1), box-shadow 0.2s cubic-bezier(0.2, 0, 0, 1);
            user-select: none;
            will-change: transform;
        }
        .table-card:active {
            transform: scale(0.95); /* Gentle press effect */
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        /* Modal backdrop style for iOS-like blur */
        .modal-backdrop {
            display: flex;
            backdrop-filter: blur(8px); /* Subtle glass effect on backdrop */
        }
        
        /* Custom iOS Gradient Button */
        .btn-ios-gradient {
            background-image: linear-gradient(135deg, #007AFF, #5856D6); /* Blue-to-Purple Gradient */
            transition: background-image 0.2s;
        }
        .btn-ios-gradient:hover {
            opacity: 0.9;
        }

        /* Modal Slide-in Animation */
        #table-modal {
            transition: opacity 0.3s ease-in-out;
        }
        .modal-slide-in {
            opacity: 1;
        }
        .modal-slide-out {
            opacity: 0;
        }
        
        /* Modal Content Slide for iOS Feel */
        #modal-content {
            transition: transform 0.3s cubic-bezier(0.2, 0, 0, 1), opacity 0.3s ease-in-out;
        }
        .modal-slide-enter {
            transform: translateY(100vh);
            opacity: 0.5;
        }
        .modal-slide-enter-active {
            transform: translateY(0);
            opacity: 1;
        }

        /* Header/Footer Blur */
        .blur-header-footer {
            backdrop-filter: blur(20px);
            background-color: rgba(255, 255, 255, 0.85); /* Semi-transparent white */
            border-color: rgba(0, 0, 0, 0.05); /* Light border */
        }
        
        /* iOS Chip/Badge Styling */
        .status-chip {
             display: inline-flex;
             align-items: center;
             padding: 4px 10px;
             font-size: 0.75rem; /* text-xs */
             font-weight: 600; /* semibold */
             border-radius: 9999px; /* rounded-full */
             transition: background-color 0.2s;
        }
        .status-chip.pending {
            background-color: #FF3B301A; /* Red 10% opacity */
            color: #FF3B30; /* iOS Red */
        }
        .status-chip.done {
            background-color: #34C7591A; /* Green 10% opacity */
            color: #34C759; /* iOS Green */
        }
    </style>
</head>
<body class="min-h-screen">
    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center pt-8 pb-6 mb-6 bg-white shadow-ios rounded-3xl">
            <h1 class="text-3xl md:text-4xl font-extrabold text-slate-800">
                <span class="text-[#007AFF]">Realtime</span> Status Bàn
            </h1>
            <p class="text-gray-500 mt-2 font-medium text-sm">Nhấp vào bàn để xem thông tin hoặc đặt món</p>
        </header>

        <div id="loading" class="text-center p-8 text-gray-500">
            <svg class="animate-spin h-8 w-8 text-[#007AFF] mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="mt-3 font-medium">Đang kết nối tới Firebase...</p>
        </div>

        <div id="tables-container" class="grid grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 sm:gap-6">
            </div>

        <div id="error-message" class="hidden text-center p-6 mt-6 bg-[#FF3B301A] border border-[#FF3B30] text-[#FF3B30] rounded-xl font-medium" role="alert">
            <p class="font-bold text-lg">Lỗi Kết Nối</p>
            <p>Không thể tải dữ liệu bàn. Vui lòng kiểm tra console log để biết chi tiết.</p>
        </div>
    </div>

    <div id="table-modal" class="fixed inset-0 bg-gray-900/40 z-50 hidden items-end justify-center modal-slide-out modal-backdrop p-0" onclick="handleModalBackdropClick(event)">
        <div id="modal-content" class="bg-white rounded-t-3xl shadow-2xl w-full max-w-full lg:max-w-4xl max-h-[90vh] overflow-hidden transform transition-all duration-300 flex flex-col modal-slide-enter">
            <div id="modal-header" class="p-4 border-b border-gray-100 flex justify-between items-center blur-header-footer flex-shrink-0">
                <h3 id="modal-table-name" class="text-xl font-bold text-slate-800">Thông tin Bàn</h3>
                <button onclick="closeTableModal()" class="text-gray-400 hover:text-gray-600 focus:outline-none p-1 rounded-full bg-gray-100 hover:bg-gray-200 active:scale-95 transition">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            
            <div id="modal-body-container" class="flex-grow overflow-y-auto">

                <div id="main-actions-section" class="p-5 space-y-4">
                    <button id="btn-order" data-table-name="" class="w-full py-4 px-4 rounded-xl text-lg font-bold text-white btn-ios-gradient transition duration-150 shadow-lg shadow-blue-500/30 active:scale-[0.98]">
                        &#x1F37D; Đặt Món (Mở Menu tại chỗ)
                    </button>
                    <button id="btn-view-orders" class="w-full py-4 px-4 rounded-xl text-lg font-bold text-slate-800 bg-gray-200 hover:bg-gray-300 transition duration-150 shadow-md active:scale-[0.98]">
                        &#x1F4DC; Xem Món Đã Order
                    </button>
                    
                    <div id="ordered-items-display" class="hidden mt-4 p-5 border border-gray-200 rounded-xl max-h-96 overflow-y-auto bg-white shadow-inner">
                        <p class="font-bold text-xl border-b pb-3 mb-4 text-slate-700 flex justify-between items-center">
                            Danh sách Món Đã Order 
                            <span id="order-status-indicator" class="text-base font-medium status-chip pending"></span>
                        </p>
                        <ul id="order-list" class="space-y-3 text-base">
                            </ul>
                    </div>
                </div>

                <div id="iframe-section" class="hidden w-full h-full flex flex-col absolute inset-0">
                    <div class="p-3 border-b border-gray-100 bg-white flex items-center flex-shrink-0">
                        <button id="btn-back-to-actions" class="px-3 py-1.5 mr-3 text-sm font-semibold text-[#007AFF] bg-white rounded-lg active:scale-95 transition border border-[#007AFF]/30">
                            &larr; Quay Lại
                        </button>
                        <span class="font-bold text-base text-slate-800">Đặt Món cho Bàn <span id="iframe-table-name" class="text-[#007AFF]"></span></span>
                    </div>
                    <iframe id="menu-iframe" src="" class="flex-grow w-full border-0"></iframe>
                </div>

            </div>
            
            <div id="modal-footer" class="p-4 border-t border-gray-100 text-right blur-header-footer flex-shrink-0">
                <button onclick="closeTableModal()" class="px-5 py-2 text-base font-semibold text-[#007AFF] bg-gray-100 rounded-xl hover:bg-gray-200 active:scale-95 transition">Đóng</button>
            </div>
        </div>
    </div>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";

        // Your web app's Firebase configuration (using the configuration provided by the user)
        const firebaseConfig = {
            apiKey: "AIzaSyB8uLkLJFlzmCodcawJhs2dRckHQzO5y10",
            authDomain: "chitieu-7263e.firebaseapp.com",
            databaseURL: "https://chitieu-7263e-default-rtdb.firebaseio.com",
            projectId: "chitieu-7263e",
            storageBucket: "chitieu-7263e.firebasestorage.app",
            messagingSenderId: "83833140682",
            appId: "1:83833140682:web:f9254b418ace3a659fcb33",
            measurementId: "G-523X74K18N"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        
        // --- GLOBAL STATE & CONSTANTS ---
        let allTablesData = {};
        let allOrders = {};
        const MENU_URL = "https://thanhchan791791.github.io/member/menu/";

        // References to DOM elements
        const tablesContainer = document.getElementById('tables-container');
        const loadingIndicator = document.getElementById('loading');
        const errorMessage = document.getElementById('error-message');
        
        // References for the Modal
        const tableModal = document.getElementById('table-modal');
        const modalContent = document.getElementById('modal-content');
        const modalTableName = document.getElementById('modal-table-name');
        const modalFooter = document.getElementById('modal-footer');
        
        const mainActionsSection = document.getElementById('main-actions-section');
        const iframeSection = document.getElementById('iframe-section');
        const menuIframe = document.getElementById('menu-iframe');
        const btnOrder = document.getElementById('btn-order');
        const btnViewOrders = document.getElementById('btn-view-orders');
        const btnBackToActions = document.getElementById('btn-back-to-actions');
        const iframeTableNameSpan = document.getElementById('iframe-table-name');

        const orderedItemsDisplay = document.getElementById('ordered-items-display');
        const orderList = document.getElementById('order-list');
        const orderStatusIndicator = document.getElementById('order-status-indicator');

        // --- MODAL VIEW MANAGEMENT FUNCTIONS ---

        /**
         * Sets the modal view to show the main action buttons and order summary.
         * @param {string} tableName - The user-friendly name of the table.
         */
        function showActionButtonsView(tableName) {
            // Update header and view visibility
            modalTableName.textContent = `Thao tác với Bàn: ${tableName}`;
            iframeSection.classList.add('hidden');
            mainActionsSection.classList.remove('hidden');
            orderedItemsDisplay.classList.add('hidden'); 
            modalFooter.classList.remove('hidden');

            // Revert modal size for action view
            modalContent.classList.remove('lg:max-w-4xl');
            modalContent.classList.add('lg:max-w-lg'); // Set back to smaller width on desktop

            // Ensure iframe is clear
            menuIframe.src = ''; 
        }

        /**
         * Sets the modal view to show the menu iframe.
         * @param {string} tableId - The Firebase key of the table.
         * @param {string} tableName - The user-friendly name of the table.
         */
        function showMenuIframeView(tableId, tableName) {
            // Update header and view visibility
            modalTableName.textContent = `Đặt Món cho Bàn: ${tableName}`;
            iframeTableNameSpan.textContent = tableName;

            // Load URL into iframe
            menuIframe.src = `${MENU_URL}?table=${tableId}&name=${tableName}`; 

            // Swap views
            mainActionsSection.classList.add('hidden');
            iframeSection.classList.remove('hidden');
            modalFooter.classList.add('hidden'); // Hide footer close button

            // Adjust modal size for iframe view
            modalContent.classList.remove('lg:max-w-lg');
            modalContent.classList.add('lg:max-w-4xl'); // Set to larger size on desktop
        }


        /**
         * Closes the action modal with iOS-like slide-out animation.
         */
        window.closeTableModal = () => {
            modalContent.classList.add('modal-slide-enter');
            modalContent.classList.remove('modal-slide-enter-active');
            tableModal.classList.add('modal-slide-out');
            tableModal.classList.remove('modal-slide-in');

            setTimeout(() => {
                tableModal.classList.add('hidden');
                tableModal.classList.remove('modal-backdrop');
                menuIframe.src = ''; // Clean up iframe source to stop video/audio if any
                modalContent.classList.remove('modal-slide-enter'); // Clean up class for next time
            }, 300); // Match transition duration
        };

        /**
         * Handles click outside the modal content to close it.
         */
        window.handleModalBackdropClick = (event) => {
            if (event.target === tableModal) {
                closeTableModal();
            }
        };
        
        /**
         * Renders the orders for a specific table ID.
         * @param {string} tableId - The Firebase key of the table.
         * @param {string} tableName - The user-friendly name of the table.
         */
        function displayTableOrders(tableId, tableName) {
            orderList.innerHTML = ''; // Clear previous items
            let totalItemsCount = 0;
            let totalPrice = 0;
            let hasPending = false;
            let foundOrder = false;

            // Iterate through all top-level orders
            Object.entries(allOrders).forEach(([orderKey, orderValue]) => {
                // Check if this order belongs to the clicked table
                if (orderValue.tableId === tableId && orderValue.items) {
                    foundOrder = true;
                    // Iterate through the items of this specific order
                    Object.values(orderValue.items).forEach(item => {
                        const itemTotal = (item.price || 0) * (item.quantity || 1);
                        totalPrice += itemTotal;
                        totalItemsCount += (item.quantity || 1);
                        
                        // Check for pending status to flag the order
                        if (item.status === 'pending') {
                            hasPending = true;
                        }
                        
                        // Formatting price
                        const formattedPrice = (item.price || 0).toLocaleString('vi-VN');
                        
                        // LOGIC FIX: Coi mọi trạng thái KHÔNG PHẢI 'pending' là 'done'
                        const isPending = item.status === 'pending';
                        const statusClass = isPending ? 'status-chip pending' : 'status-chip done';
                        const statusText = isPending ? 'Đang Chờ' : 'Đã Xong';

                        const itemHtml = `
                            <li class="flex justify-between items-start py-2 border-b border-gray-100 last:border-b-0">
                                <div class="flex-1 min-w-0 pr-3">
                                    <span class="font-medium text-slate-800">${item.itemName || 'Món không tên'}</span>
                                    <span class="block text-xs text-gray-400 italic font-normal">${item.type || 'Khác'}</span>
                                </div>
                                <div class="flex flex-col items-end pl-3">
                                    <span class="text-base font-semibold text-slate-700">${item.quantity || 1} x ${formattedPrice} VNĐ</span>
                                    <span class="${statusClass} mt-1">${statusText}</span>
                                </div>
                            </li>
                        `;
                        orderList.insertAdjacentHTML('beforeend', itemHtml);
                    });
                }
            });

            // Update status indicator and summary
            if (hasPending) {
                orderStatusIndicator.textContent = 'Có món Đang Chờ';
                orderStatusIndicator.classList.remove('done', 'bg-gray-300', 'text-gray-700');
                orderStatusIndicator.classList.add('pending');
            } else if (foundOrder) {
                orderStatusIndicator.textContent = 'Tất cả đã Xong';
                orderStatusIndicator.classList.remove('pending', 'bg-gray-300', 'text-gray-700');
                orderStatusIndicator.classList.add('done');
            } else {
                 orderStatusIndicator.textContent = 'Chưa có Order';
                 orderStatusIndicator.classList.remove('pending', 'done');
                 orderStatusIndicator.classList.add('bg-gray-300', 'text-gray-700');
            }


            if (totalItemsCount === 0) {
                orderList.innerHTML = '<p class="text-center italic text-gray-400 p-4">Bàn này chưa có món nào được đặt.</p>';
                orderedItemsDisplay.classList.remove('hidden'); // Show empty state
            } else {
                // Add total summary
                const summaryHtml = `
                    <li class="mt-4 pt-3 border-t-2 border-gray-200 flex justify-between items-center font-extrabold text-xl text-[#007AFF]">
                        <span>TỔNG CỘNG (${totalItemsCount} món)</span>
                        <span>${totalPrice.toLocaleString('vi-VN')} VNĐ</span>
                    </li>
                `;
                orderList.insertAdjacentHTML('beforeend', summaryHtml);
                orderedItemsDisplay.classList.remove('hidden');
            }

        }


        /**
         * Opens the modal for a specific table with iOS-like slide-in animation.
         * @param {string} tableId - The Firebase key of the table.
         * @param {string} tableName - The user-friendly name of the table (e.g., "B1").
         */
        window.openTableModal = (tableId, tableName) => {
            // Set initial view to action buttons
            showActionButtonsView(tableName); 

            // Set data attributes for button handlers
            btnOrder.setAttribute('data-table-id', tableId);
            btnOrder.setAttribute('data-table-name', tableName);
            btnViewOrders.setAttribute('data-table-id', tableId);

            // Show the modal backdrop and trigger animation
            tableModal.classList.remove('hidden', 'modal-slide-out');
            tableModal.classList.add('modal-backdrop', 'modal-slide-in');
            
            // Trigger content slide-up after backdrop is visible
            setTimeout(() => {
                modalContent.classList.remove('modal-slide-enter');
                modalContent.classList.add('modal-slide-enter-active');
            }, 10); // Small delay to ensure display:flex is applied
        };

        // --- EVENT LISTENERS FOR MODAL BUTTONS ---

        // 1. Order Button: Displays the menu iframe
        btnOrder.addEventListener('click', (event) => {
            
            const tableId = event.currentTarget.getAttribute('data-table-id');
            const tableName = event.currentTarget.getAttribute('data-table-name');
            showMenuIframeView(tableId, tableName);
        });

        // 2. View Orders Button: Displays the order list
        btnViewOrders.addEventListener('click', (event) => {
            
            const tableId = event.currentTarget.getAttribute('data-table-id');
            const tableName = allTablesData[tableId]?.name || `[ID: ${tableId}]`;
            displayTableOrders(tableId, tableName);
        });

        // 3. Back Button (Quay Lại): Returns from iframe to action buttons
        btnBackToActions.addEventListener('click', (event) => {
            
            const tableName = btnOrder.getAttribute('data-table-name');
            showActionButtonsView(tableName);
        });

        // --- FIREBASE LISTENERS ---

        /**
         * Renders the table list based on the snapshot data.
         * @param {object} tablesData - An object containing table data keyed by their IDs.
         */
        function renderTables(tablesData) {
            allTablesData = tablesData; // Update global table data state
            tablesContainer.innerHTML = '';
            
            const tableEntries = tablesData ? Object.entries(tablesData) : [];
            
            // Sort tables alphabetically by name (e.g., B1, B2, B3)
            tableEntries.sort(([, a], [, b]) => {
                const nameA = a.name || "";
                const nameB = b.name || "";
                return nameA.localeCompare(nameB, undefined, { numeric: true, sensitivity: 'base' });
            });

            if (tableEntries.length === 0) {
                 tablesContainer.innerHTML = '<p class="text-center col-span-full text-gray-500 p-10 font-medium">Không tìm thấy dữ liệu bàn nào.</p>';
                 return;
            }

            tableEntries.forEach(([key, table]) => {
                const name = table.name || `[ID: ${key}]`;
                const status = (table.status || 'unknown').toLowerCase();
                
                let statusText = '';
                let bgColor = 'bg-white';
                let accentColor = 'text-gray-500';
                let statusBadgeColor = 'bg-gray-300 text-gray-700';
                let icon = '&#x2753;'; // Question mark

                switch (status) {
                    case 'occupied':
                        statusText = 'Đang có Khách';
                        accentColor = 'text-[#FF3B30]'; // iOS Red
                        statusBadgeColor = 'bg-[#FF3B301A] text-[#FF3B30]';
                        icon = '&#x1F6D1;'; // Red sign
                        break;
                    case 'available':
                        statusText = 'Sẵn sàng';
                        accentColor = 'text-[#34C759]'; // iOS Green
                        statusBadgeColor = 'bg-[#34C7591A] text-[#34C759]';
                        icon = '&#x2705;'; // Check mark
                        break;
                    default:
                        statusText = 'Không rõ';
                        accentColor = 'text-gray-500';
                        statusBadgeColor = 'bg-gray-300 text-gray-700';
                        icon = '&#x2753;'; // Question mark
                        break;
                }

                // Add the onclick handler to call openTableModal with key (ID) and name
                const cardHtml = `
                    <button onclick="openTableModal('${key}', '${name}')" 
                            class="table-card p-5 rounded-2xl shadow-ios ${bgColor} text-slate-800">
                        <div class="flex items-center justify-between">
                            <h2 class="text-3xl font-extrabold ${accentColor}">${name}</h2>
                            <span class="text-3xl leading-none">${icon}</span>
                        </div>
                        <div class="mt-4 pt-3">
                            <p class="text-sm text-gray-500 font-medium">Trạng thái:</p>
                            <span class="text-base font-semibold status-chip ${statusBadgeColor} mt-1">${statusText}</span>
                        </div>
                        <p class="text-xs text-gray-400 mt-2 truncate font-light">ID: ${key}</p>
                    </button>
                `;
                
                tablesContainer.insertAdjacentHTML('beforeend', cardHtml);
            });
        }

        /**
         * Setup Realtime Database listener for the 'tables' node (Table Status).
         */
        function setupTableListener() {
            const tablesRef = ref(db, 'tables');

            try {
                onValue(tablesRef, (snapshot) => {
                    loadingIndicator.classList.add('hidden');
                    
                    if (snapshot.exists()) {
                        const tablesData = snapshot.val();
                        console.log("Firebase Table Data Received:", tablesData);
                        renderTables(tablesData);
                    } else {
                        console.log("No data available at /tables");
                        renderTables(null);
                    }
                }, 
                (error) => {
                    loadingIndicator.classList.add('hidden');
                    errorMessage.classList.remove('hidden');
                    console.error("Firebase Read Error:", error);
                });
            } catch (e) {
                loadingIndicator.classList.add('hidden');
                errorMessage.classList.remove('hidden');
                console.error("Initialization or Listener Setup Error:", e);
            }
        }

        /**
         * Setup Realtime Database listener for the 'kitchen_bar_orders' node (Order Data).
         */
        function setupOrderListener() {
            const ordersRef = ref(db, 'kitchen_bar_orders');
            onValue(ordersRef, (snapshot) => {
                if (snapshot.exists()) {
                    allOrders = snapshot.val();
                    console.log("Firebase Order Data Received:", allOrders);
                    // Re-render orders if the modal is open and showing the order list
                    const tableId = btnViewOrders.getAttribute('data-table-id');
                    if (tableId && !orderedItemsDisplay.classList.contains('hidden')) {
                         const tableName = allTablesData[tableId]?.name || `[ID: ${tableId}]`;
                         displayTableOrders(tableId, tableName);
                    }
                } else {
                    allOrders = {};
                }
            }, (error) => {
                console.error("Firebase Order Read Error:", error);
            });
        }


        // Start the process when the script loads
        setupTableListener();
        setupOrderListener();

    </script>
</body>
</html>
